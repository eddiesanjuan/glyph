function debounce(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>e.apply(this,a),t)}}const API_URL="localhost"===window.location.hostname&&localStorage.getItem("USE_LOCAL_API")?"http://localhost:3000":(window.location.hostname.includes("glyph.you")||window.location.hostname.includes(".railway.app"),"https://api.glyph.you"),DEMO_API_KEY="gk_demo_playground_2024";(async()=>{try{await fetch(`${API_URL}/health`,{method:"GET"}),console.log("[Glyph] API warmed up")}catch(e){}})();let isStorageAvailable=!0,storageFailureCount=0,storageWarningShown=!1;function checkStorageAvailability(){const e="__glyph_storage_test__";try{return localStorage.setItem(e,"test"),localStorage.removeItem(e),!0}catch(e){return!1}}function handleStorageFailure(){storageFailureCount++,storageFailureCount>=2&&!storageWarningShown&&(storageWarningShown=!0,setTimeout(()=>{"function"==typeof showToast&&showToast("Private browsing detected - saved versions won't persist","warning",6e3)},1e3))}function safeSetItem(e,t){if(!isStorageAvailable)return handleStorageFailure(),!1;try{return localStorage.setItem(e,t),!0}catch(e){return console.warn("[Glyph] localStorage.setItem failed:",e),handleStorageFailure(),!1}}function safeGetItem(e,t=null){if(!isStorageAvailable)return t;try{const n=localStorage.getItem(e);return null!==n?n:t}catch(e){return console.warn("[Glyph] localStorage.getItem failed:",e),t}}isStorageAvailable=checkStorageAvailability(),isStorageAvailable||setTimeout(()=>{"function"==typeof showToast&&showToast("Private browsing detected - saved versions won't persist","warning",6e3)},2e3),function(){try{const e=new URLSearchParams(window.location.search),t=e.get("apiKey");if(t&&t.startsWith("gk_")&&t!==DEMO_API_KEY){localStorage.setItem("glyph_user_api_key",t),console.log("[Glyph] API key received from URL parameter"),e.delete("apiKey");const n=window.location.pathname+(e.toString()?"?"+e.toString():"")+window.location.hash;history.replaceState({},"",n),setTimeout(()=>{updateAuthUI(),"function"==typeof showToast&&showToast("Signed in successfully","success",3e3)},500)}}catch(e){console.warn("[Glyph] Error handling URL API key:",e)}}();let isLoadingFromUrl=!1,currentEditingTemplate=null;function checkUrlTemplateParameters(){try{const e=new URLSearchParams(window.location.search),t=e.get("templateId"),n=e.get("sourceId");if(t)return isLoadingFromUrl=!0,setTimeout(()=>{loadSavedTemplateWithSource(t,n)},100),!0}catch(e){console.warn("[Glyph] Error checking URL template parameters:",e)}return!1}async function loadSavedTemplateWithSource(e,t){const n=getUserApiKey();if(n===DEMO_API_KEY)return showToast("Sign in with your API key to edit saved templates","warning",5e3),isLoadingFromUrl=!1,void initializePreview();showInitialLoadingSkeleton(),setStatus("Loading template..."),updateSkeletonStage("connecting");try{console.log("[Glyph] Loading saved template:",e);const a=await fetch(`${API_URL}/v1/templates/saved/${e}`,{headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(!a.ok){if(404===a.status)throw new Error("Template not found. It may have been deleted.");if(403===a.status)throw new Error("You do not have access to this template.");const e=await a.json().catch(()=>({}));throw new Error(e.error||"Failed to load template")}const o=(await a.json()).template;console.log("[Glyph] Template loaded:",o.name),currentEditingTemplate={id:o.id,name:o.name,sourceId:t};let i=o.sampleData||o.sample_data||{};if(t){updateSkeletonStage("loading"),setStatus("Loading source data...");try{const a=await fetch(`${API_URL}/v1/sources/${t}/records?limit=1`,{headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(a.ok){const o=await a.json();if(o.records&&o.records.length>0){const a=o.records[0];try{const o=await fetch(`${API_URL}/v1/mappings?template_id=${e}&source_id=${t}`,{headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(o.ok){const e=await o.json();if(e.mappings&&e.mappings.length>0){const t=e.mappings[0];i=applyFieldMappings(a,t.field_mappings),console.log("[Glyph] Applied field mappings from mapping:",t.id)}else i=a.fields||a,console.log("[Glyph] No mapping found, using raw record")}else i=a.fields||a}catch(e){console.warn("[Glyph] Could not load mappings:",e),i=a.fields||a}}}else console.warn("[Glyph] Could not load source records:",a.status)}catch(e){console.warn("[Glyph] Could not load source data:",e)}}updateSkeletonStage("loading"),setStatus("Creating preview...");const s=await fetch(`${API_URL}/v1/preview`,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({savedTemplateId:e,data:i})});if(!s.ok){const e=await s.json().catch(()=>({}));throw new Error(e.error||"Failed to create preview session")}const r=await s.json();if(currentHtml=r.html,sessionId=r.sessionId,renderPreview(currentHtml),showEditingBanner(o.name,!!t),hideInitialLoadingSkeleton(),setStatus("Ready"),startSessionTimer(),showSaveTemplateButton(),window.innerWidth<=480){const e=document.getElementById("preview-container");e&&e.classList.add("zoomed-in")}const l=document.getElementById("playground")||document.querySelector(".playground");l&&setTimeout(()=>{l.scrollIntoView({behavior:"smooth"})},300),showToast(`Loaded "${o.name}"`,"success",3e3),console.log("[Glyph] Template loaded successfully, session:",sessionId)}catch(e){console.error("[Glyph] Load template error:",e),hideInitialLoadingSkeleton(),showToast(e.message||"Failed to load template","error",5e3),isLoadingFromUrl=!1,initializePreview()}finally{isLoadingFromUrl=!1}}function applyFieldMappings(e,t){if(!t||"object"!=typeof t)return e.fields||e;const n={};for(const[a,o]of Object.entries(t)){const t=getNestedValue(e,o);void 0!==t&&setNestedValue(n,a,t)}return n}function getNestedValue(e,t){if(!t||!e)return;const n=t.split(".");let a=e;for(const e of n){if(null==a)return;a=a[e]}return a}function setNestedValue(e,t,n){if(!t)return;const a=t.split(".");let o=e;for(let e=0;e<a.length-1;e++)o[a[e]]||(o[a[e]]={}),o=o[a[e]];o[a[a.length-1]]=n}function showEditingBanner(e,t){const n=document.querySelector(".editing-banner");n&&n.remove();const a=document.createElement("div");a.className="editing-banner",a.innerHTML=`\n        <span class="editing-banner__icon">\n          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>\n          </svg>\n        </span>\n        <span class="editing-banner__text">\n          Editing: <strong>${escapeHtmlForBanner(e)}</strong>\n          ${t?'<span class="editing-banner__source">with live data</span>':""}\n        </span>\n        <button class="editing-banner__close" onclick="this.parentElement.remove()" title="Dismiss">\n          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>\n          </svg>\n        </button>\n      `;const o=document.querySelector(".playground__main")||document.querySelector(".playground__content")||document.querySelector(".playground");o&&o.insertBefore(a,o.firstChild)}function escapeHtmlForBanner(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function removeEditingBanner(){const e=document.querySelector(".editing-banner");e&&e.remove(),currentEditingTemplate=null}function isUserLoggedIn(){try{const e=localStorage.getItem("glyph_user_api_key");return e&&e!==DEMO_API_KEY&&e.startsWith("gk_")}catch(e){return!1}}function updateAuthUI(){const e=document.getElementById("auth-settings-btn"),t=document.getElementById("auth-indicator");if(!e)return;const n=isUserLoggedIn();e.classList.toggle("logged-in",n),t&&(t.style.display=n?"block":"none")}function logoutUser(){try{localStorage.removeItem("glyph_user_api_key"),updateAuthUI(),"function"==typeof showToast&&showToast("Signed out","info",2e3)}catch(e){console.warn("[Glyph] Error during logout:",e)}}function loginWithApiKey(e){if(!e||!e.startsWith("gk_"))return"function"==typeof showToast&&showToast("Invalid API key format","error",3e3),!1;if(e===DEMO_API_KEY)return"function"==typeof showToast&&showToast("Cannot use demo API key","error",3e3),!1;try{return localStorage.setItem("glyph_user_api_key",e),updateAuthUI(),"function"==typeof showToast&&showToast("Signed in successfully","success",3e3),!0}catch(e){return"function"==typeof showToast&&showToast("Failed to save API key","error",3e3),!1}}function initAuthModal(){const e=document.getElementById("auth-settings-btn"),t=document.getElementById("auth-modal"),n=document.getElementById("auth-modal-close"),a=document.getElementById("auth-login-btn"),o=document.getElementById("auth-logout-btn"),i=document.getElementById("auth-api-key-input"),s=document.getElementById("auth-error"),r=document.getElementById("auth-state-logged-out"),l=document.getElementById("auth-state-logged-in"),d=document.getElementById("auth-key-preview"),c=document.getElementById("auth-modal-title");function p(){t.classList.remove("active"),document.body.style.overflow=""}e&&t&&(e.addEventListener("click",function(){const e=isUserLoggedIn();if(e){r.style.display="none",l.style.display="block",c.textContent="Account";try{const e=localStorage.getItem("glyph_user_api_key");e&&(d.textContent=e.substring(0,10)+"...")}catch(e){}}else r.style.display="block",l.style.display="none",c.textContent="Sign In",i.value="",s.style.display="none";t.classList.add("active"),document.body.style.overflow="hidden",e||setTimeout(()=>i.focus(),100)}),n.addEventListener("click",p),t.addEventListener("click",e=>{e.target===t&&p()}),a.addEventListener("click",()=>{const e=i.value.trim();return e?e.startsWith("gk_")?e===DEMO_API_KEY?(s.textContent="Cannot use demo API key",void(s.style.display="block")):void(loginWithApiKey(e)&&p()):(s.textContent="API key must start with gk_",void(s.style.display="block")):(s.textContent="Please enter an API key",void(s.style.display="block"))}),i.addEventListener("keydown",e=>{"Enter"===e.key&&a.click()}),o.addEventListener("click",()=>{logoutUser(),p()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&t.classList.contains("active")&&p()}),updateAuthUI())}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initAuthModal):initAuthModal();const MAX_DEMO_DOWNLOADS=3;let demoDownloadCount=0;function addWatermarkToHtml(e){const t="\n        <style>\n          .glyph-demo-watermark {\n            position: fixed;\n            bottom: 12px;\n            right: 12px;\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            font-size: 10px;\n            color: rgba(100, 116, 139, 0.6);\n            background: rgba(248, 250, 252, 0.9);\n            padding: 4px 8px;\n            border-radius: 4px;\n            border: 1px solid rgba(148, 163, 184, 0.3);\n            z-index: 9999;\n            pointer-events: none;\n          }\n          @media print {\n            .glyph-demo-watermark {\n              position: fixed;\n              bottom: 12px;\n              right: 12px;\n            }\n          }\n        </style>\n      ",n='<div class="glyph-demo-watermark">Created with Glyph - glyph.you</div>';return e.includes("</body>")?e.replace("</body>",t+n+"</body>"):e+t+n}async function generateDemoPdf(){if(demoDownloadCount>=3)return showModal(),!1;if(!currentHtml)return showToast("No document to generate. Please wait for preview to load.","error"),!1;try{const e=addWatermarkToHtml(currentHtml),t=await fetch(`${API_URL}/v1/generate`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${DEMO_API_KEY}`},body:JSON.stringify({html:e,format:"pdf"})});if(!t.ok){const e=await t.json().catch(()=>({}));throw new Error(e.error||"PDF generation failed")}const n=await t.blob(),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=`glyph-demo-${Date.now()}.pdf`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a),demoDownloadCount++;const i=3-demoDownloadCount,s=document.getElementById("demo-downloads-remaining");return s&&(s.textContent=0===i?"This was your last demo download.":`${i} demo download${1===i?"":"s"} remaining.`),showPdfSuccessModal(),!0}catch(e){return console.error("[Glyph] Demo PDF generation failed:",e),showToast("PDF generation failed. Please try again.","error"),!1}}function showPdfSuccessModal(){const e=document.getElementById("pdf-success-modal");e&&(e.classList.add("visible"),document.body.style.overflow="hidden")}function hidePdfSuccessModal(){const e=document.getElementById("pdf-success-modal");e&&(e.classList.remove("visible"),document.body.style.overflow="")}function fallbackCopyToClipboard(e){return new Promise((t,n)=>{const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.left="-9999px",a.style.top="0",a.setAttribute("readonly",""),document.body.appendChild(a);try{a.select(),a.setSelectionRange(0,e.length);const o=document.execCommand("copy");document.body.removeChild(a),o?t():n(new Error("execCommand copy failed"))}catch(e){document.body.removeChild(a),n(e)}})}async function copyTextToClipboard(e){if(navigator.clipboard&&"function"==typeof navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(e),!0}catch(e){console.warn("[Glyph] Clipboard API failed, trying fallback:",e)}try{return await fallbackCopyToClipboard(e),!0}catch(e){return console.error("[Glyph] All clipboard methods failed:",e),!1}}function copyToClipboard(e,t){const n=document.createElement("textarea");n.innerHTML=e;copyTextToClipboard(n.value).then(e=>{const t=document.getElementById("copy-toast");e?(t.classList.add("show"),setTimeout(()=>{t.classList.remove("show")},2e3)):showToast("Couldn't copy to clipboard - try Ctrl/Cmd+C","error",4e3)})}function copyQuickStart(e){copyTextToClipboard('<script src="https://sdk.glyph.you/glyph.min.js"><\/script>\n<glyph-editor\n  api-key="YOUR_KEY"\n  template="quote-modern"\n></glyph-editor>').then(t=>{t&&(e.classList.add("copied"),e.textContent="Copied!",setTimeout(()=>{e.classList.remove("copied"),e.innerHTML='<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14"><rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke-width="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke-width="2"/></svg> Copy'},2e3))})}function copyIntegrationCode(){const e=document.querySelector(".code-block--active");if(!e)return;const t=e.querySelector("code");if(!t)return;const n=document.createElement("textarea");n.innerHTML=t.textContent||"";copyTextToClipboard(n.value).then(e=>{const t=document.getElementById("integration-copy-btn");e?(t&&(t.classList.add("copied"),t.querySelector("span").textContent="Copied!",setTimeout(()=>{t.classList.remove("copied"),t.querySelector("span").textContent="Copy Code"},2e3)),showIntegrationCopyToast()):(t&&(t.classList.add("error"),t.querySelector("span").textContent="Copy failed",setTimeout(()=>{t.classList.remove("error"),t.querySelector("span").textContent="Copy Code"},3e3)),showToast("Couldn't copy to clipboard - try Ctrl/Cmd+C","error",4e3))})}function showIntegrationCopyToast(){let e=document.getElementById("integration-copy-toast");e||(e=document.createElement("div"),e.id="integration-copy-toast",e.className="integration-copy-toast",e.innerHTML='\n          <div class="integration-copy-toast__content">\n            <svg class="integration-copy-toast__icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>\n            </svg>\n            <span>Copied! <a href="https://dashboard.glyph.you">Get your API key</a> to start using Glyph</span>\n          </div>\n        ',document.body.appendChild(e)),e.classList.add("visible"),setTimeout(()=>{e.classList.remove("visible")},4e3)}let currentTemplate="quote-modern",currentHtml="",sessionId=null;const MAX_UNDO_HISTORY=10;let undoHistory=[];const MAX_REDO_HISTORY=20;let redoHistory=[],diffRegionSnapshots=null,isDiffActive=!1;const appliedActions=new Set,SESSION_DURATION_MS=36e5,WARNING_THRESHOLD_MS=6e5,URGENT_THRESHOLD_MS=3e5;let sessionStartTime=null,sessionTimerInterval=null,hasShown10MinWarning=!1,hasShown5MinWarning=!1,userHasInteracted=!1,hasShownSuccessCta=!1,hasShownFirstInstantWin=!1;function getSessionTimerElements(){return{timer:document.getElementById("session-timer"),timerText:document.getElementById("session-timer-text"),warningToast:document.getElementById("session-warning-toast"),warningTitle:document.getElementById("session-warning-title"),warningMessage:document.getElementById("session-warning-message"),warningDownload:document.getElementById("session-warning-download"),warningDismiss:document.getElementById("session-warning-dismiss")}}function formatTimeRemaining(e){if(e<=0)return"Expired";const t=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3);return t>=60?"60 min":t>0?`${t} min`:`${n}s`}function startSessionTimer(){sessionStartTime=Date.now(),hasShown10MinWarning=!1,hasShown5MinWarning=!1,sessionTimerInterval&&clearInterval(sessionTimerInterval),sessionTimerInterval=setInterval(updateSessionTimer,1e3),updateSessionTimer(),document.addEventListener("visibilitychange",handleVisibilityChange),console.log("[Glyph] Session timer started")}function handleVisibilityChange(){document.hidden?sessionTimerInterval&&(clearInterval(sessionTimerInterval),sessionTimerInterval=null):sessionStartTime&&!sessionTimerInterval&&(updateSessionTimer(),sessionTimerInterval=setInterval(updateSessionTimer,1e3))}function updateSessionTimer(){if(!sessionStartTime)return;const e=getSessionTimerElements();if(!e.timer||!e.timerText)return;const t=36e5-(Date.now()-sessionStartTime);e.timerText.textContent=formatTimeRemaining(t),e.timer.classList.remove("warning","urgent"),t<=3e5?(e.timer.classList.add("urgent"),e.timer.title="Session expiring soon! Download PDF now to save your work."):t<=6e5?(e.timer.classList.add("warning"),e.timer.title="Less than 10 minutes remaining. Consider saving your work."):e.timer.title="Demo session lasts 60 minutes. Changes are lost when session expires. Download PDF to save your work.",t<=6e5&&t>3e5&&!hasShown10MinWarning&&(hasShown10MinWarning=!0,showSessionWarning("Session expires in 10 minutes","Save your work! Download PDF or save a named version now.",!1)),t<=3e5&&t>0&&!hasShown5MinWarning&&(hasShown5MinWarning=!0,showSessionWarning("Session expires in 5 minutes!","Download your PDF or sign up to continue working.",!0)),t<=0&&(clearInterval(sessionTimerInterval),handleSessionExpired())}function showSessionWarning(e,t,n){if(!userHasInteracted)return void console.log("[Glyph] Suppressing session warning - user has not interacted yet");const a=getSessionTimerElements();a.warningToast&&(a.warningTitle.textContent=e,a.warningMessage.textContent=t,a.warningToast.classList.remove("urgent"),n&&a.warningToast.classList.add("urgent"),a.warningToast.style.display="flex",a.warningToast.removeAttribute("aria-hidden"),a.warningToast.classList.add("visible"),console.log(`[Glyph] Session warning: ${e}`))}function hideSessionWarning(){const e=getSessionTimerElements();e.warningToast&&(e.warningToast.classList.remove("visible"),setTimeout(()=>{e.warningToast.classList.contains("visible")||(e.warningToast.style.display="none",e.warningToast.setAttribute("aria-hidden","true"))},300))}function handleSessionExpired(){console.log("[Glyph] Session expired - initiating graceful reload");const e=getSessionTimerElements();if(e.warningToast){e.warningTitle.textContent="Session Expired",e.warningMessage.textContent="Starting fresh session...",e.warningToast.style.display="flex",e.warningToast.removeAttribute("aria-hidden"),e.warningToast.classList.add("visible","urgent");const t=e.warningToast.querySelector(".session-warning-toast__actions");t&&(t.style.display="none")}setTimeout(()=>{sessionId=null,sessionStartTime=null,currentHtml="",undoHistory=[],redoHistory=[],historyEntries=[],currentHistoryIndex=-1,hideSessionWarning(),loadPreview(),showToast("New session started","success")},2e3)}function initSessionTimerListeners(){const e=getSessionTimerElements();e.warningDismiss&&e.warningDismiss.addEventListener("click",hideSessionWarning),e.warningDownload&&e.warningDownload.addEventListener("click",()=>{hideSessionWarning();const e=document.getElementById("generate-btn");e&&e.click()})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initSessionTimerListeners):initSessionTimerListeners();let lastFailedPrompt=null,apiErrorToastTimeout=null,consecutiveFailures=0,lastErrorWasSessionError=!1,autoRetryCount=0,isAutoRetrying=!1;const MAX_AUTO_RETRIES=2,RETRY_DELAYS=[1e3,2e3];function getApiErrorElements(){return{toast:document.getElementById("api-error-toast"),message:document.getElementById("api-error-message"),retryBtn:document.getElementById("api-error-retry"),dismissBtn:document.getElementById("api-error-dismiss"),closeBtn:document.getElementById("api-error-close"),title:document.getElementById("api-error-title")}}function classifyError(e){const t=e.toLowerCase();return t.includes("network")||t.includes("fetch")||t.includes("failed to fetch")?"network":t.includes("timeout")||t.includes("took too long")?"timeout":t.includes("session")||t.includes("expired")||t.includes("dev_session_not_found")?"session":t.includes("rate")||t.includes("429")?"rate_limit":t.includes("500")||t.includes("502")||t.includes("503")?"server":t.includes("cannot delete")||t.includes("would remove content")||t.includes("destructive")?"guardrail_destructive":t.includes("cannot modify protected")||t.includes("protected field")||t.includes("protected region")?"guardrail_protected":t.includes("guardrail")||t.includes("blocked")||t.includes("refused")||t.includes("cannot")?"guardrail":t.includes("not possible")||t.includes("not feasible")||t.includes("pdfs are static")||t.includes("static document")?"impossible":"unknown"}function isRetryableError(e){return["network","timeout","server","session","unknown"].includes(e)}function showApiError(e,t,n){const a=getApiErrorElements();if(!a.toast)return;const o=classifyError(e);if(!n&&isRetryableError(o)&&autoRetryCount<2&&!isAutoRetrying){autoRetryCount++,isAutoRetrying=!0,lastFailedPrompt=t,"session"===o&&(lastErrorWasSessionError=!0);const e=RETRY_DELAYS[autoRetryCount-1],n=document.getElementById("api-error-retry-status");a.message.textContent="timeout"===o?"This modification is taking longer than usual.":"network"===o?"Connection issue detected.":"Something went wrong.",a.title&&(a.title.textContent="Retrying..."),n&&(n.style.display="block",n.textContent="Retrying... ("+autoRetryCount+"/2)"),a.retryBtn&&(a.retryBtn.disabled=!0);const i=document.getElementById("api-error-fallback");return i&&(i.style.display="none"),a.toast.style.display="flex",a.toast.removeAttribute("inert"),a.toast.classList.add("visible"),apiErrorToastTimeout&&clearTimeout(apiErrorToastTimeout),console.log("[Glyph] Auto-retrying ("+autoRetryCount+"/2) in "+e+"ms"),void setTimeout(async()=>{if(hideApiError(),isAutoRetrying=!1,a.retryBtn&&(a.retryBtn.disabled=!1),lastFailedPrompt){if(lastErrorWasSessionError){lastErrorWasSessionError=!1;try{setStatus("Refreshing session..."),await initializePreview(),await new Promise(e=>setTimeout(e,500))}catch(e){return console.error("[Glyph] Session refresh failed during auto-retry:",e),autoRetryCount=2,void showApiError("Session refresh failed. Please reload the page.",t,!0)}}applyModifications(lastFailedPrompt)}},e)}autoRetryCount=0,isAutoRetrying=!1,consecutiveFailures++,lastFailedPrompt=t,a.title&&(a.title.textContent=consecutiveFailures>=2?"Still Having Trouble":"Modification Failed");let i="";switch(o){case"network":i="Connection issue. Check your network and retry.";break;case"timeout":i=consecutiveFailures>=2?'Complex requests need more processing time. Try specific instructions like "Make the header blue" or "Add a border to the table".':"This modification is taking longer than usual. Try a simpler change, or retry.";break;case"session":i="Your session has expired. Refreshing...",lastErrorWasSessionError=!0,initializePreview().catch(()=>{});break;case"rate_limit":i="Too many requests. Please wait a moment and try again.";break;case"server":i="Server is busy. Click Retry in a moment.";break;case"guardrail_destructive":i="This request would remove content. Try styling changes like colors, fonts, or layout instead.";break;case"guardrail_protected":i="Some fields are protected. Try adding new elements or changing existing styles.";break;case"guardrail":i=e+" Try a different approach.";break;case"impossible":i=e;break;default:i=consecutiveFailures>=2?"The AI couldn't process this request. Try rephrasing your description.":"Something went wrong. Click Retry or try a different prompt."}a.message.textContent=i;const s=document.getElementById("api-error-retry-status");s&&(s.style.display="none"),a.retryBtn&&(a.retryBtn.textContent=consecutiveFailures>=2?"Try Again":"Retry",a.retryBtn.disabled=!1);const r=document.getElementById("api-error-fallback");if(r){const e=!isRetryableError(o)||consecutiveFailures>=2;r.style.display=e?"block":"none"}a.toast.style.display="flex",a.toast.removeAttribute("inert"),a.toast.classList.add("visible"),apiErrorToastTimeout&&clearTimeout(apiErrorToastTimeout),apiErrorToastTimeout=setTimeout(hideApiError,15e3),console.error("[Glyph] API Error shown to user:",e,"(type: "+o+", retries exhausted: "+(autoRetryCount>=2)+")")}function hideApiError(){const e=getApiErrorElements();e.toast&&(e.toast.classList.remove("visible"),setTimeout(()=>{e.toast.classList.contains("visible")||(e.toast.style.display="none",e.toast.setAttribute("inert",""))},300)),apiErrorToastTimeout&&(clearTimeout(apiErrorToastTimeout),apiErrorToastTimeout=null)}async function retryFailedModification(){if(autoRetryCount=0,hideApiError(),lastFailedPrompt){if(lastErrorWasSessionError){console.log("[Glyph] Session error detected, refreshing session before retry"),setStatus("Refreshing session..."),lastErrorWasSessionError=!1;try{await initializePreview(),await new Promise(e=>setTimeout(e,500))}catch(e){return console.error("[Glyph] Failed to refresh session:",e),void showToast("Unable to refresh session. Please reload the page.","error")}}applyModifications(lastFailedPrompt)}}function initApiErrorListeners(){const e=getApiErrorElements();e.retryBtn&&e.retryBtn.addEventListener("click",retryFailedModification),e.dismissBtn&&e.dismissBtn.addEventListener("click",hideApiError),e.closeBtn&&e.closeBtn.addEventListener("click",hideApiError);document.querySelectorAll(".api-error-toast__fallback-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-prompt");t&&(hideApiError(),consecutiveFailures=0,autoRetryCount=0,applyModifications(t))})})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initApiErrorListeners):initApiErrorListeners();const nav=document.getElementById("nav");window.addEventListener("scroll",()=>{window.scrollY>50?nav.classList.add("scrolled"):nav.classList.remove("scrolled")},{passive:!0});const typingText=document.getElementById("typing-text"),heroDemo=document.getElementById("hero-demo"),commands=[{text:"Add a diagonal DRAFT watermark",color:"#1E3A5F",effect:"watermark"},{text:"Group items by category with subtotals",color:"#0D9488",effect:"grouping"},{text:"Add a QR code for instant payment",color:"#1E3A5F",effect:"qrcode"},{text:"Add payment terms: Net 30",color:"#22C55E",effect:"terms"},{text:"Add a signature line with date",color:"#F97316",effect:"signature"}];let commandIndex=0,charIndex=0,isDeleting=!1;const effectElements={watermark:document.getElementById("demo-effect-watermark"),grouping:document.getElementById("demo-effect-grouping"),qrcode:[document.getElementById("demo-effect-qrcode"),document.getElementById("demo-effect-qrcode-label")],terms:document.getElementById("demo-effect-terms"),signature:document.getElementById("demo-effect-signature")};function clearAllEffects(){heroDemo.classList.remove("demo-preview--grouping"),heroDemo.style.setProperty("--demo-accent","#1E3A5F"),Object.values(effectElements).flat().forEach(e=>{e&&e.classList.remove("demo-effect--active")})}function activateEffect(e){if(clearAllEffects(),"grouping"===e)heroDemo.classList.add("demo-preview--grouping"),effectElements.grouping&&effectElements.grouping.classList.add("demo-effect--active");else if("qrcode"===e)effectElements.qrcode.forEach(e=>e.classList.add("demo-effect--active"));else if(effectElements[e]){const t=effectElements[e];Array.isArray(t)?t.forEach(e=>e.classList.add("demo-effect--active")):t.classList.add("demo-effect--active")}}function typeCommand(){const e=commands[commandIndex];if(isDeleting)typingText.textContent=e.text.substring(0,charIndex-1),charIndex--,0===charIndex&&(clearAllEffects(),isDeleting=!1,commandIndex=(commandIndex+1)%commands.length);else if(typingText.textContent=e.text.substring(0,charIndex+1),charIndex++,charIndex===e.text.length)return setTimeout(()=>{heroDemo.style.setProperty("--demo-accent",e.color),activateEffect(e.effect)},300),void setTimeout(()=>{isDeleting=!0,typeCommand()},2500);setTimeout(typeCommand,isDeleting?30:80)}setTimeout(typeCommand,1e3);const demoCommand=document.querySelector(".demo-command");demoCommand&&demoCommand.addEventListener("click",()=>{const e=commands[commandIndex].text,t={"Add a diagonal DRAFT watermark":"Add a subtle DRAFT watermark diagonally across the document","Group items by category with subtotals":"Group the line items by category and add subtotals for each category","Add a QR code for instant payment":"Add a QR code in the bottom right corner for easy mobile payment","Add payment terms: Net 30":"Add payment terms: Net 30 with 2% early payment discount if paid within 10 days","Add a signature line with date":"Add a thank you message and signature line at the bottom with the current date"}[e]||e,n=document.getElementById("playground");n&&(n.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{const e=document.getElementById("prompt-input");e&&(e.value=t,e.focus(),e.dispatchEvent(new Event("input",{bubbles:!0})),e.style.transition="box-shadow 0.3s ease",e.style.boxShadow="0 0 0 3px rgba(30, 58, 95, 0.3)",setTimeout(()=>{e.style.boxShadow=""},400),setTimeout(()=>{"function"!=typeof applyModifications||isProcessingModification||(console.log("[Glyph] Hero click: executing command -",t),applyModifications(t))},200))},600))});const codeTabs=document.querySelectorAll(".code-tab"),codeBlocks=document.querySelectorAll(".code-block");codeTabs.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.lang;codeTabs.forEach(e=>e.classList.remove("code-tab--active")),codeBlocks.forEach(e=>e.classList.remove("code-block--active")),e.classList.add("code-tab--active"),document.getElementById(`code-${t}`).classList.add("code-block--active")})});const playgroundTabs=document.querySelectorAll(".playground__tab"),promptInput=document.getElementById("prompt-input"),playgroundInputWrapper=document.getElementById("playground-input-wrapper"),suggestions=document.querySelectorAll(".playground__suggestion"),applyBtn=document.getElementById("apply-btn"),undoBtn=document.getElementById("undo-btn"),diffToggleBtn=document.getElementById("diff-toggle-btn"),generateBtn=document.getElementById("generate-btn"),previewFrame=document.getElementById("preview-frame"),previewContainer=document.getElementById("preview-container"),previewLoading=document.getElementById("preview-loading"),previewStatus=document.querySelector(".playground__preview-status"),zoomToggle=document.getElementById("zoom-toggle");zoomToggle&&zoomToggle.addEventListener("click",()=>{previewContainer.classList.toggle("zoomed-in")});const voiceBtn=document.getElementById("voice-input-btn");let speechRecognition=null,isListening=!1;function initSpeechRecognition(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e)return voiceBtn&&(voiceBtn.classList.add("unsupported"),voiceBtn.title="Voice input not supported in this browser"),console.log("[Glyph] Speech recognition not supported in this browser"),null;const t=new e;return t.continuous=!1,t.interimResults=!1,t.lang="en-US",t.maxAlternatives=1,t.onstart=()=>{isListening=!0,voiceBtn.classList.add("listening"),console.log("[Glyph] Voice input started")},t.onend=()=>{isListening=!1,voiceBtn.classList.remove("listening"),console.log("[Glyph] Voice input ended")},t.onresult=e=>{const t=e.results[0][0].transcript,n=e.results[0][0].confidence;console.log("[Glyph] Voice transcript:",t,"(confidence:",(100*n).toFixed(1)+"%)"),promptInput&&(promptInput.value=t,promptInput.focus(),promptInput.dispatchEvent(new Event("input",{bubbles:!0})))},t.onerror=e=>{console.log("[Glyph] Voice input error:",e.error),isListening=!1,voiceBtn.classList.remove("listening");let t="Voice input error";switch(e.error){case"no-speech":t="No speech detected. Try again.";break;case"audio-capture":t="Microphone not available";break;case"not-allowed":t="Microphone access denied";break;case"network":t="Network error. Check your connection."}showToast(t,"error")},t}function toggleVoiceInput(){if(speechRecognition||(speechRecognition=initSpeechRecognition(),speechRecognition))if(isListening)speechRecognition.stop();else try{speechRecognition.start()}catch(e){console.log("[Glyph] Could not start voice input:",e.message)}}if(voiceBtn){window.SpeechRecognition||window.webkitSpeechRecognition||voiceBtn.classList.add("unsupported"),voiceBtn.addEventListener("click",toggleVoiceInput)}let isProcessingModification=!1;function setSuggestionsDisabled(e){suggestions.forEach(t=>{t.disabled=e})}const DATA_FIELDS=[{category:"Client",name:"Client Name",path:"client.name",example:"John Smith",type:"string"},{category:"Client",name:"Company",path:"client.company",example:"TechStart Inc.",type:"string"},{category:"Client",name:"Email",path:"client.email",example:"john@techstart.io",type:"string"},{category:"Client",name:"Phone",path:"client.phone",example:"(555) 123-4567",type:"string"},{category:"Client",name:"Address",path:"client.address",example:"123 Main Street",type:"string"},{category:"Quote Info",name:"Quote Number",path:"meta.quoteNumber",example:"Q-2024-001",type:"string"},{category:"Quote Info",name:"Date",path:"meta.date",example:"January 15, 2024",type:"date"},{category:"Quote Info",name:"Valid Until",path:"meta.validUntil",example:"February 15, 2024",type:"date"},{category:"Quote Info",name:"Notes",path:"meta.notes",example:"Thank you!",type:"string"},{category:"Quote Info",name:"Terms",path:"meta.terms",example:"Net 30 days",type:"string"},{category:"Company",name:"Company Name",path:"branding.companyName",example:"Acme Corp",type:"string"},{category:"Company",name:"Logo URL",path:"branding.logoUrl",example:"https://...",type:"string"},{category:"Company",name:"Company Address",path:"branding.companyAddress",example:"456 Business Ave",type:"string"},{category:"Totals",name:"Subtotal",path:"totals.subtotal",example:"10,000.00",type:"number"},{category:"Totals",name:"Discount",path:"totals.discount",example:"500.00",type:"number"},{category:"Totals",name:"Tax",path:"totals.tax",example:"760.00",type:"number"},{category:"Totals",name:"Total",path:"totals.total",example:"10,260.00",type:"number"},{category:"Line Items",name:"Description",path:"lineItems[].description",example:"Service item",type:"string"},{category:"Styles",name:"Accent Color",path:"styles.accentColor",example:"#1E3A5F",type:"string"}],QUICK_ACTIONS=[{type:"action",category:"Quick Actions",icon:"qr",label:"Add QR code for payment",description:"Easy mobile payment scanning",value:"Add a QR code in the bottom right corner for easy mobile payment",score:95},{type:"action",category:"Quick Actions",icon:"image",label:"Add company logo",description:"Brand your document",value:"Add the company logo in the header, sized appropriately",score:94},{type:"action",category:"Quick Actions",icon:"sparkles",label:"Make design more professional",description:"Enhance overall appearance",value:"Make this design look more professional and polished with better typography and spacing",score:93},{type:"action",category:"Quick Actions",icon:"stamp",label:"Add DRAFT watermark",description:"Mark as work in progress",value:"Add a subtle DRAFT watermark diagonally across the document",score:85},{type:"action",category:"Quick Actions",icon:"pen",label:"Add signature line",description:"Space for client approval",value:"Add a signature line at the bottom with date field for client approval",score:84},{type:"action",category:"Quick Actions",icon:"layout",label:"Make layout compact",description:"Reduce whitespace",value:"Make the layout more compact, reducing unnecessary whitespace while keeping it readable",score:80}],MAKE_SUGGESTIONS=[{type:"action",category:"Make Changes",icon:"arrow-up",label:"make header bigger",description:"Increase header size",value:"Make the header section bigger and more prominent",score:90},{type:"action",category:"Make Changes",icon:"dollar",label:"make totals prominent",description:"Highlight totals section",value:"Make the totals section more prominent with larger text and better contrast",score:89},{type:"action",category:"Make Changes",icon:"compress",label:"make layout compact",description:"Reduce whitespace",value:"Make the layout more compact with tighter spacing",score:88},{type:"action",category:"Make Changes",icon:"text",label:"make text larger",description:"Increase font size",value:"Make all text slightly larger for better readability",score:87},{type:"action",category:"Make Changes",icon:"sparkles",label:"make it look modern",description:"Contemporary styling",value:"Make this look more modern with clean lines and contemporary styling",score:86},{type:"action",category:"Make Changes",icon:"moon",label:"make it dark mode",description:"Dark theme",value:"Make this a dark mode design with light text on dark background",score:85}],ADD_SUGGESTIONS=[{type:"action",category:"Add Elements",icon:"qr",label:"add QR code",description:"Payment QR code",value:"Add a QR code in the bottom right for mobile payment",score:95},{type:"action",category:"Add Elements",icon:"image",label:"add logo",description:"Company logo",value:"Add the company logo in the header",score:94},{type:"action",category:"Add Elements",icon:"stamp",label:"add watermark",description:"Background watermark",value:"Add a subtle watermark to the document",score:90},{type:"action",category:"Add Elements",icon:"file-text",label:"add terms",description:"Payment terms",value:"Add payment terms section at the bottom: Net 30 days",score:89},{type:"action",category:"Add Elements",icon:"heart",label:"add thank you note",description:"Appreciation message",value:"Add a thank you note at the bottom of the document",score:88},{type:"action",category:"Add Elements",icon:"percent",label:"add discount row",description:"Discount in totals",value:"Add a discount row to the totals section",score:87},{type:"action",category:"Add Elements",icon:"pen",label:"add signature line",description:"Approval signature",value:"Add a signature line for client approval",score:86}],CHANGE_SUGGESTIONS=[{type:"action",category:"Change Style",icon:"palette",label:"change colors",description:"Modify color scheme",value:"Change the accent color to a different shade",score:90},{type:"action",category:"Change Style",icon:"palette",label:"change to blue",description:"Blue color scheme",value:"Change the accent color to a professional blue (#2563eb)",score:89},{type:"action",category:"Change Style",icon:"palette",label:"change to purple",description:"Purple color scheme",value:"Change the accent color to a modern purple (#7c3aed)",score:88},{type:"action",category:"Change Style",icon:"type",label:"change font",description:"Different typography",value:"Change the font family to something more modern",score:86},{type:"action",category:"Change Style",icon:"layout",label:"change layout",description:"Different arrangement",value:"Change the overall layout to be more dynamic",score:85}],CATEGORY_ICONS={"Quick Actions":'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',Recent:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',Suggestions:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg>',"Data Fields":'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',"Add Elements":'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',"Make Changes":'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>',"Change Style":'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="6.5" cy="13.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>'},SUGGESTION_ICONS={qr:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/></svg>',image:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',sparkles:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3L14.5 8.5L20 9L15.5 13L17 19L12 16L7 19L8.5 13L4 9L9.5 8.5L12 3Z"/></svg>',stamp:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 22h14"/><path d="M19.27 13.73A2.5 2.5 0 0 0 17.5 13h-11A2.5 2.5 0 0 0 4 15.5V17a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-1.5c0-.66-.26-1.3-.73-1.77Z"/></svg>',pen:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>',layout:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg>',"arrow-up":'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>',dollar:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',compress:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/></svg>',text:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>',moon:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',"file-text":'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',heart:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',percent:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>',palette:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="6.5" cy="13.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>',type:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="12" y1="4" x2="12" y2="20"/></svg>',clock:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',lightbulb:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg>',field:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'},FUZZY_SHORTCUTS={ph:["phone","photo"],qr:["QR code","QR"],$:["total","subtotal","price","dollar"],em:["email"],disc:["discount"],sig:["signature"],wat:["watermark"],pro:["professional"]},RECENT_ACTIONS_KEY="glyph_recent_actions",MAX_RECENT_ACTIONS=5;function getRecentActions(){try{const e=safeGetItem(RECENT_ACTIONS_KEY);return e?JSON.parse(e):[]}catch(e){return[]}}function saveRecentAction(e,t){try{const n=getRecentActions().filter(e=>e.value!==t);n.unshift({label:e,value:t,timestamp:Date.now()}),safeSetItem(RECENT_ACTIONS_KEY,JSON.stringify(n.slice(0,5)))}catch(e){handleStorageFailure()}}function formatTimeAgo(e){const t=Math.floor((Date.now()-e)/1e3);return t<60?"just now":t<3600?`${Math.floor(t/60)} min ago`:t<86400?`${Math.floor(t/3600)} hr ago`:`${Math.floor(t/86400)} days ago`}function analyzeDocumentContext(){const e=currentHtml.toLowerCase();return{hasLogo:e.includes("logo")||e.includes("<img")&&e.includes("header"),hasQrCode:e.includes("qr")||e.includes("qrcode"),hasTerms:e.includes("terms")||e.includes("net 30")||e.includes("net 15"),hasDiscount:e.includes("discount"),hasSignature:e.includes("signature"),hasTax:e.includes("tax"),hasThankYouNote:e.includes("thank you")}}function fuzzyMatch(e,t){if(!e)return 50;const n=e.toLowerCase(),a=t.toLowerCase();return a===n?100:a.startsWith(n)?95:a.includes(n)?75:0}function applyFuzzyShortcuts(e){const t=e.toLowerCase(),n=[e];for(const[e,a]of Object.entries(FUZZY_SHORTCUTS))(t.startsWith(e)||t===e)&&n.push(...a);return n}let autocompleteVisible=!1,autocompleteSelectedIndex=0,allSuggestions=[],autocompleteDropdown=null;function createAutocompleteDropdown(){autocompleteDropdown=document.createElement("div"),autocompleteDropdown.className="playground-autocomplete",autocompleteDropdown.id="playground-autocomplete",autocompleteDropdown.style.display="none",playgroundInputWrapper.appendChild(autocompleteDropdown)}function getContextualSuggestions(){const e=analyzeDocumentContext(),t=[];return e.hasQrCode||t.push({type:"suggestion",category:"Suggestions",icon:"lightbulb",label:"Add QR code for payment",description:"Make it easy for clients to pay",value:"Add a QR code in the bottom right for easy mobile payment",score:92}),e.hasLogo||t.push({type:"suggestion",category:"Suggestions",icon:"lightbulb",label:"Add company logo",description:"Brand your document professionally",value:"Add the company logo in the header, sized appropriately",score:91}),e.hasTerms||t.push({type:"suggestion",category:"Suggestions",icon:"lightbulb",label:"Add payment terms - Net 30?",description:"Your invoice has no payment terms",value:"Add payment terms at the bottom: Net 30 days",score:88}),e.hasThankYouNote||t.push({type:"suggestion",category:"Suggestions",icon:"lightbulb",label:"Add a thank you note",description:"Personal touch builds relationships",value:'Add a thank you note at the bottom: "Thank you for your business!"',score:80}),t}function generateSuggestions(e){const t=e.trim().toLowerCase(),n=[],a=t.startsWith("make "),o=t.startsWith("add "),i=t.startsWith("change "),s=e.endsWith("{{");let r=t;if(a?r=t.slice(5):o?r=t.slice(4):i?r=t.slice(7):s&&(r=""),!t||t.length<3){getRecentActions().forEach((e,t)=>{n.push({type:"recent",category:"Recent",icon:"clock",label:e.label,description:formatTimeAgo(e.timestamp),value:e.value,score:100-t})})}t&&!o||n.push(...getContextualSuggestions());const l=(e,t)=>{if(!t)return e;const n=applyFuzzyShortcuts(t);return e.filter(e=>n.some(t=>{const n=fuzzyMatch(t,e.label),a=.7*fuzzyMatch(t,e.description);return Math.max(n,a)>30}))};a?n.push(...l(MAKE_SUGGESTIONS,r)):o?n.push(...l(ADD_SUGGESTIONS,r)):i&&n.push(...l(CHANGE_SUGGESTIONS,r)),a||i||s||n.push(...l(QUICK_ACTIONS,r));const d=DATA_FIELDS.map(e=>{const t=applyFuzzyShortcuts(r);let n=0;t.forEach(t=>{n=Math.max(n,fuzzyMatch(t,e.name),.9*fuzzyMatch(t,e.path))});const a=s?85:60;return{type:"field",category:"Data Fields",icon:"field",label:e.name,description:`{{${e.path}}}`,value:`{{${e.path}}}`,path:e.path,example:e.example,score:r?a*(n/100):a}}).filter(e=>!r||e.score>15);n.push(...d);const c=new Map;return n.forEach(e=>{const t=e.value.toLowerCase();(!c.has(t)||e.score>c.get(t).score)&&c.set(t,e)}),Array.from(c.values()).sort((e,t)=>t.score-e.score).slice(0,15)}function renderAutocomplete(){if(!autocompleteDropdown)return;const e={};allSuggestions.forEach(t=>{e[t.category]||(e[t.category]=[]),e[t.category].push(t)});let t="",n=0;["Recent","Suggestions","Quick Actions","Make Changes","Add Elements","Change Style","Data Fields"].forEach(a=>{const o=e[a];if(!o||0===o.length)return;t+=`<div class="autocomplete-category ${"Recent"===a?"autocomplete-category--recent":"Suggestions"===a?"autocomplete-category--suggestions":"Quick Actions"===a?"autocomplete-category--quick":"Data Fields"===a?"autocomplete-category--fields":""}">\n          <span class="autocomplete-category-icon">${CATEGORY_ICONS[a]||""}</span>\n          <span>${escapeHtml(a)}</span>\n        </div>`,o.forEach(e=>{const a=n===autocompleteSelectedIndex,o=SUGGESTION_ICONS[e.icon]||SUGGESTION_ICONS.field,i=`autocomplete-item--${e.type}`;t+=`<div class="autocomplete-item ${i} ${a?"selected":""}" data-index="${n}">\n            <div class="autocomplete-item-main">\n              <span class="autocomplete-item-icon">${o}</span>\n              <div class="autocomplete-item-content">\n                <span class="autocomplete-item-name">${escapeHtml(e.label)}</span>\n                <span class="autocomplete-item-description">${escapeHtml(e.description)}</span>\n              </div>\n            </div>\n            ${e.example?`<span class="autocomplete-item-example">${escapeHtml(e.example)}</span>`:""}\n          </div>`,n++})}),t+='<div class="autocomplete-hint">\n        <span><kbd></kbd> Navigate</span>\n        <span><kbd>Enter</kbd> Select</span>\n        <span><kbd>Esc</kbd> Close</span>\n      </div>',autocompleteDropdown.innerHTML=t,autocompleteDropdown.querySelectorAll(".autocomplete-item").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.getAttribute("data-index")||"0",10);selectAutocompleteSuggestion(allSuggestions[t])}),e.addEventListener("mouseenter",()=>{autocompleteSelectedIndex=parseInt(e.getAttribute("data-index")||"0",10),updateAutocompleteSelection()})})}function showAutocomplete(){allSuggestions=generateSuggestions(promptInput.value),0!==allSuggestions.length?(autocompleteSelectedIndex=0,renderAutocomplete(),autocompleteDropdown.style.display="block",autocompleteVisible=!0):hideAutocomplete()}function hideAutocomplete(){autocompleteDropdown&&(autocompleteDropdown.style.display="none"),autocompleteVisible=!1,autocompleteSelectedIndex=0}function updateAutocompleteSelection(){if(!autocompleteDropdown)return;autocompleteDropdown.querySelectorAll(".autocomplete-item").forEach((e,t)=>{e.classList.toggle("selected",t===autocompleteSelectedIndex)});const e=autocompleteDropdown.querySelector(".autocomplete-item.selected");e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}function selectAutocompleteSuggestion(e){if(!e)return;saveRecentAction(e.label,e.value);let t=e.value;if("field"===e.type&&e.path){const n=promptInput.value;if(n.endsWith("{{"))t=n.slice(0,-2)+`{{${e.path}}}`;else if(n.toLowerCase().startsWith("add ")){t={"client.email":"Add {{client.email}} below the client name","client.phone":"Add {{client.phone}} next to the client contact info","meta.notes":"Add {{meta.notes}} at the bottom of the document","meta.terms":"Add {{meta.terms}} in the footer section","branding.logoUrl":"Add the company logo {{branding.logoUrl}} in the header","totals.discount":"Add a discount row showing {{totals.discount}} in the totals section"}[e.path]||`Add {{${e.path}}} to the document`}else t=`Add {{${e.path}}} to the document`}promptInput.value=t,promptInput.focus(),promptInput.setSelectionRange(promptInput.value.length,promptInput.value.length),hideAutocomplete()}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function isInstantAction(e){const t=e.toLowerCase();return[/qr\s*code/i,/watermark/i,/payment\s*terms|net\s*\d+/i,/group.*category|group.*subtotal/i,/bold.*header|header.*bold/i,/add.*date|today.*date|date.*corner/i,/add.*border|border.*document/i,/thank\s*you.*note|thank.*note|add.*thank/i,/add.*signature|signature.*line/i].some(e=>e.test(t))}createAutocompleteDropdown(),promptInput.addEventListener("input",debounce(()=>{showAutocomplete()},300)),promptInput.addEventListener("focus",()=>{showAutocomplete()}),promptInput.addEventListener("blur",()=>{setTimeout(()=>hideAutocomplete(),150)}),promptInput.addEventListener("keydown",e=>{autocompleteVisible&&("ArrowDown"===e.key?(e.preventDefault(),autocompleteSelectedIndex=(autocompleteSelectedIndex+1)%allSuggestions.length,updateAutocompleteSelection()):"ArrowUp"===e.key?(e.preventDefault(),autocompleteSelectedIndex=(autocompleteSelectedIndex-1+allSuggestions.length)%allSuggestions.length,updateAutocompleteSelection()):"Enter"===e.key&&autocompleteVisible?(e.preventDefault(),selectAutocompleteSuggestion(allSuggestions[autocompleteSelectedIndex])):"Escape"===e.key?(e.preventDefault(),hideAutocomplete()):"Tab"===e.key&&autocompleteVisible&&(e.preventDefault(),selectAutocompleteSuggestion(allSuggestions[autocompleteSelectedIndex])))}),autocompleteDropdown&&autocompleteDropdown.addEventListener("mousedown",e=>{e.preventDefault()});const sampleQuoteData={branding:{companyName:"Acme Corporation",companyAddress:"123 Business Ave, Suite 100\nSan Francisco, CA 94102",logoUrl:""},meta:{quoteNumber:"Q-2024-0042",date:"January 18, 2026",validUntil:"February 17, 2026",notes:"Thank you for your business! Payment due within 30 days.",terms:"Terms: Net 30 days. All prices in USD."},client:{name:"John Smith",company:"TechStart Inc.",email:"john@techstart.io",address:"456 Startup Lane\nPalo Alto, CA 94301"},lineItems:[{description:"UI/UX Design",details:"Custom interface design and prototypes",quantity:1,unitPrice:3500,total:3500,category:"Design"},{description:"Brand Guidelines",details:"Logo usage, colors, typography specs",quantity:1,unitPrice:1500,total:1500,category:"Design"},{description:"Server Hardware",details:"Dell PowerEdge R750 with 64GB RAM",quantity:2,unitPrice:4200,total:8400,category:"Materials"},{description:"Network Equipment",details:"Cisco switches and cabling",quantity:1,unitPrice:2800,total:2800,category:"Materials"},{description:"Software Licenses",details:"Enterprise software bundle",quantity:5,unitPrice:450,total:2250,category:"Materials"},{description:"Installation",details:"On-site hardware setup and config",quantity:16,unitPrice:150,total:2400,category:"Labor"},{description:"Training",details:"Staff training sessions (4 hours each)",quantity:3,unitPrice:500,total:1500,category:"Labor"}],totals:{subtotal:22350,tax:0,discount:0,total:22350},styles:{accentColor:"#1E3A5F"}},sampleInvoiceData={branding:{companyName:"Acme Corporation",companyAddress:"123 Business Ave, Suite 100\nSan Francisco, CA 94102",logoUrl:"",logoInitial:"A"},invoice:{number:"INV-2026-0087",date:"January 27, 2026",dueDate:"February 26, 2026",notes:"Thank you for your prompt payment.",paymentTerms:"Payment due within 30 days. Late fees of 1.5% per month apply."},billTo:{name:"Sarah Chen",company:"Brightpath Analytics",email:"sarah@brightpath.io",address:"789 Data Drive, Austin, TX 73301"},lineItems:[{description:"Data Pipeline Setup",details:"ETL pipeline configuration and testing",quantity:1,rate:"4,500.00",amount:"4,500.00"},{description:"Dashboard Development",details:"Custom analytics dashboards (3 views)",quantity:3,rate:"2,000.00",amount:"6,000.00"},{description:"API Integration",details:"Third-party API connectors",quantity:2,rate:"1,500.00",amount:"3,000.00"}],totals:{subtotal:"13,500.00",tax:"1,080.00",total:"14,580.00"},styles:{accentColor:"#2563eb"}},sampleReceiptData={merchant:{name:"The Daily Grind",address:"456 Market St, San Francisco, CA 94102"},receipt:{number:"REC-2026-0193",date:"January 27, 2026",time:"10:32 AM"},items:[{name:"Monthly Subscription - Pro Plan",quantity:1,price:"49.00"},{name:"Additional Storage (50GB)",quantity:1,price:"10.00"}],totals:{subtotal:"59.00",tax:"4.72",total:"63.72"},payment:{method:"Credit Card ending in 4242"},styles:{accentColor:"#059669"}},sampleReportData={report:{title:"Q4 2025 Performance Review",subtitle:"Trends, Opportunities, and Strategic Recommendations",author:"Strategy Team",date:"January 27, 2026",organization:"Acme Corporation"},styles:{accentColor:"#7c3aed"}},sampleContractData={contract:{title:"Service Agreement",number:"CTR-2026-0042",effectiveDate:"March 1, 2026",term:"12 months",jurisdiction:"State of California"},parties:{party1:{name:"Acme Solutions Inc.",address:"100 Innovation Drive\nSan Francisco, CA 94105"},party2:{name:"Northwind Traders LLC",address:"250 Commerce Street\nPortland, OR 97201"}},sections:[{number:"1",title:"Scope of Services",content:"The Service Provider agrees to deliver software development consulting services as outlined in Exhibit A."},{number:"2",title:"Compensation",content:"The Client agrees to pay a monthly retainer of $15,000 USD, due on the first business day of each month."},{number:"3",title:"Confidentiality",content:"Both parties agree to maintain the confidentiality of all proprietary information shared during the term of this agreement."},{number:"4",title:"Termination",content:"Either party may terminate this agreement with thirty (30) days written notice."}],signatures:{showLines:!0},styles:{accentColor:"#1e40af"}},sampleCertificateData={certificate:{title:"Certificate of Achievement",recipientName:"Alexandra Chen",description:"In recognition of exceptional performance and dedication in the Advanced Software Engineering Program.",date:"January 27, 2026",issuer:"Dr. James Walker",issuerTitle:"Program Director",organization:"Meridian Institute of Technology"},styles:{accentColor:"#b45309"}},sampleLetterData={letter:{date:"January 27, 2026",senderName:"Michael Torres",senderTitle:"Vice President, Business Development",senderCompany:"Cascade Partners LLC",senderAddress:"800 Fifth Avenue, Suite 3200\nSeattle, WA 98104",recipientName:"Sarah Chen",recipientTitle:"Chief Technology Officer",recipientCompany:"Horizon Dynamics Inc.",recipientAddress:"1200 Market Street\nSan Francisco, CA 94103",subject:"Strategic Partnership Proposal - Q1 2026",salutation:"Dear Ms. Chen,",body:["I am writing to express our strong interest in establishing a strategic partnership between Cascade Partners and Horizon Dynamics.","Cascade Partners brings over fifteen years of expertise in cloud infrastructure optimization. Combined with your innovative approach to AI-driven analytics, we see a significant opportunity.","Please let me know if you are available for a meeting during the week of February 5th."],closing:"Sincerely,"},styles:{accentColor:"#374151"}},sampleProposalData={proposal:{title:"Website Redesign & Development",number:"PROP-2026-018",date:"January 27, 2026",validUntil:"February 26, 2026",description:"A comprehensive redesign and development of your company website to improve user experience, modernize the visual identity, and increase conversion rates."},client:{name:"James Mitchell",company:"Clearwater Analytics",address:"450 Market Street\nSuite 800\nSan Francisco, CA 94105",email:"james@clearwater.io"},deliverables:[{title:"Discovery & Research",description:"Stakeholder interviews, competitive analysis, user research, and requirements documentation."},{title:"UX Design",description:"Wireframes, user flows, and interactive prototypes for all key pages."},{title:"Visual Design",description:"High-fidelity mockups, design system, and component library."},{title:"Frontend Development",description:"Responsive implementation using Next.js with performance optimization."},{title:"QA & Launch",description:"Cross-browser testing, accessibility audit, and production deployment."}],timeline:[{phase:"Discovery & Research",duration:"2 weeks",details:"Kickoff, interviews, audit"},{phase:"UX & Visual Design",duration:"3 weeks",details:"Wireframes, prototypes, mockups"},{phase:"Development",duration:"4 weeks",details:"Build, integrate, iterate"},{phase:"QA & Launch",duration:"1 week",details:"Testing, fixes, deployment"}],pricing:{lineItems:[{description:"Discovery & Research",details:"Stakeholder interviews, competitive audit",amount:"3,500.00"},{description:"UX & Visual Design",details:"Wireframes, prototypes, design system",amount:"8,500.00"},{description:"Frontend Development",details:"Next.js implementation, CMS integration",amount:"12,000.00"},{description:"QA & Launch Support",details:"Testing, accessibility, deployment",amount:"2,000.00"}],subtotal:"26,000.00",total:"26,000.00"},terms:"Payment is due in three installments: 40% upon signing, 30% at design approval, and 30% upon project completion.",branding:{logoInitial:"A",companyName:"Apex Digital Studio",companyAddress:"220 Design Way\nAustin, TX 78701"},styles:{accentColor:"#2563eb"}},TEMPLATE_TYPE_CONFIG={quote:{variants:[{id:"quote-modern",label:"Modern"},{id:"quote-professional",label:"Professional"},{id:"quote-bold",label:"Bold"}],data:sampleQuoteData},invoice:{variants:[{id:"invoice-clean",label:"Clean"}],data:sampleInvoiceData},receipt:{variants:[{id:"receipt-minimal",label:"Minimal"}],data:sampleReceiptData},report:{variants:[{id:"report-cover",label:"Cover"}],data:sampleReportData},contract:{variants:[{id:"contract-simple",label:"Simple"}],data:sampleContractData},certificate:{variants:[{id:"certificate-modern",label:"Modern"}],data:sampleCertificateData},letter:{variants:[{id:"letter-business",label:"Business"}],data:sampleLetterData},proposal:{variants:[{id:"proposal-basic",label:"Basic"}],data:sampleProposalData}};function getCurrentSampleData(){for(const[e,t]of Object.entries(TEMPLATE_TYPE_CONFIG))if(t.variants.some(e=>e.id===currentTemplate))return t.data;return sampleQuoteData}let isInDemoMode=!1;function updateSkeletonStage(e){const t=document.querySelectorAll(".preview-init-loading__stage"),n=["connecting","loading","ready"],a=n.indexOf(e);t.forEach(e=>{const t=e.dataset.stage,o=n.indexOf(t);e.classList.remove("active","completed"),o<a?e.classList.add("completed"):o===a&&e.classList.add("active")})}function hideInitialLoadingSkeleton(){const e=document.getElementById("preview-init-loading");e&&(updateSkeletonStage("ready"),setTimeout(()=>{e.classList.add("hidden"),setTimeout(()=>{e.style.display="none"},400)},300))}function showInitialLoadingSkeleton(){const e=document.getElementById("preview-init-loading");e&&(e.style.display="flex",e.classList.remove("hidden"),updateSkeletonStage("connecting"))}function showDemoModeBanner(){const e=document.getElementById("demo-mode-banner");e&&(e.classList.add("visible"),isInDemoMode=!0)}function hideDemoModeBanner(){const e=document.getElementById("demo-mode-banner");e&&(e.classList.remove("visible"),isInDemoMode=!1)}function setupDemoModeBanner(){const e=document.getElementById("demo-mode-retry"),t=document.getElementById("demo-mode-dismiss");e&&e.addEventListener("click",async()=>{e.textContent="Retrying...",e.disabled=!0,hideDemoModeBanner(),await initializePreview(),e.textContent="Retry Connection",e.disabled=!1}),t&&t.addEventListener("click",()=>{hideDemoModeBanner()})}async function initializePreview(){showInitialLoadingSkeleton(),setStatus("Connecting..."),updateSkeletonStage("connecting");try{setTimeout(()=>updateSkeletonStage("loading"),400);const e=await fetch(`${API_URL}/v1/preview`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${DEMO_API_KEY}`},body:JSON.stringify({template:currentTemplate,data:getCurrentSampleData()})});if(!e.ok)throw new Error("Failed to load preview");const t=await e.json();if(currentHtml=t.html,sessionId=t.sessionId,setStatus("Loading preview..."),hideDemoModeBanner(),renderPreview(currentHtml),hideInitialLoadingSkeleton(),setStatus("Ready"),startSessionTimer(),window.innerWidth<=480){const e=document.getElementById("preview-container");e&&e.classList.add("zoomed-in")}}catch(e){if(console.warn("API not available, using static demo:",e),updateSkeletonStage("loading"),setStatus("Loading demo..."),renderStaticDemo(),hideInitialLoadingSkeleton(),setStatus("Demo Mode"),showDemoModeBanner(),startSessionTimer(),window.innerWidth<=480){const e=document.getElementById("preview-container");e&&e.classList.add("zoomed-in")}}}function showPreviewError(){const e=previewFrame.parentElement;if(!e)return;if(e.querySelector(".glyph-preview-error"))return;const t=document.createElement("div");t.className="glyph-preview-error",t.innerHTML='\n        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 2rem; text-align: center; background: #1a1a2e; color: #fff; border-radius: 8px;">\n          <svg width="48" height="48" fill="none" stroke="#ef4444" viewBox="0 0 24 24" style="margin-bottom: 1rem;">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>\n          </svg>\n          <p style="font-size: 1rem; margin-bottom: 0.5rem; font-weight: 500;">Preview unavailable</p>\n          <p style="font-size: 0.875rem; color: #9ca3af; margin-bottom: 1rem;">The preview couldn\'t load properly.</p>\n          <button onclick="location.reload()" style="padding: 0.5rem 1rem; background: #7c3aed; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">\n            Refresh Page\n          </button>\n        </div>\n      ',t.style.cssText="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10;",previewFrame.style.display="none",e.style.position="relative",e.appendChild(t)}function renderPreview(e,t={}){const{changes:n=[],previousHtml:a=null}=t;let o;try{if(o=previewFrame.contentDocument||previewFrame.contentWindow.document,!o)throw new Error("contentDocument is null")}catch(e){return console.error("[Glyph] Preview frame access denied:",e),void showPreviewError()}try{o.open(),o.write(e),o.close()}catch(e){return console.error("[Glyph] Preview frame write failed:",e),void showPreviewError()}(n.length>0||a)&&highlightChangedRegions(o,n,a,e)}function highlightChangedRegions(e,t,n,a){const o="glyph-change-highlight-styles";if(!e.getElementById(o)){const t=e.createElement("style");t.id=o,t.textContent="\n          .glyph-changed {\n            position: relative;\n            animation: glyphChangeHighlight 2.5s ease-out forwards;\n            border-radius: 4px;\n          }\n          .glyph-changed::before {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: linear-gradient(\n              90deg,\n              transparent,\n              rgba(124, 58, 237, 0.15),\n              transparent\n            );\n            background-size: 200% 100%;\n            animation: glyphChangeShimmer 1.5s ease-out;\n            pointer-events: none;\n            border-radius: inherit;\n          }\n          @keyframes glyphChangeHighlight {\n            0% {\n              box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.7), 0 0 20px rgba(124, 58, 237, 0.4);\n              background-color: rgba(124, 58, 237, 0.08);\n            }\n            50% {\n              box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.5), 0 0 30px rgba(124, 58, 237, 0.3);\n              background-color: rgba(124, 58, 237, 0.05);\n            }\n            100% {\n              box-shadow: 0 0 0 0px rgba(124, 58, 237, 0), 0 0 0px rgba(124, 58, 237, 0);\n              background-color: rgba(124, 58, 237, 0);\n            }\n          }\n          @keyframes glyphChangeShimmer {\n            0% { background-position: 200% 0; }\n            100% { background-position: -200% 0; }\n          }\n        ",e.head.appendChild(t)}const i=e.querySelectorAll("[data-glyph-region]");let s=0;const r=extractChangeKeywords(t);i.forEach(e=>{const t=e.getAttribute("data-glyph-region").toLowerCase();r.some(e=>t.includes(e)||e.includes(t))&&(applyHighlight(e),s++)}),0===s&&n&&(s=highlightByDiff(e,n,a)),0===s&&t.length>0&&highlightByKeywordSearch(e,r),console.log(`[Glyph] Highlighted ${s} changed regions`)}function extractChangeKeywords(e){const t=[],n=[/header/i,/footer/i,/title/i,/subtitle/i,/logo/i,/color/i,/background/i,/font/i,/text/i,/border/i,/button/i,/link/i,/image/i,/icon/i,/table/i,/price/i,/total/i,/item/i,/product/i,/service/i,/company/i,/contact/i,/address/i,/phone/i,/email/i,/date/i,/number/i,/signature/i,/qr/i,/code/i,/payment/i,/terms/i,/notes/i,/description/i];return e.forEach(e=>{const a=e.toLowerCase();n.forEach(e=>{const n=a.match(e);n&&t.push(n[0].toLowerCase())});(a.match(/\b[a-z]{4,}\b/gi)||[]).forEach(e=>{["added","updated","changed","modified","removed","style","styling"].includes(e.toLowerCase())||t.push(e.toLowerCase())})}),[...new Set(t)]}function applyHighlight(e){e.classList.add("glyph-changed"),setTimeout(()=>{e.classList.remove("glyph-changed")},2500)}function highlightByKeywordSearch(e,t){if(0===t.length)return;e.querySelectorAll(["h1","h2","h3","h4","h5","h6","header","footer","section","article",".header",".footer",".title",".subtitle",'[class*="header"]','[class*="title"]','[class*="footer"]','[class*="logo"]','[class*="price"]','[class*="total"]'].join(", ")).forEach(e=>{const n=(e.className||"").toLowerCase(),a=(e.id||"").toLowerCase(),o=(e.textContent||"").toLowerCase().substring(0,100);t.some(e=>n.includes(e)||a.includes(e)||o.includes(e))&&applyHighlight(e)})}function highlightByDiff(e,t,n){let a=0;const o=document.createElement("div"),i=document.createElement("div");o.innerHTML=t,i.innerHTML=n;e.querySelectorAll("[data-glyph-region]").forEach(e=>{const t=e.getAttribute("data-glyph-region"),n=o.querySelector(`[data-glyph-region="${t}"]`);n&&n.innerHTML===e.innerHTML||(applyHighlight(e),a++)});return e.querySelectorAll("h1, h2, h3, .header, .title, table, .total").forEach(e=>{const t=o.querySelectorAll(e.tagName);let n=!1;t.forEach(t=>{t.outerHTML===e.outerHTML&&(n=!0)}),n||e.classList.contains("glyph-changed")||(applyHighlight(e),a++)}),a}function saveToUndoHistory(){currentHtml&&(undoHistory.push(currentHtml),redoHistory=[],undoHistory.length>10&&undoHistory.shift(),updateUndoButtonState())}function performUndo(){if(0===undoHistory.length)return;const e=undoHistory.pop();currentHtml=e,renderPreview(currentHtml),refreshAppliedActionsFromHtml(currentHtml),previewContainer.classList.add("success"),setTimeout(()=>previewContainer.classList.remove("success"),500),flashPreviewArea(),setStatus("Undone"),console.log("[Glyph] Undo performed, history length:",undoHistory.length),setTimeout(()=>setStatus("Ready"),1500),updateUndoButtonState(),clearDiffState()}function updateUndoButtonState(){undoBtn&&(undoBtn.disabled=0===undoHistory.length,undoBtn.title=undoHistory.length>0?`Undo last change (${undoHistory.length} available)`:"No changes to undo"),updateShareAndSaveButtonState()}function updateShareAndSaveButtonState(){const e=undoHistory.length>0,t=document.getElementById("share-btn"),n=document.getElementById("save-version-btn");t&&(t.disabled=!e,t.title="Share this customization",t.dataset.tooltip=e?"":"Make a change to share"),n&&(n.disabled=!e,n.title="Save named version",n.dataset.tooltip=e?"":"Make a change to save a version")}function clearUndoHistory(){undoHistory=[],updateUndoButtonState(),clearAllAppliedActions(),clearDiffState()}function snapshotRegions(e){const t=document.createElement("div");t.innerHTML=e;const n=new Map;return t.querySelectorAll("[data-glyph-region]").forEach(e=>{n.set(e.getAttribute("data-glyph-region"),e.innerHTML)}),n}function captureDiffBefore(){currentHtml&&(diffRegionSnapshots={before:snapshotRegions(currentHtml),after:null},isDiffActive&&toggleDiffView(!1))}function captureDiffAfter(){diffRegionSnapshots&&currentHtml&&(diffRegionSnapshots.after=snapshotRegions(currentHtml),updateDiffButtonState())}function getChangedRegionNames(){if(!diffRegionSnapshots||!diffRegionSnapshots.before||!diffRegionSnapshots.after)return[];const e=[],t=diffRegionSnapshots.after,n=diffRegionSnapshots.before;return t.forEach((t,a)=>{const o=n.get(a);void 0!==o&&o===t||e.push(a)}),n.forEach((n,a)=>{t.has(a)||e.push(a)}),e}function toggleDiffView(e){isDiffActive=void 0!==e?e:!isDiffActive,diffToggleBtn&&diffToggleBtn.classList.toggle("active",isDiffActive);const t=previewFrame;if(!t||!t.contentDocument)return;const n=t.contentDocument,a="glyph-diff-toggle-styles";if(!isDiffActive){const e=n.getElementById(a);return e&&e.remove(),void n.querySelectorAll(".glyph-diff-changed").forEach(e=>{e.classList.remove("glyph-diff-changed")})}if(!n.getElementById(a)){const e=n.createElement("style");e.id=a,e.textContent="\n          .glyph-diff-changed {\n            outline: 2px solid rgba(34, 197, 94, 0.6);\n            outline-offset: 2px;\n            background-color: rgba(34, 197, 94, 0.06);\n            border-radius: 3px;\n            transition: outline-color 0.2s, background-color 0.2s;\n          }\n        ",n.head.appendChild(e)}const o=getChangedRegionNames();o.forEach(e=>{const t=n.querySelector(`[data-glyph-region="${e}"]`);t&&t.classList.add("glyph-diff-changed")}),console.log(`[Glyph] Diff view: ${o.length} changed regions highlighted`)}function updateDiffButtonState(){if(!diffToggleBtn)return;const e=getChangedRegionNames().length>0;diffToggleBtn.disabled=!e,diffToggleBtn.title=e?`Show changes (${getChangedRegionNames().length} regions changed)`:"No changes to show"}function clearDiffState(){diffRegionSnapshots=null,isDiffActive=!1,diffToggleBtn&&(diffToggleBtn.classList.remove("active"),diffToggleBtn.disabled=!0,diffToggleBtn.title="No changes to show")}diffToggleBtn&&diffToggleBtn.addEventListener("click",()=>{diffToggleBtn.disabled||toggleDiffView()});const shortcutsBar=document.getElementById("shortcuts-bar"),shortcutsDismiss=document.getElementById("shortcuts-dismiss"),SHORTCUTS_DISMISSED_KEY="glyph_shortcuts_dismissed",isMac=navigator.platform.toUpperCase().indexOf("MAC")>=0,modKey=isMac?"":"Ctrl";function initShortcutLabels(){document.querySelectorAll("#shortcut-mod, #shortcut-mod-2, #shortcut-mod-3").forEach(e=>{e&&(e.textContent=modKey)})}function initShortcutsBar(){shortcutsBar&&shortcutsBar.classList.add("hidden"),initShortcutLabels();const e=document.getElementById("prompt-input");e&&shortcutsBar&&(e.addEventListener("focus",()=>{"true"!==safeGetItem(SHORTCUTS_DISMISSED_KEY)&&window.innerWidth>=768&&shortcutsBar.classList.remove("hidden")}),e.addEventListener("blur",()=>{setTimeout(()=>{shortcutsBar&&shortcutsBar.classList.add("hidden")},200)}))}function performRedo(){if(0===redoHistory.length)return;currentHtml&&(undoHistory.push(currentHtml),undoHistory.length>10&&undoHistory.shift());const e=redoHistory.pop();currentHtml=e,renderPreview(currentHtml),refreshAppliedActionsFromHtml(currentHtml),currentHistoryIndex<historyEntries.length-1&&(currentHistoryIndex++,updateHistoryCount(),renderHistoryPanel()),setStatus("Redone"),console.log("[Glyph] Redo performed, history length:",redoHistory.length),setTimeout(()=>setStatus("Ready"),1500),updateUndoButtonState()}shortcutsDismiss&&shortcutsDismiss.addEventListener("click",()=>{shortcutsBar.classList.add("hidden"),safeSetItem(SHORTCUTS_DISMISSED_KEY,"true")});const originalPerformUndo=performUndo;performUndo=function(){if(0===undoHistory.length)return;currentHtml&&(redoHistory.push(currentHtml),redoHistory.length>20&&redoHistory.shift());const e=undoHistory.pop();currentHtml=e,renderPreview(currentHtml),refreshAppliedActionsFromHtml(currentHtml),currentHistoryIndex>0&&(currentHistoryIndex--,updateHistoryCount(),renderHistoryPanel()),setStatus("Undone"),console.log("[Glyph] Undo performed, history length:",undoHistory.length),setTimeout(()=>setStatus("Ready"),1500),updateUndoButtonState(),clearDiffState()},document.addEventListener("keydown",e=>{const t=isMac?e.metaKey:e.ctrlKey;if(t&&"z"===e.key&&!e.shiftKey&&(e.preventDefault(),performUndo()),t&&"z"===e.key&&e.shiftKey&&(e.preventDefault(),performRedo()),t&&"Enter"===e.key){e.preventDefault();const t=document.getElementById("prompt-input");t&&t.value.trim()&&applyModifications(t.value.trim())}if("Escape"===e.key){const e=document.getElementById("prompt-input");e&&(e.value="",e.blur())}}),initShortcutsBar();const commandPaletteOverlay=document.getElementById("command-palette-overlay"),commandPaletteInput=document.getElementById("command-palette-input"),commandPaletteResults=document.getElementById("command-palette-results"),cmdKHint=document.getElementById("cmd-k-hint"),cmdKLabel=document.getElementById("cmd-k-label");cmdKLabel&&(cmdKLabel.textContent=isMac?"K":"Ctrl+K");let selectedCommandIndex=0,filteredPaletteCommands=[];const paletteCommands=[{name:"Add Watermark",action:()=>applyInstantCommand("Add a diagonal watermark that says DRAFT across the page"),category:"Quick Actions",icon:"watermark"},{name:"Add QR Code",action:()=>applyInstantCommand("Add a QR code in the corner for quick mobile payment"),category:"Quick Actions",icon:"qr"},{name:"Add Payment Terms",action:()=>applyInstantCommand("Add payment terms: Net 30 with 2% early payment discount if paid within 10 days"),category:"Quick Actions",icon:"terms"},{name:"Add Date",action:()=>applyInstantCommand("Add today's date in the top right corner"),category:"Quick Actions",icon:"date"},{name:"Add Border",action:()=>applyInstantCommand("Add a professional border around the document"),category:"Quick Actions",icon:"border"},{name:"Add Thank You Note",action:()=>applyInstantCommand("Add a thank you note at the bottom"),category:"Quick Actions",icon:"note"},{name:"Add Signature",action:()=>applyInstantCommand("Add a signature"),category:"Quick Actions",icon:"signature"},{name:"Switch to Modern Quote",action:()=>switchToTemplate("quote-modern"),category:"Templates",icon:"template"},{name:"Switch to Professional Quote",action:()=>switchToTemplate("quote-professional"),category:"Templates",icon:"template"},{name:"Switch to Bold Quote",action:()=>switchToTemplate("quote-bold"),category:"Templates",icon:"template"},{name:"Switch to Invoice",action:()=>switchToTemplateType("invoice"),category:"Templates",icon:"template"},{name:"Switch to Receipt",action:()=>switchToTemplateType("receipt"),category:"Templates",icon:"template"},{name:"Switch to Report Cover",action:()=>switchToTemplateType("report"),category:"Templates",icon:"template"},{name:"Switch to Contract",action:()=>switchToTemplateType("contract"),category:"Templates",icon:"template"},{name:"Switch to Certificate",action:()=>switchToTemplateType("certificate"),category:"Templates",icon:"template"},{name:"Switch to Letter",action:()=>switchToTemplateType("letter"),category:"Templates",icon:"template"},{name:"Switch to Proposal",action:()=>switchToTemplateType("proposal"),category:"Templates",icon:"template"},{name:"Undo",action:()=>performUndo(),category:"Edit",shortcut:isMac?"Z":"Ctrl+Z",icon:"undo"},{name:"Redo",action:()=>performRedo(),category:"Edit",shortcut:isMac?"Z":"Ctrl+Shift+Z",icon:"redo"},{name:"Download PDF",action:()=>triggerPdfDownload(),category:"Export",icon:"download"},{name:"Get API Code",action:()=>openCopyCodeModal(),category:"Developer",icon:"code"},{name:"View History",action:()=>toggleHistoryPanel(),category:"View",icon:"history"},{name:"Go to Dashboard",action:()=>window.open("https://dashboard.glyph.you","_blank"),category:"Navigation",icon:"external"},{name:"Go to Docs",action:()=>window.open("https://docs.glyph.you","_blank"),category:"Navigation",icon:"external"}];function applyInstantCommand(e){const t=document.getElementById("prompt-input");t&&(t.value=e,applyModifications(e))}function switchToTemplate(e){for(const[t,n]of Object.entries(TEMPLATE_TYPE_CONFIG))if(n.variants.some(t=>t.id===e)){const n=document.getElementById("template-type-select-playground");if(n&&n.value!==t)return n.value=t,n.dispatchEvent(new Event("change")),void setTimeout(()=>{const t=document.querySelector(`.playground__tab[data-template="${e}"]`);t&&!t.classList.contains("playground__tab--active")&&t.click()},500);break}const t=document.querySelector(`.playground__tab[data-template="${e}"]`);t&&!t.classList.contains("playground__tab--active")&&t.click()}function switchToTemplateType(e){const t=document.getElementById("template-type-select-playground");t&&t.value!==e&&(t.value=e,t.dispatchEvent(new Event("change")))}function triggerPdfDownload(){const e=document.getElementById("generate-btn");e&&!e.disabled&&e.click()}function getCommandIcon(e){const t={watermark:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>',qr:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>',terms:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>',date:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>',border:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v14a1 1 0 01-1 1H5a1 1 0 01-1-1V5z"/>',note:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>',signature:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>',template:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>',undo:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>',redo:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/>',download:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>',code:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>',history:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>',external:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>'};return t[e]||t.note}function filterPaletteCommands(e){if(!e)return[...paletteCommands];const t=e.toLowerCase();return paletteCommands.filter(e=>e.name.toLowerCase().includes(t)||e.category.toLowerCase().includes(t))}function renderCommandResults(){if(!commandPaletteResults)return;if(0===filteredPaletteCommands.length)return void(commandPaletteResults.innerHTML='<div class="command-palette__empty">No matching commands</div>');const e={};filteredPaletteCommands.forEach(t=>{e[t.category]||(e[t.category]=[]),e[t.category].push(t)});let t="";Object.entries(e).forEach(([e,n])=>{t+=`<div class="command-palette__category">${e}</div>`,n.forEach((e,n)=>{const a=filteredPaletteCommands.indexOf(e);t+=`\n            <div class="command-palette__item${a===selectedCommandIndex?" command-palette__item--selected":""}" data-index="${a}">\n              <svg class="command-palette__item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                ${getCommandIcon(e.icon)}\n              </svg>\n              <span class="command-palette__item-name">${e.name}</span>\n              ${e.shortcut?`<span class="command-palette__item-shortcut">${e.shortcut}</span>`:""}\n            </div>\n          `})}),commandPaletteResults.innerHTML=t,commandPaletteResults.querySelectorAll(".command-palette__item").forEach(e=>{e.addEventListener("click",()=>{executeCommand(parseInt(e.dataset.index,10))}),e.addEventListener("mouseenter",()=>{selectedCommandIndex=parseInt(e.dataset.index,10),updateSelectedItem()})})}function updateSelectedItem(){commandPaletteResults.querySelectorAll(".command-palette__item").forEach((e,t)=>{const n=parseInt(e.dataset.index,10);e.classList.toggle("command-palette__item--selected",n===selectedCommandIndex)});const e=commandPaletteResults.querySelector(".command-palette__item--selected");e&&e.scrollIntoView({block:"nearest"})}function executeCommand(e){const t=filteredPaletteCommands[e];t&&(closeCommandPalette(),setTimeout(()=>t.action(),50))}function openCommandPalette(){commandPaletteOverlay&&(commandPaletteOverlay.classList.add("visible"),document.body.style.overflow="hidden",selectedCommandIndex=0,filteredPaletteCommands=filterPaletteCommands(""),commandPaletteInput&&(commandPaletteInput.value="",commandPaletteInput.focus()),renderCommandResults())}function closeCommandPalette(){commandPaletteOverlay&&(commandPaletteOverlay.classList.remove("visible"),document.body.style.overflow="")}commandPaletteInput&&(commandPaletteInput.addEventListener("input",e=>{const t=e.target.value;filteredPaletteCommands=filterPaletteCommands(t),selectedCommandIndex=0,renderCommandResults()}),commandPaletteInput.addEventListener("keydown",e=>{"ArrowDown"===e.key?(e.preventDefault(),selectedCommandIndex=Math.min(selectedCommandIndex+1,filteredPaletteCommands.length-1),updateSelectedItem()):"ArrowUp"===e.key?(e.preventDefault(),selectedCommandIndex=Math.max(selectedCommandIndex-1,0),updateSelectedItem()):"Enter"===e.key?(e.preventDefault(),executeCommand(selectedCommandIndex)):"Escape"===e.key&&(e.preventDefault(),closeCommandPalette())})),commandPaletteOverlay&&commandPaletteOverlay.addEventListener("click",e=>{e.target===commandPaletteOverlay&&closeCommandPalette()}),cmdKHint&&cmdKHint.addEventListener("click",openCommandPalette),document.addEventListener("keydown",e=>{(isMac?e.metaKey:e.ctrlKey)&&"k"===e.key&&(e.preventDefault(),commandPaletteOverlay?.classList.contains("visible")?closeCommandPalette():openCommandPalette()),"Escape"===e.key&&commandPaletteOverlay?.classList.contains("visible")&&(e.preventDefault(),e.stopPropagation(),closeCommandPalette())});const shortcutsOverlay=document.getElementById("shortcuts-overlay"),shortcutsClose=shortcutsOverlay?.querySelector(".shortcuts-close");function showShortcuts(){shortcutsOverlay?.classList.remove("hidden"),document.body.style.overflow="hidden"}function hideShortcuts(){shortcutsOverlay?.classList.add("hidden"),document.body.style.overflow=""}let historyToggleBtn,historyPanel,historyPanelClose,historyPanelContent,historyCountEl;function getHistoryElements(){historyToggleBtn||(historyToggleBtn=document.getElementById("history-toggle-btn"),historyPanel=document.getElementById("history-panel"),historyPanelClose=document.getElementById("history-panel-close"),historyPanelContent=document.getElementById("history-panel-content"),historyCountEl=document.getElementById("history-count"))}document.querySelectorAll(".shortcuts-overlay .mod-key").forEach(e=>{e.textContent=isMac?"":"Ctrl"}),document.addEventListener("keydown",e=>{"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(commandPaletteOverlay?.classList.contains("visible")||("?"===e.key&&(e.preventDefault(),shortcutsOverlay?.classList.contains("hidden")?showShortcuts():hideShortcuts()),"Escape"!==e.key||shortcutsOverlay?.classList.contains("hidden")||(e.preventDefault(),hideShortcuts())))}),shortcutsClose?.addEventListener("click",hideShortcuts),shortcutsOverlay?.addEventListener("click",e=>{e.target===shortcutsOverlay&&hideShortcuts()});let historyEntries=[],currentHistoryIndex=-1;const MAX_HISTORY_ENTRIES=50;function addHistoryEntry(e,t){const n={id:Date.now(),timestamp:new Date,prompt:e||"Initial state",html:t};currentHistoryIndex<historyEntries.length-1&&(historyEntries=historyEntries.slice(0,currentHistoryIndex+1)),historyEntries.push(n),currentHistoryIndex=historyEntries.length-1,historyEntries.length>50&&(historyEntries.shift(),currentHistoryIndex--),updateHistoryCount(),renderHistoryPanel()}function updateHistoryCount(){getHistoryElements(),historyCountEl&&(historyCountEl.textContent=historyEntries.length)}function formatHistoryTime(e){const t=new Date-e,n=Math.floor(t/1e3),a=Math.floor(n/60),o=Math.floor(a/60);return n<60?"Just now":a<60?`${a}m ago`:o<24?`${o}h ago`:e.toLocaleDateString()}function renderHistoryPanel(){if(getHistoryElements(),!historyPanelContent)return;if(0===historyEntries.length)return void(historyPanelContent.innerHTML='\n          <div class="history-panel__empty">\n            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>\n            </svg>\n            <div class="history-panel__empty-title">No changes yet</div>\n            <div class="history-panel__empty-text">Apply some changes to see your edit history here</div>\n          </div>\n        ');const e=historyEntries.slice().reverse().map((e,t)=>{const n=historyEntries.length-1-t,a=n===currentHistoryIndex;return`\n            <div class="history-entry${a?" history-entry--current":""}" data-index="${n}">\n              <div class="history-entry__time">${formatHistoryTime(new Date(e.timestamp))}</div>\n              <div class="history-entry__prompt">${escapeHtml(e.prompt)}</div>\n              ${a?"":'<button class="history-entry__restore">Restore</button>'}\n            </div>\n          `}).join("");historyPanelContent.innerHTML=`<div class="history-timeline">${e}</div>`,historyPanelContent.querySelectorAll(".history-entry").forEach(e=>{e.addEventListener("click",t=>{if(t.target.classList.contains("history-entry__restore")||!e.classList.contains("history-entry--current")){restoreHistoryEntry(parseInt(e.dataset.index,10))}})})}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function restoreHistoryEntry(e){if(e<0||e>=historyEntries.length)return;const t=historyEntries[e];currentHistoryIndex=e,currentHtml=t.html,renderPreview(currentHtml),renderHistoryPanel(),showToast(`Restored to "${t.prompt.substring(0,30)}${t.prompt.length>30?"...":""}"`)}function toggleHistoryPanel(){getHistoryElements(),historyPanel&&(historyPanel.classList.toggle("open"),historyToggleBtn?.classList.toggle("active",historyPanel.classList.contains("open")))}function closeHistoryPanel(){historyPanel&&(historyPanel.classList.remove("open"),historyToggleBtn?.classList.remove("active"))}function initHistoryPanelListeners(){getHistoryElements(),historyToggleBtn&&historyToggleBtn.addEventListener("click",toggleHistoryPanel),historyPanelClose&&historyPanelClose.addEventListener("click",closeHistoryPanel),document.addEventListener("click",e=>{getHistoryElements(),!historyPanel?.classList.contains("open")||historyPanel.contains(e.target)||historyToggleBtn?.contains(e.target)||closeHistoryPanel()})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initHistoryPanelListeners):initHistoryPanelListeners();const SAVED_VERSIONS_KEY="glyph_saved_versions",MAX_SAVED_VERSIONS=10;let _saveVersionElements=null;function getSaveVersionElements(){return _saveVersionElements||(_saveVersionElements={saveVersionBtn:document.getElementById("save-version-btn"),saveVersionModal:document.getElementById("save-version-modal"),versionNameInput:document.getElementById("version-name-input"),saveVersionConfirm:document.getElementById("save-version-confirm"),saveVersionCancel:document.getElementById("save-version-cancel"),savedVersionsList:document.getElementById("saved-versions-list"),savedVersionsCount:document.getElementById("saved-versions-count"),deleteConfirmModal:document.getElementById("delete-confirm-modal"),deleteVersionName:document.getElementById("delete-version-name"),deleteConfirm:document.getElementById("delete-confirm"),deleteCancel:document.getElementById("delete-cancel"),glyphToast:document.getElementById("glyph-toast"),toastMessage:document.getElementById("toast-message")}),_saveVersionElements}let savedVersions=[],versionToDelete=null;function loadSavedVersions(){try{const e=safeGetItem(SAVED_VERSIONS_KEY);savedVersions=e?JSON.parse(e):[],renderSavedVersions()}catch(e){console.error("[Glyph] Error loading saved versions:",e),savedVersions=[]}}function persistSavedVersions(){safeSetItem(SAVED_VERSIONS_KEY,JSON.stringify(savedVersions))||handleStorageFailure()}function showToast(e,t="success",n=3e3){const a=getSaveVersionElements();if(!a.glyphToast||!a.toastMessage)return;a.toastMessage.textContent=e,a.glyphToast.className="glyph-toast glyph-toast--"+t;const o=a.glyphToast.querySelector(".glyph-toast__icon path");o&&("success"===t?o.setAttribute("d","M5 13l4 4L19 7"):"error"===t?o.setAttribute("d","M6 18L18 6M6 6l12 12"):"info"===t?o.setAttribute("d","M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"):"warning"===t&&o.setAttribute("d","M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z")),a.glyphToast.style.display="flex",a.glyphToast.removeAttribute("aria-hidden"),a.glyphToast.classList.add("active"),setTimeout(()=>{a.glyphToast.classList.remove("active"),setTimeout(()=>{a.glyphToast.classList.contains("active")||(a.glyphToast.style.display="none",a.glyphToast.setAttribute("aria-hidden","true"))},300)},n)}function showSuccessCta(){if(hasShownSuccessCta)return;hasShownSuccessCta=!0;const e=document.getElementById("success-cta");e&&setTimeout(()=>{e.classList.add("visible")},1e3)}const FIRST_WIN_KEY="glyph_first_win";function isFirstWin(){try{return!localStorage.getItem(FIRST_WIN_KEY)}catch(e){return!1}}function markFirstWinComplete(){try{localStorage.setItem(FIRST_WIN_KEY,"true")}catch(e){}}function celebrateFirstInstantWin(){if(hasShownFirstInstantWin)return;hasShownFirstInstantWin=!0;const e=document.querySelector(".playground__preview-area");e&&(e.classList.add("first-win-glow"),setTimeout(()=>{e.classList.remove("first-win-glow")},800)),showModificationSuccessToast(0,!0),updateResponseTimeBadge(0,!0),promptSaveAfterFirstWin()}function flashPreviewArea(){const e=document.querySelector(".playground__preview-area");e&&(e.classList.remove("content-updated"),e.offsetWidth,e.classList.add("content-updated"),setTimeout(()=>{e.classList.remove("content-updated")},500))}function highlightQuickActions(){document.querySelectorAll(".playground__suggestion--hero:not(.playground__suggestion--applied)").forEach((e,t)=>{setTimeout(()=>{e.classList.add("playground__suggestion--highlight"),setTimeout(()=>{e.classList.remove("playground__suggestion--highlight")},600)},100*t)});const e=document.querySelector(".playground__suggestions");e&&window.innerWidth<=480&&e.scrollIntoView({behavior:"smooth",block:"nearest"})}function markActionApplied(e){document.querySelectorAll(".playground__suggestion").forEach(t=>{t.dataset.prompt===e&&(t.classList.add("playground__suggestion--applied"),appliedActions.add(e))})}function clearActionApplied(e){document.querySelectorAll(".playground__suggestion").forEach(t=>{t.dataset.prompt===e&&(t.classList.remove("playground__suggestion--applied"),appliedActions.delete(e))})}function clearAllAppliedActions(){document.querySelectorAll(".playground__suggestion").forEach(e=>{e.classList.remove("playground__suggestion--applied")}),appliedActions.clear()}function refreshAppliedActionsFromHtml(e){const t=document.querySelectorAll(".playground__suggestion");console.log("[Glyph] Refreshing applied action states from HTML"),t.forEach(t=>{const n=t.dataset.prompt,a=n.toLowerCase();let o=!1;/watermark/i.test(a)?o=e.includes("glyph-watermark"):/qr\s*code/i.test(a)?o=e.includes("glyph-qr-code"):/group.*category/i.test(a)?o=e.includes("glyph-category-group"):/payment\s*terms|net\s*\d+/i.test(a)?o=e.includes("glyph-payment-terms"):/bold.*header|header.*bold/i.test(a)?o=e.includes("glyph-bold-header"):/add.*date|today.*date/i.test(a)?o=e.includes("glyph-date-added"):/add.*border|border.*document/i.test(a)?o=e.includes("glyph-document-border"):/thank\s*you.*note|add.*thank/i.test(a)?o=e.includes("glyph-thank-you"):/add.*signature|signature.*line/i.test(a)&&(o=e.includes("glyph-signature-line")),o?(t.classList.add("playground__suggestion--applied"),appliedActions.add(n)):(t.classList.remove("playground__suggestion--applied"),appliedActions.delete(n))})}let hasPromptedSaveAfterWin=!1;function promptSaveAfterFirstWin(){hasPromptedSaveAfterWin||savedVersions.length>0||(hasPromptedSaveAfterWin=!0,setTimeout(()=>{const e=document.getElementById("save-version-btn");e&&(e.classList.add("ready-to-save"),setTimeout(()=>{e.classList.remove("ready-to-save")},6e3))},1500))}let lastSuccessfulModifyRequest=null;function trackModifyRequest(e){lastSuccessfulModifyRequest={sessionId:e.sessionId||sessionId,prompt:e.prompt,timestamp:Date.now()}}function openCopyCodeModal(){const e=document.getElementById("copy-code-modal");e&&lastSuccessfulModifyRequest&&(generateCodeSnippets(),e.classList.add("active"),document.body.style.overflow="hidden")}function closeCopyCodeModal(){const e=document.getElementById("copy-code-modal");e&&(e.classList.remove("active"),document.body.style.overflow="")}function generateCodeSnippets(){if(!lastSuccessfulModifyRequest)return;const{sessionId:e,prompt:t}=lastSuccessfulModifyRequest,n="https://api.glyph.you",a=(o=t,JSON.stringify(o).slice(1,-1));var o;const i=`curl -X POST ${n}/v1/modify \\\n  -H "Authorization: Bearer YOUR_API_KEY" \\\n  -H "Content-Type: application/json" \\\n  -d '{\n    "sessionId": "${e}",\n    "prompt": "${a}"\n  }'`,s=`const response = await fetch('${n}/v1/modify', {\n  method: 'POST',\n  headers: {\n    'Authorization': 'Bearer YOUR_API_KEY',\n    'Content-Type': 'application/json'\n  },\n  body: JSON.stringify({\n    sessionId: '${e}',\n    prompt: '${a}'\n  })\n});\n\nconst result = await response.json();\nconsole.log(result.html); // Updated HTML`,r=`import requests\n\nresponse = requests.post(\n    '${n}/v1/modify',\n    headers={\n        'Authorization': 'Bearer YOUR_API_KEY',\n        'Content-Type': 'application/json'\n    },\n    json={\n        'sessionId': '${e}',\n        'prompt': '${a}'\n    }\n)\n\nresult = response.json()\nprint(result['html'])  # Updated HTML`,l=document.getElementById("code-snippet-curl"),d=document.getElementById("code-snippet-javascript"),c=document.getElementById("code-snippet-python");l&&(l.textContent=i),d&&(d.textContent=s),c&&(c.textContent=r)}function initCopyCodeModal(){const e=document.getElementById("copy-code-modal");if(!e)return;const t=document.getElementById("copy-code-close");t&&t.addEventListener("click",closeCopyCodeModal),e.addEventListener("click",t=>{t.target===e&&closeCopyCodeModal()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&e.classList.contains("active")&&closeCopyCodeModal()});const n=e.querySelectorAll(".copy-code-modal__tab"),a=e.querySelectorAll(".copy-code-modal__snippet");n.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.lang;n.forEach(e=>e.classList.remove("copy-code-modal__tab--active")),e.classList.add("copy-code-modal__tab--active"),a.forEach(e=>{e.dataset.lang===t?e.classList.add("copy-code-modal__snippet--active"):e.classList.remove("copy-code-modal__snippet--active")})})});e.querySelectorAll(".copy-code-modal__copy-btn").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.lang,n=document.getElementById(`code-snippet-${t}`);if(!n)return;if(await copyTextToClipboard(n.textContent)){const t=e.innerHTML;e.classList.add("copy-code-modal__copy-btn--copied"),e.innerHTML='\n              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>\n              </svg>\n              Copied!\n            ',setTimeout(()=>{e.classList.remove("copy-code-modal__copy-btn--copied"),e.innerHTML=t},2e3)}else showToast("Couldn't copy to clipboard - try Ctrl/Cmd+C","error",4e3)})}),console.log("[Glyph] Copy as Code modal initialized")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initCopyCodeModal):initCopyCodeModal();let modificationSuccessToastElement=null,modificationSuccessToastTimeout=null;function updateResponseTimeBadge(e,t=!1){const n=document.getElementById("response-time-badge");if(!n)return;const a=parseFloat(e),o=t||a<.5;n.textContent=t?"Instant":`${e}s`,n.className="playground__response-time"+(o?" playground__response-time--fast":""),n.style.display=""}function showModificationSuccessToast(e,t=!1){const n=isFirstWin();if(!modificationSuccessToastElement){modificationSuccessToastElement=document.createElement("div"),modificationSuccessToastElement.className="modification-success-toast",modificationSuccessToastElement.innerHTML='\n          <svg class="modification-success-toast__icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>\n          </svg>\n          <div class="modification-success-toast__content">\n            <span class="modification-success-toast__title">Changes applied successfully</span>\n            <span class="modification-success-toast__detail"></span>\n          </div>\n          <div class="modification-success-toast__actions">\n            <button class="modification-success-toast__code-btn" id="toast-get-code-btn" title="Get API code for this modification">\n              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>\n              </svg>\n              <span>Get Code</span>\n            </button>\n          </div>\n        ',document.body.appendChild(modificationSuccessToastElement);const e=modificationSuccessToastElement.querySelector("#toast-get-code-btn");e&&e.addEventListener("click",e=>{e.stopPropagation(),modificationSuccessToastElement.classList.remove("visible"),modificationSuccessToastTimeout&&clearTimeout(modificationSuccessToastTimeout),openCopyCodeModal()})}const a=modificationSuccessToastElement.querySelector(".modification-success-toast__title"),o=modificationSuccessToastElement.querySelector(".modification-success-toast__detail");n?(a&&(a.textContent="You just customized your first PDF!"),o&&(o.textContent="That was all you. Try another change!"),markFirstWinComplete()):t?(a&&(a.textContent="Changes applied instantly!"),o&&(o.textContent="Local transformation - no API call needed")):(a&&(a.textContent="Changes applied successfully"),o&&(o.textContent=`Completed in ${e}s`)),modificationSuccessToastTimeout&&clearTimeout(modificationSuccessToastTimeout),requestAnimationFrame(()=>{modificationSuccessToastElement.classList.add("visible")});if(modificationSuccessToastTimeout=setTimeout(()=>{modificationSuccessToastElement.classList.remove("visible")},n?5e3:4e3),window.innerWidth<=480){const e=document.querySelector(".playground__preview-area");e&&setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"start"})},300),n&&previewContainer&&!previewContainer.classList.contains("zoomed-in")&&setTimeout(()=>{previewContainer.classList.add("zoomed-in")},800)}}function formatTimestamp(e){const t=new Date(e),n=new Date-t,a=Math.floor(n/6e4),o=Math.floor(n/36e5),i=Math.floor(n/864e5);return a<1?"Just now":a<60?a+" min ago":o<24?o+" hour"+(1===o?"":"s")+" ago":i<7?i+" day"+(1===i?"":"s")+" ago":t.toLocaleDateString("en-US",{month:"short",day:"numeric"})}function renderSavedVersions(){const e=getSaveVersionElements();if(!e.savedVersionsList||!e.savedVersionsCount)return;if(e.savedVersionsCount.textContent=savedVersions.length+"/10",0===savedVersions.length)return void(e.savedVersionsList.innerHTML='<div class="saved-versions__empty">Save your best versions <span class="saved-versions__slots">'+(10-savedVersions.length)+" slots available</span></div>");const t=[...savedVersions].sort((e,t)=>t.timestamp-e.timestamp);e.savedVersionsList.innerHTML=t.map(e=>{const t=document.createElement("div");return t.className="saved-version-item",t.setAttribute("data-id",e.id),t.innerHTML='<svg class="saved-version-item__star" fill="currentColor" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg><div class="saved-version-item__info"><div class="saved-version-item__name">'+escapeHtml(e.name)+'</div><div class="saved-version-item__date">'+formatTimestamp(e.timestamp)+'</div></div><button class="saved-version-item__delete" data-id="'+e.id+'" title="Delete version"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>',t.outerHTML}).join(""),e.savedVersionsList.querySelectorAll(".saved-version-item").forEach(e=>{e.addEventListener("click",t=>{if(t.target.closest(".saved-version-item__delete"))return;restoreSavedVersion(e.getAttribute("data-id"))})}),e.savedVersionsList.querySelectorAll(".saved-version-item__delete").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();confirmDeleteVersion(e.getAttribute("data-id"))})})}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function openSaveVersionModal(){const e=getSaveVersionElements();currentHtml?savedVersions.length>=10?showToast("Maximum 10 versions. Delete one first.","error"):(e.versionNameInput&&(e.versionNameInput.value=""),e.saveVersionModal&&e.saveVersionModal.classList.add("active"),setTimeout(()=>e.versionNameInput&&e.versionNameInput.focus(),100)):showToast("No document to save","error")}function closeSaveVersionModal(){const e=getSaveVersionElements();e.saveVersionModal&&e.saveVersionModal.classList.remove("active"),e.versionNameInput&&(e.versionNameInput.value="")}const FIRST_SAVE_KEY="glyph_first_save_complete";function isFirstSave(){try{return!localStorage.getItem(FIRST_SAVE_KEY)}catch(e){return!1}}function markFirstSaveComplete(){try{localStorage.setItem(FIRST_SAVE_KEY,"true")}catch(e){}}function saveCurrentVersion(){const e=getSaveVersionElements(),t=e.versionNameInput?e.versionNameInput.value.trim():"";if(!t)return void showToast("Please enter a name","error");if(!currentHtml)return void showToast("No document to save","error");const n=isFirstSave(),a=10-savedVersions.length-1,o={id:Date.now().toString(36)+Math.random().toString(36).substr(2,5),name:t,html:currentHtml,timestamp:Date.now()};savedVersions.push(o),persistSavedVersions(),renderSavedVersions(),closeSaveVersionModal();const i=document.getElementById("save-version-btn");i&&i.classList.remove("ready-to-save"),n?(markFirstSaveComplete(),showToast("First version saved! "+a+" slots remaining","success",4e3),celebrateFirstSave()):showToast('Version saved as "'+t+'"',"success"),console.log("[Glyph] Saved version:",t)}function celebrateFirstSave(){const e=document.getElementById("saved-versions-section");e&&(e.classList.add("first-save-glow"),setTimeout(()=>{e.classList.remove("first-save-glow")},1e3))}function restoreSavedVersion(e){const t=savedVersions.find(t=>t.id===e);t&&(saveToUndoHistory(),currentHtml=t.html,renderPreview(currentHtml),previewContainer.classList.add("success"),setTimeout(()=>previewContainer.classList.remove("success"),500),flashPreviewArea(),setStatus("Restored"),setTimeout(()=>setStatus("Ready"),1500),showToast('Restored "'+t.name+'"',"success"),console.log("[Glyph] Restored version:",t.name))}function confirmDeleteVersion(e){const t=getSaveVersionElements(),n=savedVersions.find(t=>t.id===e);n&&(versionToDelete=e,t.deleteVersionName&&(t.deleteVersionName.textContent=n.name),t.deleteConfirmModal&&t.deleteConfirmModal.classList.add("active"))}function closeDeleteModal(){const e=getSaveVersionElements();e.deleteConfirmModal&&e.deleteConfirmModal.classList.remove("active"),versionToDelete=null}function deleteSavedVersion(){if(!versionToDelete)return;const e=savedVersions.find(e=>e.id===versionToDelete),t=e?e.name:"version";savedVersions=savedVersions.filter(e=>e.id!==versionToDelete),persistSavedVersions(),renderSavedVersions(),closeDeleteModal(),showToast('Deleted "'+t+'"',"success"),console.log("[Glyph] Deleted version:",t)}function initSaveVersionListeners(){const e=getSaveVersionElements();e.saveVersionBtn&&e.saveVersionBtn.addEventListener("click",openSaveVersionModal),e.saveVersionCancel&&e.saveVersionCancel.addEventListener("click",closeSaveVersionModal),e.saveVersionConfirm&&e.saveVersionConfirm.addEventListener("click",saveCurrentVersion),e.saveVersionModal&&e.saveVersionModal.addEventListener("click",t=>{t.target===e.saveVersionModal&&closeSaveVersionModal()}),e.versionNameInput&&e.versionNameInput.addEventListener("keypress",e=>{"Enter"===e.key&&saveCurrentVersion()}),e.deleteCancel&&e.deleteCancel.addEventListener("click",closeDeleteModal),e.deleteConfirm&&e.deleteConfirm.addEventListener("click",deleteSavedVersion),e.deleteConfirmModal&&e.deleteConfirmModal.addEventListener("click",t=>{t.target===e.deleteConfirmModal&&closeDeleteModal()}),loadSavedVersions()}function renderStaticDemo(){const e=generateStaticHtml(sampleQuoteData,"#1E3A5F");currentHtml=e,renderPreview(e)}function generateStaticHtml(e,t){return`<!DOCTYPE html>\n<html>\n<head>\n<style>\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body { font-family: system-ui, sans-serif; font-size: 12px; color: #1a1a1a; padding: 32px; }\n  .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 20px; border-bottom: 2px solid ${t}; margin-bottom: 20px; }\n  .company { font-size: 18px; font-weight: 700; color: ${t}; }\n  .company-address { font-size: 11px; color: #666; margin-top: 4px; white-space: pre-line; }\n  .title { font-size: 24px; font-weight: 700; color: ${t}; text-transform: uppercase; letter-spacing: 0.05em; }\n  .meta { display: flex; gap: 32px; background: #f9fafb; padding: 16px 20px; border-radius: 8px; margin-bottom: 24px; }\n  .meta-item { text-align: center; }\n  .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 4px; }\n  .meta-value { font-weight: 600; }\n  .client { margin-bottom: 24px; }\n  .client-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px; font-weight: 600; }\n  .client-name { font-weight: 600; font-size: 14px; }\n  .client-company { color: #666; margin-top: 4px; }\n  .client-email { color: #666; font-size: 11px; }\n  table { width: 100%; border-collapse: collapse; }\n  th { background: ${t}; color: white; padding: 10px 12px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }\n  th:nth-child(2), th:nth-child(3), th:nth-child(4) { text-align: right; }\n  td { padding: 12px; border-bottom: 1px solid #e5e5e5; vertical-align: top; }\n  td:nth-child(2), td:nth-child(3), td:nth-child(4) { text-align: right; }\n  .item-desc { font-weight: 500; }\n  .item-details { font-size: 11px; color: #666; margin-top: 4px; }\n  .totals { display: flex; justify-content: flex-end; margin-top: 20px; }\n  .totals-table { width: 200px; }\n  .totals-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e5e5; }\n  .totals-row.total { border-top: 2px solid ${t}; border-bottom: none; padding-top: 10px; margin-top: 4px; }\n  .totals-label { color: #666; }\n  .totals-value { font-weight: 500; }\n  .totals-row.total .totals-label, .totals-row.total .totals-value { font-weight: 700; color: ${t}; }\n</style>\n</head>\n<body>\n  <div class="header">\n    <div>\n      <div class="company">${e.branding.companyName}</div>\n      <div class="company-address">${e.branding.companyAddress}</div>\n    </div>\n    <div class="title">Quote</div>\n  </div>\n\n  <div class="meta">\n    <div class="meta-item">\n      <div class="meta-label">Quote Number</div>\n      <div class="meta-value">${e.meta.quoteNumber}</div>\n    </div>\n    <div class="meta-item">\n      <div class="meta-label">Date</div>\n      <div class="meta-value">${e.meta.date}</div>\n    </div>\n    <div class="meta-item">\n      <div class="meta-label">Valid Until</div>\n      <div class="meta-value">${e.meta.validUntil}</div>\n    </div>\n  </div>\n\n  <div class="client">\n    <div class="client-label">Prepared For</div>\n    <div class="client-name">${e.client.name}</div>\n    <div class="client-company">${e.client.company}</div>\n    <div class="client-email">${e.client.email}</div>\n  </div>\n\n  <table>\n    <thead>\n      <tr>\n        <th>Description</th>\n        <th>Qty</th>\n        <th>Price</th>\n        <th>Total</th>\n      </tr>\n    </thead>\n    <tbody>\n      ${e.lineItems.map(e=>`\n      <tr>\n        <td>\n          <div class="item-desc">${e.description}</div>\n          <div class="item-details">${e.details}</div>\n        </td>\n        <td>${e.quantity}</td>\n        <td>$${e.unitPrice}</td>\n        <td>$${e.total}</td>\n      </tr>\n      `).join("")}\n    </tbody>\n  </table>\n\n  <div class="totals">\n    <div class="totals-table">\n      <div class="totals-row">\n        <span class="totals-label">Subtotal</span>\n        <span class="totals-value">$${e.totals.subtotal}</span>\n      </div>\n      <div class="totals-row total">\n        <span class="totals-label">Total</span>\n        <span class="totals-value">$${e.totals.total}</span>\n      </div>\n    </div>\n  </div>\n</body>\n</html>`}function setStatus(e){previewStatus.innerHTML=`<span class="status-dot"></span>${e}`}function setStepperStep(e){const t=document.querySelectorAll(".stepper__step"),n=document.querySelectorAll(".stepper__connector"),a=["analyze","generate","render"].indexOf(e);-1!==a&&(t.forEach((e,t)=>{e.classList.remove("active","completed"),t<a?e.classList.add("completed"):t===a&&e.classList.add("active")}),n.forEach((e,t)=>{e.classList.toggle("done",t<a)}))}function completeAllSteps(){document.querySelectorAll(".stepper__step").forEach(e=>{e.classList.remove("active"),e.classList.add("completed")}),document.querySelectorAll(".stepper__connector").forEach(e=>{e.classList.add("done")})}function resetStepper(){document.querySelectorAll(".stepper__step").forEach(e=>{e.classList.remove("active","completed")}),document.querySelectorAll(".stepper__connector").forEach(e=>{e.classList.remove("done")})}function updateProgressivePreview(){}function clearProgressivePreview(){}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initSaveVersionListeners):setTimeout(initSaveVersionListeners,0);let elapsedTimerInterval=null,loadingStartTime=null,currentAbortController=null,cancelButtonTimeout=null;function resetLoadingStages(){resetStepper()}function activateStage(e){setStepperStep({analyze:"analyze",generate:"generate",apply:"generate",validate:"render"}[e]||e)}function showLoading(e){previewLoading.classList.toggle("visible",e);const t=document.getElementById("loading-cancel-btn");e?(resetStepper(),loadingStartTime=Date.now(),setStepperStep("analyze"),t&&t.classList.remove("visible"),cancelButtonTimeout&&(clearTimeout(cancelButtonTimeout),cancelButtonTimeout=null),cancelButtonTimeout=setTimeout(()=>{t&&isProcessingModification&&t.classList.add("visible")},5e3),elapsedTimerInterval&&(clearInterval(elapsedTimerInterval),elapsedTimerInterval=null),elapsedTimerInterval=setInterval(()=>{setStatus(`Applying... ${Math.floor((Date.now()-loadingStartTime)/1e3)}s`)},1e3)):(elapsedTimerInterval&&(clearInterval(elapsedTimerInterval),elapsedTimerInterval=null),cancelButtonTimeout&&(clearTimeout(cancelButtonTimeout),cancelButtonTimeout=null),t&&t.classList.remove("visible"),completeAllSteps(),setTimeout(()=>{resetStepper()},500))}function isAiRefusalResponse(e){if(!e||"string"!=typeof e)return!1;const t=e.trim(),n=[/I understand your request/i,/I cannot|I can't|I'm unable to/i,/I apologize|I'm sorry/i,/Unfortunately,? I/i,/This (request|feature|functionality) (is|isn't|cannot)/i,/beyond my capabilities/i,/not possible to/i,/I'd be happy to help.*but/i,/This would require/i,/PDF documents cannot/i,/interactive (features|elements|charts)/i,/video (player|playback|content)/i,/animations? (are|is) not/i,/real-time (data|updates)/i];if(!(t.includes("<!DOCTYPE")||t.includes("<html")||t.includes("<body")||t.includes("<div")||t.includes("<table"))){for(const t of n)if(t.test(e))return!0;if(t.length<500)return!0}const a=e.replace(/<[^>]*>/g,"").trim();if(a.length>100)for(const e of n)if(e.test(a.substring(0,500)))return!0;return!1}function extractRefusalMessage(e){const t=e.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim().split(".")[0];return t.length>100?t.substring(0,100)+"...":t||"This request cannot be completed"}async function processStreamingResponse(e,t){const{onStart:n,onDelta:a,onChanges:o,onComplete:i,onError:s}=t;if(!e.body)throw new Error("No response body for streaming");const r=e.body.getReader(),l=new TextDecoder;let d="",c=null;try{for(;;){const{done:e,value:t}=await r.read();if(e)break;d+=l.decode(t,{stream:!0});const p=d.split("\n");d=p.pop()||"";let m="",u="";for(const e of p)if(e.startsWith("event: "))m=e.slice(7);else if(e.startsWith("data: "))u=e.slice(6);else if(""===e&&m&&u){try{const e=JSON.parse(u);switch(m){case"start":n&&n(e);break;case"delta":a&&a(e);break;case"changes":o&&o(e);break;case"complete":c=e,i&&i(e);break;case"error":throw s&&s(e),new Error(e.error||"Stream error")}}catch(e){if("Stream error"===e.message)throw e;console.warn("[Glyph] Failed to parse SSE data:",u)}m="",u=""}}}finally{r.releaseLock()}if(!c)throw new Error("Stream ended without complete event");return c}async function applyModifications(e){if(!e.trim())return showToast("Try a quick action above! They work instantly.","info",3e3),void highlightQuickActions();if(userHasInteracted=!0,isProcessingModification)return void console.log("[Glyph] Modification already in progress, ignoring request");if(isInstantAction(e)){if(console.log("[Glyph] Applying instant action locally:",e),captureDiffBefore(),saveToUndoHistory(),simulateModification(e),markActionApplied(e),promptInput.value="",captureDiffAfter(),trackModifyRequest({sessionId:sessionId,prompt:e}),hasShownFirstInstantWin?(showModificationSuccessToast(0,!0),updateResponseTimeBadge(0,!0),flashPreviewArea()):celebrateFirstInstantWin(),window.innerWidth<=480){const r=document.querySelector(".playground__preview-area");r&&setTimeout(()=>{r.scrollIntoView({behavior:"smooth",block:"start"})},300)}return}const t=currentHtml;captureDiffBefore(),saveToUndoHistory(),isProcessingModification=!0,showLoading(!0),setStatus("Applying..."),applyBtn.classList.add("loading"),applyBtn.disabled=!0,setSuggestionsDisabled(!0);const n=Date.now();currentAbortController=new AbortController;const a=setTimeout(()=>{console.warn("[Glyph] Absolute timeout reached (90s)"),currentAbortController.abort()},9e4);let o=setTimeout(()=>{console.warn("[Glyph] No streaming activity for 15s, aborting"),currentAbortController.abort()},15e3);const i=setTimeout(()=>{isProcessingModification&&showToast("Almost there! Complex changes take a bit longer to perfect.","info",6e3)},45e3);try{async function s(e){try{const t=await e.json();return t.error||t.message||`Server error (${e.status})`}catch{return`Server error (${e.status})`}}if(sessionId){const p=await fetch(`${API_URL}/v1/modify?stream=true`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${DEMO_API_KEY}`},body:JSON.stringify({sessionId:sessionId,prompt:e,html:currentHtml}),signal:currentAbortController.signal});if(window.__glyphRateLimit&&window.__glyphRateLimit.track(),!p.ok){429===p.status&&window.__glyphRateLimit&&window.__glyphRateLimit.onRateLimited();const y=await s(p);throw new Error(y)}let m=0,u="";const g=await processStreamingResponse(p,{onStart:e=>{console.log("[Glyph Stream] Started:",e.model),setStepperStep("analyze"),setStatus("AI is working...")},onDelta:e=>{if(m++,u+=e.html||"",clearTimeout(o),o=setTimeout(()=>{console.warn("[Glyph] No streaming activity for 15s, aborting"),currentAbortController.abort()},15e3),20===m&&setStepperStep("generate"),m%20==0){setStatus(`AI is working... ${Math.floor((Date.now()-n)/1e3)}s`)}},onChanges:e=>{console.log("[Glyph Stream] Changes:",e.changes),setStepperStep("generate")},onComplete:e=>{console.log("[Glyph Stream] Complete:",e.fastPath?"fast path":`${m} chunks`),setStepperStep("render"),elapsedTimerInterval&&(clearInterval(elapsedTimerInterval),elapsedTimerInterval=null)},onError:e=>{console.error("[Glyph Stream] Error:",e)}}),h=((Date.now()-n)/1e3).toFixed(1);if(isAiRefusalResponse(g.html)){console.warn("[Glyph] AI refusal detected, not rendering to document");const v=extractRefusalMessage(g.html);return undoHistory.length>0&&(undoHistory.pop(),updateUndoButtonState()),showToast(v,"warning",5e3),setStatus("Request not supported"),setTimeout(()=>setStatus("Ready"),3e3),clearTimeout(a),void clearTimeout(o)}return currentHtml=g.html,renderPreview(currentHtml,{changes:g.changes||[],previousHtml:t}),addHistoryEntry(e,currentHtml),previewContainer.classList.add("success"),setTimeout(()=>previewContainer.classList.remove("success"),500),flashPreviewArea(),consecutiveFailures=0,autoRetryCount=0,lastErrorWasSessionError=!1,showSuccessCta(),captureDiffAfter(),trackModifyRequest({sessionId:sessionId,prompt:e}),showModificationSuccessToast(h),updateResponseTimeBadge(h),setStatus(`Done in ${h}s`),console.log(`[Glyph] Modification completed in ${h}s (${g.fastPath?"fast path":m+" stream chunks"})`),setTimeout(()=>setStatus("Ready"),2e3),sessionId&&startValidationPolling(sessionId),clearTimeout(a),void clearTimeout(o)}const l=await fetch(`${API_URL}/v1/modify`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${DEMO_API_KEY}`},body:JSON.stringify({html:currentHtml,instruction:e}),signal:currentAbortController.signal});if(window.__glyphRateLimit&&window.__glyphRateLimit.track(),!l.ok){429===l.status&&window.__glyphRateLimit&&window.__glyphRateLimit.onRateLimited();const f=await s(l);throw new Error(f)}const d=((Date.now()-n)/1e3).toFixed(1),c=await l.json();if(isAiRefusalResponse(c.html)){console.warn("[Glyph] AI refusal detected, not rendering to document");const b=extractRefusalMessage(c.html);return undoHistory.length>0&&(undoHistory.pop(),updateUndoButtonState()),showToast(b,"warning",5e3),setStatus("Request not supported"),setTimeout(()=>setStatus("Ready"),3e3),clearTimeout(a),void clearTimeout(o)}currentHtml=c.html,renderPreview(currentHtml,{changes:c.changes||[],previousHtml:t}),addHistoryEntry(e,currentHtml),previewContainer.classList.add("success"),setTimeout(()=>previewContainer.classList.remove("success"),500),flashPreviewArea(),consecutiveFailures=0,autoRetryCount=0,lastErrorWasSessionError=!1,showSuccessCta(),captureDiffAfter(),trackModifyRequest({prompt:e}),showModificationSuccessToast(d),updateResponseTimeBadge(d),setStatus(`Done in ${d}s`),console.log(`[Glyph] Modification completed in ${d}s`),setTimeout(()=>setStatus("Ready"),2e3)}catch(w){clearTimeout(a),clearTimeout(o),clearProgressivePreview(),console.error("[Glyph] API modification failed:",w),undoHistory.length>0&&(undoHistory.pop(),updateUndoButtonState());let S=w.message||"Unknown error";const x=Date.now()-n,T="AbortError"===w.name&&x<89e3;if("AbortError"===w.name){if(T)return showToast("Modification cancelled","info"),setStatus("Ready"),void console.log("[Glyph] Modification cancelled by user");S="timeout - request took too long (60s limit)"}showApiError(S,e),setStatus("Error - See message"),setTimeout(()=>setStatus("Ready"),3e3)}finally{clearTimeout(a),clearTimeout(o),clearTimeout(i),clearProgressivePreview(),currentAbortController=null,isProcessingModification=!1,showLoading(!1),applyBtn.classList.remove("loading"),applyBtn.disabled=!1,setSuggestionsDisabled(!1),promptInput.value=""}}let validationPollInterval=null,currentValidationToast=null;function startValidationPolling(e){validationPollInterval&&clearInterval(validationPollInterval);let t=0;validationPollInterval=setInterval(async()=>{t++;try{const t=await fetch(`${API_URL}/v1/modify/validation-status?sessionId=${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${DEMO_API_KEY}`}});if(t.ok){const n=await t.json();if(n.validationResult)return clearInterval(validationPollInterval),validationPollInterval=null,void(n.validationResult.criticalCount>0&&!isInDemoMode?showValidationToast(n.validationResult,n.hasAutoFix,e):n.validationResult.criticalCount>0&&isInDemoMode?(console.log("[Glyph] Demo mode: Suppressing validation toast ("+n.validationResult.criticalCount+" critical issues)"),showValidationSuccessToast()):n.validationResult.warningCount>0?(console.log("[Glyph] Self-check: "+n.validationResult.warningCount+" minor warnings (not shown to user)"),showValidationSuccessToast()):(console.log("[Glyph] Self-check passed - no issues detected"),showValidationSuccessToast()))}}catch(e){console.warn("[Glyph] Validation poll error:",e)}t>=60&&(clearInterval(validationPollInterval),validationPollInterval=null,console.log("[Glyph] Validation poll timeout - validation still pending"),showValidationTimeoutMessage())},1e3)}function showValidationTimeoutMessage(){if(!userHasInteracted)return;const e=document.createElement("div");e.className="validation-toast validation-toast--info",e.innerHTML='\n        <div class="validation-toast__content">\n          <svg class="validation-toast__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <circle cx="12" cy="12" r="10"></circle>\n            <path d="M12 16v-4M12 8h.01"></path>\n          </svg>\n          <div class="validation-toast__text">\n            <span class="validation-toast__title">Quality check in progress</span>\n            <span class="validation-toast__message">Running final validation... Your changes are applied.</span>\n          </div>\n        </div>\n      ',document.body.appendChild(e),requestAnimationFrame(()=>e.classList.add("visible")),setTimeout(()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300)},5e3)}function showValidationToast(e,t,n){currentValidationToast&&currentValidationToast.remove();const a=document.createElement("div");a.className="validation-toast";const o=e.criticalCount>0,i="validation-toast__icon--warning",s=`<svg class="validation-toast__icon ${i}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg>`,r=(e.issues||[]).slice(0,3).map(e=>`<div class="validation-toast__issue validation-toast__issue--${"critical"===e.severity?"critical":"warning"}">${e.description}</div>`).join("");a.innerHTML=`\n        <div class="validation-toast__header">\n          ${s}\n          <span class="validation-toast__title">\n            ${o?"Quick Fix Available":"Suggestions Available"}\n          </span>\n          <button class="validation-toast__close" aria-label="Close">\n            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">\n              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>\n            </svg>\n          </button>\n        </div>\n        <div class="validation-toast__issues">\n          ${r}\n        </div>\n        ${t?'\n          <div class="validation-toast__actions">\n            <button class="validation-toast__btn validation-toast__btn--primary" data-action="apply-fix">\n              Apply Fix\n            </button>\n            <button class="validation-toast__btn validation-toast__btn--secondary" data-action="dismiss">\n              Dismiss\n            </button>\n          </div>\n        ':'\n          <div class="validation-toast__actions">\n            <button class="validation-toast__btn validation-toast__btn--secondary" data-action="dismiss">\n              Got it\n            </button>\n          </div>\n        '}\n      `,a.querySelector(".validation-toast__close").addEventListener("click",()=>{dismissValidationToast(a)}),a.querySelectorAll("[data-action]").forEach(e=>{e.addEventListener("click",e=>{"apply-fix"===e.target.dataset.action?applyValidationFix(n,a):dismissValidationToast(a)})}),document.body.appendChild(a),currentValidationToast=a,requestAnimationFrame(()=>{a.classList.add("visible")}),setTimeout(()=>{document.body.contains(a)&&dismissValidationToast(a)},15e3)}function dismissValidationToast(e){e.classList.remove("visible"),setTimeout(()=>{e.remove(),currentValidationToast===e&&(currentValidationToast=null)},300)}function showValidationSuccessToast(){currentValidationToast&&currentValidationToast.remove();const e=document.createElement("div");e.className="validation-toast validation-toast--success";e.innerHTML='\n        <div class="validation-toast__header">\n          <svg class="validation-toast__icon validation-toast__icon--success" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">\n        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/>\n      </svg>\n          <span class="validation-toast__title">Changes verified safe</span>\n        </div>\n      ',document.body.appendChild(e),currentValidationToast=e,requestAnimationFrame(()=>{e.classList.add("visible")}),setTimeout(()=>{document.body.contains(e)&&dismissValidationToast(e)},3e3)}async function applyValidationFix(e,t){const n=t.querySelector('[data-action="apply-fix"]');n.textContent="Applying...",n.disabled=!0;try{const a=await fetch(`${API_URL}/v1/modify/apply-fix`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${DEMO_API_KEY}`},body:JSON.stringify({sessionId:e})});if(a.ok){const e=await a.json();currentHtml=e.html,renderPreview(currentHtml),n.textContent="Fixed!",n.style.background="var(--color-success)",previewContainer.classList.add("success"),setTimeout(()=>previewContainer.classList.remove("success"),500),flashPreviewArea(),setTimeout(()=>{dismissValidationToast(t)},1e3)}else n.textContent="Failed",n.style.background="var(--color-error)",setTimeout(()=>{n.textContent="Apply Fix",n.style.background="",n.disabled=!1},2e3)}catch(e){console.error("[Glyph] Apply fix error:",e),n.textContent="Error",n.disabled=!1}}function injectWatermark(e,t="DRAFT"){if(e.includes("glyph-watermark"))return e.replace(/(<div class="glyph-watermark"[^>]*>)[^<]*(<\/div>)/i,`$1${t}$2`);const n=`<div class="glyph-watermark" style="${"\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) rotate(-45deg);\n        font-size: 100px;\n        font-weight: 900;\n        color: rgba(0, 0, 0, 0.07);\n        pointer-events: none;\n        white-space: nowrap;\n        z-index: 1000;\n        letter-spacing: 20px;\n        user-select: none;\n      ".replace(/\n\s*/g," ")}">${t}</div>`;return e.replace("</body>",`${n}</body>`)}function injectQrCode(e){if(e.includes("glyph-qr-code"))return e;const t=`<div class="glyph-qr-code" style="${"\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        width: 80px;\n        height: 100px;\n        background: white;\n        border: 1px solid #e5e5e5;\n        border-radius: 8px;\n        padding: 8px;\n        text-align: center;\n        font-family: sans-serif;\n        font-size: 8px;\n        color: #666;\n        z-index: 999;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n      ".replace(/\n\s*/g," ")}"><svg viewBox="0 0 64 64" style="width:60px;height:60px;"><rect fill="#000" x="0" y="0" width="8" height="8"/><rect fill="#000" x="8" y="0" width="8" height="8"/><rect fill="#000" x="16" y="0" width="8" height="8"/><rect fill="#000" x="24" y="0" width="8" height="8"/><rect fill="#000" x="32" y="0" width="8" height="8"/><rect fill="#000" x="40" y="0" width="8" height="8"/><rect fill="#000" x="48" y="0" width="8" height="8"/><rect fill="#000" x="0" y="8" width="8" height="8"/><rect fill="#000" x="48" y="8" width="8" height="8"/><rect fill="#000" x="0" y="16" width="8" height="8"/><rect fill="#000" x="16" y="16" width="8" height="8"/><rect fill="#000" x="24" y="16" width="8" height="8"/><rect fill="#000" x="32" y="16" width="8" height="8"/><rect fill="#000" x="48" y="16" width="8" height="8"/><rect fill="#000" x="0" y="24" width="8" height="8"/><rect fill="#000" x="16" y="24" width="8" height="8"/><rect fill="#000" x="24" y="24" width="8" height="8"/><rect fill="#000" x="32" y="24" width="8" height="8"/><rect fill="#000" x="48" y="24" width="8" height="8"/><rect fill="#000" x="0" y="32" width="8" height="8"/><rect fill="#000" x="16" y="32" width="8" height="8"/><rect fill="#000" x="24" y="32" width="8" height="8"/><rect fill="#000" x="32" y="32" width="8" height="8"/><rect fill="#000" x="48" y="32" width="8" height="8"/><rect fill="#000" x="0" y="40" width="8" height="8"/><rect fill="#000" x="48" y="40" width="8" height="8"/><rect fill="#000" x="0" y="48" width="8" height="8"/><rect fill="#000" x="8" y="48" width="8" height="8"/><rect fill="#000" x="16" y="48" width="8" height="8"/><rect fill="#000" x="24" y="48" width="8" height="8"/><rect fill="#000" x="32" y="48" width="8" height="8"/><rect fill="#000" x="40" y="48" width="8" height="8"/><rect fill="#000" x="48" y="48" width="8" height="8"/></svg><div style="margin-top:4px;">Scan to pay</div></div>`;return e.replace("</body>",`${t}</body>`)}function changeAccentColor(e,t){return e=(e=(e=(e=e.replace(/--accent-color:\s*[^;]+;/g,`--accent-color: ${t};`)).replace(/background(-color)?:\s*#1E3A5F/gi,`background$1: ${t}`)).replace(/border(-color)?:\s*#1E3A5F/gi,`border$1: ${t}`)).replace(/color:\s*#1E3A5F/gi,`color: ${t}`)}function injectBoldHeader(e){if(e.includes("glyph-bold-header-applied"))return e;return e.replace("</head>",'\n        <style class="glyph-bold-header-applied">\n          h1, .invoice-title, .document-title, [class*="title"], [class*="header"] h1 {\n            font-weight: 900 !important;\n            font-size: 1.3em !important;\n            letter-spacing: -0.02em !important;\n          }\n          .company-name, [class*="company"] {\n            font-weight: 800 !important;\n            font-size: 1.15em !important;\n          }\n        </style>\n      </head>')}function injectDate(e){if(e.includes("glyph-date-badge"))return e;const t=(new Date).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),n=`<div class="glyph-date-badge" style="${"\n        position: fixed;\n        top: 20px;\n        right: 110px;\n        background: #f8fafc;\n        border: 1px solid #e2e8f0;\n        border-radius: 6px;\n        padding: 8px 12px;\n        font-family: sans-serif;\n        font-size: 11px;\n        color: #475569;\n        z-index: 998;\n        box-shadow: 0 1px 3px rgba(0,0,0,0.08);\n      ".replace(/\n\s*/g," ")}">${t}</div>`;return e.replace("</body>",`${n}</body>`)}function injectBorder(e){if(e.includes("glyph-document-border"))return e;return e.replace("</head>",'\n        <style class="glyph-document-border">\n          body {\n            border: 3px solid #1e3a5f !important;\n            border-radius: 8px !important;\n            margin: 16px !important;\n            box-shadow: 0 4px 12px rgba(30, 58, 95, 0.15) !important;\n          }\n          @media print {\n            body {\n              border: 2px solid #1e3a5f !important;\n              margin: 12px !important;\n            }\n          }\n        </style>\n      </head>')}function injectThankYouNote(e){if(e.includes("glyph-thank-you-note"))return e;const t=`<div class="glyph-thank-you-note" style="${"\n        margin: 24px 20px;\n        padding: 20px;\n        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);\n        border-radius: 12px;\n        border-left: 4px solid #22c55e;\n        font-family: sans-serif;\n        text-align: center;\n      ".replace(/\n\s*/g," ")}">\n        <div style="font-size: 16px; font-weight: 600; color: #166534; margin-bottom: 6px;">Thank You for Your Business!</div>\n        <div style="font-size: 12px; color: #15803d; line-height: 1.5;">We appreciate your trust in our services. Please don't hesitate to reach out if you have any questions.</div>\n      </div>`;return e.replace("</body>",`${t}</body>`)}function injectSignature(e){if(e.includes("glyph-signature-line"))return e;const t=(new Date).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),n=`<div class="glyph-signature-line" style="${"\n        margin: 32px 20px;\n        padding: 24px;\n        font-family: sans-serif;\n        border-top: 1px solid #e5e7eb;\n      ".replace(/\n\s*/g," ")}">\n        <div style="display: flex; justify-content: space-between; gap: 48px;">\n          <div style="flex: 1;">\n            <div style="border-bottom: 1px solid #374151; margin-bottom: 8px; height: 40px;"></div>\n            <div style="font-size: 12px; color: #6b7280;">Authorized Signature</div>\n          </div>\n          <div style="flex: 1;">\n            <div style="border-bottom: 1px solid #374151; margin-bottom: 8px; height: 40px; display: flex; align-items: flex-end; padding-bottom: 4px; color: #374151; font-size: 14px;">${t}</div>\n            <div style="font-size: 12px; color: #6b7280;">Date</div>\n          </div>\n        </div>\n      </div>`;return e.replace("</body>",`${n}</body>`)}function extractTermsText(e){const t=e.toLowerCase(),n=e.match(/net\s*(\d+)/i),a=n?n[1]:"30",o=e.match(/(\d+)%\s*(early\s*)?(?:payment\s*)?discount/i),i=o?o[1]:null,s=e.match(/(?:within|in)\s*(\d+)\s*days/i),r=s?s[1]:"10";let l=`Net ${a} days`;return i?l+=`. ${i}% early payment discount if paid within ${r} days`:(t.includes("discount")||t.includes("early"))&&(l+=`. 2% early payment discount if paid within ${r} days`),l}function injectPaymentTerms(e,t){if(e.includes("glyph-payment-terms")||e.includes("Payment Terms</div>"))return e.replace(/(<div class="glyph-payment-terms"[^>]*>[\s\S]*?<div[^>]*>Payment Terms<\/div>\s*<div[^>]*>)[^<]*(<\/div>)/i,`$1${t}$2`);const n=`<div class="glyph-payment-terms" style="${"\n        margin: 24px 20px;\n        padding: 16px;\n        background: #f9fafb;\n        border-radius: 8px;\n        border-left: 4px solid #1e3a5f;\n        font-family: sans-serif;\n      ".replace(/\n\s*/g," ")}">\n        <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px; font-weight: 600;">Payment Terms</div>\n        <div style="font-size: 12px; color: #1a1a1a; line-height: 1.5;">${t}</div>\n      </div>`;return e.replace("</body>",`${n}</body>`)}function injectGroupByCategory(e){if(e.includes("glyph-category-group")||e.includes("Category Subtotal"))return e;if(!e.match(/<tbody>([\s\S]*?)<\/tbody>/))return e;const t={Design:[{description:"UI/UX Design",details:"Custom interface design and prototypes",quantity:1,unitPrice:3500,total:3500},{description:"Brand Guidelines",details:"Logo usage, colors, typography specs",quantity:1,unitPrice:1500,total:1500}],Materials:[{description:"Server Hardware",details:"Dell PowerEdge R750 with 64GB RAM",quantity:2,unitPrice:4200,total:8400},{description:"Network Equipment",details:"Cisco switches and cabling",quantity:1,unitPrice:2800,total:2800},{description:"Software Licenses",details:"Enterprise software bundle",quantity:5,unitPrice:450,total:2250}],Labor:[{description:"Installation",details:"On-site hardware setup and config",quantity:16,unitPrice:150,total:2400},{description:"Training",details:"Staff training sessions (4 hours each)",quantity:3,unitPrice:500,total:1500}]};let n="";for(const[e,a]of Object.entries(t)){const t=a.reduce((e,t)=>e+t.total,0);n+=`\n          <tr class="glyph-category-group" style="background: #f8fafc;">\n            <td colspan="4" style="font-weight: 600; color: #1e3a5f; padding: 12px 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid #e2e8f0;">${e}</td>\n          </tr>`;for(const e of a)n+=`\n          <tr>\n            <td>\n              <div class="item-desc">${e.description}</div>\n              <div class="item-details">${e.details}</div>\n            </td>\n            <td>${e.quantity}</td>\n            <td>$${e.unitPrice.toFixed(2)}</td>\n            <td>$${e.total.toFixed(2)}</td>\n          </tr>`;n+=`\n          <tr class="glyph-category-subtotal" style="background: #f1f5f9;">\n            <td colspan="3" style="text-align: right; font-weight: 500; color: #64748b; padding-right: 16px; font-size: 12px;">${e} Subtotal</td>\n            <td style="font-weight: 600; color: #1e3a5f;">$${t.toFixed(2)}</td>\n          </tr>`}return e.replace(/<tbody>[\s\S]*?<\/tbody>/,`<tbody>${n}</tbody>`)}function simulateModification(e){const t=e.toLowerCase();let n=currentHtml;if(t.includes("terms")||t.includes("payment terms")||t.includes("net ")){n=injectPaymentTerms(n,extractTermsText(e))}if(t.includes("watermark")){let e="DRAFT";t.includes("paid")?e="PAID":t.includes("confidential")?e="CONFIDENTIAL":t.includes("approved")?e="APPROVED":t.includes("void")?e="VOID":t.includes("sample")&&(e="SAMPLE"),n=injectWatermark(n,e)}t.includes("qr")&&(n=injectQrCode(n)),t.includes("group")&&(t.includes("category")||t.includes("subtotal"))&&(n=injectGroupByCategory(n)),t.includes("bold")&&(t.includes("header")||t.includes("title"))&&(n=injectBoldHeader(n)),t.includes("date")&&(t.includes("add")||t.includes("today"))&&(n=injectDate(n)),t.includes("border")&&(n=injectBorder(n)),t.includes("thank")&&(t.includes("you")||t.includes("note"))&&(n=injectThankYouNote(n)),t.includes("signature")&&(n=injectSignature(n)),t.includes("blue")?n=changeAccentColor(n,"#3B82F6"):t.includes("purple")||t.includes("stripe")?n=changeAccentColor(n,"#635BFF"):t.includes("red")?n=changeAccentColor(n,"#EF4444"):t.includes("green")?n=changeAccentColor(n,"#22C55E"):t.includes("orange")?n=changeAccentColor(n,"#F97316"):t.includes("pink")?n=changeAccentColor(n,"#EC4899"):(t.includes("gold")||t.includes("yellow"))&&(n=changeAccentColor(n,"#EAB308")),currentHtml=n,renderPreview(currentHtml),addHistoryEntry(e,currentHtml),previewContainer.classList.add("success"),setTimeout(()=>previewContainer.classList.remove("success"),500),flashPreviewArea(),setStatus("Demo: Updated!"),setTimeout(()=>setStatus("Demo Mode"),2e3)}function generateEnhancedHtml(e,t,n){const a="stripe"===n.style,o="apple"===n.style,i=n.watermark?`\n        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 80px; font-weight: 900; color: rgba(0,0,0,0.06); pointer-events: none; white-space: nowrap; z-index: 1;">${n.watermark}</div>\n      `:"",s=n.qrCode?'\n        <div style="position: absolute; top: 20px; right: 20px; width: 80px; height: 80px; background: white; border: 1px solid #e5e5e5; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px;">\n          <svg viewBox="0 0 100 100" width="50" height="50">\n            <rect x="10" y="10" width="25" height="25" fill="#1a1a1a"/>\n            <rect x="15" y="15" width="15" height="15" fill="white"/>\n            <rect x="18" y="18" width="9" height="9" fill="#1a1a1a"/>\n            <rect x="65" y="10" width="25" height="25" fill="#1a1a1a"/>\n            <rect x="70" y="15" width="15" height="15" fill="white"/>\n            <rect x="73" y="18" width="9" height="9" fill="#1a1a1a"/>\n            <rect x="10" y="65" width="25" height="25" fill="#1a1a1a"/>\n            <rect x="15" y="70" width="15" height="15" fill="white"/>\n            <rect x="18" y="73" width="9" height="9" fill="#1a1a1a"/>\n            <rect x="40" y="10" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="50" y="10" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="40" y="20" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="45" y="25" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="40" y="40" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="45" y="45" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="50" y="40" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="55" y="45" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="10" y="45" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="20" y="50" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="65" y="45" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="75" y="50" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="85" y="55" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="65" y="65" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="75" y="75" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="85" y="85" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="45" y="65" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="55" y="75" width="5" height="5" fill="#1a1a1a"/>\n            <rect x="45" y="85" width="5" height="5" fill="#1a1a1a"/>\n          </svg>\n          <div style="font-size: 7px; color: #666; margin-top: 4px;">Scan to pay</div>\n        </div>\n      ':"",r=n.terms?`\n        <div style="margin-top: 24px; padding: 16px; background: #f9fafb; border-radius: 8px; border-left: 4px solid ${t};">\n          <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px; font-weight: 600;">Payment Terms</div>\n          <div style="font-size: 12px; color: #1a1a1a;">${n.terms}</div>\n        </div>\n      `:"",l=n.signature?`\n        <div style="margin-top: 32px; display: flex; justify-content: space-between; align-items: flex-end;">\n          <div style="flex: 1;">\n            <div style="font-size: 11px; color: #666; margin-bottom: 8px;">Thank you for your business!</div>\n            <div style="border-bottom: 1px solid #1a1a1a; width: 200px; margin-bottom: 4px;"></div>\n            <div style="font-size: 10px; color: #666;">Authorized Signature</div>\n          </div>\n          <div style="text-align: right;">\n            <div style="font-size: 11px; color: #666;">Date: ${(new Date).toLocaleDateString()}</div>\n          </div>\n        </div>\n      `:"",d=n.progressBar?`\n        <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, ${t}15, ${t}05); border-radius: 8px;">\n          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">\n            <span style="font-size: 11px; font-weight: 600; color: ${t};">Payment Progress</span>\n            <span style="font-size: 11px; font-weight: 600; color: ${t};">${n.progressBar}% Paid</span>\n          </div>\n          <div style="height: 8px; background: #e5e5e5; border-radius: 4px; overflow: hidden;">\n            <div style="height: 100%; width: ${n.progressBar}%; background: linear-gradient(90deg, ${t}, ${t}cc); border-radius: 4px;"></div>\n          </div>\n          <div style="font-size: 10px; color: #666; margin-top: 6px;">$${(e.totals.total*n.progressBar/100).toFixed(2)} of $${e.totals.total.toFixed(2)} received</div>\n        </div>\n      `:"";return`<!DOCTYPE html>\n<html>\n<head>\n<style>\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body { font-family: system-ui, sans-serif; font-size: 12px; color: #1a1a1a; padding: 32px; position: relative; }\n  .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 20px; border-bottom: 2px solid ${t}; margin-bottom: 20px; }\n  .company { font-size: 18px; font-weight: 700; color: ${t}; }\n  .company-address { font-size: 11px; color: #666; margin-top: 4px; white-space: pre-line; }\n  .title { font-size: 24px; font-weight: 700; color: ${t}; text-transform: uppercase; letter-spacing: 0.05em; }\n  .meta { display: flex; gap: 32px; background: #f9fafb; padding: 16px 20px; border-radius: 8px; margin-bottom: 24px; }\n  .meta-item { text-align: center; }\n  .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 4px; }\n  .meta-value { font-weight: 600; }\n  .client { margin-bottom: 24px; }\n  .client-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px; font-weight: 600; }\n  .client-name { font-weight: 600; font-size: 14px; }\n  .client-company { color: #666; margin-top: 4px; }\n  .client-email { color: #666; font-size: 11px; }\n  table { width: 100%; border-collapse: collapse; }\n  th { background: ${t}; color: white; padding: 10px 12px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }\n  th:nth-child(2), th:nth-child(3), th:nth-child(4) { text-align: right; }\n  td { padding: 12px; border-bottom: 1px solid #e5e5e5; vertical-align: top; }\n  td:nth-child(2), td:nth-child(3), td:nth-child(4) { text-align: right; }\n  .item-desc { font-weight: 500; }\n  .item-details { font-size: 11px; color: #666; margin-top: 4px; }\n  .totals { display: flex; justify-content: flex-end; margin-top: 20px; }\n  .totals-table { width: 200px; }\n  .totals-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e5e5; }\n  .totals-row.total { border-top: 2px solid ${t}; border-bottom: none; padding-top: 10px; margin-top: 4px; }\n  .totals-label { color: #666; }\n  .totals-value { font-weight: 500; }\n  .totals-row.total .totals-label, .totals-row.total .totals-value { font-weight: 700; color: ${t}; }\n  ${a?"\n        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }\n        .header { border-bottom: none; padding-bottom: 0; margin-bottom: 32px; }\n        .company { font-size: 14px; font-weight: 500; color: #1a1a1a; letter-spacing: -0.01em; }\n        .title { font-size: 32px; font-weight: 600; color: #1a1a1a; text-transform: none; letter-spacing: -0.02em; }\n        .meta { background: transparent; padding: 0; gap: 48px; }\n        .meta-item { text-align: left; }\n        .meta-label { font-size: 12px; color: #697386; text-transform: none; letter-spacing: 0; }\n        .meta-value { font-size: 14px; }\n        th { background: transparent; color: #697386; font-size: 12px; text-transform: none; letter-spacing: 0; border-bottom: 1px solid #e6e6e6; }\n        td { border-bottom: 1px solid #e6e6e6; }\n        .totals-row.total { border-top: 1px solid #e6e6e6; }\n        .totals-row.total .totals-label, .totals-row.total .totals-value { color: #1a1a1a; }\n      ":""}\n  ${o?"\n        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; }\n        .header { border-bottom: none; }\n        .company { font-size: 13px; font-weight: 400; color: #86868b; }\n        .title { font-size: 40px; font-weight: 600; color: #1d1d1f; text-transform: none; letter-spacing: -0.025em; }\n        .meta { background: transparent; border-radius: 0; }\n        th { background: transparent; color: #86868b; border-bottom: 1px solid #d2d2d7; }\n        td { border-bottom: 1px solid #d2d2d7; }\n      ":""}\n</style>\n</head>\n<body>\n  ${i}\n  ${s}\n  <div class="header">\n    <div>\n      <div class="company">${e.branding.companyName}</div>\n      <div class="company-address">${e.branding.companyAddress}</div>\n    </div>\n    <div class="title">${a?"Invoice":"Quote"}</div>\n  </div>\n\n  <div class="meta">\n    <div class="meta-item">\n      <div class="meta-label">Quote Number</div>\n      <div class="meta-value">${e.meta.quoteNumber}</div>\n    </div>\n    <div class="meta-item">\n      <div class="meta-label">Date</div>\n      <div class="meta-value">${e.meta.date}</div>\n    </div>\n    <div class="meta-item">\n      <div class="meta-label">Valid Until</div>\n      <div class="meta-value">${e.meta.validUntil}</div>\n    </div>\n  </div>\n\n  <div class="client">\n    <div class="client-label">Prepared For</div>\n    <div class="client-name">${e.client.name}</div>\n    <div class="client-company">${e.client.company}</div>\n    <div class="client-email">${e.client.email}</div>\n  </div>\n\n  <table>\n    <thead>\n      <tr>\n        <th>Description</th>\n        <th>Qty</th>\n        <th>Price</th>\n        <th>Total</th>\n      </tr>\n    </thead>\n    <tbody>\n      ${e.lineItems.map(e=>`\n      <tr>\n        <td>\n          <div class="item-desc">${e.description}</div>\n          <div class="item-details">${e.details}</div>\n        </td>\n        <td>${e.quantity}</td>\n        <td>$${e.unitPrice}</td>\n        <td>$${e.total}</td>\n      </tr>\n      `).join("")}\n    </tbody>\n  </table>\n\n  <div class="totals">\n    <div class="totals-table">\n      <div class="totals-row">\n        <span class="totals-label">Subtotal</span>\n        <span class="totals-value">$${e.totals.subtotal}</span>\n      </div>\n      <div class="totals-row total">\n        <span class="totals-label">Total</span>\n        <span class="totals-value">$${e.totals.total}</span>\n      </div>\n    </div>\n  </div>\n\n  ${d}\n  ${r}\n  ${l}\n</body>\n</html>`}window.addEventListener("pagehide",()=>{validationPollInterval&&(clearInterval(validationPollInterval),validationPollInterval=null)}),playgroundTabs.forEach(e=>{e.addEventListener("click",async()=>{if(e.classList.contains("playground__tab--active"))return;const t=document.querySelector(".playground__preview-frame-wrapper");playgroundTabs.forEach(e=>e.classList.remove("playground__tab--active")),e.classList.add("playground__tab--active"),t&&t.classList.add("template-switching"),await new Promise(e=>setTimeout(e,200)),currentTemplate=e.dataset.template,sessionId=null,clearUndoHistory(),removeEditingBanner(),await initializePreview(),t&&t.classList.remove("template-switching")})});const templateTypeSelect=document.getElementById("template-type-select-playground"),styleTabsContainer=document.getElementById("playground-style-tabs");function bindStyleTabs(){const e=styleTabsContainer.querySelectorAll(".playground__tab");e.forEach(t=>{t.addEventListener("click",async()=>{if(t.classList.contains("playground__tab--active"))return;const n=document.querySelector(".playground__preview-frame-wrapper");e.forEach(e=>e.classList.remove("playground__tab--active")),t.classList.add("playground__tab--active"),n&&n.classList.add("template-switching"),await new Promise(e=>setTimeout(e,200)),currentTemplate=t.dataset.template,sessionId=null,clearUndoHistory(),removeEditingBanner(),await initializePreview(),n&&n.classList.remove("template-switching")})})}templateTypeSelect&&templateTypeSelect.addEventListener("change",async()=>{const e=templateTypeSelect.value,t=TEMPLATE_TYPE_CONFIG[e];if(!t)return;styleTabsContainer.innerHTML="",t.variants.forEach((e,t)=>{const n=document.createElement("button");n.className="playground__tab"+(0===t?" playground__tab--active":""),n.dataset.template=e.id,n.textContent=e.label,styleTabsContainer.appendChild(n)}),bindStyleTabs();const n=document.querySelector(".playground__preview-frame-wrapper");n&&n.classList.add("template-switching"),await new Promise(e=>setTimeout(e,200)),currentTemplate=t.variants[0].id,sessionId=null,clearUndoHistory(),removeEditingBanner(),await initializePreview(),n&&n.classList.remove("template-switching")}),suggestions.forEach(e=>{e.addEventListener("click",()=>{if(isProcessingModification)return void console.log("[Glyph] Modification in progress, ignoring suggestion click");const t=e.dataset.prompt;promptInput.value=t,applyModifications(t)})}),applyBtn.addEventListener("click",()=>{applyModifications(promptInput.value)}),undoBtn.addEventListener("click",()=>{isProcessingModification||performUndo()});const shareBtn=document.getElementById("share-btn");shareBtn&&shareBtn.addEventListener("click",()=>{const e=historyEntries.filter(e=>e.prompt&&"Initial state"!==e.prompt).map(e=>e.prompt);if(0===e.length)return void showToast("Apply some changes first before sharing","info");const t=document.querySelector(".playground__tab--active"),n={template:t?t.dataset.template:"quote-modern",actions:e},a=btoa(JSON.stringify(n)),o=window.location.origin+window.location.pathname+"#playground?mods="+a;navigator.clipboard.writeText(o).then(()=>{showToast("Link copied to clipboard","success")}).catch(()=>{showToast("Could not copy link","error")})});const loadingCancelBtn=document.getElementById("loading-cancel-btn");loadingCancelBtn&&loadingCancelBtn.addEventListener("click",()=>{isProcessingModification&&currentAbortController&&(console.log("[Glyph] User cancelled modification"),currentAbortController.abort())}),promptInput.addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),applyModifications(promptInput.value))}),generateBtn.addEventListener("click",async()=>{if(demoDownloadCount>=3)return void showModal();const e=generateBtn.innerHTML;generateBtn.innerHTML='<div class="loading-spinner loading-spinner--small"></div>Generating...',generateBtn.disabled=!0;try{await generateDemoPdf()}finally{generateBtn.innerHTML=e,generateBtn.disabled=!1}});const modalOverlay=document.getElementById("modal-overlay"),modalClose=document.getElementById("modal-close");function showModal(){modalOverlay.classList.add("visible"),document.body.style.overflow="hidden"}function hideModal(){modalOverlay.classList.remove("visible"),document.body.style.overflow=""}modalClose.addEventListener("click",hideModal),modalOverlay.addEventListener("click",e=>{e.target===modalOverlay&&hideModal()});const pdfSuccessClose=document.getElementById("pdf-success-close"),pdfSuccessModal=document.getElementById("pdf-success-modal");pdfSuccessClose&&pdfSuccessClose.addEventListener("click",hidePdfSuccessModal),pdfSuccessModal&&pdfSuccessModal.addEventListener("click",e=>{e.target===pdfSuccessModal&&hidePdfSuccessModal()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(modalOverlay.classList.contains("visible")&&hideModal(),pdfSuccessModal&&pdfSuccessModal.classList.contains("visible")&&hidePdfSuccessModal())});const hamburger=document.getElementById("hamburger"),mobileMenu=document.getElementById("mobile-menu");function handleSharedUrl(){const e=window.location.hash;if(!e.startsWith("#playground?mods="))return;const t=e.replace("#playground?mods=","");let n;try{n=JSON.parse(atob(t))}catch(e){return void console.warn("[Glyph] Invalid shared URL payload")}if(!n||!Array.isArray(n.actions)||0===n.actions.length)return;const a=document.getElementById("playground")||document.querySelector(".playground");a&&a.scrollIntoView({behavior:"smooth"});const o=document.querySelector(".playground__input-area");if(o){const e=document.createElement("div");e.className="shared-customization-banner",e.innerHTML=`\n          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>\n          </svg>\n          <span>Viewing shared customization (${n.actions.length} change${1!==n.actions.length?"s":""})</span>\n        `,o.insertBefore(e,o.firstChild)}if(n.template){const e=document.querySelector(`.playground__tab[data-template="${n.template}"]`);e&&!e.classList.contains("playground__tab--active")&&e.click()}function i(e,t){if(t>=e.length)return;if(isProcessingModification)return void setTimeout(()=>i(e,t),1e3);const n=e[t],a=document.getElementById("prompt-input");a&&(a.value=n,applyModifications(n)),setTimeout(()=>i(e,t+1),2e3)}setTimeout(function e(){const t=document.getElementById("preview-frame");t&&t.srcdoc?i(n.actions,0):setTimeout(e,500)},1500)}hamburger.addEventListener("click",()=>{hamburger.classList.toggle("active"),mobileMenu.classList.toggle("visible")}),document.querySelectorAll(".nav__mobile-links a").forEach(e=>{e.addEventListener("click",()=>{hamburger.classList.remove("active"),mobileMenu.classList.remove("visible")})}),document.addEventListener("DOMContentLoaded",()=>{[document.getElementById("glyph-toast"),document.getElementById("session-warning-toast")].forEach(e=>{e&&(e.classList.remove("active","visible"),e.style.display="none",e.setAttribute("aria-hidden","true"))});const e=document.getElementById("api-error-toast");e&&(e.classList.remove("active","visible"),e.style.display="none",e.setAttribute("inert","")),setupDemoModeBanner();const t=checkUrlTemplateParameters();t||initializePreview(),t||handleSharedUrl()}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){const t=this.getAttribute("href");if(!t||"#"===t)return;const n=t.replace("#",""),a=document.getElementById(n)||document.querySelector(t);a&&(e.preventDefault(),a.scrollIntoView({behavior:"smooth",block:"start"}),history.pushState(null,"",t))})});const observerOptions={threshold:.1,rootMargin:"0px 0px -50px 0px"},observer=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(e.target.style.opacity="1",e.target.style.transform="translateY(0)")})},observerOptions);document.querySelectorAll(".feature-card, .pricing-card").forEach(e=>{e.style.opacity="0",e.style.transform="translateY(30px)",e.style.transition="opacity 0.6s ease, transform 0.6s ease",observer.observe(e)});const GLYPH_API=API_URL,airtableState={currentStep:1,apiKey:"",bases:[],selectedBase:null,selectedTable:null,tables:[],fields:[],records:[],description:"",style:"modern",generatedTemplate:null,generatedHtml:""},airtableModalOverlay=document.getElementById("airtable-modal-overlay"),connectAirtableBtn=document.getElementById("connect-airtable"),airtableModalClose=document.getElementById("airtable-modal-close"),airtableBackBtn=document.getElementById("airtable-back-btn"),airtableNextBtn=document.getElementById("airtable-next-btn"),airtableKeyInput=document.getElementById("airtable-key"),airtableBaseSelect=document.getElementById("airtable-base"),airtableTableSelect=document.getElementById("airtable-table"),airtableFieldsContainer=document.getElementById("airtable-fields"),airtableFieldsList=document.getElementById("airtable-fields-list"),airtableDescription=document.getElementById("airtable-description"),airtableStyleBtns=document.querySelectorAll(".airtable-style-btn"),airtablePreviewFrame=document.getElementById("airtable-preview-frame"),airtablePreviewLoading=document.getElementById("airtable-preview-loading"),airtableRefineInput=document.getElementById("airtable-refine-input"),airtableRefineBtn=document.getElementById("airtable-refine-btn"),airtableDownloadPdfBtn=document.getElementById("airtable-download-pdf"),airtableSaveTemplateBtn=document.getElementById("airtable-save-template");function closeAirtableModal(){airtableModalOverlay.classList.remove("visible"),document.body.style.overflow="",resetAirtableState()}function resetAirtableState(){airtableState.currentStep=1,airtableState.apiKey="",airtableState.bases=[],airtableState.selectedBase=null,airtableState.selectedTable=null,airtableState.tables=[],airtableState.fields=[],airtableState.records=[],airtableState.description="",airtableState.style="modern",airtableState.generatedTemplate=null,airtableState.generatedHtml="",airtableState.isDemoMode=!1,airtableState.isDemo=!1,airtableKeyInput.value="",airtableBaseSelect.innerHTML='<option value="">Select a base...</option>',airtableBaseSelect.disabled=!0,airtableTableSelect.innerHTML='<option value="">Select a table...</option>',airtableTableSelect.disabled=!0,airtableFieldsContainer.style.display="none",airtableFieldsList.innerHTML="",airtableDescription.value="",airtableStyleBtns.forEach(e=>e.classList.remove("selected")),airtableStyleBtns[0].classList.add("selected"),airtableDemoBadge.classList.remove("visible"),airtableTokenError.classList.remove("visible");const e=document.querySelector(".airtable-error-toast");e&&e.remove(),goToStep(1)}function goToStep(e){airtableState.currentStep=e,document.querySelectorAll(".airtable-step-content").forEach(t=>{t.classList.remove("active"),parseInt(t.dataset.step)===e&&t.classList.add("active")}),document.querySelectorAll(".airtable-progress__step").forEach(t=>{const n=parseInt(t.dataset.step);t.classList.remove("active","completed"),n===e?t.classList.add("active"):n<e&&t.classList.add("completed")}),document.querySelectorAll(".airtable-progress__connector").forEach((t,n)=>{n<e-1?t.classList.add("completed"):t.classList.remove("completed")}),airtableBackBtn.style.display=e>1?"flex":"none",updateNextButton()}function updateNextButton(){let e="",t=!1;switch(airtableState.currentStep){case 1:e="Connect",t=!airtableKeyInput.value.trim().startsWith("pat");break;case 2:e="Continue",t=!airtableState.selectedTable;break;case 3:e="Generate Template",t=!airtableDescription.value.trim();break;case 4:return e="Done",t=!1,void(airtableNextBtn.style.display="none")}airtableNextBtn.style.display="flex",airtableNextBtn.innerHTML=`${e}<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>`,airtableNextBtn.disabled=t}connectAirtableBtn.addEventListener("click",()=>{airtableModalOverlay.classList.add("visible"),document.body.style.overflow="hidden",airtableKeyInput.focus()}),airtableModalClose.addEventListener("click",closeAirtableModal),airtableModalOverlay.addEventListener("click",e=>{e.target===airtableModalOverlay&&closeAirtableModal()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&airtableModalOverlay.classList.contains("visible")&&closeAirtableModal()});const airtableTokenError=document.getElementById("airtable-token-error"),airtableDemoBadge=document.getElementById("airtable-demo-badge");async function connectToAirtable(){const e=airtableKeyInput.value.trim();if(e){airtableState.apiKey=e,setNextButtonLoading(!0);try{const t=await fetch(`${GLYPH_API}/v1/airtable/connect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:e})});if(t.ok){const e=await t.json();airtableState.bases=e.bases||[],populateBases(airtableState.bases),goToStep(2)}else await connectDirectToAirtable(e)}catch(t){console.warn("Glyph API connection failed, trying direct Airtable:",t),await connectDirectToAirtable(e)}finally{setNextButtonLoading(!1)}}}async function connectDirectToAirtable(e){try{const t=await fetch("https://api.airtable.com/v0/meta/bases",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error("Invalid API key");const n=await t.json();airtableState.bases=n.bases||[],airtableState.isDemoMode=!1,airtableDemoBadge.classList.remove("visible"),populateBases(airtableState.bases),goToStep(2)}catch(e){console.error("Airtable connection failed:",e),showConnectionErrorToast()}}function showConnectionErrorToast(){const e=document.querySelector(".airtable-error-toast");e&&e.remove();const t=document.createElement("div");t.className="airtable-error-toast",t.innerHTML='\n        <div class="airtable-error-toast__message">\n          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>\n          </svg>\n          <span>Could not connect to Airtable. Please check your token and try again.</span>\n        </div>\n        <div class="airtable-error-toast__actions">\n          <button class="airtable-error-toast__btn airtable-error-toast__btn--secondary" id="airtable-retry-btn">Try Again</button>\n          <button class="airtable-error-toast__btn airtable-error-toast__btn--primary" id="airtable-demo-btn">Continue with Demo Data</button>\n        </div>\n      ',document.querySelector(".airtable-modal").appendChild(t),setTimeout(()=>t.classList.add("visible"),10),document.getElementById("airtable-retry-btn").addEventListener("click",()=>{t.classList.remove("visible"),setTimeout(()=>t.remove(),300),airtableKeyInput.focus()}),document.getElementById("airtable-demo-btn").addEventListener("click",()=>{t.classList.remove("visible"),setTimeout(()=>t.remove(),300),enterDemoMode()})}function enterDemoMode(){airtableState.isDemoMode=!0,airtableDemoBadge.classList.add("visible"),showAirtableToast("Using demo data for preview","warning"),loadDemoData()}function showAirtableToast(e,t="success"){const n=document.querySelector(".airtable-toast");n&&n.remove();const a=document.createElement("div");a.className=`airtable-toast airtable-toast--${t}`,a.innerHTML=`\n        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n          ${"success"===t?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>':"info"===t?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'}\n        </svg>\n        <span>${e}</span>\n      `,document.querySelector(".airtable-modal").appendChild(a),setTimeout(()=>a.classList.add("visible"),10),setTimeout(()=>{a.classList.remove("visible"),setTimeout(()=>a.remove(),300)},3e3)}function loadDemoData(){airtableState.bases=[{id:"appDemo123",name:"CRM Database"},{id:"appDemo456",name:"Project Tracker"},{id:"appDemo789",name:"Inventory Management"}],populateBases(airtableState.bases),airtableState.demoTables={appDemo123:[{id:"tblClients",name:"Clients",fields:[{name:"Name",type:"singleLineText"},{name:"Company",type:"singleLineText"},{name:"Email",type:"email"},{name:"Phone",type:"phoneNumber"},{name:"Status",type:"singleSelect"},{name:"Deal Value",type:"currency"}]},{id:"tblDeals",name:"Deals",fields:[{name:"Deal Name",type:"singleLineText"},{name:"Client",type:"linkedRecord"},{name:"Value",type:"currency"},{name:"Stage",type:"singleSelect"},{name:"Close Date",type:"date"}]}],appDemo456:[{id:"tblProjects",name:"Projects",fields:[{name:"Project Name",type:"singleLineText"},{name:"Description",type:"multilineText"},{name:"Owner",type:"collaborator"},{name:"Start Date",type:"date"},{name:"Due Date",type:"date"},{name:"Status",type:"singleSelect"},{name:"Budget",type:"currency"}]},{id:"tblTasks",name:"Tasks",fields:[{name:"Task",type:"singleLineText"},{name:"Project",type:"linkedRecord"},{name:"Assignee",type:"collaborator"},{name:"Priority",type:"singleSelect"},{name:"Complete",type:"checkbox"}]}],appDemo789:[{id:"tblProducts",name:"Products",fields:[{name:"Product Name",type:"singleLineText"},{name:"SKU",type:"singleLineText"},{name:"Category",type:"singleSelect"},{name:"Price",type:"currency"},{name:"Quantity",type:"number"},{name:"Supplier",type:"linkedRecord"}]}]},airtableState.demoRecords={tblClients:[{id:"rec1",fields:{Name:"John Smith",Company:"Acme Corp",Email:"john@acme.com",Phone:"+1 555-0123",Status:"Active","Deal Value":5e4}},{id:"rec2",fields:{Name:"Sarah Johnson",Company:"TechStart Inc",Email:"sarah@techstart.io",Phone:"+1 555-0456",Status:"Prospect","Deal Value":25e3}},{id:"rec3",fields:{Name:"Mike Chen",Company:"Global Solutions",Email:"mike@globalsol.com",Phone:"+1 555-0789",Status:"Active","Deal Value":75e3}}],tblProjects:[{id:"rec1",fields:{"Project Name":"Website Redesign",Description:"Complete overhaul of company website",Owner:"Alice","Start Date":"2024-01-15","Due Date":"2024-03-30",Status:"In Progress",Budget:45e3}},{id:"rec2",fields:{"Project Name":"Mobile App Launch",Description:"Launch iOS and Android apps",Owner:"Bob","Start Date":"2024-02-01","Due Date":"2024-06-15",Status:"Planning",Budget:12e4}}],tblProducts:[{id:"rec1",fields:{"Product Name":"Premium Widget",SKU:"WDG-001",Category:"Electronics",Price:299.99,Quantity:150,Supplier:"SupplyCo"}},{id:"rec2",fields:{"Product Name":"Basic Gadget",SKU:"GDG-002",Category:"Electronics",Price:49.99,Quantity:500,Supplier:"TechParts"}}]},airtableState.isDemo=!0,airtableState.isDemoMode=!0,airtableDemoBadge.classList.add("visible"),goToStep(2)}function populateBases(e){airtableBaseSelect.innerHTML='<option value="">Select a base...</option>',e.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,airtableBaseSelect.appendChild(t)}),airtableBaseSelect.disabled=!1}async function fetchTablesDirectly(e){try{const t=await fetch(`https://api.airtable.com/v0/meta/bases/${e}/tables`,{headers:{Authorization:`Bearer ${airtableState.apiKey}`}});if(!t.ok){const e=await t.text();return console.error("Failed to fetch tables:",t.status,e),void(airtableState.tables=[])}const n=await t.json();airtableState.tables=n.tables||[]}catch(e){console.error("Failed to fetch tables:",e),airtableState.tables=[]}}function populateTables(e){airtableTableSelect.innerHTML='<option value="">Select a table...</option>',e.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,airtableTableSelect.appendChild(t)}),airtableTableSelect.disabled=!1}function displayFields(e){airtableFieldsList.innerHTML="",e.forEach(e=>{const t=document.createElement("span");t.className="airtable-field-badge",t.innerHTML=`\n          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>\n          </svg>\n          ${e.name}\n        `,airtableFieldsList.appendChild(t)}),airtableFieldsContainer.style.display="flex"}async function fetchSampleRecords(){if(airtableState.selectedBase&&airtableState.selectedTable){if(airtableState.isDemo&&airtableState.demoRecords){const e=airtableState.selectedTable.id;return void(airtableState.records=airtableState.demoRecords[e]||[])}try{const e=airtableState.selectedBase.id,t=(airtableState.selectedTable.id,await fetch(`https://api.airtable.com/v0/${e}/${encodeURIComponent(airtableState.selectedTable.name)}?maxRecords=3`,{headers:{Authorization:`Bearer ${airtableState.apiKey}`}}));if(t.ok){const e=await t.json();airtableState.records=e.records||[]}}catch(e){console.warn("Failed to fetch sample records:",e),airtableState.records=[]}}}function prepareDescriptionStep(){document.getElementById("step3-fields-preview").innerHTML=airtableState.fields.map(e=>`<div class="airtable-data-row"><span class="airtable-data-label">${e.name}</span><span class="airtable-data-value">${e.type}</span></div>`).join("")}async function generateTemplate(){if(airtableState.description=airtableDescription.value.trim(),airtableState.description){setNextButtonLoading(!0),goToStep(4),showPreviewLoading(!0);try{const e=await fetch(`${GLYPH_API}/v1/templates/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({airtable:{apiKey:airtableState.apiKey,baseId:airtableState.selectedBase.id,tableId:airtableState.selectedTable.id,tableName:airtableState.selectedTable.name},description:airtableState.description,style:airtableState.style,fields:airtableState.fields,sampleRecords:airtableState.records})});if(e.ok){const t=await e.json();airtableState.generatedTemplate=t.template,airtableState.generatedHtml=t.html||t.preview,renderAirtablePreview(airtableState.generatedHtml),displayDataPreview()}else generateDemoTemplate()}catch(e){console.warn("Template generation failed, using demo:",e),generateDemoTemplate()}finally{setNextButtonLoading(!1),showPreviewLoading(!1)}}}function generateDemoTemplate(){const e="modern"===airtableState.style?"#1E3A5F":"professional"===airtableState.style?"#1E40AF":"#6B7280",t="modern"===airtableState.style?"#64748b":"professional"===airtableState.style?"#475569":"#9CA3AF",n="minimal"===airtableState.style?"#fafafa":"#f9fafb",a=airtableState.records[0]?.fields||{},o=airtableState.fields.map(e=>e.name).slice(0,5),i=(airtableState.description||"").toLowerCase(),s=airtableState.selectedBase?.name||"Your Company",r=(new Date).toLocaleDateString(),l=new Date(Date.now()+2592e6).toLocaleDateString();let d;switch(detectDocumentType(i)){case"invoice":d=generateInvoiceTemplate(e,t,n,a,o,s,r,l);break;case"receipt":d=generateReceiptTemplate(e,t,n,a,o,s,r);break;case"packing":d=generatePackingSlipTemplate(e,t,n,a,o,s,r);break;case"report":d=generateReportTemplate(e,t,n,a,o,s,r);break;default:d=generateDataTableTemplate(e,t,n,a,o,s,r)}airtableState.generatedHtml=d,renderAirtablePreview(d),displayDataPreview()}function detectDocumentType(e){return/\b(invoice|invoices|billing|bill)\b/i.test(e)?"invoice":/\b(receipt|receipts|payment\s+confirmation|paid)\b/i.test(e)?"receipt":/\b(packing|shipping|slip|shipment|delivery)\b/i.test(e)?"packing":/\b(report|summary|analysis|overview)\b/i.test(e)?"report":"data"}function findFieldValue(e,t,n){const a=Object.keys(e).map(e=>({orig:e,lower:e.toLowerCase()}));for(const n of t){const t=a.find(e=>e.lower.includes(n.toLowerCase()));if(t&&e[t.orig])return e[t.orig]}return n}function generateInvoiceTemplate(e,t,n,a,o,i,s,r){const l=findFieldValue(a,["name","customer","client","company","contact"],"Customer Name"),d=findFieldValue(a,["email","mail"],"customer@example.com"),c=findFieldValue(a,["address","location","street"],"123 Main Street"),p=findFieldValue(a,["item","product","service","description","title"],"Professional Services"),m=findFieldValue(a,["qty","quantity","units","count"],"1"),u=findFieldValue(a,["rate","price","cost","amount"],"500.00");return`<!DOCTYPE html>\n<html>\n<head>\n<style>\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body { font-family: system-ui, -apple-system, sans-serif; font-size: 12px; color: #1a1a1a; padding: 40px; background: white; }\n  .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; }\n  .company { font-size: 24px; font-weight: 700; color: ${e}; }\n  .company-details { font-size: 11px; color: ${t}; margin-top: 4px; }\n  .doc-title { font-size: 32px; font-weight: 700; color: ${e}; text-transform: uppercase; letter-spacing: 0.05em; }\n  .invoice-meta { display: flex; gap: 40px; margin-bottom: 32px; }\n  .meta-block { }\n  .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 4px; }\n  .meta-value { font-weight: 600; font-size: 14px; }\n  .addresses { display: flex; gap: 60px; margin-bottom: 32px; }\n  .address-block { }\n  .address-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 8px; font-weight: 600; }\n  .address-content { line-height: 1.6; }\n  .address-name { font-weight: 600; }\n  .line-items { width: 100%; border-collapse: collapse; margin-bottom: 24px; }\n  .line-items th { background: ${e}; color: white; padding: 12px 16px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }\n  .line-items th:last-child, .line-items td:last-child { text-align: right; }\n  .line-items th:nth-child(2), .line-items td:nth-child(2),\n  .line-items th:nth-child(3), .line-items td:nth-child(3) { text-align: center; }\n  .line-items td { padding: 14px 16px; border-bottom: 1px solid #e5e5e5; }\n  .totals { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; margin-top: 16px; }\n  .total-row { display: flex; gap: 40px; font-size: 13px; }\n  .total-label { color: ${t}; min-width: 80px; }\n  .total-value { font-weight: 500; min-width: 100px; text-align: right; }\n  .total-final { font-size: 16px; font-weight: 700; color: ${e}; padding-top: 8px; border-top: 2px solid ${e}; }\n  .footer { margin-top: 48px; padding-top: 16px; border-top: 1px solid #e5e5e5; text-align: center; color: #999; font-size: 10px; }\n  .notes { background: ${n}; padding: 16px; border-radius: 8px; margin-top: 32px; }\n  .notes-title { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 8px; }\n</style>\n</head>\n<body>\n  <div class="header">\n    <div>\n      <div class="company">${i}</div>\n      <div class="company-details">123 Business Ave, Suite 100<br>contact@company.com</div>\n    </div>\n    <div class="doc-title">Invoice</div>\n  </div>\n\n  <div class="invoice-meta">\n    <div class="meta-block">\n      <div class="meta-label">Invoice #</div>\n      <div class="meta-value">INV-001</div>\n    </div>\n    <div class="meta-block">\n      <div class="meta-label">Date</div>\n      <div class="meta-value">${s}</div>\n    </div>\n    <div class="meta-block">\n      <div class="meta-label">Due Date</div>\n      <div class="meta-value">${r}</div>\n    </div>\n  </div>\n\n  <div class="addresses">\n    <div class="address-block">\n      <div class="address-label">Bill To</div>\n      <div class="address-content">\n        <div class="address-name">${l}</div>\n        <div>${c}</div>\n        <div>${d}</div>\n      </div>\n    </div>\n  </div>\n\n  <table class="line-items">\n    <thead>\n      <tr>\n        <th>Description</th>\n        <th>Qty</th>\n        <th>Rate</th>\n        <th>Amount</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>${p}</td>\n        <td>${m}</td>\n        <td>$${parseFloat(u).toFixed(2)}</td>\n        <td>$${(parseFloat(m)*parseFloat(u)||500).toFixed(2)}</td>\n      </tr>\n      <tr>\n        <td>Additional Services</td>\n        <td>2</td>\n        <td>$250.00</td>\n        <td>$500.00</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <div class="totals">\n    <div class="total-row">\n      <span class="total-label">Subtotal</span>\n      <span class="total-value">$${1e3.toFixed(2)}</span>\n    </div>\n    <div class="total-row">\n      <span class="total-label">Tax (10%)</span>\n      <span class="total-value">$${100..toFixed(2)}</span>\n    </div>\n    <div class="total-row total-final">\n      <span class="total-label">Total</span>\n      <span class="total-value">$${1100..toFixed(2)}</span>\n    </div>\n  </div>\n\n  <div class="notes">\n    <div class="notes-title">Payment Terms</div>\n    <div>Payment is due within 30 days. Please include invoice number with payment.</div>\n  </div>\n\n  <div class="footer">\n    Generated with Glyph - AI-Powered PDF Customization\n  </div>\n</body>\n</html>`}function generateReceiptTemplate(e,t,n,a,o,i,s){const r=findFieldValue(a,["name","customer","client","contact"],"Customer Name"),l=(findFieldValue(a,["email","mail"],"customer@example.com"),findFieldValue(a,["item","product","service","description"],"Product/Service"));return`<!DOCTYPE html>\n<html>\n<head>\n<style>\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body { font-family: system-ui, -apple-system, sans-serif; font-size: 12px; color: #1a1a1a; padding: 40px; background: white; max-width: 400px; margin: 0 auto; }\n  .header { text-align: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid ${e}; }\n  .company { font-size: 24px; font-weight: 700; color: ${e}; margin-bottom: 4px; }\n  .company-details { font-size: 11px; color: ${t}; }\n  .doc-title { font-size: 20px; font-weight: 700; color: ${e}; text-transform: uppercase; letter-spacing: 0.1em; margin-top: 16px; }\n  .receipt-meta { background: ${n}; padding: 16px; border-radius: 8px; margin-bottom: 24px; }\n  .meta-row { display: flex; justify-content: space-between; margin-bottom: 8px; }\n  .meta-row:last-child { margin-bottom: 0; }\n  .meta-label { color: ${t}; font-size: 11px; }\n  .meta-value { font-weight: 600; }\n  .items { margin-bottom: 24px; }\n  .item-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e5e5; }\n  .item-name { font-weight: 500; }\n  .item-price { font-weight: 600; }\n  .totals { border-top: 2px solid #e5e5e5; padding-top: 16px; }\n  .total-row { display: flex; justify-content: space-between; margin-bottom: 8px; }\n  .total-final { font-size: 18px; font-weight: 700; color: ${e}; margin-top: 12px; padding-top: 12px; border-top: 2px solid ${e}; }\n  .paid-stamp { text-align: center; margin: 24px 0; padding: 12px; border: 3px solid #22c55e; border-radius: 8px; color: #22c55e; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; }\n  .footer { margin-top: 32px; text-align: center; color: #999; font-size: 10px; }\n  .thank-you { font-size: 14px; color: ${e}; font-weight: 600; margin-bottom: 8px; }\n</style>\n</head>\n<body>\n  <div class="header">\n    <div class="company">${i}</div>\n    <div class="company-details">123 Business Ave | contact@company.com</div>\n    <div class="doc-title">Receipt</div>\n  </div>\n\n  <div class="receipt-meta">\n    <div class="meta-row">\n      <span class="meta-label">Receipt #</span>\n      <span class="meta-value">RCP-001</span>\n    </div>\n    <div class="meta-row">\n      <span class="meta-label">Date</span>\n      <span class="meta-value">${s}</span>\n    </div>\n    <div class="meta-row">\n      <span class="meta-label">Customer</span>\n      <span class="meta-value">${r}</span>\n    </div>\n    <div class="meta-row">\n      <span class="meta-label">Payment Method</span>\n      <span class="meta-value">${findFieldValue(a,["payment","method","card"],"Credit Card")}</span>\n    </div>\n  </div>\n\n  <div class="items">\n    <div class="item-row">\n      <span class="item-name">${l}</span>\n      <span class="item-price">$500.00</span>\n    </div>\n    <div class="item-row">\n      <span class="item-name">Service Fee</span>\n      <span class="item-price">$50.00</span>\n    </div>\n  </div>\n\n  <div class="totals">\n    <div class="total-row">\n      <span>Subtotal</span>\n      <span>$550.00</span>\n    </div>\n    <div class="total-row">\n      <span>Tax</span>\n      <span>$55.00</span>\n    </div>\n    <div class="total-row total-final">\n      <span>Total Paid</span>\n      <span>$605.00</span>\n    </div>\n  </div>\n\n  <div class="paid-stamp">Paid</div>\n\n  <div class="footer">\n    <div class="thank-you">Thank you for your business!</div>\n    <div>Generated with Glyph - AI-Powered PDF Customization</div>\n  </div>\n</body>\n</html>`}function generatePackingSlipTemplate(e,t,n,a,o,i,s){const r=findFieldValue(a,["name","customer","client","contact","recipient"],"Recipient Name"),l=findFieldValue(a,["address","location","street","shipping"],"456 Delivery Lane"),d=findFieldValue(a,["city","town"],"Anytown"),c=findFieldValue(a,["item","product","sku","description"],"Product Item"),p=findFieldValue(a,["qty","quantity","units","count"],"2");return`<!DOCTYPE html>\n<html>\n<head>\n<style>\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body { font-family: system-ui, -apple-system, sans-serif; font-size: 12px; color: #1a1a1a; padding: 40px; background: white; }\n  .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 3px solid ${e}; }\n  .company { font-size: 24px; font-weight: 700; color: ${e}; }\n  .doc-title { font-size: 28px; font-weight: 700; color: ${e}; text-transform: uppercase; letter-spacing: 0.05em; }\n  .shipping-info { display: flex; gap: 60px; margin-bottom: 32px; }\n  .address-block { flex: 1; }\n  .address-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 8px; font-weight: 600; padding-bottom: 8px; border-bottom: 1px solid #e5e5e5; }\n  .address-content { line-height: 1.8; padding: 12px; background: ${n}; border-radius: 8px; }\n  .address-name { font-weight: 700; font-size: 14px; }\n  .order-meta { background: ${n}; padding: 16px 24px; border-radius: 8px; margin-bottom: 32px; display: flex; gap: 40px; }\n  .meta-block { }\n  .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 4px; }\n  .meta-value { font-weight: 600; font-size: 14px; }\n  .items-table { width: 100%; border-collapse: collapse; }\n  .items-table th { background: ${e}; color: white; padding: 12px 16px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }\n  .items-table th:last-child { text-align: center; width: 100px; }\n  .items-table td { padding: 14px 16px; border-bottom: 1px solid #e5e5e5; }\n  .items-table td:last-child { text-align: center; font-weight: 600; }\n  .item-sku { font-size: 10px; color: ${t}; margin-top: 2px; }\n  .checkbox { width: 16px; height: 16px; border: 2px solid ${e}; border-radius: 3px; display: inline-block; margin-right: 8px; vertical-align: middle; }\n  .summary { margin-top: 24px; text-align: right; font-size: 14px; }\n  .summary-value { font-weight: 700; color: ${e}; }\n  .footer { margin-top: 48px; padding-top: 16px; border-top: 1px solid #e5e5e5; text-align: center; color: #999; font-size: 10px; }\n  .signature-line { margin-top: 48px; display: flex; gap: 40px; }\n  .sig-block { flex: 1; }\n  .sig-label { font-size: 10px; text-transform: uppercase; color: ${t}; margin-bottom: 8px; }\n  .sig-line { border-bottom: 1px solid #333; height: 40px; }\n</style>\n</head>\n<body>\n  <div class="header">\n    <div class="company">${i}</div>\n    <div class="doc-title">Packing Slip</div>\n  </div>\n\n  <div class="order-meta">\n    <div class="meta-block">\n      <div class="meta-label">Order #</div>\n      <div class="meta-value">ORD-12345</div>\n    </div>\n    <div class="meta-block">\n      <div class="meta-label">Ship Date</div>\n      <div class="meta-value">${s}</div>\n    </div>\n    <div class="meta-block">\n      <div class="meta-label">Carrier</div>\n      <div class="meta-value">Standard Shipping</div>\n    </div>\n  </div>\n\n  <div class="shipping-info">\n    <div class="address-block">\n      <div class="address-label">Ship From</div>\n      <div class="address-content">\n        <div class="address-name">${i}</div>\n        <div>123 Warehouse Blvd</div>\n        <div>Distribution Center, ST 12345</div>\n      </div>\n    </div>\n    <div class="address-block">\n      <div class="address-label">Ship To</div>\n      <div class="address-content">\n        <div class="address-name">${r}</div>\n        <div>${l}</div>\n        <div>${d}, ST 67890</div>\n      </div>\n    </div>\n  </div>\n\n  <table class="items-table">\n    <thead>\n      <tr>\n        <th>Item Description</th>\n        <th>Qty</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>\n          <span class="checkbox"></span>${c}\n          <div class="item-sku">SKU: ITEM-001</div>\n        </td>\n        <td>${p}</td>\n      </tr>\n      <tr>\n        <td>\n          <span class="checkbox"></span>Packaging Materials\n          <div class="item-sku">SKU: PKG-001</div>\n        </td>\n        <td>1</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <div class="summary">\n    Total Items: <span class="summary-value">${parseInt(p)+1}</span>\n  </div>\n\n  <div class="signature-line">\n    <div class="sig-block">\n      <div class="sig-label">Packed By</div>\n      <div class="sig-line"></div>\n    </div>\n    <div class="sig-block">\n      <div class="sig-label">Date</div>\n      <div class="sig-line"></div>\n    </div>\n  </div>\n\n  <div class="footer">\n    Generated with Glyph - AI-Powered PDF Customization\n  </div>\n</body>\n</html>`}function generateReportTemplate(e,t,n,a,o,i,s){return`<!DOCTYPE html>\n<html>\n<head>\n<style>\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body { font-family: system-ui, -apple-system, sans-serif; font-size: 12px; color: #1a1a1a; padding: 40px; background: white; }\n  .header { margin-bottom: 32px; padding-bottom: 20px; border-bottom: 3px solid ${e}; }\n  .company { font-size: 14px; color: ${t}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.1em; }\n  .doc-title { font-size: 28px; font-weight: 700; color: ${e}; }\n  .subtitle { font-size: 14px; color: ${t}; margin-top: 8px; }\n  .meta-bar { display: flex; gap: 32px; background: ${n}; padding: 16px 24px; border-radius: 8px; margin-bottom: 32px; }\n  .meta-item { }\n  .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 4px; }\n  .meta-value { font-weight: 600; }\n  .section { margin-bottom: 32px; }\n  .section-title { font-size: 16px; font-weight: 700; color: ${e}; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid ${e}; }\n  .summary-cards { display: flex; gap: 16px; margin-bottom: 32px; }\n  .summary-card { flex: 1; background: ${n}; padding: 20px; border-radius: 8px; text-align: center; }\n  .card-value { font-size: 28px; font-weight: 700; color: ${e}; }\n  .card-label { font-size: 11px; color: ${t}; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 4px; }\n  .data-table { width: 100%; border-collapse: collapse; }\n  .data-table th { background: ${e}; color: white; padding: 12px 16px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }\n  .data-table td { padding: 12px 16px; border-bottom: 1px solid #e5e5e5; }\n  .data-table tr:nth-child(even) { background: ${n}; }\n  .footer { margin-top: 48px; padding-top: 16px; border-top: 1px solid #e5e5e5; text-align: center; color: #999; font-size: 10px; }\n  .notes { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 16px; margin-top: 24px; }\n  .notes-title { font-weight: 600; margin-bottom: 4px; }\n</style>\n</head>\n<body>\n  <div class="header">\n    <div class="company">${i}</div>\n    <div class="doc-title">${findFieldValue(a,["title","name","report","subject"],"Data Report")}</div>\n    <div class="subtitle">Comprehensive data overview and analysis</div>\n  </div>\n\n  <div class="meta-bar">\n    <div class="meta-item">\n      <div class="meta-label">Report Date</div>\n      <div class="meta-value">${s}</div>\n    </div>\n    <div class="meta-item">\n      <div class="meta-label">Period</div>\n      <div class="meta-value">Current Quarter</div>\n    </div>\n    <div class="meta-item">\n      <div class="meta-label">Status</div>\n      <div class="meta-value">Final</div>\n    </div>\n  </div>\n\n  <div class="section">\n    <div class="section-title">Summary</div>\n    <div class="summary-cards">\n      <div class="summary-card">\n        <div class="card-value">${o.length}</div>\n        <div class="card-label">Data Fields</div>\n      </div>\n      <div class="summary-card">\n        <div class="card-value">${Object.keys(a).length}</div>\n        <div class="card-label">Values</div>\n      </div>\n      <div class="summary-card">\n        <div class="card-value">100%</div>\n        <div class="card-label">Complete</div>\n      </div>\n    </div>\n  </div>\n\n  <div class="section">\n    <div class="section-title">Data Overview</div>\n    <table class="data-table">\n      <thead>\n        <tr>\n          <th>Field</th>\n          <th>Value</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${o.map(e=>`\n        <tr>\n          <td>${e}</td>\n          <td>${a[e]||"{{"+e+"}}"}</td>\n        </tr>\n        `).join("")}\n      </tbody>\n    </table>\n  </div>\n\n  <div class="notes">\n    <div class="notes-title">Note</div>\n    <div>This report was automatically generated from your Airtable data. You can customize the layout and add additional sections using Glyph's AI-powered editor.</div>\n  </div>\n\n  <div class="footer">\n    Generated with Glyph - AI-Powered PDF Customization\n  </div>\n</body>\n</html>`}function generateDataTableTemplate(e,t,n,a,o,i,s){return`<!DOCTYPE html>\n<html>\n<head>\n<style>\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body { font-family: system-ui, -apple-system, sans-serif; font-size: 12px; color: #1a1a1a; padding: 32px; background: white; }\n  .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 20px; border-bottom: 3px solid ${e}; margin-bottom: 24px; }\n  .company { font-size: 20px; font-weight: 700; color: ${e}; }\n  .doc-title { font-size: 28px; font-weight: 700; color: ${e}; text-transform: uppercase; letter-spacing: 0.05em; }\n  .meta { display: flex; gap: 40px; background: ${n}; padding: 16px 24px; border-radius: 8px; margin-bottom: 24px; }\n  .meta-item { }\n  .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 4px; }\n  .meta-value { font-weight: 600; font-size: 14px; }\n  .section { margin-bottom: 24px; }\n  .section-title { font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; color: ${e}; margin-bottom: 12px; font-weight: 600; }\n  table { width: 100%; border-collapse: collapse; }\n  th { background: ${e}; color: white; padding: 12px 16px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }\n  td { padding: 14px 16px; border-bottom: 1px solid #e5e5e5; }\n  .field-name { color: ${t}; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; }\n  .field-value { font-weight: 500; margin-top: 4px; }\n  .footer { margin-top: 32px; padding-top: 16px; border-top: 1px solid #e5e5e5; text-align: center; color: #999; font-size: 10px; }\n</style>\n</head>\n<body>\n  <div class="header">\n    <div class="company">${i}</div>\n    <div class="doc-title">Document</div>\n  </div>\n\n  <div class="meta">\n    <div class="meta-item">\n      <div class="meta-label">Table</div>\n      <div class="meta-value">${airtableState.selectedTable?.name||"Data"}</div>\n    </div>\n    <div class="meta-item">\n      <div class="meta-label">Generated</div>\n      <div class="meta-value">${s}</div>\n    </div>\n    <div class="meta-item">\n      <div class="meta-label">Style</div>\n      <div class="meta-value">${airtableState.style.charAt(0).toUpperCase()+airtableState.style.slice(1)}</div>\n    </div>\n  </div>\n\n  <div class="section">\n    <div class="section-title">Data Fields</div>\n    <table>\n      <thead>\n        <tr>\n          <th>Field</th>\n          <th>Value</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${o.map(e=>`\n        <tr>\n          <td><div class="field-name">${e}</div></td>\n          <td><div class="field-value">${a[e]||"{{"+e+"}}"}</div></td>\n        </tr>\n        `).join("")}\n      </tbody>\n    </table>\n  </div>\n\n  <div class="footer">\n    Generated with Glyph - AI-Powered PDF Customization\n  </div>\n</body>\n</html>`}function renderAirtablePreview(e){const t=airtablePreviewFrame.contentDocument||airtablePreviewFrame.contentWindow.document;t.open(),t.write(e),t.close()}function displayDataPreview(){const e=document.getElementById("airtable-data-preview"),t=airtableState.records[0]?.fields||{},n=airtableState.fields.slice(0,4).map(e=>e.name);e.innerHTML=n.map(e=>`<div class="airtable-data-row">\n          <span class="airtable-data-label">${e}</span>\n          <span class="airtable-data-value">${truncateValue(t[e])}</span>\n        </div>`).join("")}function truncateValue(e){if(!e)return"-";const t=String(e);return t.length>20?t.substring(0,20)+"...":t}function showPreviewLoading(e){airtablePreviewLoading.classList.toggle("visible",e)}function setNextButtonLoading(e){airtableNextBtn.classList.toggle("loading",e),airtableNextBtn.disabled=e}function simulateRefinement(e){let t=airtableState.generatedHtml;const n=e.toLowerCase();n.includes("blue")?t=t.replace(/#1E3A5F|#1E40AF|#6B7280/g,"#3B82F6"):n.includes("red")?t=t.replace(/#1E3A5F|#1E40AF|#6B7280/g,"#EF4444"):n.includes("green")?t=t.replace(/#1E3A5F|#1E40AF|#6B7280/g,"#22C55E"):n.includes("purple")?t=t.replace(/#1E3A5F|#1E40AF|#6B7280/g,"#8B5CF6"):n.includes("orange")&&(t=t.replace(/#1E3A5F|#1E40AF|#6B7280/g,"#F97316")),airtableState.generatedHtml=t,renderAirtablePreview(t)}airtableKeyInput.addEventListener("input",()=>{const e=airtableKeyInput.value.trim();e.length>0&&!e.startsWith("pat")?airtableTokenError.classList.add("visible"):airtableTokenError.classList.remove("visible"),updateNextButton()}),airtableDescription.addEventListener("input",updateNextButton),airtableStyleBtns.forEach(e=>{e.addEventListener("click",()=>{airtableStyleBtns.forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),airtableState.style=e.dataset.style,document.getElementById("info-style").textContent=e.dataset.style.charAt(0).toUpperCase()+e.dataset.style.slice(1)})}),airtableBackBtn.addEventListener("click",()=>{airtableState.currentStep>1&&goToStep(airtableState.currentStep-1)}),airtableNextBtn.addEventListener("click",async()=>{switch(airtableState.currentStep){case 1:await connectToAirtable();break;case 2:prepareDescriptionStep(),goToStep(3);break;case 3:await generateTemplate()}}),airtableBaseSelect.addEventListener("change",async e=>{const t=e.target.value;if(!t)return airtableTableSelect.innerHTML='<option value="">Select a table...</option>',airtableTableSelect.disabled=!0,airtableFieldsContainer.style.display="none",airtableState.selectedBase=null,airtableState.selectedTable=null,void updateNextButton();if(airtableState.selectedBase=airtableState.bases.find(e=>e.id===t),document.getElementById("info-base").textContent=airtableState.selectedBase?.name||"-",airtableTableSelect.innerHTML='<option value="">Loading tables...</option>',airtableTableSelect.disabled=!0,airtableState.isDemo&&airtableState.demoTables[t])return airtableState.tables=airtableState.demoTables[t],void populateTables(airtableState.tables);try{const e=await fetch(`${GLYPH_API}/v1/airtable/bases/${t}/tables`,{headers:{Authorization:`Bearer ${airtableState.apiKey}`}});if(e.ok){const t=await e.json();airtableState.tables=t.tables||[]}else await fetchTablesDirectly(t)}catch(e){console.warn("Glyph API failed, trying direct Airtable:",e),await fetchTablesDirectly(t)}populateTables(airtableState.tables)}),airtableTableSelect.addEventListener("change",async e=>{const t=e.target.value;if(!t)return airtableFieldsContainer.style.display="none",airtableState.selectedTable=null,airtableState.fields=[],void updateNextButton();airtableState.selectedTable=airtableState.tables.find(e=>e.id===t),document.getElementById("info-table").textContent=airtableState.selectedTable?.name||"-",airtableState.fields=airtableState.selectedTable?.fields||[],displayFields(airtableState.fields),await fetchSampleRecords(),updateNextButton()}),airtableRefineBtn.addEventListener("click",async()=>{const e=airtableRefineInput.value.trim();if(e){airtableRefineBtn.disabled=!0,airtableRefineBtn.textContent="Refining...",showPreviewLoading(!0);try{const t=await fetch(`${GLYPH_API}/v1/templates/refine`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({template:airtableState.generatedTemplate,html:airtableState.generatedHtml,modification:e,data:airtableState.records[0]?.fields||{}})});if(t.ok){const e=await t.json();airtableState.generatedHtml=e.html||e.preview,renderAirtablePreview(airtableState.generatedHtml)}else simulateRefinement(e)}catch(t){console.warn("Refinement failed, simulating:",t),simulateRefinement(e)}finally{airtableRefineBtn.disabled=!1,airtableRefineBtn.textContent="Refine",showPreviewLoading(!1),airtableRefineInput.value=""}}}),airtableRefineInput.addEventListener("keypress",e=>{"Enter"===e.key&&airtableRefineBtn.click()}),airtableDownloadPdfBtn.addEventListener("click",async()=>{airtableDownloadPdfBtn.classList.add("loading");try{const e=await fetch(`${GLYPH_API}/v1/pdf`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({html:airtableState.generatedHtml})});if(e.ok){const t=await e.blob(),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=`${airtableState.selectedTable?.name||"document"}.pdf`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}else alert("PDF generation requires an API key. Sign up at dashboard.glyph.you")}catch(e){console.error("PDF download failed:",e),alert("PDF generation requires an API key. Sign up at dashboard.glyph.you")}finally{airtableDownloadPdfBtn.classList.remove("loading")}}),airtableSaveTemplateBtn.addEventListener("click",()=>{alert("Template saving requires an account. Sign up at dashboard.glyph.you to save and manage your templates.")});const batchViewSelect=document.getElementById("batch-view-select"),batchFilenameInput=document.getElementById("batch-filename"),batchRecordCount=document.getElementById("batch-record-count"),batchGenerateBtn=document.getElementById("batch-generate-btn"),batchBtnText=document.getElementById("batch-btn-text"),batchProgress=document.getElementById("batch-progress"),batchProgressFill=document.getElementById("batch-progress-fill"),batchCompleted=document.getElementById("batch-completed"),batchTotal=document.getElementById("batch-total");let batchJobId=null,batchPollInterval=null;async function loadBatchViews(){if(airtableState.apiKey&&airtableState.selectedBase&&airtableState.selectedTable){try{const e=new URLSearchParams({apiKey:airtableState.apiKey,baseId:airtableState.selectedBase.id,tableId:airtableState.selectedTable.id}),t=await fetch(`${GLYPH_API}/v1/templates/views?${e}`);if(t.ok){const e=await t.json();batchViewSelect.innerHTML='<option value="">All records</option>',(e.views||[]).forEach(e=>{const t=document.createElement("option");t.value=e.name,t.textContent=e.name,batchViewSelect.appendChild(t)})}}catch(e){console.warn("Failed to load views:",e)}airtableState.selectedTable&&(batchFilenameInput.value=`${airtableState.selectedTable.name.toLowerCase().replace(/\s+/g,"-")}-{{fields.Name}}.pdf`),await updateRecordCount()}}async function updateRecordCount(){if(!airtableState.apiKey||!airtableState.selectedBase||!airtableState.selectedTable)return batchRecordCount.textContent="0",void(batchGenerateBtn.disabled=!0);try{const e=new URLSearchParams({apiKey:airtableState.apiKey,baseId:airtableState.selectedBase.id,tableId:airtableState.selectedTable.id});batchViewSelect.value&&e.append("view",batchViewSelect.value);const t=await fetch(`${GLYPH_API}/v1/templates/count?${e}`);if(t.ok){const e=await t.json();batchRecordCount.textContent=e.count||0,batchGenerateBtn.disabled=0===(e.count||0),batchBtnText.textContent=`Generate All PDFs (${e.count} records)`}}catch(e){console.warn("Failed to get record count:",e),batchRecordCount.textContent="?"}}async function pollBatchStatus(){if(batchJobId)try{const e=await fetch(`${GLYPH_API}/v1/templates/batch/${batchJobId}`);if(!e.ok)throw new Error("Failed to get job status");const t=await e.json();if(batchCompleted.textContent=t.completed,batchTotal.textContent=t.total,batchProgressFill.style.width=`${t.progress}%`,batchBtnText.textContent=`Processing... ${t.progress}%`,"completed"===t.status){clearInterval(batchPollInterval),batchBtnText.textContent="Downloading...";const e=await fetch(`${GLYPH_API}/v1/templates/batch/${batchJobId}/download`);if(e.ok){downloadBlob(await e.blob(),`batch-${batchJobId}.zip`),batchBtnText.textContent="Download Complete!"}setTimeout(resetBatchUI,3e3)}else if("failed"===t.status)throw clearInterval(batchPollInterval),new Error("Batch job failed")}catch(e){console.error("Polling error:",e),clearInterval(batchPollInterval),alert("Batch processing failed"),resetBatchUI()}}function downloadBlob(e,t){const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}function resetBatchUI(){batchGenerateBtn.disabled=!1,batchGenerateBtn.classList.remove("loading");const e=batchRecordCount.textContent;batchBtnText.textContent=`Generate All PDFs (${e} records)`,batchProgress.style.display="none",batchJobId=null,batchPollInterval&&(clearInterval(batchPollInterval),batchPollInterval=null)}batchViewSelect.addEventListener("change",updateRecordCount),batchGenerateBtn.addEventListener("click",async()=>{if(!airtableState.generatedHtml||!airtableState.apiKey)return void alert("Please generate a template first");const e=parseInt(batchRecordCount.textContent)||0;if(0===e)return void alert("No records to generate");batchGenerateBtn.disabled=!0,batchGenerateBtn.classList.add("loading"),batchBtnText.textContent="Starting...",batchProgress.style.display="block",batchProgressFill.style.width="0%",batchCompleted.textContent="0",batchTotal.textContent=e;const t={template:airtableState.generatedHtml,airtable:{apiKey:airtableState.apiKey,baseId:airtableState.selectedBase.id,tableId:airtableState.selectedTable.id,view:batchViewSelect.value||void 0,maxRecords:e},output:{filename:batchFilenameInput.value||"document-{{record.id}}.pdf"}};try{if(e<=20){batchBtnText.textContent="Generating...";const n=await fetch(`${GLYPH_API}/v1/templates/batch`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok){const e=await n.json();throw new Error(e.error||"Batch generation failed")}downloadBlob(await n.blob(),`batch-${Date.now()}.zip`),batchProgressFill.style.width="100%",batchCompleted.textContent=e,batchBtnText.textContent="Download Complete!"}else{batchBtnText.textContent="Starting batch job...";const e=await fetch(`${GLYPH_API}/v1/templates/batch/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){const t=await e.json();throw new Error(t.error||"Failed to start batch job")}const n=await e.json();batchJobId=n.jobId,batchBtnText.textContent="Processing...",batchPollInterval=setInterval(pollBatchStatus,2e3)}}catch(e){console.error("Batch generation error:",e),alert(e.message||"Batch generation failed"),resetBatchUI()}});const originalGoToStep=goToStep;goToStep=function(e){originalGoToStep(e),4===e&&loadBatchViews()};let saveTemplateElements=null;function getSaveTemplateElements(){return saveTemplateElements||(saveTemplateElements={btn:document.getElementById("save-template-btn"),modal:document.getElementById("save-template-modal"),form:document.getElementById("save-template-form"),demoNotice:document.getElementById("save-template-demo-notice"),nameInput:document.getElementById("template-name-input"),typeSelect:document.getElementById("template-type-select"),descriptionInput:document.getElementById("template-description-input"),defaultCheckbox:document.getElementById("template-default-checkbox"),errorEl:document.getElementById("save-template-error"),cancelBtn:document.getElementById("save-template-cancel"),confirmBtn:document.getElementById("save-template-confirm")}),saveTemplateElements}function canSaveTemplates(){try{const e=localStorage.getItem("glyph_user_api_key");return e&&e!==DEMO_API_KEY&&e.startsWith("gk_")}catch(e){return!1}}function getUserApiKey(){try{const e=localStorage.getItem("glyph_user_api_key");if(e&&e.startsWith("gk_"))return e}catch(e){}return DEMO_API_KEY}function showSaveTemplateButton(){const e=getSaveTemplateElements();e.btn&&e.btn.classList.add("visible")}function hideSaveTemplateButton(){const e=getSaveTemplateElements();e.btn&&e.btn.classList.remove("visible")}function showSaveTemplateModal(){const e=getSaveTemplateElements();if(!e.modal)return;const t=canSaveTemplates();if(e.form&&(e.form.style.display=t?"flex":"none"),e.demoNotice&&(e.demoNotice.style.display=t?"none":"block"),t&&e.form){e.form.reset(),e.errorEl&&(e.errorEl.textContent="",e.errorEl.classList.remove("visible")),currentEditingTemplate&&currentEditingTemplate.name&&e.nameInput&&(e.nameInput.value=currentEditingTemplate.name);const t=e.modal.querySelector(".save-template-modal__title, h3"),n=e.confirmBtn?.querySelector(".btn-text");currentEditingTemplate&&currentEditingTemplate.id?(t&&(t.textContent="Update Template"),n&&(n.textContent="Update Template")):(t&&(t.textContent="Save Template"),n&&(n.textContent="Save Template"))}e.modal.classList.add("active"),t&&e.nameInput&&setTimeout(()=>e.nameInput.focus(),100)}function closeSaveTemplateModal(){const e=getSaveTemplateElements();e.modal&&e.modal.classList.remove("active")}function showSaveTemplateError(e){const t=getSaveTemplateElements();t.errorEl&&(t.errorEl.textContent=e,t.errorEl.classList.add("visible"))}function hideSaveTemplateError(){const e=getSaveTemplateElements();e.errorEl&&(e.errorEl.textContent="",e.errorEl.classList.remove("visible"))}function setSaveTemplateLoading(e){const t=getSaveTemplateElements();if(!t.confirmBtn)return;const n=t.confirmBtn.querySelector(".btn-text"),a=t.confirmBtn.querySelector(".btn-spinner");t.confirmBtn.disabled=e,n&&(n.style.display=e?"none":"inline"),a&&(a.style.display=e?"inline-block":"none")}async function handleSaveTemplateSubmit(e){e.preventDefault();const t=getSaveTemplateElements();if(!t.nameInput)return;const n=t.nameInput.value.trim(),a=t.typeSelect?.value||void 0,o=t.descriptionInput?.value.trim()||void 0,i=t.defaultCheckbox?.checked||!1,s=currentEditingTemplate&&currentEditingTemplate.id;if(!n)return showSaveTemplateError("Please enter a template name."),void t.nameInput.focus();if(!currentHtml)return void showSaveTemplateError("No template content to save. Apply some changes first.");const r=getUserApiKey();if(r!==DEMO_API_KEY){setSaveTemplateLoading(!0),hideSaveTemplateError();try{let e;e=s?await fetch(`${API_URL}/v1/templates/saved/${currentEditingTemplate.id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({name:n,type:a||void 0,description:o||void 0,html:currentHtml,isDefault:i})}):await fetch(`${API_URL}/v1/templates/saved`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({name:n,type:a||void 0,description:o||void 0,html:currentHtml,isDefault:i})});const t=await e.json();if(!e.ok)throw new Error(t.error||t.message||"Failed to save template");closeSaveTemplateModal(),s?(showToast(`Template "${n}" updated!`,"success",4e3),currentEditingTemplate.name=t.template.name,showEditingBanner(t.template.name,!!currentEditingTemplate.sourceId)):(showToast(`Template saved! ID: ${t.template.id}`,"success",4e3),currentEditingTemplate={id:t.template.id,name:t.template.name,sourceId:null},showEditingBanner(t.template.name,!1)),console.log("[Glyph] Template saved:",{id:t.template.id,name:t.template.name,type:t.template.type,action:s?"updated":"created",apiUsage:`Use with API: POST /v1/create with templateId: "${t.template.id}"`})}catch(e){console.error("[Glyph] Failed to save template:",e),showSaveTemplateError(e.message||"Failed to save template. Please try again.")}finally{setSaveTemplateLoading(!1)}}else showSaveTemplateError("You need an API key to save templates. Get one from the dashboard.")}function initSaveTemplateFeature(){const e=getSaveTemplateElements();e.btn&&e.btn.addEventListener("click",showSaveTemplateModal),e.cancelBtn&&e.cancelBtn.addEventListener("click",closeSaveTemplateModal),e.form&&e.form.addEventListener("submit",handleSaveTemplateSubmit),e.modal&&e.modal.addEventListener("click",t=>{t.target===e.modal&&closeSaveTemplateModal()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&e.modal?.classList.contains("active")&&closeSaveTemplateModal()}),console.log("[Glyph] Save Template feature initialized")}const originalAddHistoryEntry=addHistoryEntry;addHistoryEntry=function(e,t){originalAddHistoryEntry(e,t),historyEntries.length>0&&showSaveTemplateButton()},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initSaveTemplateFeature):initSaveTemplateFeature(),function(){const e=function(){const e=document.getElementById("mouseGlow");if(!e)return;if(!window.matchMedia("(hover: hover)").matches)return void(e.style.display="none");let t=0,n=0,a=0,o=0,i=null,s=!1;function r(){s&&(a+=.1*(t-a),o+=.1*(n-o),e.style.left=a+"px",e.style.top=o+"px",i=requestAnimationFrame(r))}function l(){s||(s=!0,r())}document.addEventListener("mousemove",function(a){t=a.clientX,n=a.clientY,e.classList.add("active")}),document.addEventListener("mouseleave",function(){e.classList.remove("active")}),document.addEventListener("visibilitychange",()=>{document.hidden?(s=!1,i&&(cancelAnimationFrame(i),i=null),e.classList.remove("active")):l()}),document.hidden||l()};"function"==typeof requestIdleCallback?requestIdleCallback(e):setTimeout(e,2e3)}(),function(){[{input:"prompt-input",hint:"prompt-input-hint"},{input:"airtable-key",hint:"airtable-key-hint"},{input:"batch-filename",hint:"batch-filename-hint"}].forEach(function(e){var t=document.getElementById(e.input),n=document.getElementById(e.hint);t&&n&&(t.addEventListener("focus",function(){n.classList.add("input-hint--visible")}),t.addEventListener("blur",function(){n.classList.remove("input-hint--visible")}))});[{input:"template-name-input",counter:"template-name-counter"},{input:"template-description-input",counter:"template-description-counter"},{input:"version-name-input",counter:"version-name-counter"}].forEach(function(e){var t=document.getElementById(e.input),n=document.getElementById(e.counter);if(t&&n){var a=parseInt(n.getAttribute("data-max"),10)||100;t.addEventListener("focus",function(){n.classList.add("char-counter--visible"),o()}),t.addEventListener("blur",function(){n.classList.remove("char-counter--visible")}),t.addEventListener("input",o)}function o(){var e=t.value.length;n.textContent=e+" / "+a,n.classList.remove("char-counter--warning","char-counter--limit"),e>=a?n.classList.add("char-counter--limit"):e>=.85*a&&n.classList.add("char-counter--warning")}}),function(){var e=[],t=document.getElementById("rate-limit-indicator"),n=document.getElementById("rate-limit-text");function a(){!function(){for(var t=Date.now();e.length>0&&t-e[0]>6e4;)e.shift()}();var a=e.length;0!==a?(t.style.display="",n.textContent=a+"/10 requests this minute",t.classList.remove("playground__rate-limit--warning","playground__rate-limit--error"),a>=10?(t.classList.add("playground__rate-limit--error"),n.textContent=a+"/10 requests - slow down"):a>=8&&(t.classList.add("playground__rate-limit--warning"),n.textContent=a+"/10 requests - slow down")):t.style.display="none"}t&&n&&(window.__glyphRateLimit={track:function(){e.push(Date.now()),a()},onRateLimited:function(){t&&n&&(t.style.display="",t.classList.remove("playground__rate-limit--warning"),t.classList.add("playground__rate-limit--error"),n.innerHTML='Rate limited &mdash; resets shortly. <a href="#pricing" class="playground__rate-limit-link">Get a free API key for more.</a>')},update:a},setInterval(a,1e4))}(),document.addEventListener("keydown",function(e){if((e.ctrlKey||e.metaKey)&&"s"===e.key){var t=document.getElementById("playground");if(!t)return;var n=t.getBoundingClientRect();if(!(n.top<window.innerHeight&&n.bottom>0))return;e.preventDefault(),e.stopPropagation(),"function"==typeof showToast&&showToast("Generating PDF...","info",3e3);var a=document.getElementById("generate-btn");a&&!a.disabled?a.click():"function"==typeof showToast&&showToast("No document ready to download yet.","warning",3e3)}}),function(){function e(){var e=document.querySelector("#preview-container iframe");if(e)try{var t=e.contentDocument||e.contentWindow.document;if(!t)return;t.querySelectorAll("[data-glyph-region]").forEach(function(e){var t=e.getAttribute("data-glyph-region");t&&!e.getAttribute("aria-label")&&(e.setAttribute("aria-label","Editable PDF region: "+t),e.setAttribute("role","button"))})}catch(e){}}var t=new MutationObserver(function(){setTimeout(e,500)}),n=document.getElementById("preview-container");n&&t.observe(n,{childList:!0,subtree:!0}),setTimeout(e,2e3)}()}();