function debounce(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout(()=>e.apply(this,o),t)}}const API_URL=window.location.hostname==="localhost"&&localStorage.getItem("USE_LOCAL_API")?"http://localhost:3000":(window.location.hostname.includes("glyph.you")||window.location.hostname.includes(".railway.app"),"https://api.glyph.you"),DEMO_API_KEY="gk_demo_playground_2024";(async()=>{try{await fetch(`${API_URL}/health`,{method:"GET"}),console.log("[Glyph] API warmed up")}catch{}})();let isStorageAvailable=!0,storageFailureCount=0,storageWarningShown=!1;function checkStorageAvailability(){const e="__glyph_storage_test__";try{return localStorage.setItem(e,"test"),localStorage.removeItem(e),!0}catch{return!1}}isStorageAvailable=checkStorageAvailability();function handleStorageFailure(){storageFailureCount++,storageFailureCount>=2&&!storageWarningShown&&(storageWarningShown=!0,setTimeout(()=>{typeof showToast=="function"&&showToast("Private browsing detected - saved versions won't persist","warning",6e3)},1e3))}function safeSetItem(e,t){if(!isStorageAvailable)return handleStorageFailure(),!1;try{return localStorage.setItem(e,t),!0}catch(n){return console.warn("[Glyph] localStorage.setItem failed:",n),handleStorageFailure(),!1}}function safeGetItem(e,t=null){if(!isStorageAvailable)return t;try{const n=localStorage.getItem(e);return n!==null?n:t}catch(n){return console.warn("[Glyph] localStorage.getItem failed:",n),t}}isStorageAvailable||setTimeout(()=>{typeof showToast=="function"&&showToast("Private browsing detected - saved versions won't persist","warning",6e3)},2e3);const MAX_DEMO_DOWNLOADS=3;let demoDownloadCount=0;function addWatermarkToHtml(e){const t=`
        <style>
          .glyph-demo-watermark {
            position: fixed;
            bottom: 12px;
            right: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 10px;
            color: rgba(100, 116, 139, 0.6);
            background: rgba(248, 250, 252, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            z-index: 9999;
            pointer-events: none;
          }
          @media print {
            .glyph-demo-watermark {
              position: fixed;
              bottom: 12px;
              right: 12px;
            }
          }
        </style>
      `,n='<div class="glyph-demo-watermark">Created with Glyph - glyph.you</div>';return e.includes("</body>")?e.replace("</body>",t+n+"</body>"):e+t+n}async function generateDemoPdf(){if(demoDownloadCount>=MAX_DEMO_DOWNLOADS)return showModal(),!1;if(!currentHtml)return showToast("No document to generate. Please wait for preview to load.","error"),!1;try{const e=addWatermarkToHtml(currentHtml),t=await fetch(`${API_URL}/v1/generate`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${DEMO_API_KEY}`},body:JSON.stringify({html:e,format:"pdf"})});if(!t.ok){const s=await t.json().catch(()=>({}));throw new Error(s.error||"PDF generation failed")}const n=await t.blob(),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=`glyph-demo-${Date.now()}.pdf`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o),demoDownloadCount++;const a=MAX_DEMO_DOWNLOADS-demoDownloadCount,r=document.getElementById("demo-downloads-remaining");return r&&(a===0?r.textContent="This was your last demo download.":r.textContent=`${a} demo download${a===1?"":"s"} remaining.`),showPdfSuccessModal(),!0}catch(e){return console.error("[Glyph] Demo PDF generation failed:",e),showToast("PDF generation failed. Please try again.","error"),!1}}function showPdfSuccessModal(){const e=document.getElementById("pdf-success-modal");e&&(e.classList.add("visible"),document.body.style.overflow="hidden")}function hidePdfSuccessModal(){const e=document.getElementById("pdf-success-modal");e&&(e.classList.remove("visible"),document.body.style.overflow="")}function fallbackCopyToClipboard(e){return new Promise((t,n)=>{const o=document.createElement("textarea");o.value=e,o.style.position="fixed",o.style.left="-9999px",o.style.top="0",o.setAttribute("readonly",""),document.body.appendChild(o);try{o.select(),o.setSelectionRange(0,e.length);const i=document.execCommand("copy");document.body.removeChild(o),i?t():n(new Error("execCommand copy failed"))}catch(i){document.body.removeChild(o),n(i)}})}async function copyTextToClipboard(e){if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")try{return await navigator.clipboard.writeText(e),!0}catch(t){console.warn("[Glyph] Clipboard API failed, trying fallback:",t)}try{return await fallbackCopyToClipboard(e),!0}catch(t){return console.error("[Glyph] All clipboard methods failed:",t),!1}}function copyToClipboard(e,t){const n=document.createElement("textarea");n.innerHTML=e;const o=n.value;copyTextToClipboard(o).then(i=>{const a=document.getElementById("copy-toast");i?(a.classList.add("show"),setTimeout(()=>{a.classList.remove("show")},2e3)):showToast("Couldn't copy to clipboard - try Ctrl/Cmd+C","error",4e3)})}function copyIntegrationCode(){const e=document.querySelector(".code-block--active");if(!e)return;const t=e.querySelector("code");if(!t)return;const n=document.createElement("textarea");n.innerHTML=t.textContent||"";const o=n.value;copyTextToClipboard(o).then(i=>{const a=document.getElementById("integration-copy-btn");i?(a&&(a.classList.add("copied"),a.querySelector("span").textContent="Copied!",setTimeout(()=>{a.classList.remove("copied"),a.querySelector("span").textContent="Copy Code"},2e3)),showIntegrationCopyToast()):(a&&(a.classList.add("error"),a.querySelector("span").textContent="Copy failed",setTimeout(()=>{a.classList.remove("error"),a.querySelector("span").textContent="Copy Code"},3e3)),showToast("Couldn't copy to clipboard - try Ctrl/Cmd+C","error",4e3))})}function showIntegrationCopyToast(){let e=document.getElementById("integration-copy-toast");e||(e=document.createElement("div"),e.id="integration-copy-toast",e.className="integration-copy-toast",e.innerHTML=`
          <div class="integration-copy-toast__content">
            <svg class="integration-copy-toast__icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span>Copied! <a href="https://dashboard.glyph.you">Get your API key</a> to start using Glyph</span>
          </div>
        `,document.body.appendChild(e)),e.classList.add("visible"),setTimeout(()=>{e.classList.remove("visible")},4e3)}let currentTemplate="quote-modern",currentHtml="",sessionId=null;const MAX_UNDO_HISTORY=10;let undoHistory=[];const MAX_REDO_HISTORY=20;let redoHistory=[],diffRegionSnapshots=null,isDiffActive=!1;const appliedActions=new Set,SESSION_DURATION_MS=60*60*1e3,WARNING_THRESHOLD_MS=10*60*1e3,URGENT_THRESHOLD_MS=5*60*1e3;let sessionStartTime=null,sessionTimerInterval=null,hasShown10MinWarning=!1,hasShown5MinWarning=!1,userHasInteracted=!1,hasShownSuccessCta=!1,hasShownFirstInstantWin=!1;function getSessionTimerElements(){return{timer:document.getElementById("session-timer"),timerText:document.getElementById("session-timer-text"),warningToast:document.getElementById("session-warning-toast"),warningTitle:document.getElementById("session-warning-title"),warningMessage:document.getElementById("session-warning-message"),warningDownload:document.getElementById("session-warning-download"),warningDismiss:document.getElementById("session-warning-dismiss")}}function formatTimeRemaining(e){if(e<=0)return"Expired";const t=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3);return t>=60?"60 min":t>0?`${t} min`:`${n}s`}function startSessionTimer(){sessionStartTime=Date.now(),hasShown10MinWarning=!1,hasShown5MinWarning=!1,sessionTimerInterval&&clearInterval(sessionTimerInterval),sessionTimerInterval=setInterval(updateSessionTimer,1e3),updateSessionTimer(),document.addEventListener("visibilitychange",handleVisibilityChange),console.log("[Glyph] Session timer started")}function handleVisibilityChange(){document.hidden?sessionTimerInterval&&(clearInterval(sessionTimerInterval),sessionTimerInterval=null):sessionStartTime&&!sessionTimerInterval&&(updateSessionTimer(),sessionTimerInterval=setInterval(updateSessionTimer,1e3))}function updateSessionTimer(){if(!sessionStartTime)return;const e=getSessionTimerElements();if(!e.timer||!e.timerText)return;const t=Date.now()-sessionStartTime,n=SESSION_DURATION_MS-t;e.timerText.textContent=formatTimeRemaining(n),e.timer.classList.remove("warning","urgent"),n<=URGENT_THRESHOLD_MS?(e.timer.classList.add("urgent"),e.timer.title="Session expiring soon! Download PDF now to save your work."):n<=WARNING_THRESHOLD_MS?(e.timer.classList.add("warning"),e.timer.title="Less than 10 minutes remaining. Consider saving your work."):e.timer.title="Demo session lasts 60 minutes. Changes are lost when session expires. Download PDF to save your work.",n<=WARNING_THRESHOLD_MS&&n>URGENT_THRESHOLD_MS&&!hasShown10MinWarning&&(hasShown10MinWarning=!0,showSessionWarning("Session expires in 10 minutes","Save your work! Download PDF or save a named version now.",!1)),n<=URGENT_THRESHOLD_MS&&n>0&&!hasShown5MinWarning&&(hasShown5MinWarning=!0,showSessionWarning("Session expires in 5 minutes!","Download your PDF or sign up to continue working.",!0)),n<=0&&(clearInterval(sessionTimerInterval),handleSessionExpired())}function showSessionWarning(e,t,n){if(!userHasInteracted){console.log("[Glyph] Suppressing session warning - user has not interacted yet");return}const o=getSessionTimerElements();o.warningToast&&(o.warningTitle.textContent=e,o.warningMessage.textContent=t,o.warningToast.classList.remove("urgent"),n&&o.warningToast.classList.add("urgent"),o.warningToast.style.display="flex",o.warningToast.removeAttribute("aria-hidden"),o.warningToast.classList.add("visible"),console.log(`[Glyph] Session warning: ${e}`))}function hideSessionWarning(){const e=getSessionTimerElements();e.warningToast&&(e.warningToast.classList.remove("visible"),setTimeout(()=>{e.warningToast.classList.contains("visible")||(e.warningToast.style.display="none",e.warningToast.setAttribute("aria-hidden","true"))},300))}function handleSessionExpired(){console.log("[Glyph] Session expired - initiating graceful reload");const e=getSessionTimerElements();if(e.warningToast){e.warningTitle.textContent="Session Expired",e.warningMessage.textContent="Starting fresh session...",e.warningToast.style.display="flex",e.warningToast.removeAttribute("aria-hidden"),e.warningToast.classList.add("visible","urgent");const t=e.warningToast.querySelector(".session-warning-toast__actions");t&&(t.style.display="none")}setTimeout(()=>{sessionId=null,sessionStartTime=null,currentHtml="",undoHistory=[],redoHistory=[],historyEntries=[],currentHistoryIndex=-1,hideSessionWarning(),loadPreview(),showToast("New session started","success")},2e3)}function initSessionTimerListeners(){const e=getSessionTimerElements();e.warningDismiss&&e.warningDismiss.addEventListener("click",hideSessionWarning),e.warningDownload&&e.warningDownload.addEventListener("click",()=>{hideSessionWarning();const t=document.getElementById("generate-btn");t&&t.click()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initSessionTimerListeners):initSessionTimerListeners();let lastFailedPrompt=null,apiErrorToastTimeout=null,consecutiveFailures=0,lastErrorWasSessionError=!1,autoRetryCount=0,isAutoRetrying=!1;const MAX_AUTO_RETRIES=2,RETRY_DELAYS=[1e3,2e3];function getApiErrorElements(){return{toast:document.getElementById("api-error-toast"),message:document.getElementById("api-error-message"),retryBtn:document.getElementById("api-error-retry"),dismissBtn:document.getElementById("api-error-dismiss"),closeBtn:document.getElementById("api-error-close"),title:document.getElementById("api-error-title")}}function classifyError(e){const t=e.toLowerCase();return t.includes("network")||t.includes("fetch")||t.includes("failed to fetch")?"network":t.includes("timeout")||t.includes("took too long")?"timeout":t.includes("session")||t.includes("expired")||t.includes("dev_session_not_found")?"session":t.includes("rate")||t.includes("429")?"rate_limit":t.includes("500")||t.includes("502")||t.includes("503")?"server":t.includes("cannot delete")||t.includes("would remove content")||t.includes("destructive")?"guardrail_destructive":t.includes("cannot modify protected")||t.includes("protected field")||t.includes("protected region")?"guardrail_protected":t.includes("guardrail")||t.includes("blocked")||t.includes("refused")||t.includes("cannot")?"guardrail":t.includes("not possible")||t.includes("not feasible")||t.includes("pdfs are static")||t.includes("static document")?"impossible":"unknown"}function isRetryableError(e){return["network","timeout","server","session","unknown"].includes(e)}function showApiError(e,t,n){const o=getApiErrorElements();if(!o.toast)return;const i=classifyError(e);if(!n&&isRetryableError(i)&&autoRetryCount<MAX_AUTO_RETRIES&&!isAutoRetrying){autoRetryCount++,isAutoRetrying=!0,lastFailedPrompt=t,i==="session"&&(lastErrorWasSessionError=!0);const l=RETRY_DELAYS[autoRetryCount-1],p=document.getElementById("api-error-retry-status");o.message.textContent=i==="timeout"?"This modification is taking longer than usual.":i==="network"?"Connection issue detected.":"Something went wrong.",o.title&&(o.title.textContent="Retrying..."),p&&(p.style.display="block",p.textContent="Retrying... ("+autoRetryCount+"/"+MAX_AUTO_RETRIES+")"),o.retryBtn&&(o.retryBtn.disabled=!0);const c=document.getElementById("api-error-fallback");c&&(c.style.display="none"),o.toast.style.display="flex",o.toast.removeAttribute("inert"),o.toast.classList.add("visible"),apiErrorToastTimeout&&clearTimeout(apiErrorToastTimeout),console.log("[Glyph] Auto-retrying ("+autoRetryCount+"/"+MAX_AUTO_RETRIES+") in "+l+"ms"),setTimeout(async()=>{if(hideApiError(),isAutoRetrying=!1,o.retryBtn&&(o.retryBtn.disabled=!1),lastFailedPrompt){if(lastErrorWasSessionError){lastErrorWasSessionError=!1;try{setStatus("Refreshing session..."),await initializePreview(),await new Promise(d=>setTimeout(d,500))}catch(d){console.error("[Glyph] Session refresh failed during auto-retry:",d),autoRetryCount=MAX_AUTO_RETRIES,showApiError("Session refresh failed. Please reload the page.",t,!0);return}}applyModifications(lastFailedPrompt)}},l);return}autoRetryCount=0,isAutoRetrying=!1,consecutiveFailures++,lastFailedPrompt=t,o.title&&(consecutiveFailures>=2?o.title.textContent="Still Having Trouble":o.title.textContent="Modification Failed");let a="";switch(i){case"network":a="Connection issue. Check your network and retry.";break;case"timeout":a=consecutiveFailures>=2?'Complex requests need more processing time. Try specific instructions like "Make the header blue" or "Add a border to the table".':"This modification is taking longer than usual. Try a simpler change, or retry.";break;case"session":a="Your session has expired. Refreshing...",lastErrorWasSessionError=!0,initializePreview().catch(()=>{});break;case"rate_limit":a="Too many requests. Please wait a moment and try again.";break;case"server":a="Server is busy. Click Retry in a moment.";break;case"guardrail_destructive":a="This request would remove content. Try styling changes like colors, fonts, or layout instead.";break;case"guardrail_protected":a="Some fields are protected. Try adding new elements or changing existing styles.";break;case"guardrail":a=e+" Try a different approach.";break;case"impossible":a=e;break;default:a=consecutiveFailures>=2?"The AI couldn't process this request. Try rephrasing your description.":"Something went wrong. Click Retry or try a different prompt."}o.message.textContent=a;const r=document.getElementById("api-error-retry-status");r&&(r.style.display="none"),o.retryBtn&&(o.retryBtn.textContent=consecutiveFailures>=2?"Try Again":"Retry",o.retryBtn.disabled=!1);const s=document.getElementById("api-error-fallback");if(s){const l=!isRetryableError(i)||consecutiveFailures>=2;s.style.display=l?"block":"none"}o.toast.style.display="flex",o.toast.removeAttribute("inert"),o.toast.classList.add("visible"),apiErrorToastTimeout&&clearTimeout(apiErrorToastTimeout),apiErrorToastTimeout=setTimeout(hideApiError,15e3),console.error("[Glyph] API Error shown to user:",e,"(type: "+i+", retries exhausted: "+(autoRetryCount>=MAX_AUTO_RETRIES)+")")}function hideApiError(){const e=getApiErrorElements();e.toast&&(e.toast.classList.remove("visible"),setTimeout(()=>{e.toast.classList.contains("visible")||(e.toast.style.display="none",e.toast.setAttribute("inert",""))},300)),apiErrorToastTimeout&&(clearTimeout(apiErrorToastTimeout),apiErrorToastTimeout=null)}async function retryFailedModification(){if(autoRetryCount=0,hideApiError(),lastFailedPrompt){if(lastErrorWasSessionError){console.log("[Glyph] Session error detected, refreshing session before retry"),setStatus("Refreshing session..."),lastErrorWasSessionError=!1;try{await initializePreview(),await new Promise(e=>setTimeout(e,500))}catch(e){console.error("[Glyph] Failed to refresh session:",e),showToast("Unable to refresh session. Please reload the page.","error");return}}applyModifications(lastFailedPrompt)}}function initApiErrorListeners(){const e=getApiErrorElements();e.retryBtn&&e.retryBtn.addEventListener("click",retryFailedModification),e.dismissBtn&&e.dismissBtn.addEventListener("click",hideApiError),e.closeBtn&&e.closeBtn.addEventListener("click",hideApiError),document.querySelectorAll(".api-error-toast__fallback-btn").forEach(n=>{n.addEventListener("click",()=>{const o=n.getAttribute("data-prompt");o&&(hideApiError(),consecutiveFailures=0,autoRetryCount=0,applyModifications(o))})})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initApiErrorListeners):initApiErrorListeners();const nav=document.getElementById("nav");window.addEventListener("scroll",()=>{window.scrollY>50?nav.classList.add("scrolled"):nav.classList.remove("scrolled")});const typingText=document.getElementById("typing-text"),heroDemo=document.getElementById("hero-demo"),commands=[{text:"Add a diagonal DRAFT watermark",color:"#1E3A5F",effect:"watermark"},{text:"Group items by category with subtotals",color:"#0D9488",effect:"grouping"},{text:"Add a QR code for instant payment",color:"#1E3A5F",effect:"qrcode"},{text:"Add payment terms: Net 30",color:"#22C55E",effect:"terms"},{text:"Add a signature line with date",color:"#F97316",effect:"signature"}];let commandIndex=0,charIndex=0,isDeleting=!1;const effectElements={watermark:document.getElementById("demo-effect-watermark"),grouping:document.getElementById("demo-effect-grouping"),qrcode:[document.getElementById("demo-effect-qrcode"),document.getElementById("demo-effect-qrcode-label")],terms:document.getElementById("demo-effect-terms"),signature:document.getElementById("demo-effect-signature")};function clearAllEffects(){heroDemo.classList.remove("demo-preview--grouping"),heroDemo.style.setProperty("--demo-accent","#1E3A5F"),Object.values(effectElements).flat().forEach(e=>{e&&e.classList.remove("demo-effect--active")})}function activateEffect(e){if(clearAllEffects(),e==="grouping")heroDemo.classList.add("demo-preview--grouping"),effectElements.grouping&&effectElements.grouping.classList.add("demo-effect--active");else if(e==="qrcode")effectElements.qrcode.forEach(t=>t.classList.add("demo-effect--active"));else if(effectElements[e]){const t=effectElements[e];Array.isArray(t)?t.forEach(n=>n.classList.add("demo-effect--active")):t.classList.add("demo-effect--active")}}function typeCommand(){const e=commands[commandIndex];if(isDeleting)typingText.textContent=e.text.substring(0,charIndex-1),charIndex--,charIndex===0&&(clearAllEffects(),isDeleting=!1,commandIndex=(commandIndex+1)%commands.length);else if(typingText.textContent=e.text.substring(0,charIndex+1),charIndex++,charIndex===e.text.length){setTimeout(()=>{heroDemo.style.setProperty("--demo-accent",e.color),activateEffect(e.effect)},300),setTimeout(()=>{isDeleting=!0,typeCommand()},2500);return}setTimeout(typeCommand,isDeleting?30:80)}setTimeout(typeCommand,1e3);const demoCommand=document.querySelector(".demo-command");demoCommand&&demoCommand.addEventListener("click",()=>{const t=commands[commandIndex].text,o={"Add a diagonal DRAFT watermark":"Add a subtle DRAFT watermark diagonally across the document","Group items by category with subtotals":"Group the line items by category and add subtotals for each category","Add a QR code for instant payment":"Add a QR code in the bottom right corner for easy mobile payment","Add payment terms: Net 30":"Add payment terms: Net 30 with 2% early payment discount if paid within 10 days","Add a signature line with date":"Add a thank you message and signature line at the bottom with the current date"}[t]||t,i=document.getElementById("playground");i&&(i.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{const a=document.getElementById("prompt-input");a&&(a.value=o,a.focus(),a.dispatchEvent(new Event("input",{bubbles:!0})),a.style.transition="box-shadow 0.3s ease",a.style.boxShadow="0 0 0 3px rgba(30, 58, 95, 0.3)",setTimeout(()=>{a.style.boxShadow=""},400),setTimeout(()=>{typeof applyModifications=="function"&&!isProcessingModification&&(console.log("[Glyph] Hero click: executing command -",o),applyModifications(o))},200))},600))});const codeTabs=document.querySelectorAll(".code-tab"),codeBlocks=document.querySelectorAll(".code-block");codeTabs.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.lang;codeTabs.forEach(n=>n.classList.remove("code-tab--active")),codeBlocks.forEach(n=>n.classList.remove("code-block--active")),e.classList.add("code-tab--active"),document.getElementById(`code-${t}`).classList.add("code-block--active")})});const playgroundTabs=document.querySelectorAll(".playground__tab"),promptInput=document.getElementById("prompt-input"),playgroundInputWrapper=document.getElementById("playground-input-wrapper"),suggestions=document.querySelectorAll(".playground__suggestion"),applyBtn=document.getElementById("apply-btn"),undoBtn=document.getElementById("undo-btn"),diffToggleBtn=document.getElementById("diff-toggle-btn"),generateBtn=document.getElementById("generate-btn"),previewFrame=document.getElementById("preview-frame"),previewContainer=document.getElementById("preview-container"),previewLoading=document.getElementById("preview-loading"),previewStatus=document.querySelector(".playground__preview-status"),zoomToggle=document.getElementById("zoom-toggle");zoomToggle&&zoomToggle.addEventListener("click",()=>{previewContainer.classList.toggle("zoomed-in")});const voiceBtn=document.getElementById("voice-input-btn");let speechRecognition=null,isListening=!1;function initSpeechRecognition(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e)return voiceBtn&&(voiceBtn.classList.add("unsupported"),voiceBtn.title="Voice input not supported in this browser"),console.log("[Glyph] Speech recognition not supported in this browser"),null;const t=new e;return t.continuous=!1,t.interimResults=!1,t.lang="en-US",t.maxAlternatives=1,t.onstart=()=>{isListening=!0,voiceBtn.classList.add("listening"),console.log("[Glyph] Voice input started")},t.onend=()=>{isListening=!1,voiceBtn.classList.remove("listening"),console.log("[Glyph] Voice input ended")},t.onresult=n=>{const o=n.results[0][0].transcript,i=n.results[0][0].confidence;console.log("[Glyph] Voice transcript:",o,"(confidence:",(i*100).toFixed(1)+"%)"),promptInput&&(promptInput.value=o,promptInput.focus(),promptInput.dispatchEvent(new Event("input",{bubbles:!0})))},t.onerror=n=>{console.log("[Glyph] Voice input error:",n.error),isListening=!1,voiceBtn.classList.remove("listening");let o="Voice input error";switch(n.error){case"no-speech":o="No speech detected. Try again.";break;case"audio-capture":o="Microphone not available";break;case"not-allowed":o="Microphone access denied";break;case"network":o="Network error. Check your connection.";break}showToast(o,"error")},t}function toggleVoiceInput(){if(!(!speechRecognition&&(speechRecognition=initSpeechRecognition(),!speechRecognition)))if(isListening)speechRecognition.stop();else try{speechRecognition.start()}catch(e){console.log("[Glyph] Could not start voice input:",e.message)}}voiceBtn&&(window.SpeechRecognition||window.webkitSpeechRecognition||voiceBtn.classList.add("unsupported"),voiceBtn.addEventListener("click",toggleVoiceInput));let isProcessingModification=!1;function setSuggestionsDisabled(e){suggestions.forEach(t=>{t.disabled=e})}const DATA_FIELDS=[{category:"Client",name:"Client Name",path:"client.name",example:"John Smith",type:"string"},{category:"Client",name:"Company",path:"client.company",example:"TechStart Inc.",type:"string"},{category:"Client",name:"Email",path:"client.email",example:"john@techstart.io",type:"string"},{category:"Client",name:"Phone",path:"client.phone",example:"(555) 123-4567",type:"string"},{category:"Client",name:"Address",path:"client.address",example:"123 Main Street",type:"string"},{category:"Quote Info",name:"Quote Number",path:"meta.quoteNumber",example:"Q-2024-001",type:"string"},{category:"Quote Info",name:"Date",path:"meta.date",example:"January 15, 2024",type:"date"},{category:"Quote Info",name:"Valid Until",path:"meta.validUntil",example:"February 15, 2024",type:"date"},{category:"Quote Info",name:"Notes",path:"meta.notes",example:"Thank you!",type:"string"},{category:"Quote Info",name:"Terms",path:"meta.terms",example:"Net 30 days",type:"string"},{category:"Company",name:"Company Name",path:"branding.companyName",example:"Acme Corp",type:"string"},{category:"Company",name:"Logo URL",path:"branding.logoUrl",example:"https://...",type:"string"},{category:"Company",name:"Company Address",path:"branding.companyAddress",example:"456 Business Ave",type:"string"},{category:"Totals",name:"Subtotal",path:"totals.subtotal",example:"10,000.00",type:"number"},{category:"Totals",name:"Discount",path:"totals.discount",example:"500.00",type:"number"},{category:"Totals",name:"Tax",path:"totals.tax",example:"760.00",type:"number"},{category:"Totals",name:"Total",path:"totals.total",example:"10,260.00",type:"number"},{category:"Line Items",name:"Description",path:"lineItems[].description",example:"Service item",type:"string"},{category:"Styles",name:"Accent Color",path:"styles.accentColor",example:"#1E3A5F",type:"string"}],QUICK_ACTIONS=[{type:"action",category:"Quick Actions",icon:"qr",label:"Add QR code for payment",description:"Easy mobile payment scanning",value:"Add a QR code in the bottom right corner for easy mobile payment",score:95},{type:"action",category:"Quick Actions",icon:"image",label:"Add company logo",description:"Brand your document",value:"Add the company logo in the header, sized appropriately",score:94},{type:"action",category:"Quick Actions",icon:"sparkles",label:"Make design more professional",description:"Enhance overall appearance",value:"Make this design look more professional and polished with better typography and spacing",score:93},{type:"action",category:"Quick Actions",icon:"stamp",label:"Add DRAFT watermark",description:"Mark as work in progress",value:"Add a subtle DRAFT watermark diagonally across the document",score:85},{type:"action",category:"Quick Actions",icon:"pen",label:"Add signature line",description:"Space for client approval",value:"Add a signature line at the bottom with date field for client approval",score:84},{type:"action",category:"Quick Actions",icon:"layout",label:"Make layout compact",description:"Reduce whitespace",value:"Make the layout more compact, reducing unnecessary whitespace while keeping it readable",score:80}],MAKE_SUGGESTIONS=[{type:"action",category:"Make Changes",icon:"arrow-up",label:"make header bigger",description:"Increase header size",value:"Make the header section bigger and more prominent",score:90},{type:"action",category:"Make Changes",icon:"dollar",label:"make totals prominent",description:"Highlight totals section",value:"Make the totals section more prominent with larger text and better contrast",score:89},{type:"action",category:"Make Changes",icon:"compress",label:"make layout compact",description:"Reduce whitespace",value:"Make the layout more compact with tighter spacing",score:88},{type:"action",category:"Make Changes",icon:"text",label:"make text larger",description:"Increase font size",value:"Make all text slightly larger for better readability",score:87},{type:"action",category:"Make Changes",icon:"sparkles",label:"make it look modern",description:"Contemporary styling",value:"Make this look more modern with clean lines and contemporary styling",score:86},{type:"action",category:"Make Changes",icon:"moon",label:"make it dark mode",description:"Dark theme",value:"Make this a dark mode design with light text on dark background",score:85}],ADD_SUGGESTIONS=[{type:"action",category:"Add Elements",icon:"qr",label:"add QR code",description:"Payment QR code",value:"Add a QR code in the bottom right for mobile payment",score:95},{type:"action",category:"Add Elements",icon:"image",label:"add logo",description:"Company logo",value:"Add the company logo in the header",score:94},{type:"action",category:"Add Elements",icon:"stamp",label:"add watermark",description:"Background watermark",value:"Add a subtle watermark to the document",score:90},{type:"action",category:"Add Elements",icon:"file-text",label:"add terms",description:"Payment terms",value:"Add payment terms section at the bottom: Net 30 days",score:89},{type:"action",category:"Add Elements",icon:"heart",label:"add thank you note",description:"Appreciation message",value:"Add a thank you note at the bottom of the document",score:88},{type:"action",category:"Add Elements",icon:"percent",label:"add discount row",description:"Discount in totals",value:"Add a discount row to the totals section",score:87},{type:"action",category:"Add Elements",icon:"pen",label:"add signature line",description:"Approval signature",value:"Add a signature line for client approval",score:86}],CHANGE_SUGGESTIONS=[{type:"action",category:"Change Style",icon:"palette",label:"change colors",description:"Modify color scheme",value:"Change the accent color to a different shade",score:90},{type:"action",category:"Change Style",icon:"palette",label:"change to blue",description:"Blue color scheme",value:"Change the accent color to a professional blue (#2563eb)",score:89},{type:"action",category:"Change Style",icon:"palette",label:"change to purple",description:"Purple color scheme",value:"Change the accent color to a modern purple (#7c3aed)",score:88},{type:"action",category:"Change Style",icon:"type",label:"change font",description:"Different typography",value:"Change the font family to something more modern",score:86},{type:"action",category:"Change Style",icon:"layout",label:"change layout",description:"Different arrangement",value:"Change the overall layout to be more dynamic",score:85}],CATEGORY_ICONS={"Quick Actions":'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',Recent:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',Suggestions:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg>',"Data Fields":'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',"Add Elements":'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',"Make Changes":'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>',"Change Style":'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="6.5" cy="13.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>'},SUGGESTION_ICONS={qr:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/></svg>',image:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',sparkles:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3L14.5 8.5L20 9L15.5 13L17 19L12 16L7 19L8.5 13L4 9L9.5 8.5L12 3Z"/></svg>',stamp:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 22h14"/><path d="M19.27 13.73A2.5 2.5 0 0 0 17.5 13h-11A2.5 2.5 0 0 0 4 15.5V17a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-1.5c0-.66-.26-1.3-.73-1.77Z"/></svg>',pen:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>',layout:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg>',"arrow-up":'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>',dollar:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',compress:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/></svg>',text:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>',moon:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',"file-text":'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',heart:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',percent:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>',palette:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="6.5" cy="13.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>',type:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="12" y1="4" x2="12" y2="20"/></svg>',clock:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',lightbulb:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg>',field:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'},FUZZY_SHORTCUTS={ph:["phone","photo"],qr:["QR code","QR"],$:["total","subtotal","price","dollar"],em:["email"],disc:["discount"],sig:["signature"],wat:["watermark"],pro:["professional"]},RECENT_ACTIONS_KEY="glyph_recent_actions",MAX_RECENT_ACTIONS=5;function getRecentActions(){try{const e=safeGetItem(RECENT_ACTIONS_KEY);return e?JSON.parse(e):[]}catch{return[]}}function saveRecentAction(e,t){try{const n=getRecentActions().filter(o=>o.value!==t);n.unshift({label:e,value:t,timestamp:Date.now()}),safeSetItem(RECENT_ACTIONS_KEY,JSON.stringify(n.slice(0,MAX_RECENT_ACTIONS)))}catch{handleStorageFailure()}}function formatTimeAgo(e){const t=Math.floor((Date.now()-e)/1e3);return t<60?"just now":t<3600?`${Math.floor(t/60)} min ago`:t<86400?`${Math.floor(t/3600)} hr ago`:`${Math.floor(t/86400)} days ago`}function analyzeDocumentContext(){const e=currentHtml.toLowerCase();return{hasLogo:e.includes("logo")||e.includes("<img")&&e.includes("header"),hasQrCode:e.includes("qr")||e.includes("qrcode"),hasTerms:e.includes("terms")||e.includes("net 30")||e.includes("net 15"),hasDiscount:e.includes("discount"),hasSignature:e.includes("signature"),hasTax:e.includes("tax"),hasThankYouNote:e.includes("thank you")}}function fuzzyMatch(e,t){if(!e)return 50;const n=e.toLowerCase(),o=t.toLowerCase();return o===n?100:o.startsWith(n)?95:o.includes(n)?75:0}function applyFuzzyShortcuts(e){const t=e.toLowerCase(),n=[e];for(const[o,i]of Object.entries(FUZZY_SHORTCUTS))(t.startsWith(o)||t===o)&&n.push(...i);return n}let autocompleteVisible=!1,autocompleteSelectedIndex=0,allSuggestions=[],autocompleteDropdown=null;function createAutocompleteDropdown(){autocompleteDropdown=document.createElement("div"),autocompleteDropdown.className="playground-autocomplete",autocompleteDropdown.id="playground-autocomplete",autocompleteDropdown.style.display="none",playgroundInputWrapper.appendChild(autocompleteDropdown)}function getContextualSuggestions(){const e=analyzeDocumentContext(),t=[];return e.hasQrCode||t.push({type:"suggestion",category:"Suggestions",icon:"lightbulb",label:"Add QR code for payment",description:"Make it easy for clients to pay",value:"Add a QR code in the bottom right for easy mobile payment",score:92}),e.hasLogo||t.push({type:"suggestion",category:"Suggestions",icon:"lightbulb",label:"Add company logo",description:"Brand your document professionally",value:"Add the company logo in the header, sized appropriately",score:91}),e.hasTerms||t.push({type:"suggestion",category:"Suggestions",icon:"lightbulb",label:"Add payment terms - Net 30?",description:"Your invoice has no payment terms",value:"Add payment terms at the bottom: Net 30 days",score:88}),e.hasThankYouNote||t.push({type:"suggestion",category:"Suggestions",icon:"lightbulb",label:"Add a thank you note",description:"Personal touch builds relationships",value:'Add a thank you note at the bottom: "Thank you for your business!"',score:80}),t}function generateSuggestions(e){const t=e.trim().toLowerCase(),n=[],o=t.startsWith("make "),i=t.startsWith("add "),a=t.startsWith("change "),r=e.endsWith("{{");let s=t;o?s=t.slice(5):i?s=t.slice(4):a?s=t.slice(7):r&&(s=""),(!t||t.length<3)&&getRecentActions().forEach((m,f)=>{n.push({type:"recent",category:"Recent",icon:"clock",label:m.label,description:formatTimeAgo(m.timestamp),value:m.value,score:100-f})}),(!t||i)&&n.push(...getContextualSuggestions());const l=(d,m)=>{if(!m)return d;const f=applyFuzzyShortcuts(m);return d.filter(u=>f.some(g=>{const v=fuzzyMatch(g,u.label),h=fuzzyMatch(g,u.description)*.7;return Math.max(v,h)>30}))};o?n.push(...l(MAKE_SUGGESTIONS,s)):i?n.push(...l(ADD_SUGGESTIONS,s)):a&&n.push(...l(CHANGE_SUGGESTIONS,s)),!o&&!a&&!r&&n.push(...l(QUICK_ACTIONS,s));const p=DATA_FIELDS.map(d=>{const m=applyFuzzyShortcuts(s);let f=0;m.forEach(g=>{f=Math.max(f,fuzzyMatch(g,d.name),fuzzyMatch(g,d.path)*.9)});const u=r?85:60;return{type:"field",category:"Data Fields",icon:"field",label:d.name,description:`{{${d.path}}}`,value:`{{${d.path}}}`,path:d.path,example:d.example,score:s?u*(f/100):u}}).filter(d=>!s||d.score>15);n.push(...p);const c=new Map;return n.forEach(d=>{const m=d.value.toLowerCase();(!c.has(m)||d.score>c.get(m).score)&&c.set(m,d)}),Array.from(c.values()).sort((d,m)=>m.score-d.score).slice(0,15)}function renderAutocomplete(){if(!autocompleteDropdown)return;const e=["Recent","Suggestions","Quick Actions","Make Changes","Add Elements","Change Style","Data Fields"],t={};allSuggestions.forEach(i=>{t[i.category]||(t[i.category]=[]),t[i.category].push(i)});let n="",o=0;e.forEach(i=>{const a=t[i];if(!a||a.length===0)return;const r=CATEGORY_ICONS[i]||"";n+=`<div class="autocomplete-category ${i==="Recent"?"autocomplete-category--recent":i==="Suggestions"?"autocomplete-category--suggestions":i==="Quick Actions"?"autocomplete-category--quick":i==="Data Fields"?"autocomplete-category--fields":""}">
          <span class="autocomplete-category-icon">${r}</span>
          <span>${escapeHtml(i)}</span>
        </div>`,a.forEach(l=>{const p=o===autocompleteSelectedIndex,c=SUGGESTION_ICONS[l.icon]||SUGGESTION_ICONS.field,d=`autocomplete-item--${l.type}`;n+=`<div class="autocomplete-item ${d} ${p?"selected":""}" data-index="${o}">
            <div class="autocomplete-item-main">
              <span class="autocomplete-item-icon">${c}</span>
              <div class="autocomplete-item-content">
                <span class="autocomplete-item-name">${escapeHtml(l.label)}</span>
                <span class="autocomplete-item-description">${escapeHtml(l.description)}</span>
              </div>
            </div>
            ${l.example?`<span class="autocomplete-item-example">${escapeHtml(l.example)}</span>`:""}
          </div>`,o++})}),n+=`<div class="autocomplete-hint">
        <span><kbd>\u2191\u2193</kbd> Navigate</span>
        <span><kbd>Enter</kbd> Select</span>
        <span><kbd>Esc</kbd> Close</span>
      </div>`,autocompleteDropdown.innerHTML=n,autocompleteDropdown.querySelectorAll(".autocomplete-item").forEach(i=>{i.addEventListener("click",()=>{const a=parseInt(i.getAttribute("data-index")||"0",10);selectAutocompleteSuggestion(allSuggestions[a])}),i.addEventListener("mouseenter",()=>{autocompleteSelectedIndex=parseInt(i.getAttribute("data-index")||"0",10),updateAutocompleteSelection()})})}function showAutocomplete(){if(allSuggestions=generateSuggestions(promptInput.value),allSuggestions.length===0){hideAutocomplete();return}autocompleteSelectedIndex=0,renderAutocomplete(),autocompleteDropdown.style.display="block",autocompleteVisible=!0}function hideAutocomplete(){autocompleteDropdown&&(autocompleteDropdown.style.display="none"),autocompleteVisible=!1,autocompleteSelectedIndex=0}function updateAutocompleteSelection(){if(!autocompleteDropdown)return;autocompleteDropdown.querySelectorAll(".autocomplete-item").forEach((n,o)=>{n.classList.toggle("selected",o===autocompleteSelectedIndex)});const t=autocompleteDropdown.querySelector(".autocomplete-item.selected");t&&t.scrollIntoView({block:"nearest",behavior:"smooth"})}function selectAutocompleteSuggestion(e){if(!e)return;saveRecentAction(e.label,e.value);let t=e.value;if(e.type==="field"&&e.path){const n=promptInput.value;n.endsWith("{{")?t=n.slice(0,-2)+`{{${e.path}}}`:n.toLowerCase().startsWith("add ")?t={"client.email":"Add {{client.email}} below the client name","client.phone":"Add {{client.phone}} next to the client contact info","meta.notes":"Add {{meta.notes}} at the bottom of the document","meta.terms":"Add {{meta.terms}} in the footer section","branding.logoUrl":"Add the company logo {{branding.logoUrl}} in the header","totals.discount":"Add a discount row showing {{totals.discount}} in the totals section"}[e.path]||`Add {{${e.path}}} to the document`:t=`Add {{${e.path}}} to the document`}promptInput.value=t,promptInput.focus(),promptInput.setSelectionRange(promptInput.value.length,promptInput.value.length),hideAutocomplete()}createAutocompleteDropdown();function isInstantAction(e){const t=e.toLowerCase();return[/qr\s*code/i,/watermark/i,/payment\s*terms|net\s*\d+/i,/group.*category|group.*subtotal/i,/bold.*header|header.*bold/i,/add.*date|today.*date|date.*corner/i,/add.*border|border.*document/i,/thank\s*you.*note|thank.*note|add.*thank/i,/add.*signature|signature.*line/i].some(o=>o.test(t))}promptInput.addEventListener("input",debounce(()=>{showAutocomplete()},300)),promptInput.addEventListener("focus",()=>{showAutocomplete()}),promptInput.addEventListener("blur",()=>{setTimeout(()=>hideAutocomplete(),150)}),promptInput.addEventListener("keydown",e=>{autocompleteVisible&&(e.key==="ArrowDown"?(e.preventDefault(),autocompleteSelectedIndex=(autocompleteSelectedIndex+1)%allSuggestions.length,updateAutocompleteSelection()):e.key==="ArrowUp"?(e.preventDefault(),autocompleteSelectedIndex=(autocompleteSelectedIndex-1+allSuggestions.length)%allSuggestions.length,updateAutocompleteSelection()):e.key==="Enter"&&autocompleteVisible?(e.preventDefault(),selectAutocompleteSuggestion(allSuggestions[autocompleteSelectedIndex])):e.key==="Escape"?(e.preventDefault(),hideAutocomplete()):e.key==="Tab"&&autocompleteVisible&&(e.preventDefault(),selectAutocompleteSuggestion(allSuggestions[autocompleteSelectedIndex])))}),autocompleteDropdown&&autocompleteDropdown.addEventListener("mousedown",e=>{e.preventDefault()});const sampleQuoteData={branding:{companyName:"Acme Corporation",companyAddress:`123 Business Ave, Suite 100
San Francisco, CA 94102`,logoUrl:""},meta:{quoteNumber:"Q-2024-0042",date:"January 18, 2026",validUntil:"February 17, 2026",notes:"Thank you for your business! Payment due within 30 days.",terms:"Terms: Net 30 days. All prices in USD."},client:{name:"John Smith",company:"TechStart Inc.",email:"john@techstart.io",address:`456 Startup Lane
Palo Alto, CA 94301`},lineItems:[{description:"UI/UX Design",details:"Custom interface design and prototypes",quantity:1,unitPrice:3500,total:3500,category:"Design"},{description:"Brand Guidelines",details:"Logo usage, colors, typography specs",quantity:1,unitPrice:1500,total:1500,category:"Design"},{description:"Server Hardware",details:"Dell PowerEdge R750 with 64GB RAM",quantity:2,unitPrice:4200,total:8400,category:"Materials"},{description:"Network Equipment",details:"Cisco switches and cabling",quantity:1,unitPrice:2800,total:2800,category:"Materials"},{description:"Software Licenses",details:"Enterprise software bundle",quantity:5,unitPrice:450,total:2250,category:"Materials"},{description:"Installation",details:"On-site hardware setup and config",quantity:16,unitPrice:150,total:2400,category:"Labor"},{description:"Training",details:"Staff training sessions (4 hours each)",quantity:3,unitPrice:500,total:1500,category:"Labor"}],totals:{subtotal:22350,tax:0,discount:0,total:22350},styles:{accentColor:"#1E3A5F"}},sampleInvoiceData={branding:{companyName:"Acme Corporation",companyAddress:`123 Business Ave, Suite 100
San Francisco, CA 94102`,logoUrl:""},meta:{invoiceNumber:"INV-2026-0087",date:"January 27, 2026",dueDate:"February 26, 2026",notes:"Thank you for your prompt payment.",terms:"Payment due within 30 days. Late fees of 1.5% per month apply."},client:{name:"Sarah Chen",company:"Brightpath Analytics",email:"sarah@brightpath.io",address:`789 Data Drive
Austin, TX 73301`},lineItems:[{description:"Data Pipeline Setup",details:"ETL pipeline configuration and testing",quantity:1,unitPrice:4500,total:4500},{description:"Dashboard Development",details:"Custom analytics dashboards (3 views)",quantity:3,unitPrice:2e3,total:6e3},{description:"API Integration",details:"Third-party API connectors",quantity:2,unitPrice:1500,total:3e3}],totals:{subtotal:13500,tax:1080,discount:0,total:14580},styles:{accentColor:"#2563eb"}},sampleReceiptData={branding:{companyName:"Acme Corporation",companyAddress:`123 Business Ave
San Francisco, CA 94102`,logoUrl:""},meta:{receiptNumber:"REC-2026-0193",date:"January 27, 2026",paymentMethod:"Credit Card ending in 4242"},client:{name:"Alex Rivera",company:"Rivera Design Studio",email:"alex@riveradesign.co"},lineItems:[{description:"Monthly Subscription - Pro Plan",quantity:1,unitPrice:49,total:49},{description:"Additional Storage (50GB)",quantity:1,unitPrice:10,total:10}],totals:{subtotal:59,tax:4.72,total:63.72},styles:{accentColor:"#059669"}},sampleReportData={branding:{companyName:"Acme Corporation",companyAddress:`123 Business Ave
San Francisco, CA 94102`,logoUrl:""},meta:{reportTitle:"Q4 2025 Performance Review",date:"January 27, 2026",author:"Strategy Team",department:"Operations"},styles:{accentColor:"#7c3aed"}},TEMPLATE_TYPE_CONFIG={quote:{variants:[{id:"quote-modern",label:"Modern"},{id:"quote-professional",label:"Professional"},{id:"quote-bold",label:"Bold"}],data:sampleQuoteData},invoice:{variants:[{id:"invoice-clean",label:"Clean"}],data:sampleInvoiceData},receipt:{variants:[{id:"receipt-minimal",label:"Minimal"}],data:sampleReceiptData},report:{variants:[{id:"report-cover",label:"Cover"}],data:sampleReportData}};function getCurrentSampleData(){for(const[e,t]of Object.entries(TEMPLATE_TYPE_CONFIG))if(t.variants.some(n=>n.id===currentTemplate))return t.data;return sampleQuoteData}let isInDemoMode=!1;function updateSkeletonStage(e){const t=document.querySelectorAll(".preview-init-loading__stage"),n=["connecting","loading","ready"],o=n.indexOf(e);t.forEach(i=>{const a=i.dataset.stage,r=n.indexOf(a);i.classList.remove("active","completed"),r<o?i.classList.add("completed"):r===o&&i.classList.add("active")})}function hideInitialLoadingSkeleton(){const e=document.getElementById("preview-init-loading");e&&(updateSkeletonStage("ready"),setTimeout(()=>{e.classList.add("hidden"),setTimeout(()=>{e.style.display="none"},400)},300))}function showInitialLoadingSkeleton(){const e=document.getElementById("preview-init-loading");e&&(e.style.display="flex",e.classList.remove("hidden"),updateSkeletonStage("connecting"))}function showDemoModeBanner(){const e=document.getElementById("demo-mode-banner");e&&(e.classList.add("visible"),isInDemoMode=!0)}function hideDemoModeBanner(){const e=document.getElementById("demo-mode-banner");e&&(e.classList.remove("visible"),isInDemoMode=!1)}function setupDemoModeBanner(){const e=document.getElementById("demo-mode-retry"),t=document.getElementById("demo-mode-dismiss");e&&e.addEventListener("click",async()=>{e.textContent="Retrying...",e.disabled=!0,hideDemoModeBanner(),await initializePreview(),e.textContent="Retry Connection",e.disabled=!1}),t&&t.addEventListener("click",()=>{hideDemoModeBanner()})}async function initializePreview(){showInitialLoadingSkeleton(),setStatus("Connecting..."),updateSkeletonStage("connecting");try{setTimeout(()=>updateSkeletonStage("loading"),400);const e=await fetch(`${API_URL}/v1/preview`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${DEMO_API_KEY}`},body:JSON.stringify({template:currentTemplate,data:getCurrentSampleData()})});if(!e.ok)throw new Error("Failed to load preview");const t=await e.json();if(currentHtml=t.html,sessionId=t.sessionId,setStatus("Loading preview..."),hideDemoModeBanner(),renderPreview(currentHtml),hideInitialLoadingSkeleton(),setStatus("Ready"),startSessionTimer(),window.innerWidth<=480){const n=document.getElementById("preview-container");n&&n.classList.add("zoomed-in")}}catch(e){if(console.warn("API not available, using static demo:",e),updateSkeletonStage("loading"),setStatus("Loading demo..."),renderStaticDemo(),hideInitialLoadingSkeleton(),setStatus("Demo Mode"),showDemoModeBanner(),startSessionTimer(),window.innerWidth<=480){const t=document.getElementById("preview-container");t&&t.classList.add("zoomed-in")}}}function showPreviewError(){const e=previewFrame.parentElement;if(!e||e.querySelector(".glyph-preview-error"))return;const t=document.createElement("div");t.className="glyph-preview-error",t.innerHTML=`
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 2rem; text-align: center; background: #1a1a2e; color: #fff; border-radius: 8px;">
          <svg width="48" height="48" fill="none" stroke="#ef4444" viewBox="0 0 24 24" style="margin-bottom: 1rem;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <p style="font-size: 1rem; margin-bottom: 0.5rem; font-weight: 500;">Preview unavailable</p>
          <p style="font-size: 0.875rem; color: #9ca3af; margin-bottom: 1rem;">The preview couldn't load properly.</p>
          <button onclick="location.reload()" style="padding: 0.5rem 1rem; background: #7c3aed; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
            Refresh Page
          </button>
        </div>
      `,t.style.cssText="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10;",previewFrame.style.display="none",e.style.position="relative",e.appendChild(t)}function renderPreview(e,t={}){const{changes:n=[],previousHtml:o=null}=t;let i;try{if(i=previewFrame.contentDocument||previewFrame.contentWindow.document,!i)throw new Error("contentDocument is null")}catch(a){console.error("[Glyph] Preview frame access denied:",a),showPreviewError();return}try{i.open(),i.write(e),i.close()}catch(a){console.error("[Glyph] Preview frame write failed:",a),showPreviewError();return}(n.length>0||o)&&highlightChangedRegions(i,n,o,e)}function highlightChangedRegions(e,t,n,o){const i="glyph-change-highlight-styles";if(!e.getElementById(i)){const l=e.createElement("style");l.id=i,l.textContent=`
          .glyph-changed {
            position: relative;
            animation: glyphChangeHighlight 2.5s ease-out forwards;
            border-radius: 4px;
          }
          .glyph-changed::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
              90deg,
              transparent,
              rgba(124, 58, 237, 0.15),
              transparent
            );
            background-size: 200% 100%;
            animation: glyphChangeShimmer 1.5s ease-out;
            pointer-events: none;
            border-radius: inherit;
          }
          @keyframes glyphChangeHighlight {
            0% {
              box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.7), 0 0 20px rgba(124, 58, 237, 0.4);
              background-color: rgba(124, 58, 237, 0.08);
            }
            50% {
              box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.5), 0 0 30px rgba(124, 58, 237, 0.3);
              background-color: rgba(124, 58, 237, 0.05);
            }
            100% {
              box-shadow: 0 0 0 0px rgba(124, 58, 237, 0), 0 0 0px rgba(124, 58, 237, 0);
              background-color: rgba(124, 58, 237, 0);
            }
          }
          @keyframes glyphChangeShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
          }
        `,e.head.appendChild(l)}const a=e.querySelectorAll("[data-glyph-region]");let r=0;const s=extractChangeKeywords(t);a.forEach(l=>{const p=l.getAttribute("data-glyph-region").toLowerCase();s.some(d=>p.includes(d)||d.includes(p))&&(applyHighlight(l),r++)}),r===0&&n&&(r=highlightByDiff(e,n,o)),r===0&&t.length>0&&highlightByKeywordSearch(e,s),console.log(`[Glyph] Highlighted ${r} changed regions`)}function extractChangeKeywords(e){const t=[],n=[/header/i,/footer/i,/title/i,/subtitle/i,/logo/i,/color/i,/background/i,/font/i,/text/i,/border/i,/button/i,/link/i,/image/i,/icon/i,/table/i,/price/i,/total/i,/item/i,/product/i,/service/i,/company/i,/contact/i,/address/i,/phone/i,/email/i,/date/i,/number/i,/signature/i,/qr/i,/code/i,/payment/i,/terms/i,/notes/i,/description/i];return e.forEach(o=>{const i=o.toLowerCase();n.forEach(r=>{const s=i.match(r);s&&t.push(s[0].toLowerCase())}),(i.match(/\b[a-z]{4,}\b/gi)||[]).forEach(r=>{["added","updated","changed","modified","removed","style","styling"].includes(r.toLowerCase())||t.push(r.toLowerCase())})}),[...new Set(t)]}function applyHighlight(e){e.classList.add("glyph-changed"),setTimeout(()=>{e.classList.remove("glyph-changed")},2500)}function highlightByKeywordSearch(e,t){if(t.length===0)return;const n=["h1","h2","h3","h4","h5","h6","header","footer","section","article",".header",".footer",".title",".subtitle",'[class*="header"]','[class*="title"]','[class*="footer"]','[class*="logo"]','[class*="price"]','[class*="total"]'];e.querySelectorAll(n.join(", ")).forEach(i=>{const a=(i.className||"").toLowerCase(),r=(i.id||"").toLowerCase(),s=(i.textContent||"").toLowerCase().substring(0,100);t.some(p=>a.includes(p)||r.includes(p)||s.includes(p))&&applyHighlight(i)})}function highlightByDiff(e,t,n){let o=0;const i=document.createElement("div"),a=document.createElement("div");return i.innerHTML=t,a.innerHTML=n,e.querySelectorAll("[data-glyph-region]").forEach(l=>{const p=l.getAttribute("data-glyph-region"),c=i.querySelector(`[data-glyph-region="${p}"]`);(!c||c.innerHTML!==l.innerHTML)&&(applyHighlight(l),o++)}),e.querySelectorAll("h1, h2, h3, .header, .title, table, .total").forEach(l=>{const p=i.querySelectorAll(l.tagName);let c=!1;p.forEach(d=>{d.outerHTML===l.outerHTML&&(c=!0)}),!c&&!l.classList.contains("glyph-changed")&&(applyHighlight(l),o++)}),o}function saveToUndoHistory(){currentHtml&&(undoHistory.push(currentHtml),redoHistory=[],undoHistory.length>MAX_UNDO_HISTORY&&undoHistory.shift(),updateUndoButtonState())}function performUndo(){if(undoHistory.length===0)return;currentHtml=undoHistory.pop(),renderPreview(currentHtml),refreshAppliedActionsFromHtml(currentHtml),previewContainer.classList.add("success"),setTimeout(()=>previewContainer.classList.remove("success"),500),flashPreviewArea(),setStatus("Undone"),console.log("[Glyph] Undo performed, history length:",undoHistory.length),setTimeout(()=>setStatus("Ready"),1500),updateUndoButtonState(),clearDiffState()}function updateUndoButtonState(){undoBtn&&(undoBtn.disabled=undoHistory.length===0,undoBtn.title=undoHistory.length>0?`Undo last change (${undoHistory.length} available)`:"No changes to undo"),updateShareAndSaveButtonState()}function updateShareAndSaveButtonState(){const e=undoHistory.length>0,t=document.getElementById("share-btn"),n=document.getElementById("save-version-btn");t&&(t.disabled=!e,t.title="Share this customization",t.dataset.tooltip=e?"":"Make a change to share"),n&&(n.disabled=!e,n.title="Save named version",n.dataset.tooltip=e?"":"Make a change to save a version")}function clearUndoHistory(){undoHistory=[],updateUndoButtonState(),clearAllAppliedActions(),clearDiffState()}function snapshotRegions(e){const t=document.createElement("div");t.innerHTML=e;const n=new Map;return t.querySelectorAll("[data-glyph-region]").forEach(o=>{n.set(o.getAttribute("data-glyph-region"),o.innerHTML)}),n}function captureDiffBefore(){currentHtml&&(diffRegionSnapshots={before:snapshotRegions(currentHtml),after:null},isDiffActive&&toggleDiffView(!1))}function captureDiffAfter(){!diffRegionSnapshots||!currentHtml||(diffRegionSnapshots.after=snapshotRegions(currentHtml),updateDiffButtonState())}function getChangedRegionNames(){if(!diffRegionSnapshots||!diffRegionSnapshots.before||!diffRegionSnapshots.after)return[];const e=[],t=diffRegionSnapshots.after,n=diffRegionSnapshots.before;return t.forEach((o,i)=>{const a=n.get(i);(a===void 0||a!==o)&&e.push(i)}),n.forEach((o,i)=>{t.has(i)||e.push(i)}),e}function toggleDiffView(e){isDiffActive=e!==void 0?e:!isDiffActive,diffToggleBtn&&diffToggleBtn.classList.toggle("active",isDiffActive);const n=previewFrame;if(!n||!n.contentDocument)return;const o=n.contentDocument,i="glyph-diff-toggle-styles";if(!isDiffActive){const r=o.getElementById(i);r&&r.remove(),o.querySelectorAll(".glyph-diff-changed").forEach(s=>{s.classList.remove("glyph-diff-changed")});return}if(!o.getElementById(i)){const r=o.createElement("style");r.id=i,r.textContent=`
          .glyph-diff-changed {
            outline: 2px solid rgba(34, 197, 94, 0.6);
            outline-offset: 2px;
            background-color: rgba(34, 197, 94, 0.06);
            border-radius: 3px;
            transition: outline-color 0.2s, background-color 0.2s;
          }
        `,o.head.appendChild(r)}const a=getChangedRegionNames();a.forEach(r=>{const s=o.querySelector(`[data-glyph-region="${r}"]`);s&&s.classList.add("glyph-diff-changed")}),console.log(`[Glyph] Diff view: ${a.length} changed regions highlighted`)}function updateDiffButtonState(){if(!diffToggleBtn)return;const e=getChangedRegionNames().length>0;diffToggleBtn.disabled=!e,diffToggleBtn.title=e?`Show changes (${getChangedRegionNames().length} regions changed)`:"No changes to show"}function clearDiffState(){diffRegionSnapshots=null,isDiffActive=!1,diffToggleBtn&&(diffToggleBtn.classList.remove("active"),diffToggleBtn.disabled=!0,diffToggleBtn.title="No changes to show")}diffToggleBtn&&diffToggleBtn.addEventListener("click",()=>{diffToggleBtn.disabled||toggleDiffView()});const shortcutsBar=document.getElementById("shortcuts-bar"),shortcutsDismiss=document.getElementById("shortcuts-dismiss"),SHORTCUTS_DISMISSED_KEY="glyph_shortcuts_dismissed",isMac=navigator.platform.toUpperCase().indexOf("MAC")>=0,modKey=isMac?"\u2318":"Ctrl";function initShortcutLabels(){document.querySelectorAll("#shortcut-mod, #shortcut-mod-2, #shortcut-mod-3").forEach(t=>{t&&(t.textContent=modKey)})}function initShortcutsBar(){safeGetItem(SHORTCUTS_DISMISSED_KEY)==="true"&&shortcutsBar.classList.add("hidden"),initShortcutLabels()}shortcutsDismiss&&shortcutsDismiss.addEventListener("click",()=>{shortcutsBar.classList.add("hidden"),safeSetItem(SHORTCUTS_DISMISSED_KEY,"true")});function performRedo(){if(redoHistory.length===0)return;currentHtml&&(undoHistory.push(currentHtml),undoHistory.length>MAX_UNDO_HISTORY&&undoHistory.shift()),currentHtml=redoHistory.pop(),renderPreview(currentHtml),refreshAppliedActionsFromHtml(currentHtml),currentHistoryIndex<historyEntries.length-1&&(currentHistoryIndex++,updateHistoryCount(),renderHistoryPanel()),setStatus("Redone"),console.log("[Glyph] Redo performed, history length:",redoHistory.length),setTimeout(()=>setStatus("Ready"),1500),updateUndoButtonState()}const originalPerformUndo=performUndo;performUndo=function(){if(undoHistory.length===0)return;currentHtml&&(redoHistory.push(currentHtml),redoHistory.length>MAX_REDO_HISTORY&&redoHistory.shift()),currentHtml=undoHistory.pop(),renderPreview(currentHtml),refreshAppliedActionsFromHtml(currentHtml),currentHistoryIndex>0&&(currentHistoryIndex--,updateHistoryCount(),renderHistoryPanel()),setStatus("Undone"),console.log("[Glyph] Undo performed, history length:",undoHistory.length),setTimeout(()=>setStatus("Ready"),1500),updateUndoButtonState(),clearDiffState()},document.addEventListener("keydown",e=>{const t=isMac?e.metaKey:e.ctrlKey;if(t&&e.key==="z"&&!e.shiftKey&&(e.preventDefault(),performUndo()),t&&e.key==="z"&&e.shiftKey&&(e.preventDefault(),performRedo()),t&&e.key==="Enter"){e.preventDefault();const n=document.getElementById("prompt-input");n&&n.value.trim()&&applyModifications(n.value.trim())}if(e.key==="Escape"){const n=document.getElementById("prompt-input");n&&(n.value="",n.blur())}}),initShortcutsBar();const commandPaletteOverlay=document.getElementById("command-palette-overlay"),commandPaletteInput=document.getElementById("command-palette-input"),commandPaletteResults=document.getElementById("command-palette-results"),cmdKHint=document.getElementById("cmd-k-hint"),cmdKLabel=document.getElementById("cmd-k-label");cmdKLabel&&(cmdKLabel.textContent=isMac?"\u2318K":"Ctrl+K");let selectedCommandIndex=0,filteredPaletteCommands=[];const paletteCommands=[{name:"Add Watermark",action:()=>applyInstantCommand("Add a diagonal watermark that says DRAFT across the page"),category:"Quick Actions",icon:"watermark"},{name:"Add QR Code",action:()=>applyInstantCommand("Add a QR code in the corner for quick mobile payment"),category:"Quick Actions",icon:"qr"},{name:"Add Payment Terms",action:()=>applyInstantCommand("Add payment terms: Net 30 with 2% early payment discount if paid within 10 days"),category:"Quick Actions",icon:"terms"},{name:"Add Date",action:()=>applyInstantCommand("Add today's date in the top right corner"),category:"Quick Actions",icon:"date"},{name:"Add Border",action:()=>applyInstantCommand("Add a professional border around the document"),category:"Quick Actions",icon:"border"},{name:"Add Thank You Note",action:()=>applyInstantCommand("Add a thank you note at the bottom"),category:"Quick Actions",icon:"note"},{name:"Add Signature",action:()=>applyInstantCommand("Add a signature"),category:"Quick Actions",icon:"signature"},{name:"Switch to Modern Quote",action:()=>switchToTemplate("quote-modern"),category:"Templates",icon:"template"},{name:"Switch to Professional Quote",action:()=>switchToTemplate("quote-professional"),category:"Templates",icon:"template"},{name:"Switch to Bold Quote",action:()=>switchToTemplate("quote-bold"),category:"Templates",icon:"template"},{name:"Switch to Invoice",action:()=>switchToTemplateType("invoice"),category:"Templates",icon:"template"},{name:"Switch to Receipt",action:()=>switchToTemplateType("receipt"),category:"Templates",icon:"template"},{name:"Switch to Report Cover",action:()=>switchToTemplateType("report"),category:"Templates",icon:"template"},{name:"Undo",action:()=>performUndo(),category:"Edit",shortcut:isMac?"\u2318Z":"Ctrl+Z",icon:"undo"},{name:"Redo",action:()=>performRedo(),category:"Edit",shortcut:isMac?"\u21E7\u2318Z":"Ctrl+Shift+Z",icon:"redo"},{name:"Download PDF",action:()=>triggerPdfDownload(),category:"Export",icon:"download"},{name:"Get API Code",action:()=>openCopyCodeModal(),category:"Developer",icon:"code"},{name:"View History",action:()=>toggleHistoryPanel(),category:"View",icon:"history"},{name:"Go to Dashboard",action:()=>window.open("https://dashboard.glyph.you","_blank"),category:"Navigation",icon:"external"},{name:"Go to Docs",action:()=>window.open("https://docs.glyph.you","_blank"),category:"Navigation",icon:"external"}];function applyInstantCommand(e){const t=document.getElementById("prompt-input");t&&(t.value=e,applyModifications(e))}function switchToTemplate(e){for(const[n,o]of Object.entries(TEMPLATE_TYPE_CONFIG))if(o.variants.some(i=>i.id===e)){const i=document.getElementById("template-type-select-playground");if(i&&i.value!==n){i.value=n,i.dispatchEvent(new Event("change")),setTimeout(()=>{const a=document.querySelector(`.playground__tab[data-template="${e}"]`);a&&!a.classList.contains("playground__tab--active")&&a.click()},500);return}break}const t=document.querySelector(`.playground__tab[data-template="${e}"]`);t&&!t.classList.contains("playground__tab--active")&&t.click()}function switchToTemplateType(e){const t=document.getElementById("template-type-select-playground");t&&t.value!==e&&(t.value=e,t.dispatchEvent(new Event("change")))}function triggerPdfDownload(){const e=document.getElementById("generate-btn");e&&!e.disabled&&e.click()}function getCommandIcon(e){const t={watermark:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>',qr:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>',terms:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>',date:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>',border:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v14a1 1 0 01-1 1H5a1 1 0 01-1-1V5z"/>',note:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>',signature:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>',template:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>',undo:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>',redo:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/>',download:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>',code:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>',history:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>',external:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>'};return t[e]||t.note}function filterPaletteCommands(e){if(!e)return[...paletteCommands];const t=e.toLowerCase();return paletteCommands.filter(n=>n.name.toLowerCase().includes(t)||n.category.toLowerCase().includes(t))}function renderCommandResults(){if(!commandPaletteResults)return;if(filteredPaletteCommands.length===0){commandPaletteResults.innerHTML='<div class="command-palette__empty">No matching commands</div>';return}const e={};filteredPaletteCommands.forEach(n=>{e[n.category]||(e[n.category]=[]),e[n.category].push(n)});let t="";Object.entries(e).forEach(([n,o])=>{t+=`<div class="command-palette__category">${n}</div>`,o.forEach((i,a)=>{const r=filteredPaletteCommands.indexOf(i);t+=`
            <div class="command-palette__item${r===selectedCommandIndex?" command-palette__item--selected":""}" data-index="${r}">
              <svg class="command-palette__item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${getCommandIcon(i.icon)}
              </svg>
              <span class="command-palette__item-name">${i.name}</span>
              ${i.shortcut?`<span class="command-palette__item-shortcut">${i.shortcut}</span>`:""}
            </div>
          `})}),commandPaletteResults.innerHTML=t,commandPaletteResults.querySelectorAll(".command-palette__item").forEach(n=>{n.addEventListener("click",()=>{const o=parseInt(n.dataset.index,10);executeCommand(o)}),n.addEventListener("mouseenter",()=>{selectedCommandIndex=parseInt(n.dataset.index,10),updateSelectedItem()})})}function updateSelectedItem(){commandPaletteResults.querySelectorAll(".command-palette__item").forEach((n,o)=>{const i=parseInt(n.dataset.index,10);n.classList.toggle("command-palette__item--selected",i===selectedCommandIndex)});const t=commandPaletteResults.querySelector(".command-palette__item--selected");t&&t.scrollIntoView({block:"nearest"})}function executeCommand(e){const t=filteredPaletteCommands[e];t&&(closeCommandPalette(),setTimeout(()=>t.action(),50))}function openCommandPalette(){commandPaletteOverlay&&(commandPaletteOverlay.classList.add("visible"),document.body.style.overflow="hidden",selectedCommandIndex=0,filteredPaletteCommands=filterPaletteCommands(""),commandPaletteInput&&(commandPaletteInput.value="",commandPaletteInput.focus()),renderCommandResults())}function closeCommandPalette(){commandPaletteOverlay&&(commandPaletteOverlay.classList.remove("visible"),document.body.style.overflow="")}commandPaletteInput&&(commandPaletteInput.addEventListener("input",e=>{const t=e.target.value;filteredPaletteCommands=filterPaletteCommands(t),selectedCommandIndex=0,renderCommandResults()}),commandPaletteInput.addEventListener("keydown",e=>{e.key==="ArrowDown"?(e.preventDefault(),selectedCommandIndex=Math.min(selectedCommandIndex+1,filteredPaletteCommands.length-1),updateSelectedItem()):e.key==="ArrowUp"?(e.preventDefault(),selectedCommandIndex=Math.max(selectedCommandIndex-1,0),updateSelectedItem()):e.key==="Enter"?(e.preventDefault(),executeCommand(selectedCommandIndex)):e.key==="Escape"&&(e.preventDefault(),closeCommandPalette())})),commandPaletteOverlay&&commandPaletteOverlay.addEventListener("click",e=>{e.target===commandPaletteOverlay&&closeCommandPalette()}),cmdKHint&&cmdKHint.addEventListener("click",openCommandPalette),document.addEventListener("keydown",e=>{(isMac?e.metaKey:e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),commandPaletteOverlay?.classList.contains("visible")?closeCommandPalette():openCommandPalette()),e.key==="Escape"&&commandPaletteOverlay?.classList.contains("visible")&&(e.preventDefault(),e.stopPropagation(),closeCommandPalette())});const shortcutsOverlay=document.getElementById("shortcuts-overlay"),shortcutsClose=shortcutsOverlay?.querySelector(".shortcuts-close");document.querySelectorAll(".shortcuts-overlay .mod-key").forEach(e=>{e.textContent=isMac?"\u2318":"Ctrl"});function showShortcuts(){shortcutsOverlay?.classList.remove("hidden"),document.body.style.overflow="hidden"}function hideShortcuts(){shortcutsOverlay?.classList.add("hidden"),document.body.style.overflow=""}document.addEventListener("keydown",e=>{e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||commandPaletteOverlay?.classList.contains("visible")||(e.key==="?"&&(e.preventDefault(),shortcutsOverlay?.classList.contains("hidden")?showShortcuts():hideShortcuts()),e.key==="Escape"&&!shortcutsOverlay?.classList.contains("hidden")&&(e.preventDefault(),hideShortcuts()))}),shortcutsClose?.addEventListener("click",hideShortcuts),shortcutsOverlay?.addEventListener("click",e=>{e.target===shortcutsOverlay&&hideShortcuts()});let historyToggleBtn,historyPanel,historyPanelClose,historyPanelContent,historyCountEl;function getHistoryElements(){historyToggleBtn||(historyToggleBtn=document.getElementById("history-toggle-btn"),historyPanel=document.getElementById("history-panel"),historyPanelClose=document.getElementById("history-panel-close"),historyPanelContent=document.getElementById("history-panel-content"),historyCountEl=document.getElementById("history-count"))}let historyEntries=[],currentHistoryIndex=-1;const MAX_HISTORY_ENTRIES=50;function addHistoryEntry(e,t){const n={id:Date.now(),timestamp:new Date,prompt:e||"Initial state",html:t};currentHistoryIndex<historyEntries.length-1&&(historyEntries=historyEntries.slice(0,currentHistoryIndex+1)),historyEntries.push(n),currentHistoryIndex=historyEntries.length-1,historyEntries.length>MAX_HISTORY_ENTRIES&&(historyEntries.shift(),currentHistoryIndex--),updateHistoryCount(),renderHistoryPanel()}function updateHistoryCount(){getHistoryElements(),historyCountEl&&(historyCountEl.textContent=historyEntries.length)}function formatHistoryTime(e){const n=new Date-e,o=Math.floor(n/1e3),i=Math.floor(o/60),a=Math.floor(i/60);return o<60?"Just now":i<60?`${i}m ago`:a<24?`${a}h ago`:e.toLocaleDateString()}function renderHistoryPanel(){if(getHistoryElements(),!historyPanelContent)return;if(historyEntries.length===0){historyPanelContent.innerHTML=`
          <div class="history-panel__empty">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="history-panel__empty-title">No changes yet</div>
            <div class="history-panel__empty-text">Apply some changes to see your edit history here</div>
          </div>
        `;return}const e=historyEntries.slice().reverse().map((t,n)=>{const o=historyEntries.length-1-n,i=o===currentHistoryIndex;return`
            <div class="history-entry${i?" history-entry--current":""}" data-index="${o}">
              <div class="history-entry__time">${formatHistoryTime(new Date(t.timestamp))}</div>
              <div class="history-entry__prompt">${escapeHtml(t.prompt)}</div>
              ${i?"":'<button class="history-entry__restore">Restore</button>'}
            </div>
          `}).join("");historyPanelContent.innerHTML=`<div class="history-timeline">${e}</div>`,historyPanelContent.querySelectorAll(".history-entry").forEach(t=>{t.addEventListener("click",n=>{if(n.target.classList.contains("history-entry__restore")||!t.classList.contains("history-entry--current")){const o=parseInt(t.dataset.index,10);restoreHistoryEntry(o)}})})}function restoreHistoryEntry(e){if(e<0||e>=historyEntries.length)return;const t=historyEntries[e];currentHistoryIndex=e,currentHtml=t.html,renderPreview(currentHtml),renderHistoryPanel(),showToast(`Restored to "${t.prompt.substring(0,30)}${t.prompt.length>30?"...":""}"`)}function toggleHistoryPanel(){getHistoryElements(),historyPanel&&(historyPanel.classList.toggle("open"),historyToggleBtn?.classList.toggle("active",historyPanel.classList.contains("open")))}function closeHistoryPanel(){historyPanel&&(historyPanel.classList.remove("open"),historyToggleBtn?.classList.remove("active"))}function initHistoryPanelListeners(){getHistoryElements(),historyToggleBtn&&historyToggleBtn.addEventListener("click",toggleHistoryPanel),historyPanelClose&&historyPanelClose.addEventListener("click",closeHistoryPanel),document.addEventListener("click",e=>{getHistoryElements(),historyPanel?.classList.contains("open")&&!historyPanel.contains(e.target)&&!historyToggleBtn?.contains(e.target)&&closeHistoryPanel()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initHistoryPanelListeners):initHistoryPanelListeners();const SAVED_VERSIONS_KEY="glyph_saved_versions",MAX_SAVED_VERSIONS=10;let _saveVersionElements=null;function getSaveVersionElements(){return _saveVersionElements||(_saveVersionElements={saveVersionBtn:document.getElementById("save-version-btn"),saveVersionModal:document.getElementById("save-version-modal"),versionNameInput:document.getElementById("version-name-input"),saveVersionConfirm:document.getElementById("save-version-confirm"),saveVersionCancel:document.getElementById("save-version-cancel"),savedVersionsList:document.getElementById("saved-versions-list"),savedVersionsCount:document.getElementById("saved-versions-count"),deleteConfirmModal:document.getElementById("delete-confirm-modal"),deleteVersionName:document.getElementById("delete-version-name"),deleteConfirm:document.getElementById("delete-confirm"),deleteCancel:document.getElementById("delete-cancel"),glyphToast:document.getElementById("glyph-toast"),toastMessage:document.getElementById("toast-message")}),_saveVersionElements}let savedVersions=[],versionToDelete=null;function loadSavedVersions(){try{const e=safeGetItem(SAVED_VERSIONS_KEY);savedVersions=e?JSON.parse(e):[],renderSavedVersions()}catch(e){console.error("[Glyph] Error loading saved versions:",e),savedVersions=[]}}function persistSavedVersions(){safeSetItem(SAVED_VERSIONS_KEY,JSON.stringify(savedVersions))||handleStorageFailure()}function showToast(e,t="success",n=3e3){const o=getSaveVersionElements();if(!o.glyphToast||!o.toastMessage)return;o.toastMessage.textContent=e,o.glyphToast.className="glyph-toast glyph-toast--"+t;const i=o.glyphToast.querySelector(".glyph-toast__icon path");i&&(t==="success"?i.setAttribute("d","M5 13l4 4L19 7"):t==="error"?i.setAttribute("d","M6 18L18 6M6 6l12 12"):t==="info"?i.setAttribute("d","M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"):t==="warning"&&i.setAttribute("d","M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z")),o.glyphToast.style.display="flex",o.glyphToast.removeAttribute("aria-hidden"),o.glyphToast.classList.add("active"),setTimeout(()=>{o.glyphToast.classList.remove("active"),setTimeout(()=>{o.glyphToast.classList.contains("active")||(o.glyphToast.style.display="none",o.glyphToast.setAttribute("aria-hidden","true"))},300)},n)}function showSuccessCta(){if(hasShownSuccessCta)return;hasShownSuccessCta=!0;const e=document.getElementById("success-cta");e&&setTimeout(()=>{e.classList.add("visible")},1e3)}const FIRST_WIN_KEY="glyph_first_win";function isFirstWin(){try{return!localStorage.getItem(FIRST_WIN_KEY)}catch{return!1}}function markFirstWinComplete(){try{localStorage.setItem(FIRST_WIN_KEY,"true")}catch{}}function celebrateFirstInstantWin(){if(hasShownFirstInstantWin)return;hasShownFirstInstantWin=!0;const e=document.querySelector(".playground__preview-area");e&&(e.classList.add("first-win-glow"),setTimeout(()=>{e.classList.remove("first-win-glow")},800)),showModificationSuccessToast(0,!0),updateResponseTimeBadge(0,!0),promptSaveAfterFirstWin()}function flashPreviewArea(){const e=document.querySelector(".playground__preview-area");e&&(e.classList.remove("content-updated"),e.offsetWidth,e.classList.add("content-updated"),setTimeout(()=>{e.classList.remove("content-updated")},500))}function highlightQuickActions(){document.querySelectorAll(".playground__suggestion--hero:not(.playground__suggestion--applied)").forEach((n,o)=>{setTimeout(()=>{n.classList.add("playground__suggestion--highlight"),setTimeout(()=>{n.classList.remove("playground__suggestion--highlight")},600)},o*100)});const t=document.querySelector(".playground__suggestions");t&&window.innerWidth<=480&&t.scrollIntoView({behavior:"smooth",block:"nearest"})}function markActionApplied(e){document.querySelectorAll(".playground__suggestion").forEach(n=>{n.dataset.prompt===e&&(n.classList.add("playground__suggestion--applied"),appliedActions.add(e))})}function clearActionApplied(e){document.querySelectorAll(".playground__suggestion").forEach(n=>{n.dataset.prompt===e&&(n.classList.remove("playground__suggestion--applied"),appliedActions.delete(e))})}function clearAllAppliedActions(){document.querySelectorAll(".playground__suggestion").forEach(t=>{t.classList.remove("playground__suggestion--applied")}),appliedActions.clear()}function refreshAppliedActionsFromHtml(e){const t=document.querySelectorAll(".playground__suggestion");console.log("[Glyph] Refreshing applied action states from HTML"),t.forEach(n=>{const o=n.dataset.prompt,i=o.toLowerCase();let a=!1;/watermark/i.test(i)?a=e.includes("glyph-watermark"):/qr\s*code/i.test(i)?a=e.includes("glyph-qr-code"):/group.*category/i.test(i)?a=e.includes("glyph-category-group"):/payment\s*terms|net\s*\d+/i.test(i)?a=e.includes("glyph-payment-terms"):/bold.*header|header.*bold/i.test(i)?a=e.includes("glyph-bold-header"):/add.*date|today.*date/i.test(i)?a=e.includes("glyph-date-added"):/add.*border|border.*document/i.test(i)?a=e.includes("glyph-document-border"):/thank\s*you.*note|add.*thank/i.test(i)?a=e.includes("glyph-thank-you"):/add.*signature|signature.*line/i.test(i)&&(a=e.includes("glyph-signature-line")),a?(n.classList.add("playground__suggestion--applied"),appliedActions.add(o)):(n.classList.remove("playground__suggestion--applied"),appliedActions.delete(o))})}let hasPromptedSaveAfterWin=!1;function promptSaveAfterFirstWin(){hasPromptedSaveAfterWin||savedVersions.length>0||(hasPromptedSaveAfterWin=!0,setTimeout(()=>{const e=document.getElementById("save-version-btn");e&&(e.classList.add("ready-to-save"),setTimeout(()=>{e.classList.remove("ready-to-save")},6e3))},1500))}let lastSuccessfulModifyRequest=null;function trackModifyRequest(e){lastSuccessfulModifyRequest={sessionId:e.sessionId||sessionId,prompt:e.prompt,timestamp:Date.now()}}function openCopyCodeModal(){const e=document.getElementById("copy-code-modal");!e||!lastSuccessfulModifyRequest||(generateCodeSnippets(),e.classList.add("active"),document.body.style.overflow="hidden")}function closeCopyCodeModal(){const e=document.getElementById("copy-code-modal");e&&(e.classList.remove("active"),document.body.style.overflow="")}function generateCodeSnippets(){if(!lastSuccessfulModifyRequest)return;const{sessionId:e,prompt:t}=lastSuccessfulModifyRequest,n="https://api.glyph.you",i=(d=>JSON.stringify(d).slice(1,-1))(t),a=`curl -X POST ${n}/v1/modify \\
  -H "Authorization: Bearer YOUR_API_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{
    "sessionId": "${e}",
    "prompt": "${i}"
  }'`,r=`const response = await fetch('${n}/v1/modify', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    sessionId: '${e}',
    prompt: '${i}'
  })
});

const result = await response.json();
console.log(result.html); // Updated HTML`,s=`import requests

response = requests.post(
    '${n}/v1/modify',
    headers={
        'Authorization': 'Bearer YOUR_API_KEY',
        'Content-Type': 'application/json'
    },
    json={
        'sessionId': '${e}',
        'prompt': '${i}'
    }
)

result = response.json()
print(result['html'])  # Updated HTML`,l=document.getElementById("code-snippet-curl"),p=document.getElementById("code-snippet-javascript"),c=document.getElementById("code-snippet-python");l&&(l.textContent=a),p&&(p.textContent=r),c&&(c.textContent=s)}function initCopyCodeModal(){const e=document.getElementById("copy-code-modal");if(!e)return;const t=document.getElementById("copy-code-close");t&&t.addEventListener("click",closeCopyCodeModal),e.addEventListener("click",a=>{a.target===e&&closeCopyCodeModal()}),document.addEventListener("keydown",a=>{a.key==="Escape"&&e.classList.contains("active")&&closeCopyCodeModal()});const n=e.querySelectorAll(".copy-code-modal__tab"),o=e.querySelectorAll(".copy-code-modal__snippet");n.forEach(a=>{a.addEventListener("click",()=>{const r=a.dataset.lang;n.forEach(s=>s.classList.remove("copy-code-modal__tab--active")),a.classList.add("copy-code-modal__tab--active"),o.forEach(s=>{s.dataset.lang===r?s.classList.add("copy-code-modal__snippet--active"):s.classList.remove("copy-code-modal__snippet--active")})})}),e.querySelectorAll(".copy-code-modal__copy-btn").forEach(a=>{a.addEventListener("click",async()=>{const r=a.dataset.lang,s=document.getElementById(`code-snippet-${r}`);if(!s)return;if(await copyTextToClipboard(s.textContent)){const p=a.innerHTML;a.classList.add("copy-code-modal__copy-btn--copied"),a.innerHTML=`
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Copied!
            `,setTimeout(()=>{a.classList.remove("copy-code-modal__copy-btn--copied"),a.innerHTML=p},2e3)}else showToast("Couldn't copy to clipboard - try Ctrl/Cmd+C","error",4e3)})}),console.log("[Glyph] Copy as Code modal initialized")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initCopyCodeModal):initCopyCodeModal();let modificationSuccessToastElement=null,modificationSuccessToastTimeout=null;function updateResponseTimeBadge(e,t=!1){const n=document.getElementById("response-time-badge");if(!n)return;const o=parseFloat(e),i=t||o<.5;n.textContent=t?"Instant":`${e}s`,n.className="playground__response-time"+(i?" playground__response-time--fast":""),n.style.display=""}function showModificationSuccessToast(e,t=!1){const n=isFirstWin();if(!modificationSuccessToastElement){modificationSuccessToastElement=document.createElement("div"),modificationSuccessToastElement.className="modification-success-toast",modificationSuccessToastElement.innerHTML=`
          <svg class="modification-success-toast__icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
          </svg>
          <div class="modification-success-toast__content">
            <span class="modification-success-toast__title">Changes applied successfully</span>
            <span class="modification-success-toast__detail"></span>
          </div>
          <div class="modification-success-toast__actions">
            <button class="modification-success-toast__code-btn" id="toast-get-code-btn" title="Get API code for this modification">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
              </svg>
              <span>Get Code</span>
            </button>
          </div>
        `,document.body.appendChild(modificationSuccessToastElement);const r=modificationSuccessToastElement.querySelector("#toast-get-code-btn");r&&r.addEventListener("click",s=>{s.stopPropagation(),modificationSuccessToastElement.classList.remove("visible"),modificationSuccessToastTimeout&&clearTimeout(modificationSuccessToastTimeout),openCopyCodeModal()})}const o=modificationSuccessToastElement.querySelector(".modification-success-toast__title"),i=modificationSuccessToastElement.querySelector(".modification-success-toast__detail");if(n?(o&&(o.textContent="You just customized your first PDF!"),i&&(i.textContent="That was all you. Try another change!"),markFirstWinComplete()):t?(o&&(o.textContent="Changes applied instantly!"),i&&(i.textContent="Local transformation - no API call needed")):(o&&(o.textContent="Changes applied successfully"),i&&(i.textContent=`Completed in ${e}s`)),modificationSuccessToastTimeout&&clearTimeout(modificationSuccessToastTimeout),requestAnimationFrame(()=>{modificationSuccessToastElement.classList.add("visible")}),modificationSuccessToastTimeout=setTimeout(()=>{modificationSuccessToastElement.classList.remove("visible")},n?5e3:4e3),window.innerWidth<=480){const r=document.querySelector(".playground__preview-area");r&&setTimeout(()=>{r.scrollIntoView({behavior:"smooth",block:"start"})},300),n&&previewContainer&&!previewContainer.classList.contains("zoomed-in")&&setTimeout(()=>{previewContainer.classList.add("zoomed-in")},800)}}function formatTimestamp(e){const t=new Date(e),o=new Date-t,i=Math.floor(o/6e4),a=Math.floor(o/36e5),r=Math.floor(o/864e5);return i<1?"Just now":i<60?i+" min ago":a<24?a+" hour"+(a===1?"":"s")+" ago":r<7?r+" day"+(r===1?"":"s")+" ago":t.toLocaleDateString("en-US",{month:"short",day:"numeric"})}function renderSavedVersions(){const e=getSaveVersionElements();if(!e.savedVersionsList||!e.savedVersionsCount)return;if(e.savedVersionsCount.textContent=savedVersions.length+"/10",savedVersions.length===0){e.savedVersionsList.innerHTML='<div class="saved-versions__empty">Save your best versions <span class="saved-versions__slots">'+(MAX_SAVED_VERSIONS-savedVersions.length)+" slots available</span></div>";return}const t=[...savedVersions].sort((n,o)=>o.timestamp-n.timestamp);e.savedVersionsList.innerHTML=t.map(n=>{const o=document.createElement("div");return o.className="saved-version-item",o.setAttribute("data-id",n.id),o.innerHTML='<svg class="saved-version-item__star" fill="currentColor" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg><div class="saved-version-item__info"><div class="saved-version-item__name">'+escapeHtml(n.name)+'</div><div class="saved-version-item__date">'+formatTimestamp(n.timestamp)+'</div></div><button class="saved-version-item__delete" data-id="'+n.id+'" title="Delete version"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>',o.outerHTML}).join(""),e.savedVersionsList.querySelectorAll(".saved-version-item").forEach(n=>{n.addEventListener("click",o=>{if(o.target.closest(".saved-version-item__delete"))return;const i=n.getAttribute("data-id");restoreSavedVersion(i)})}),e.savedVersionsList.querySelectorAll(".saved-version-item__delete").forEach(n=>{n.addEventListener("click",o=>{o.stopPropagation();const i=n.getAttribute("data-id");confirmDeleteVersion(i)})})}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function openSaveVersionModal(){const e=getSaveVersionElements();if(!currentHtml){showToast("No document to save","error");return}if(savedVersions.length>=MAX_SAVED_VERSIONS){showToast("Maximum 10 versions. Delete one first.","error");return}e.versionNameInput&&(e.versionNameInput.value=""),e.saveVersionModal&&e.saveVersionModal.classList.add("active"),setTimeout(()=>e.versionNameInput&&e.versionNameInput.focus(),100)}function closeSaveVersionModal(){const e=getSaveVersionElements();e.saveVersionModal&&e.saveVersionModal.classList.remove("active"),e.versionNameInput&&(e.versionNameInput.value="")}const FIRST_SAVE_KEY="glyph_first_save_complete";function isFirstSave(){try{return!localStorage.getItem(FIRST_SAVE_KEY)}catch{return!1}}function markFirstSaveComplete(){try{localStorage.setItem(FIRST_SAVE_KEY,"true")}catch{}}function saveCurrentVersion(){const e=getSaveVersionElements(),t=e.versionNameInput?e.versionNameInput.value.trim():"";if(!t){showToast("Please enter a name","error");return}if(!currentHtml){showToast("No document to save","error");return}const n=isFirstSave(),o=MAX_SAVED_VERSIONS-savedVersions.length-1,i={id:Date.now().toString(36)+Math.random().toString(36).substr(2,5),name:t,html:currentHtml,timestamp:Date.now()};savedVersions.push(i),persistSavedVersions(),renderSavedVersions(),closeSaveVersionModal();const a=document.getElementById("save-version-btn");a&&a.classList.remove("ready-to-save"),n?(markFirstSaveComplete(),showToast("First version saved! "+o+" slots remaining","success",4e3),celebrateFirstSave()):showToast('Version saved as "'+t+'"',"success"),console.log("[Glyph] Saved version:",t)}function celebrateFirstSave(){const e=document.getElementById("saved-versions-section");e&&(e.classList.add("first-save-glow"),setTimeout(()=>{e.classList.remove("first-save-glow")},1e3))}function restoreSavedVersion(e){const t=savedVersions.find(n=>n.id===e);t&&(saveToUndoHistory(),currentHtml=t.html,renderPreview(currentHtml),previewContainer.classList.add("success"),setTimeout(()=>previewContainer.classList.remove("success"),500),flashPreviewArea(),setStatus("Restored"),setTimeout(()=>setStatus("Ready"),1500),showToast('Restored "'+t.name+'"',"success"),console.log("[Glyph] Restored version:",t.name))}function confirmDeleteVersion(e){const t=getSaveVersionElements(),n=savedVersions.find(o=>o.id===e);n&&(versionToDelete=e,t.deleteVersionName&&(t.deleteVersionName.textContent=n.name),t.deleteConfirmModal&&t.deleteConfirmModal.classList.add("active"))}function closeDeleteModal(){const e=getSaveVersionElements();e.deleteConfirmModal&&e.deleteConfirmModal.classList.remove("active"),versionToDelete=null}function deleteSavedVersion(){if(!versionToDelete)return;const e=savedVersions.find(n=>n.id===versionToDelete),t=e?e.name:"version";savedVersions=savedVersions.filter(n=>n.id!==versionToDelete),persistSavedVersions(),renderSavedVersions(),closeDeleteModal(),showToast('Deleted "'+t+'"',"success"),console.log("[Glyph] Deleted version:",t)}function initSaveVersionListeners(){const e=getSaveVersionElements();e.saveVersionBtn&&e.saveVersionBtn.addEventListener("click",openSaveVersionModal),e.saveVersionCancel&&e.saveVersionCancel.addEventListener("click",closeSaveVersionModal),e.saveVersionConfirm&&e.saveVersionConfirm.addEventListener("click",saveCurrentVersion),e.saveVersionModal&&e.saveVersionModal.addEventListener("click",t=>{t.target===e.saveVersionModal&&closeSaveVersionModal()}),e.versionNameInput&&e.versionNameInput.addEventListener("keypress",t=>{t.key==="Enter"&&saveCurrentVersion()}),e.deleteCancel&&e.deleteCancel.addEventListener("click",closeDeleteModal),e.deleteConfirm&&e.deleteConfirm.addEventListener("click",deleteSavedVersion),e.deleteConfirmModal&&e.deleteConfirmModal.addEventListener("click",t=>{t.target===e.deleteConfirmModal&&closeDeleteModal()}),loadSavedVersions()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initSaveVersionListeners):setTimeout(initSaveVersionListeners,0);function renderStaticDemo(){const e=generateStaticHtml(sampleQuoteData,"#1E3A5F");currentHtml=e,renderPreview(e)}function generateStaticHtml(e,t){return`<!DOCTYPE html>
<html>
<head>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; font-size: 12px; color: #1a1a1a; padding: 32px; }
  .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 20px; border-bottom: 2px solid ${t}; margin-bottom: 20px; }
  .company { font-size: 18px; font-weight: 700; color: ${t}; }
  .company-address { font-size: 11px; color: #666; margin-top: 4px; white-space: pre-line; }
  .title { font-size: 24px; font-weight: 700; color: ${t}; text-transform: uppercase; letter-spacing: 0.05em; }
  .meta { display: flex; gap: 32px; background: #f9fafb; padding: 16px 20px; border-radius: 8px; margin-bottom: 24px; }
  .meta-item { text-align: center; }
  .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 4px; }
  .meta-value { font-weight: 600; }
  .client { margin-bottom: 24px; }
  .client-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px; font-weight: 600; }
  .client-name { font-weight: 600; font-size: 14px; }
  .client-company { color: #666; margin-top: 4px; }
  .client-email { color: #666; font-size: 11px; }
  table { width: 100%; border-collapse: collapse; }
  th { background: ${t}; color: white; padding: 10px 12px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
  th:nth-child(2), th:nth-child(3), th:nth-child(4) { text-align: right; }
  td { padding: 12px; border-bottom: 1px solid #e5e5e5; vertical-align: top; }
  td:nth-child(2), td:nth-child(3), td:nth-child(4) { text-align: right; }
  .item-desc { font-weight: 500; }
  .item-details { font-size: 11px; color: #666; margin-top: 4px; }
  .totals { display: flex; justify-content: flex-end; margin-top: 20px; }
  .totals-table { width: 200px; }
  .totals-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e5e5; }
  .totals-row.total { border-top: 2px solid ${t}; border-bottom: none; padding-top: 10px; margin-top: 4px; }
  .totals-label { color: #666; }
  .totals-value { font-weight: 500; }
  .totals-row.total .totals-label, .totals-row.total .totals-value { font-weight: 700; color: ${t}; }
</style>
</head>
<body>
  <div class="header">
    <div>
      <div class="company">${e.branding.companyName}</div>
      <div class="company-address">${e.branding.companyAddress}</div>
    </div>
    <div class="title">Quote</div>
  </div>

  <div class="meta">
    <div class="meta-item">
      <div class="meta-label">Quote Number</div>
      <div class="meta-value">${e.meta.quoteNumber}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Date</div>
      <div class="meta-value">${e.meta.date}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Valid Until</div>
      <div class="meta-value">${e.meta.validUntil}</div>
    </div>
  </div>

  <div class="client">
    <div class="client-label">Prepared For</div>
    <div class="client-name">${e.client.name}</div>
    <div class="client-company">${e.client.company}</div>
    <div class="client-email">${e.client.email}</div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Description</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      ${e.lineItems.map(n=>`
      <tr>
        <td>
          <div class="item-desc">${n.description}</div>
          <div class="item-details">${n.details}</div>
        </td>
        <td>${n.quantity}</td>
        <td>$${n.unitPrice}</td>
        <td>$${n.total}</td>
      </tr>
      `).join("")}
    </tbody>
  </table>

  <div class="totals">
    <div class="totals-table">
      <div class="totals-row">
        <span class="totals-label">Subtotal</span>
        <span class="totals-value">$${e.totals.subtotal}</span>
      </div>
      <div class="totals-row total">
        <span class="totals-label">Total</span>
        <span class="totals-value">$${e.totals.total}</span>
      </div>
    </div>
  </div>
</body>
</html>`}function setStatus(e){previewStatus.innerHTML=`<span class="status-dot"></span>${e}`}function updateProgressivePreview(e){if(!previewContainer)return;let t=previewContainer.querySelector(".streaming-preview-frame");const n=previewContainer.querySelector("#preview-frame");t||(t=document.createElement("iframe"),t.className="streaming-preview-frame",t.style.cssText=`
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          border: none;
          opacity: 0.85;
          pointer-events: none;
          z-index: 10;
        `,previewContainer.style.position="relative",previewContainer.appendChild(t),n&&(n.style.opacity="0.3"));try{const o=t.contentDocument||t.contentWindow.document;o.open(),o.write(e),o.close()}catch(o){console.warn("[Glyph] Progressive preview update failed:",o)}}function clearProgressivePreview(){if(!previewContainer)return;const e=previewContainer.querySelector(".streaming-preview-frame");e&&(e.style.transition="opacity 0.3s ease",e.style.opacity="0",setTimeout(()=>e.remove(),300));const t=previewContainer.querySelector("#preview-frame");t&&(t.style.transition="opacity 0.3s ease",t.style.opacity="1")}let loadingProgressInterval=null,loadingProgress=0,stageTimeouts=[],elapsedTimerInterval=null,loadingStartTime=null,currentAbortController=null,cancelButtonTimeout=null;const loadingStages=[{name:"analyze",text:"Analyzing your request...",delay:0,maxTime:15},{name:"generate",text:"Generating modifications...",delay:15e3,maxTime:30},{name:"apply",text:"Applying changes...",delay:3e4,maxTime:45},{name:"validate",text:"Almost there...",delay:45e3,maxTime:60},{name:"extended",text:"This one's complex - hang tight!",delay:6e4,maxTime:999}],loadingTips=["AI is finding the best way to apply your change...","Glyph validates every edit to protect your document structure","Fun fact: This same AI powers enterprise PDF workflows","Your changes are reversible - use Undo anytime",'Try instant actions like "Add watermark" for immediate results',"MCP integration lets Claude Code do this automatically for you"];let currentTipIndex=0,tipRotationInterval=null;function getTimeAwareMessage(e){return e<10?"Analyzing your request (~60-90s for complex changes)...":e<25?"Generating modifications...":e<45?"Applying changes...":e<65?"Almost there...":e<80?"Finishing up...":"This one's complex - hang tight!"}function resetLoadingStages(){document.querySelectorAll(".loading-stage").forEach(t=>{t.classList.remove("active","completed")}),stageTimeouts.forEach(t=>clearTimeout(t)),stageTimeouts=[]}function activateStage(e){const t=document.querySelectorAll(".loading-stage");t.forEach(i=>{if(i.dataset.stage===e){let a=!1;t.forEach(r=>{r.dataset.stage===e?(a=!0,r.classList.add("active"),r.classList.remove("completed")):a||(r.classList.remove("active"),r.classList.add("completed"))})}});const n=document.getElementById("loading-text"),o=loadingStages.find(i=>i.name===e);n&&o&&(n.textContent=o.text)}function showLoading(e){previewLoading.classList.toggle("visible",e);const t=document.getElementById("loading-progress-bar"),n=document.getElementById("loading-text"),o=document.getElementById("loading-cancel-btn");if(e){loadingProgress=0,t.style.width="0%",resetLoadingStages(),loadingStartTime=Date.now(),o&&o.classList.remove("visible"),cancelButtonTimeout&&(clearTimeout(cancelButtonTimeout),cancelButtonTimeout=null),cancelButtonTimeout=setTimeout(()=>{o&&isProcessingModification&&o.classList.add("visible")},5e3),elapsedTimerInterval&&(clearInterval(elapsedTimerInterval),elapsedTimerInterval=null);const i=document.getElementById("loading-tip");i&&(i.classList.remove("visible"),i.textContent=""),currentTipIndex=Math.floor(Math.random()*loadingTips.length),tipRotationInterval&&(clearInterval(tipRotationInterval),tipRotationInterval=null),elapsedTimerInterval=setInterval(()=>{const s=Math.floor((Date.now()-loadingStartTime)/1e3),l=getTimeAwareMessage(s);n&&(n.textContent=`${l} (${s}s)`),setStatus(`Applying... ${s}s`),s===10&&i&&(i.textContent=loadingTips[currentTipIndex],i.classList.add("visible"),tipRotationInterval=setInterval(()=>{currentTipIndex=(currentTipIndex+1)%loadingTips.length,i.classList.remove("visible"),setTimeout(()=>{i.textContent=loadingTips[currentTipIndex],i.classList.add("visible")},300)},12e3))},1e3),n&&(n.textContent="AI requests may take 60-90 seconds. Analyzing... (0s)");const a=Date.now(),r=9e4;loadingProgressInterval=setInterval(()=>{const s=Date.now()-a,l=s/r;if(l<=1)loadingProgress=95*(1-Math.pow(1-l,2.5));else{const p=(s-r)/9e4;loadingProgress=95+3*(1-Math.exp(-p))}t.style.width=loadingProgress+"%"},50)}else{loadingProgressInterval&&(clearInterval(loadingProgressInterval),loadingProgressInterval=null),elapsedTimerInterval&&(clearInterval(elapsedTimerInterval),elapsedTimerInterval=null),cancelButtonTimeout&&(clearTimeout(cancelButtonTimeout),cancelButtonTimeout=null),o&&o.classList.remove("visible"),tipRotationInterval&&(clearInterval(tipRotationInterval),tipRotationInterval=null);const i=document.getElementById("loading-tip");i&&i.classList.remove("visible"),document.querySelectorAll(".loading-stage").forEach(r=>{r.classList.remove("active"),r.classList.add("completed")}),n&&(n.textContent="Done!"),t.style.width="100%",setTimeout(()=>{t.style.width="0%",resetLoadingStages(),n&&(n.textContent="Applying changes..."),i&&(i.textContent="")},500)}}function isAiRefusalResponse(e){if(!e||typeof e!="string")return!1;const t=e.trim(),n=t.includes("<!DOCTYPE")||t.includes("<html")||t.includes("<body")||t.includes("<div")||t.includes("<table"),o=[/I understand your request/i,/I cannot|I can't|I'm unable to/i,/I apologize|I'm sorry/i,/Unfortunately,? I/i,/This (request|feature|functionality) (is|isn't|cannot)/i,/beyond my capabilities/i,/not possible to/i,/I'd be happy to help.*but/i,/This would require/i,/PDF documents cannot/i,/interactive (features|elements|charts)/i,/video (player|playback|content)/i,/animations? (are|is) not/i,/real-time (data|updates)/i];if(!n){for(const a of o)if(a.test(e))return!0;if(t.length<500)return!0}const i=e.replace(/<[^>]*>/g,"").trim();if(i.length>100){for(const a of o)if(a.test(i.substring(0,500)))return!0}return!1}function extractRefusalMessage(e){const n=e.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim().split(".")[0];return n.length>100?n.substring(0,100)+"...":n||"This request cannot be completed"}async function processStreamingResponse(e,t){const{onStart:n,onDelta:o,onChanges:i,onComplete:a,onError:r}=t;if(!e.body)throw new Error("No response body for streaming");const s=e.body.getReader(),l=new TextDecoder;let p="",c=null;try{for(;;){const{done:d,value:m}=await s.read();if(d)break;p+=l.decode(m,{stream:!0});const f=p.split(`
`);p=f.pop()||"";let u="",g="";for(const v of f)if(v.startsWith("event: "))u=v.slice(7);else if(v.startsWith("data: "))g=v.slice(6);else if(v===""&&u&&g){try{const h=JSON.parse(g);switch(u){case"start":n&&n(h);break;case"delta":o&&o(h);break;case"changes":i&&i(h);break;case"complete":c=h,a&&a(h);break;case"error":throw r&&r(h),new Error(h.error||"Stream error")}}catch(h){if(h.message!=="Stream error")console.warn("[Glyph] Failed to parse SSE data:",g);else throw h}u="",g=""}}}finally{s.releaseLock()}if(!c)throw new Error("Stream ended without complete event");return c}async function applyModifications(e){if(!e.trim()){showToast("Try a quick action above! They work instantly.","info",3e3),highlightQuickActions();return}if(userHasInteracted=!0,isProcessingModification){console.log("[Glyph] Modification already in progress, ignoring request");return}if(isInstantAction(e)){if(console.log("[Glyph] Applying instant action locally:",e),captureDiffBefore(),saveToUndoHistory(),simulateModification(e),markActionApplied(e),promptInput.value="",captureDiffAfter(),trackModifyRequest({sessionId,prompt:e}),hasShownFirstInstantWin?(showModificationSuccessToast(0,!0),updateResponseTimeBadge(0,!0),flashPreviewArea()):celebrateFirstInstantWin(),window.innerWidth<=480){const c=document.querySelector(".playground__preview-area");c&&setTimeout(()=>{c.scrollIntoView({behavior:"smooth",block:"start"})},300)}return}const t=currentHtml;captureDiffBefore(),saveToUndoHistory(),isProcessingModification=!0,showLoading(!0),setStatus("Applying..."),applyBtn.classList.add("loading"),applyBtn.disabled=!0,setSuggestionsDisabled(!0);const n=Date.now(),o=9e4,i=15e3,a=45e3;currentAbortController=new AbortController;const r=setTimeout(()=>{console.warn("[Glyph] Absolute timeout reached (90s)"),currentAbortController.abort()},o);let s=setTimeout(()=>{console.warn("[Glyph] No streaming activity for 15s, aborting"),currentAbortController.abort()},i);function l(){clearTimeout(s),s=setTimeout(()=>{console.warn("[Glyph] No streaming activity for 15s, aborting"),currentAbortController.abort()},i)}const p=setTimeout(()=>{isProcessingModification&&showToast("Almost there! Complex changes take a bit longer to perfect.","info",6e3)},a);try{async function c(u){try{const g=await u.json();return g.error||g.message||`Server error (${u.status})`}catch{return`Server error (${u.status})`}}if(sessionId){const u=await fetch(`${API_URL}/v1/modify?stream=true`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${DEMO_API_KEY}`},body:JSON.stringify({sessionId,prompt:e,html:currentHtml}),signal:currentAbortController.signal});if(window.__glyphRateLimit&&window.__glyphRateLimit.track(),!u.ok){u.status===429&&window.__glyphRateLimit&&window.__glyphRateLimit.onRateLimited();const y=await c(u);throw new Error(y)}let g=0,v="";const h=["Understanding your request...","Building the layout...","Adding content...","Styling elements...","Refining details...","Almost there..."];let E=0;const w=await processStreamingResponse(u,{onStart:y=>{console.log("[Glyph Stream] Started:",y.model),elapsedTimerInterval&&(clearInterval(elapsedTimerInterval),elapsedTimerInterval=null),activateStage("analyze");const b=document.getElementById("loading-text");b&&(b.textContent=h[0]),setStatus("AI is working...")},onDelta:y=>{g++,v+=y.html||"",l(),g%50===0&&updateProgressivePreview(v),g===20?activateStage("generate"):g===150&&activateStage("apply");const b=Math.min(Math.floor(g/80),h.length-1);if(b!==E){E=b;const k=document.getElementById("loading-text");k&&(k.textContent=h[E])}if(g%20===0){const k=Math.floor((Date.now()-n)/1e3);setStatus(`AI is working... ${k}s`)}},onChanges:y=>{console.log("[Glyph Stream] Changes:",y.changes),activateStage("apply");const b=document.getElementById("loading-text");b&&(b.textContent="Applying your changes...")},onComplete:y=>{console.log("[Glyph Stream] Complete:",y.fastPath?"fast path":`${g} chunks`),clearProgressivePreview(),elapsedTimerInterval&&(clearInterval(elapsedTimerInterval),elapsedTimerInterval=null),activateStage("validate");const b=document.getElementById("loading-text");b&&(b.textContent=y.fastPath?"Applied instantly!":"Validating output...")},onError:y=>{console.error("[Glyph Stream] Error:",y),clearProgressivePreview()}}),x=((Date.now()-n)/1e3).toFixed(1);if(isAiRefusalResponse(w.html)){console.warn("[Glyph] AI refusal detected, not rendering to document");const y=extractRefusalMessage(w.html);undoHistory.length>0&&(undoHistory.pop(),updateUndoButtonState()),showToast(y,"warning",5e3),setStatus("Request not supported"),setTimeout(()=>setStatus("Ready"),3e3),clearTimeout(r),clearTimeout(s);return}currentHtml=w.html,renderPreview(currentHtml,{changes:w.changes||[],previousHtml:t}),addHistoryEntry(e,currentHtml),previewContainer.classList.add("success"),setTimeout(()=>previewContainer.classList.remove("success"),500),flashPreviewArea(),consecutiveFailures=0,autoRetryCount=0,lastErrorWasSessionError=!1,showSuccessCta(),captureDiffAfter(),trackModifyRequest({sessionId,prompt:e}),showModificationSuccessToast(x),updateResponseTimeBadge(x),setStatus(`Done in ${x}s`),console.log(`[Glyph] Modification completed in ${x}s (${w.fastPath?"fast path":g+" stream chunks"})`),setTimeout(()=>setStatus("Ready"),2e3),sessionId&&startValidationPolling(sessionId),clearTimeout(r),clearTimeout(s);return}const d=await fetch(`${API_URL}/v1/modify`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${DEMO_API_KEY}`},body:JSON.stringify({html:currentHtml,instruction:e}),signal:currentAbortController.signal});if(window.__glyphRateLimit&&window.__glyphRateLimit.track(),!d.ok){d.status===429&&window.__glyphRateLimit&&window.__glyphRateLimit.onRateLimited();const u=await c(d);throw new Error(u)}const m=((Date.now()-n)/1e3).toFixed(1),f=await d.json();if(isAiRefusalResponse(f.html)){console.warn("[Glyph] AI refusal detected, not rendering to document");const u=extractRefusalMessage(f.html);undoHistory.length>0&&(undoHistory.pop(),updateUndoButtonState()),showToast(u,"warning",5e3),setStatus("Request not supported"),setTimeout(()=>setStatus("Ready"),3e3),clearTimeout(r),clearTimeout(s);return}currentHtml=f.html,renderPreview(currentHtml,{changes:f.changes||[],previousHtml:t}),addHistoryEntry(e,currentHtml),previewContainer.classList.add("success"),setTimeout(()=>previewContainer.classList.remove("success"),500),flashPreviewArea(),consecutiveFailures=0,autoRetryCount=0,lastErrorWasSessionError=!1,showSuccessCta(),captureDiffAfter(),trackModifyRequest({prompt:e}),showModificationSuccessToast(m),updateResponseTimeBadge(m),setStatus(`Done in ${m}s`),console.log(`[Glyph] Modification completed in ${m}s`),setTimeout(()=>setStatus("Ready"),2e3)}catch(c){clearTimeout(r),clearTimeout(s),clearProgressivePreview(),console.error("[Glyph] API modification failed:",c),undoHistory.length>0&&(undoHistory.pop(),updateUndoButtonState());let d=c.message||"Unknown error";const m=Date.now()-n,f=c.name==="AbortError"&&m<o-1e3;if(c.name==="AbortError")if(f){showToast("Modification cancelled","info"),setStatus("Ready"),console.log("[Glyph] Modification cancelled by user");return}else d="timeout - request took too long (60s limit)";showApiError(d,e),setStatus("Error - See message"),setTimeout(()=>setStatus("Ready"),3e3)}finally{clearTimeout(r),clearTimeout(s),clearTimeout(p),clearProgressivePreview(),currentAbortController=null,isProcessingModification=!1,showLoading(!1),applyBtn.classList.remove("loading"),applyBtn.disabled=!1,setSuggestionsDisabled(!1),promptInput.value=""}}let validationPollInterval=null,currentValidationToast=null;function startValidationPolling(e){validationPollInterval&&clearInterval(validationPollInterval);let t=0;const n=60;validationPollInterval=setInterval(async()=>{t++;try{const o=await fetch(`${API_URL}/v1/modify/validation-status?sessionId=${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${DEMO_API_KEY}`}});if(o.ok){const i=await o.json();if(i.validationResult){clearInterval(validationPollInterval),validationPollInterval=null,i.validationResult.criticalCount>0&&!isInDemoMode?showValidationToast(i.validationResult,i.hasAutoFix,e):i.validationResult.criticalCount>0&&isInDemoMode?(console.log("[Glyph] Demo mode: Suppressing validation toast ("+i.validationResult.criticalCount+" critical issues)"),showValidationSuccessToast()):i.validationResult.warningCount>0?(console.log("[Glyph] Self-check: "+i.validationResult.warningCount+" minor warnings (not shown to user)"),showValidationSuccessToast()):(console.log("[Glyph] Self-check passed - no issues detected"),showValidationSuccessToast());return}}}catch(o){console.warn("[Glyph] Validation poll error:",o)}t>=n&&(clearInterval(validationPollInterval),validationPollInterval=null,console.log("[Glyph] Validation poll timeout - validation still pending"),showValidationTimeoutMessage())},1e3)}window.addEventListener("pagehide",()=>{validationPollInterval&&(clearInterval(validationPollInterval),validationPollInterval=null)});function showValidationTimeoutMessage(){if(!userHasInteracted)return;const e=document.createElement("div");e.className="validation-toast validation-toast--info",e.innerHTML=`
        <div class="validation-toast__content">
          <svg class="validation-toast__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 16v-4M12 8h.01"></path>
          </svg>
          <div class="validation-toast__text">
            <span class="validation-toast__title">Quality check in progress</span>
            <span class="validation-toast__message">Running final validation... Your changes are applied.</span>
          </div>
        </div>
      `,document.body.appendChild(e),requestAnimationFrame(()=>e.classList.add("visible")),setTimeout(()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300)},5e3)}function showValidationToast(e,t,n){currentValidationToast&&currentValidationToast.remove();const o=document.createElement("div");o.className="validation-toast";const i=e.criticalCount>0,a="validation-toast__icon--warning",r=i?`<svg class="validation-toast__icon ${a}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg>`:`<svg class="validation-toast__icon ${a}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg>`,s=(e.issues||[]).slice(0,3).map(l=>`<div class="validation-toast__issue validation-toast__issue--${l.severity==="critical"?"critical":"warning"}">${l.description}</div>`).join("");o.innerHTML=`
        <div class="validation-toast__header">
          ${r}
          <span class="validation-toast__title">
            ${i?"Quick Fix Available":"Suggestions Available"}
          </span>
          <button class="validation-toast__close" aria-label="Close">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
            </svg>
          </button>
        </div>
        <div class="validation-toast__issues">
          ${s}
        </div>
        ${t?`
          <div class="validation-toast__actions">
            <button class="validation-toast__btn validation-toast__btn--primary" data-action="apply-fix">
              Apply Fix
            </button>
            <button class="validation-toast__btn validation-toast__btn--secondary" data-action="dismiss">
              Dismiss
            </button>
          </div>
        `:`
          <div class="validation-toast__actions">
            <button class="validation-toast__btn validation-toast__btn--secondary" data-action="dismiss">
              Got it
            </button>
          </div>
        `}
      `,o.querySelector(".validation-toast__close").addEventListener("click",()=>{dismissValidationToast(o)}),o.querySelectorAll("[data-action]").forEach(l=>{l.addEventListener("click",p=>{p.target.dataset.action==="apply-fix"?applyValidationFix(n,o):dismissValidationToast(o)})}),document.body.appendChild(o),currentValidationToast=o,requestAnimationFrame(()=>{o.classList.add("visible")}),setTimeout(()=>{document.body.contains(o)&&dismissValidationToast(o)},15e3)}function dismissValidationToast(e){e.classList.remove("visible"),setTimeout(()=>{e.remove(),currentValidationToast===e&&(currentValidationToast=null)},300)}function showValidationSuccessToast(){currentValidationToast&&currentValidationToast.remove();const e=document.createElement("div");e.className="validation-toast validation-toast--success";const t=`<svg class="validation-toast__icon validation-toast__icon--success" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/>
      </svg>`;e.innerHTML=`
        <div class="validation-toast__header">
          ${t}
          <span class="validation-toast__title">Changes verified safe</span>
        </div>
      `,document.body.appendChild(e),currentValidationToast=e,requestAnimationFrame(()=>{e.classList.add("visible")}),setTimeout(()=>{document.body.contains(e)&&dismissValidationToast(e)},3e3)}async function applyValidationFix(e,t){const n=t.querySelector('[data-action="apply-fix"]');n.textContent="Applying...",n.disabled=!0;try{const o=await fetch(`${API_URL}/v1/modify/apply-fix`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${DEMO_API_KEY}`},body:JSON.stringify({sessionId:e})});o.ok?(currentHtml=(await o.json()).html,renderPreview(currentHtml),n.textContent="Fixed!",n.style.background="var(--color-success)",previewContainer.classList.add("success"),setTimeout(()=>previewContainer.classList.remove("success"),500),flashPreviewArea(),setTimeout(()=>{dismissValidationToast(t)},1e3)):(n.textContent="Failed",n.style.background="var(--color-error)",setTimeout(()=>{n.textContent="Apply Fix",n.style.background="",n.disabled=!1},2e3))}catch(o){console.error("[Glyph] Apply fix error:",o),n.textContent="Error",n.disabled=!1}}function injectWatermark(e,t="DRAFT"){if(e.includes("glyph-watermark"))return e.replace(/(<div class="glyph-watermark"[^>]*>)[^<]*(<\/div>)/i,`$1${t}$2`);const o=`<div class="glyph-watermark" style="${`
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 100px;
        font-weight: 900;
        color: rgba(0, 0, 0, 0.07);
        pointer-events: none;
        white-space: nowrap;
        z-index: 1000;
        letter-spacing: 20px;
        user-select: none;
      `.replace(/\n\s*/g," ")}">${t}</div>`;return e.replace("</body>",`${o}</body>`)}function injectQrCode(e){if(e.includes("glyph-qr-code"))return e;const o=`<div class="glyph-qr-code" style="${`
        position: fixed;
        top: 20px;
        right: 20px;
        width: 80px;
        height: 100px;
        background: white;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        padding: 8px;
        text-align: center;
        font-family: sans-serif;
        font-size: 8px;
        color: #666;
        z-index: 999;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      `.replace(/\n\s*/g," ")}"><svg viewBox="0 0 64 64" style="width:60px;height:60px;"><rect fill="#000" x="0" y="0" width="8" height="8"/><rect fill="#000" x="8" y="0" width="8" height="8"/><rect fill="#000" x="16" y="0" width="8" height="8"/><rect fill="#000" x="24" y="0" width="8" height="8"/><rect fill="#000" x="32" y="0" width="8" height="8"/><rect fill="#000" x="40" y="0" width="8" height="8"/><rect fill="#000" x="48" y="0" width="8" height="8"/><rect fill="#000" x="0" y="8" width="8" height="8"/><rect fill="#000" x="48" y="8" width="8" height="8"/><rect fill="#000" x="0" y="16" width="8" height="8"/><rect fill="#000" x="16" y="16" width="8" height="8"/><rect fill="#000" x="24" y="16" width="8" height="8"/><rect fill="#000" x="32" y="16" width="8" height="8"/><rect fill="#000" x="48" y="16" width="8" height="8"/><rect fill="#000" x="0" y="24" width="8" height="8"/><rect fill="#000" x="16" y="24" width="8" height="8"/><rect fill="#000" x="24" y="24" width="8" height="8"/><rect fill="#000" x="32" y="24" width="8" height="8"/><rect fill="#000" x="48" y="24" width="8" height="8"/><rect fill="#000" x="0" y="32" width="8" height="8"/><rect fill="#000" x="16" y="32" width="8" height="8"/><rect fill="#000" x="24" y="32" width="8" height="8"/><rect fill="#000" x="32" y="32" width="8" height="8"/><rect fill="#000" x="48" y="32" width="8" height="8"/><rect fill="#000" x="0" y="40" width="8" height="8"/><rect fill="#000" x="48" y="40" width="8" height="8"/><rect fill="#000" x="0" y="48" width="8" height="8"/><rect fill="#000" x="8" y="48" width="8" height="8"/><rect fill="#000" x="16" y="48" width="8" height="8"/><rect fill="#000" x="24" y="48" width="8" height="8"/><rect fill="#000" x="32" y="48" width="8" height="8"/><rect fill="#000" x="40" y="48" width="8" height="8"/><rect fill="#000" x="48" y="48" width="8" height="8"/></svg><div style="margin-top:4px;">Scan to pay</div></div>`;return e.replace("</body>",`${o}</body>`)}function changeAccentColor(e,t){return e=e.replace(/--accent-color:\s*[^;]+;/g,`--accent-color: ${t};`),e=e.replace(/background(-color)?:\s*#1E3A5F/gi,`background$1: ${t}`),e=e.replace(/border(-color)?:\s*#1E3A5F/gi,`border$1: ${t}`),e=e.replace(/color:\s*#1E3A5F/gi,`color: ${t}`),e}function injectBoldHeader(e){return e.includes("glyph-bold-header-applied")?e:e.replace("</head>",`
        <style class="glyph-bold-header-applied">
          h1, .invoice-title, .document-title, [class*="title"], [class*="header"] h1 {
            font-weight: 900 !important;
            font-size: 1.3em !important;
            letter-spacing: -0.02em !important;
          }
          .company-name, [class*="company"] {
            font-weight: 800 !important;
            font-size: 1.15em !important;
          }
        </style>
      </head>`)}function injectDate(e){if(e.includes("glyph-date-badge"))return e;const n=new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),i=`<div class="glyph-date-badge" style="${`
        position: fixed;
        top: 20px;
        right: 110px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 8px 12px;
        font-family: sans-serif;
        font-size: 11px;
        color: #475569;
        z-index: 998;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      `.replace(/\n\s*/g," ")}">${n}</div>`;return e.replace("</body>",`${i}</body>`)}function injectBorder(e){return e.includes("glyph-document-border")?e:e.replace("</head>",`
        <style class="glyph-document-border">
          body {
            border: 3px solid #1e3a5f !important;
            border-radius: 8px !important;
            margin: 16px !important;
            box-shadow: 0 4px 12px rgba(30, 58, 95, 0.15) !important;
          }
          @media print {
            body {
              border: 2px solid #1e3a5f !important;
              margin: 12px !important;
            }
          }
        </style>
      </head>`)}function injectThankYouNote(e){if(e.includes("glyph-thank-you-note"))return e;const n=`<div class="glyph-thank-you-note" style="${`
        margin: 24px 20px;
        padding: 20px;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-radius: 12px;
        border-left: 4px solid #22c55e;
        font-family: sans-serif;
        text-align: center;
      `.replace(/\n\s*/g," ")}">
        <div style="font-size: 16px; font-weight: 600; color: #166534; margin-bottom: 6px;">Thank You for Your Business!</div>
        <div style="font-size: 12px; color: #15803d; line-height: 1.5;">We appreciate your trust in our services. Please don't hesitate to reach out if you have any questions.</div>
      </div>`;return e.replace("</body>",`${n}</body>`)}function injectSignature(e){if(e.includes("glyph-signature-line"))return e;const t=new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),o=`<div class="glyph-signature-line" style="${`
        margin: 32px 20px;
        padding: 24px;
        font-family: sans-serif;
        border-top: 1px solid #e5e7eb;
      `.replace(/\n\s*/g," ")}">
        <div style="display: flex; justify-content: space-between; gap: 48px;">
          <div style="flex: 1;">
            <div style="border-bottom: 1px solid #374151; margin-bottom: 8px; height: 40px;"></div>
            <div style="font-size: 12px; color: #6b7280;">Authorized Signature</div>
          </div>
          <div style="flex: 1;">
            <div style="border-bottom: 1px solid #374151; margin-bottom: 8px; height: 40px; display: flex; align-items: flex-end; padding-bottom: 4px; color: #374151; font-size: 14px;">${t}</div>
            <div style="font-size: 12px; color: #6b7280;">Date</div>
          </div>
        </div>
      </div>`;return e.replace("</body>",`${o}</body>`)}function extractTermsText(e){const t=e.toLowerCase(),n=e.match(/net\s*(\d+)/i),o=n?n[1]:"30",i=e.match(/(\d+)%\s*(early\s*)?(?:payment\s*)?discount/i),a=i?i[1]:null,r=e.match(/(?:within|in)\s*(\d+)\s*days/i),s=r?r[1]:"10";let l=`Net ${o} days`;return a?l+=`. ${a}% early payment discount if paid within ${s} days`:(t.includes("discount")||t.includes("early"))&&(l+=`. 2% early payment discount if paid within ${s} days`),l}function injectPaymentTerms(e,t){if(e.includes("glyph-payment-terms")||e.includes("Payment Terms</div>"))return e.replace(/(<div class="glyph-payment-terms"[^>]*>[\s\S]*?<div[^>]*>Payment Terms<\/div>\s*<div[^>]*>)[^<]*(<\/div>)/i,`$1${t}$2`);const o=`<div class="glyph-payment-terms" style="${`
        margin: 24px 20px;
        padding: 16px;
        background: #f9fafb;
        border-radius: 8px;
        border-left: 4px solid #1e3a5f;
        font-family: sans-serif;
      `.replace(/\n\s*/g," ")}">
        <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px; font-weight: 600;">Payment Terms</div>
        <div style="font-size: 12px; color: #1a1a1a; line-height: 1.5;">${t}</div>
      </div>`;return e.replace("</body>",`${o}</body>`)}function injectGroupByCategory(e){if(e.includes("glyph-category-group")||e.includes("Category Subtotal")||!e.match(/<tbody>([\s\S]*?)<\/tbody>/))return e;const n={Design:[{description:"UI/UX Design",details:"Custom interface design and prototypes",quantity:1,unitPrice:3500,total:3500},{description:"Brand Guidelines",details:"Logo usage, colors, typography specs",quantity:1,unitPrice:1500,total:1500}],Materials:[{description:"Server Hardware",details:"Dell PowerEdge R750 with 64GB RAM",quantity:2,unitPrice:4200,total:8400},{description:"Network Equipment",details:"Cisco switches and cabling",quantity:1,unitPrice:2800,total:2800},{description:"Software Licenses",details:"Enterprise software bundle",quantity:5,unitPrice:450,total:2250}],Labor:[{description:"Installation",details:"On-site hardware setup and config",quantity:16,unitPrice:150,total:2400},{description:"Training",details:"Staff training sessions (4 hours each)",quantity:3,unitPrice:500,total:1500}]};let o="";for(const[i,a]of Object.entries(n)){const r=a.reduce((s,l)=>s+l.total,0);o+=`
          <tr class="glyph-category-group" style="background: #f8fafc;">
            <td colspan="4" style="font-weight: 600; color: #1e3a5f; padding: 12px 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid #e2e8f0;">${i}</td>
          </tr>`;for(const s of a)o+=`
          <tr>
            <td>
              <div class="item-desc">${s.description}</div>
              <div class="item-details">${s.details}</div>
            </td>
            <td>${s.quantity}</td>
            <td>$${s.unitPrice.toFixed(2)}</td>
            <td>$${s.total.toFixed(2)}</td>
          </tr>`;o+=`
          <tr class="glyph-category-subtotal" style="background: #f1f5f9;">
            <td colspan="3" style="text-align: right; font-weight: 500; color: #64748b; padding-right: 16px; font-size: 12px;">${i} Subtotal</td>
            <td style="font-weight: 600; color: #1e3a5f;">$${r.toFixed(2)}</td>
          </tr>`}return e.replace(/<tbody>[\s\S]*?<\/tbody>/,`<tbody>${o}</tbody>`)}function simulateModification(e){const t=e.toLowerCase();let n=currentHtml;if(t.includes("terms")||t.includes("payment terms")||t.includes("net ")){const o=extractTermsText(e);n=injectPaymentTerms(n,o)}if(t.includes("watermark")){let o="DRAFT";t.includes("paid")?o="PAID":t.includes("confidential")?o="CONFIDENTIAL":t.includes("approved")?o="APPROVED":t.includes("void")?o="VOID":t.includes("sample")&&(o="SAMPLE"),n=injectWatermark(n,o)}t.includes("qr")&&(n=injectQrCode(n)),t.includes("group")&&(t.includes("category")||t.includes("subtotal"))&&(n=injectGroupByCategory(n)),t.includes("bold")&&(t.includes("header")||t.includes("title"))&&(n=injectBoldHeader(n)),t.includes("date")&&(t.includes("add")||t.includes("today"))&&(n=injectDate(n)),t.includes("border")&&(n=injectBorder(n)),t.includes("thank")&&(t.includes("you")||t.includes("note"))&&(n=injectThankYouNote(n)),t.includes("signature")&&(n=injectSignature(n)),t.includes("blue")?n=changeAccentColor(n,"#3B82F6"):t.includes("purple")||t.includes("stripe")?n=changeAccentColor(n,"#635BFF"):t.includes("red")?n=changeAccentColor(n,"#EF4444"):t.includes("green")?n=changeAccentColor(n,"#22C55E"):t.includes("orange")?n=changeAccentColor(n,"#F97316"):t.includes("pink")?n=changeAccentColor(n,"#EC4899"):(t.includes("gold")||t.includes("yellow"))&&(n=changeAccentColor(n,"#EAB308")),currentHtml=n,renderPreview(currentHtml),addHistoryEntry(e,currentHtml),previewContainer.classList.add("success"),setTimeout(()=>previewContainer.classList.remove("success"),500),flashPreviewArea(),setStatus("Demo: Updated!"),setTimeout(()=>setStatus("Demo Mode"),2e3)}function generateEnhancedHtml(e,t,n){const o=n.style==="stripe",i=n.style==="apple",a=n.watermark?`
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 80px; font-weight: 900; color: rgba(0,0,0,0.06); pointer-events: none; white-space: nowrap; z-index: 1;">${n.watermark}</div>
      `:"",r=n.qrCode?`
        <div style="position: absolute; top: 20px; right: 20px; width: 80px; height: 80px; background: white; border: 1px solid #e5e5e5; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px;">
          <svg viewBox="0 0 100 100" width="50" height="50">
            <rect x="10" y="10" width="25" height="25" fill="#1a1a1a"/>
            <rect x="15" y="15" width="15" height="15" fill="white"/>
            <rect x="18" y="18" width="9" height="9" fill="#1a1a1a"/>
            <rect x="65" y="10" width="25" height="25" fill="#1a1a1a"/>
            <rect x="70" y="15" width="15" height="15" fill="white"/>
            <rect x="73" y="18" width="9" height="9" fill="#1a1a1a"/>
            <rect x="10" y="65" width="25" height="25" fill="#1a1a1a"/>
            <rect x="15" y="70" width="15" height="15" fill="white"/>
            <rect x="18" y="73" width="9" height="9" fill="#1a1a1a"/>
            <rect x="40" y="10" width="5" height="5" fill="#1a1a1a"/>
            <rect x="50" y="10" width="5" height="5" fill="#1a1a1a"/>
            <rect x="40" y="20" width="5" height="5" fill="#1a1a1a"/>
            <rect x="45" y="25" width="5" height="5" fill="#1a1a1a"/>
            <rect x="40" y="40" width="5" height="5" fill="#1a1a1a"/>
            <rect x="45" y="45" width="5" height="5" fill="#1a1a1a"/>
            <rect x="50" y="40" width="5" height="5" fill="#1a1a1a"/>
            <rect x="55" y="45" width="5" height="5" fill="#1a1a1a"/>
            <rect x="10" y="45" width="5" height="5" fill="#1a1a1a"/>
            <rect x="20" y="50" width="5" height="5" fill="#1a1a1a"/>
            <rect x="65" y="45" width="5" height="5" fill="#1a1a1a"/>
            <rect x="75" y="50" width="5" height="5" fill="#1a1a1a"/>
            <rect x="85" y="55" width="5" height="5" fill="#1a1a1a"/>
            <rect x="65" y="65" width="5" height="5" fill="#1a1a1a"/>
            <rect x="75" y="75" width="5" height="5" fill="#1a1a1a"/>
            <rect x="85" y="85" width="5" height="5" fill="#1a1a1a"/>
            <rect x="45" y="65" width="5" height="5" fill="#1a1a1a"/>
            <rect x="55" y="75" width="5" height="5" fill="#1a1a1a"/>
            <rect x="45" y="85" width="5" height="5" fill="#1a1a1a"/>
          </svg>
          <div style="font-size: 7px; color: #666; margin-top: 4px;">Scan to pay</div>
        </div>
      `:"",s=n.terms?`
        <div style="margin-top: 24px; padding: 16px; background: #f9fafb; border-radius: 8px; border-left: 4px solid ${t};">
          <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px; font-weight: 600;">Payment Terms</div>
          <div style="font-size: 12px; color: #1a1a1a;">${n.terms}</div>
        </div>
      `:"",l=n.signature?`
        <div style="margin-top: 32px; display: flex; justify-content: space-between; align-items: flex-end;">
          <div style="flex: 1;">
            <div style="font-size: 11px; color: #666; margin-bottom: 8px;">Thank you for your business!</div>
            <div style="border-bottom: 1px solid #1a1a1a; width: 200px; margin-bottom: 4px;"></div>
            <div style="font-size: 10px; color: #666;">Authorized Signature</div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 11px; color: #666;">Date: ${new Date().toLocaleDateString()}</div>
          </div>
        </div>
      `:"",p=n.progressBar?`
        <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, ${t}15, ${t}05); border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-size: 11px; font-weight: 600; color: ${t};">Payment Progress</span>
            <span style="font-size: 11px; font-weight: 600; color: ${t};">${n.progressBar}% Paid</span>
          </div>
          <div style="height: 8px; background: #e5e5e5; border-radius: 4px; overflow: hidden;">
            <div style="height: 100%; width: ${n.progressBar}%; background: linear-gradient(90deg, ${t}, ${t}cc); border-radius: 4px;"></div>
          </div>
          <div style="font-size: 10px; color: #666; margin-top: 6px;">$${(e.totals.total*n.progressBar/100).toFixed(2)} of $${e.totals.total.toFixed(2)} received</div>
        </div>
      `:"";return`<!DOCTYPE html>
<html>
<head>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; font-size: 12px; color: #1a1a1a; padding: 32px; position: relative; }
  .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 20px; border-bottom: 2px solid ${t}; margin-bottom: 20px; }
  .company { font-size: 18px; font-weight: 700; color: ${t}; }
  .company-address { font-size: 11px; color: #666; margin-top: 4px; white-space: pre-line; }
  .title { font-size: 24px; font-weight: 700; color: ${t}; text-transform: uppercase; letter-spacing: 0.05em; }
  .meta { display: flex; gap: 32px; background: #f9fafb; padding: 16px 20px; border-radius: 8px; margin-bottom: 24px; }
  .meta-item { text-align: center; }
  .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 4px; }
  .meta-value { font-weight: 600; }
  .client { margin-bottom: 24px; }
  .client-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 8px; font-weight: 600; }
  .client-name { font-weight: 600; font-size: 14px; }
  .client-company { color: #666; margin-top: 4px; }
  .client-email { color: #666; font-size: 11px; }
  table { width: 100%; border-collapse: collapse; }
  th { background: ${t}; color: white; padding: 10px 12px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
  th:nth-child(2), th:nth-child(3), th:nth-child(4) { text-align: right; }
  td { padding: 12px; border-bottom: 1px solid #e5e5e5; vertical-align: top; }
  td:nth-child(2), td:nth-child(3), td:nth-child(4) { text-align: right; }
  .item-desc { font-weight: 500; }
  .item-details { font-size: 11px; color: #666; margin-top: 4px; }
  .totals { display: flex; justify-content: flex-end; margin-top: 20px; }
  .totals-table { width: 200px; }
  .totals-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e5e5; }
  .totals-row.total { border-top: 2px solid ${t}; border-bottom: none; padding-top: 10px; margin-top: 4px; }
  .totals-label { color: #666; }
  .totals-value { font-weight: 500; }
  .totals-row.total .totals-label, .totals-row.total .totals-value { font-weight: 700; color: ${t}; }
  ${o?`
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .header { border-bottom: none; padding-bottom: 0; margin-bottom: 32px; }
        .company { font-size: 14px; font-weight: 500; color: #1a1a1a; letter-spacing: -0.01em; }
        .title { font-size: 32px; font-weight: 600; color: #1a1a1a; text-transform: none; letter-spacing: -0.02em; }
        .meta { background: transparent; padding: 0; gap: 48px; }
        .meta-item { text-align: left; }
        .meta-label { font-size: 12px; color: #697386; text-transform: none; letter-spacing: 0; }
        .meta-value { font-size: 14px; }
        th { background: transparent; color: #697386; font-size: 12px; text-transform: none; letter-spacing: 0; border-bottom: 1px solid #e6e6e6; }
        td { border-bottom: 1px solid #e6e6e6; }
        .totals-row.total { border-top: 1px solid #e6e6e6; }
        .totals-row.total .totals-label, .totals-row.total .totals-value { color: #1a1a1a; }
      `:""}
  ${i?`
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; }
        .header { border-bottom: none; }
        .company { font-size: 13px; font-weight: 400; color: #86868b; }
        .title { font-size: 40px; font-weight: 600; color: #1d1d1f; text-transform: none; letter-spacing: -0.025em; }
        .meta { background: transparent; border-radius: 0; }
        th { background: transparent; color: #86868b; border-bottom: 1px solid #d2d2d7; }
        td { border-bottom: 1px solid #d2d2d7; }
      `:""}
</style>
</head>
<body>
  ${a}
  ${r}
  <div class="header">
    <div>
      <div class="company">${e.branding.companyName}</div>
      <div class="company-address">${e.branding.companyAddress}</div>
    </div>
    <div class="title">${o?"Invoice":"Quote"}</div>
  </div>

  <div class="meta">
    <div class="meta-item">
      <div class="meta-label">Quote Number</div>
      <div class="meta-value">${e.meta.quoteNumber}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Date</div>
      <div class="meta-value">${e.meta.date}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Valid Until</div>
      <div class="meta-value">${e.meta.validUntil}</div>
    </div>
  </div>

  <div class="client">
    <div class="client-label">Prepared For</div>
    <div class="client-name">${e.client.name}</div>
    <div class="client-company">${e.client.company}</div>
    <div class="client-email">${e.client.email}</div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Description</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      ${e.lineItems.map(m=>`
      <tr>
        <td>
          <div class="item-desc">${m.description}</div>
          <div class="item-details">${m.details}</div>
        </td>
        <td>${m.quantity}</td>
        <td>$${m.unitPrice}</td>
        <td>$${m.total}</td>
      </tr>
      `).join("")}
    </tbody>
  </table>

  <div class="totals">
    <div class="totals-table">
      <div class="totals-row">
        <span class="totals-label">Subtotal</span>
        <span class="totals-value">$${e.totals.subtotal}</span>
      </div>
      <div class="totals-row total">
        <span class="totals-label">Total</span>
        <span class="totals-value">$${e.totals.total}</span>
      </div>
    </div>
  </div>

  ${p}
  ${s}
  ${l}
</body>
</html>`}playgroundTabs.forEach(e=>{e.addEventListener("click",async()=>{if(e.classList.contains("playground__tab--active"))return;const t=document.querySelector(".playground__preview-frame-wrapper");playgroundTabs.forEach(n=>n.classList.remove("playground__tab--active")),e.classList.add("playground__tab--active"),t&&t.classList.add("template-switching"),await new Promise(n=>setTimeout(n,200)),currentTemplate=e.dataset.template,sessionId=null,clearUndoHistory(),await initializePreview(),t&&t.classList.remove("template-switching")})});const templateTypeSelect=document.getElementById("template-type-select-playground"),styleTabsContainer=document.getElementById("playground-style-tabs");templateTypeSelect&&templateTypeSelect.addEventListener("change",async()=>{const e=templateTypeSelect.value,t=TEMPLATE_TYPE_CONFIG[e];if(!t)return;styleTabsContainer.innerHTML="",t.variants.forEach((o,i)=>{const a=document.createElement("button");a.className="playground__tab"+(i===0?" playground__tab--active":""),a.dataset.template=o.id,a.textContent=o.label,styleTabsContainer.appendChild(a)}),bindStyleTabs();const n=document.querySelector(".playground__preview-frame-wrapper");n&&n.classList.add("template-switching"),await new Promise(o=>setTimeout(o,200)),currentTemplate=t.variants[0].id,sessionId=null,clearUndoHistory(),await initializePreview(),n&&n.classList.remove("template-switching")});function bindStyleTabs(){const e=styleTabsContainer.querySelectorAll(".playground__tab");e.forEach(t=>{t.addEventListener("click",async()=>{if(t.classList.contains("playground__tab--active"))return;const n=document.querySelector(".playground__preview-frame-wrapper");e.forEach(o=>o.classList.remove("playground__tab--active")),t.classList.add("playground__tab--active"),n&&n.classList.add("template-switching"),await new Promise(o=>setTimeout(o,200)),currentTemplate=t.dataset.template,sessionId=null,clearUndoHistory(),await initializePreview(),n&&n.classList.remove("template-switching")})})}suggestions.forEach(e=>{e.addEventListener("click",()=>{if(isProcessingModification){console.log("[Glyph] Modification in progress, ignoring suggestion click");return}const t=e.dataset.prompt;promptInput.value=t,applyModifications(t)})}),applyBtn.addEventListener("click",()=>{applyModifications(promptInput.value)}),undoBtn.addEventListener("click",()=>{isProcessingModification||performUndo()});const shareBtn=document.getElementById("share-btn");shareBtn&&shareBtn.addEventListener("click",()=>{const e=historyEntries.filter(r=>r.prompt&&r.prompt!=="Initial state").map(r=>r.prompt);if(e.length===0){showToast("Apply some changes first before sharing","info");return}const t=document.querySelector(".playground__tab--active"),o={template:t?t.dataset.template:"quote-modern",actions:e},i=btoa(JSON.stringify(o)),a=window.location.origin+window.location.pathname+"#playground?mods="+i;navigator.clipboard.writeText(a).then(()=>{showToast("Link copied to clipboard","success")}).catch(()=>{showToast("Could not copy link","error")})});const loadingCancelBtn=document.getElementById("loading-cancel-btn");loadingCancelBtn&&loadingCancelBtn.addEventListener("click",()=>{isProcessingModification&&currentAbortController&&(console.log("[Glyph] User cancelled modification"),currentAbortController.abort())}),promptInput.addEventListener("keypress",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),applyModifications(promptInput.value))}),generateBtn.addEventListener("click",async()=>{if(demoDownloadCount>=MAX_DEMO_DOWNLOADS){showModal();return}const e=generateBtn.innerHTML;generateBtn.innerHTML='<div class="loading-spinner loading-spinner--small"></div>Generating...',generateBtn.disabled=!0;try{await generateDemoPdf()}finally{generateBtn.innerHTML=e,generateBtn.disabled=!1}});const modalOverlay=document.getElementById("modal-overlay"),modalClose=document.getElementById("modal-close");function showModal(){modalOverlay.classList.add("visible"),document.body.style.overflow="hidden"}function hideModal(){modalOverlay.classList.remove("visible"),document.body.style.overflow=""}modalClose.addEventListener("click",hideModal),modalOverlay.addEventListener("click",e=>{e.target===modalOverlay&&hideModal()});const pdfSuccessClose=document.getElementById("pdf-success-close"),pdfSuccessModal=document.getElementById("pdf-success-modal");pdfSuccessClose&&pdfSuccessClose.addEventListener("click",hidePdfSuccessModal),pdfSuccessModal&&pdfSuccessModal.addEventListener("click",e=>{e.target===pdfSuccessModal&&hidePdfSuccessModal()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&(modalOverlay.classList.contains("visible")&&hideModal(),pdfSuccessModal&&pdfSuccessModal.classList.contains("visible")&&hidePdfSuccessModal())});const hamburger=document.getElementById("hamburger"),mobileMenu=document.getElementById("mobile-menu");hamburger.addEventListener("click",()=>{hamburger.classList.toggle("active"),mobileMenu.classList.toggle("visible")}),document.querySelectorAll(".nav__mobile-links a").forEach(e=>{e.addEventListener("click",()=>{hamburger.classList.remove("active"),mobileMenu.classList.remove("visible")})}),document.addEventListener("DOMContentLoaded",()=>{[document.getElementById("glyph-toast"),document.getElementById("session-warning-toast")].forEach(n=>{n&&(n.classList.remove("active","visible"),n.style.display="none",n.setAttribute("aria-hidden","true"))});const t=document.getElementById("api-error-toast");t&&(t.classList.remove("active","visible"),t.style.display="none",t.setAttribute("inert","")),setupDemoModeBanner(),initializePreview(),handleSharedUrl()});function handleSharedUrl(){const e=window.location.hash;if(!e.startsWith("#playground?mods="))return;const t=e.replace("#playground?mods=","");let n;try{n=JSON.parse(atob(t))}catch{console.warn("[Glyph] Invalid shared URL payload");return}if(!n||!Array.isArray(n.actions)||n.actions.length===0)return;const o=document.getElementById("playground")||document.querySelector(".playground");o&&o.scrollIntoView({behavior:"smooth"});const i=document.querySelector(".playground__input-area");if(i){const s=document.createElement("div");s.className="shared-customization-banner",s.innerHTML=`
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
          </svg>
          <span>Viewing shared customization (${n.actions.length} change${n.actions.length!==1?"s":""})</span>
        `,i.insertBefore(s,i.firstChild)}if(n.template){const s=document.querySelector(`.playground__tab[data-template="${n.template}"]`);s&&!s.classList.contains("playground__tab--active")&&s.click()}function a(){const s=document.getElementById("preview-frame");if(!s||!s.srcdoc){setTimeout(a,500);return}r(n.actions,0)}function r(s,l){if(l>=s.length)return;if(isProcessingModification){setTimeout(()=>r(s,l),1e3);return}const p=s[l],c=document.getElementById("prompt-input");c&&(c.value=p,applyModifications(p)),setTimeout(()=>r(s,l+1),2e3)}setTimeout(a,1500)}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();const n=document.querySelector(this.getAttribute("href"));n&&n.scrollIntoView({behavior:"smooth",block:"start"})})});const observerOptions={threshold:.1,rootMargin:"0px 0px -50px 0px"},observer=new IntersectionObserver(e=>{e.forEach(t=>{t.isIntersecting&&(t.target.style.opacity="1",t.target.style.transform="translateY(0)")})},observerOptions);document.querySelectorAll(".feature-card, .pricing-card").forEach(e=>{e.style.opacity="0",e.style.transform="translateY(30px)",e.style.transition="opacity 0.6s ease, transform 0.6s ease",observer.observe(e)});const GLYPH_API=API_URL,airtableState={currentStep:1,apiKey:"",bases:[],selectedBase:null,selectedTable:null,tables:[],fields:[],records:[],description:"",style:"modern",generatedTemplate:null,generatedHtml:""},airtableModalOverlay=document.getElementById("airtable-modal-overlay"),connectAirtableBtn=document.getElementById("connect-airtable"),airtableModalClose=document.getElementById("airtable-modal-close"),airtableBackBtn=document.getElementById("airtable-back-btn"),airtableNextBtn=document.getElementById("airtable-next-btn"),airtableKeyInput=document.getElementById("airtable-key"),airtableBaseSelect=document.getElementById("airtable-base"),airtableTableSelect=document.getElementById("airtable-table"),airtableFieldsContainer=document.getElementById("airtable-fields"),airtableFieldsList=document.getElementById("airtable-fields-list"),airtableDescription=document.getElementById("airtable-description"),airtableStyleBtns=document.querySelectorAll(".airtable-style-btn"),airtablePreviewFrame=document.getElementById("airtable-preview-frame"),airtablePreviewLoading=document.getElementById("airtable-preview-loading"),airtableRefineInput=document.getElementById("airtable-refine-input"),airtableRefineBtn=document.getElementById("airtable-refine-btn"),airtableDownloadPdfBtn=document.getElementById("airtable-download-pdf"),airtableSaveTemplateBtn=document.getElementById("airtable-save-template");connectAirtableBtn.addEventListener("click",()=>{airtableModalOverlay.classList.add("visible"),document.body.style.overflow="hidden",airtableKeyInput.focus()});function closeAirtableModal(){airtableModalOverlay.classList.remove("visible"),document.body.style.overflow="",resetAirtableState()}airtableModalClose.addEventListener("click",closeAirtableModal),airtableModalOverlay.addEventListener("click",e=>{e.target===airtableModalOverlay&&closeAirtableModal()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&airtableModalOverlay.classList.contains("visible")&&closeAirtableModal()});function resetAirtableState(){airtableState.currentStep=1,airtableState.apiKey="",airtableState.bases=[],airtableState.selectedBase=null,airtableState.selectedTable=null,airtableState.tables=[],airtableState.fields=[],airtableState.records=[],airtableState.description="",airtableState.style="modern",airtableState.generatedTemplate=null,airtableState.generatedHtml="",airtableState.isDemoMode=!1,airtableState.isDemo=!1,airtableKeyInput.value="",airtableBaseSelect.innerHTML='<option value="">Select a base...</option>',airtableBaseSelect.disabled=!0,airtableTableSelect.innerHTML='<option value="">Select a table...</option>',airtableTableSelect.disabled=!0,airtableFieldsContainer.style.display="none",airtableFieldsList.innerHTML="",airtableDescription.value="",airtableStyleBtns.forEach(t=>t.classList.remove("selected")),airtableStyleBtns[0].classList.add("selected"),airtableDemoBadge.classList.remove("visible"),airtableTokenError.classList.remove("visible");const e=document.querySelector(".airtable-error-toast");e&&e.remove(),goToStep(1)}function goToStep(e){airtableState.currentStep=e,document.querySelectorAll(".airtable-step-content").forEach(t=>{t.classList.remove("active"),parseInt(t.dataset.step)===e&&t.classList.add("active")}),document.querySelectorAll(".airtable-progress__step").forEach(t=>{const n=parseInt(t.dataset.step);t.classList.remove("active","completed"),n===e?t.classList.add("active"):n<e&&t.classList.add("completed")}),document.querySelectorAll(".airtable-progress__connector").forEach((t,n)=>{n<e-1?t.classList.add("completed"):t.classList.remove("completed")}),airtableBackBtn.style.display=e>1?"flex":"none",updateNextButton()}function updateNextButton(){const e=airtableState.currentStep;let t="",n=!1;switch(e){case 1:t="Connect",n=!airtableKeyInput.value.trim().startsWith("pat");break;case 2:t="Continue",n=!airtableState.selectedTable;break;case 3:t="Generate Template",n=!airtableDescription.value.trim();break;case 4:t="Done",n=!1,airtableNextBtn.style.display="none";return}airtableNextBtn.style.display="flex",airtableNextBtn.innerHTML=`${t}<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>`,airtableNextBtn.disabled=n}const airtableTokenError=document.getElementById("airtable-token-error"),airtableDemoBadge=document.getElementById("airtable-demo-badge");airtableKeyInput.addEventListener("input",()=>{const e=airtableKeyInput.value.trim();e.length>0&&!e.startsWith("pat")?airtableTokenError.classList.add("visible"):airtableTokenError.classList.remove("visible"),updateNextButton()}),airtableDescription.addEventListener("input",updateNextButton),airtableStyleBtns.forEach(e=>{e.addEventListener("click",()=>{airtableStyleBtns.forEach(t=>t.classList.remove("selected")),e.classList.add("selected"),airtableState.style=e.dataset.style,document.getElementById("info-style").textContent=e.dataset.style.charAt(0).toUpperCase()+e.dataset.style.slice(1)})}),airtableBackBtn.addEventListener("click",()=>{airtableState.currentStep>1&&goToStep(airtableState.currentStep-1)}),airtableNextBtn.addEventListener("click",async()=>{switch(airtableState.currentStep){case 1:await connectToAirtable();break;case 2:prepareDescriptionStep(),goToStep(3);break;case 3:await generateTemplate();break}});async function connectToAirtable(){const e=airtableKeyInput.value.trim();if(e){airtableState.apiKey=e,setNextButtonLoading(!0);try{const t=await fetch(`${GLYPH_API}/v1/airtable/connect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:e})});if(t.ok){const n=await t.json();airtableState.bases=n.bases||[],populateBases(airtableState.bases),goToStep(2)}else await connectDirectToAirtable(e)}catch(t){console.warn("Glyph API connection failed, trying direct Airtable:",t),await connectDirectToAirtable(e)}finally{setNextButtonLoading(!1)}}}async function connectDirectToAirtable(e){try{const t=await fetch("https://api.airtable.com/v0/meta/bases",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error("Invalid API key");const n=await t.json();airtableState.bases=n.bases||[],airtableState.isDemoMode=!1,airtableDemoBadge.classList.remove("visible"),populateBases(airtableState.bases),goToStep(2)}catch(t){console.error("Airtable connection failed:",t),showConnectionErrorToast()}}function showConnectionErrorToast(){const e=document.querySelector(".airtable-error-toast");e&&e.remove();const t=document.createElement("div");t.className="airtable-error-toast",t.innerHTML=`
        <div class="airtable-error-toast__message">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span>Could not connect to Airtable. Please check your token and try again.</span>
        </div>
        <div class="airtable-error-toast__actions">
          <button class="airtable-error-toast__btn airtable-error-toast__btn--secondary" id="airtable-retry-btn">Try Again</button>
          <button class="airtable-error-toast__btn airtable-error-toast__btn--primary" id="airtable-demo-btn">Continue with Demo Data</button>
        </div>
      `,document.querySelector(".airtable-modal").appendChild(t),setTimeout(()=>t.classList.add("visible"),10),document.getElementById("airtable-retry-btn").addEventListener("click",()=>{t.classList.remove("visible"),setTimeout(()=>t.remove(),300),airtableKeyInput.focus()}),document.getElementById("airtable-demo-btn").addEventListener("click",()=>{t.classList.remove("visible"),setTimeout(()=>t.remove(),300),enterDemoMode()})}function enterDemoMode(){airtableState.isDemoMode=!0,airtableDemoBadge.classList.add("visible"),showAirtableToast("Using demo data for preview","warning"),loadDemoData()}function showAirtableToast(e,t="success"){const n=document.querySelector(".airtable-toast");n&&n.remove();const o=document.createElement("div");o.className=`airtable-toast airtable-toast--${t}`,o.innerHTML=`
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          ${t==="success"?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>':t==="info"?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'}
        </svg>
        <span>${e}</span>
      `,document.querySelector(".airtable-modal").appendChild(o),setTimeout(()=>o.classList.add("visible"),10),setTimeout(()=>{o.classList.remove("visible"),setTimeout(()=>o.remove(),300)},3e3)}function loadDemoData(){airtableState.bases=[{id:"appDemo123",name:"CRM Database"},{id:"appDemo456",name:"Project Tracker"},{id:"appDemo789",name:"Inventory Management"}],populateBases(airtableState.bases),airtableState.demoTables={appDemo123:[{id:"tblClients",name:"Clients",fields:[{name:"Name",type:"singleLineText"},{name:"Company",type:"singleLineText"},{name:"Email",type:"email"},{name:"Phone",type:"phoneNumber"},{name:"Status",type:"singleSelect"},{name:"Deal Value",type:"currency"}]},{id:"tblDeals",name:"Deals",fields:[{name:"Deal Name",type:"singleLineText"},{name:"Client",type:"linkedRecord"},{name:"Value",type:"currency"},{name:"Stage",type:"singleSelect"},{name:"Close Date",type:"date"}]}],appDemo456:[{id:"tblProjects",name:"Projects",fields:[{name:"Project Name",type:"singleLineText"},{name:"Description",type:"multilineText"},{name:"Owner",type:"collaborator"},{name:"Start Date",type:"date"},{name:"Due Date",type:"date"},{name:"Status",type:"singleSelect"},{name:"Budget",type:"currency"}]},{id:"tblTasks",name:"Tasks",fields:[{name:"Task",type:"singleLineText"},{name:"Project",type:"linkedRecord"},{name:"Assignee",type:"collaborator"},{name:"Priority",type:"singleSelect"},{name:"Complete",type:"checkbox"}]}],appDemo789:[{id:"tblProducts",name:"Products",fields:[{name:"Product Name",type:"singleLineText"},{name:"SKU",type:"singleLineText"},{name:"Category",type:"singleSelect"},{name:"Price",type:"currency"},{name:"Quantity",type:"number"},{name:"Supplier",type:"linkedRecord"}]}]},airtableState.demoRecords={tblClients:[{id:"rec1",fields:{Name:"John Smith",Company:"Acme Corp",Email:"john@acme.com",Phone:"+1 555-0123",Status:"Active","Deal Value":5e4}},{id:"rec2",fields:{Name:"Sarah Johnson",Company:"TechStart Inc",Email:"sarah@techstart.io",Phone:"+1 555-0456",Status:"Prospect","Deal Value":25e3}},{id:"rec3",fields:{Name:"Mike Chen",Company:"Global Solutions",Email:"mike@globalsol.com",Phone:"+1 555-0789",Status:"Active","Deal Value":75e3}}],tblProjects:[{id:"rec1",fields:{"Project Name":"Website Redesign",Description:"Complete overhaul of company website",Owner:"Alice","Start Date":"2024-01-15","Due Date":"2024-03-30",Status:"In Progress",Budget:45e3}},{id:"rec2",fields:{"Project Name":"Mobile App Launch",Description:"Launch iOS and Android apps",Owner:"Bob","Start Date":"2024-02-01","Due Date":"2024-06-15",Status:"Planning",Budget:12e4}}],tblProducts:[{id:"rec1",fields:{"Product Name":"Premium Widget",SKU:"WDG-001",Category:"Electronics",Price:299.99,Quantity:150,Supplier:"SupplyCo"}},{id:"rec2",fields:{"Product Name":"Basic Gadget",SKU:"GDG-002",Category:"Electronics",Price:49.99,Quantity:500,Supplier:"TechParts"}}]},airtableState.isDemo=!0,airtableState.isDemoMode=!0,airtableDemoBadge.classList.add("visible"),goToStep(2)}function populateBases(e){airtableBaseSelect.innerHTML='<option value="">Select a base...</option>',e.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,airtableBaseSelect.appendChild(n)}),airtableBaseSelect.disabled=!1}airtableBaseSelect.addEventListener("change",async e=>{const t=e.target.value;if(!t){airtableTableSelect.innerHTML='<option value="">Select a table...</option>',airtableTableSelect.disabled=!0,airtableFieldsContainer.style.display="none",airtableState.selectedBase=null,airtableState.selectedTable=null,updateNextButton();return}if(airtableState.selectedBase=airtableState.bases.find(n=>n.id===t),document.getElementById("info-base").textContent=airtableState.selectedBase?.name||"-",airtableTableSelect.innerHTML='<option value="">Loading tables...</option>',airtableTableSelect.disabled=!0,airtableState.isDemo&&airtableState.demoTables[t]){airtableState.tables=airtableState.demoTables[t],populateTables(airtableState.tables);return}try{const n=await fetch(`${GLYPH_API}/v1/airtable/bases/${t}/tables`,{headers:{Authorization:`Bearer ${airtableState.apiKey}`}});if(n.ok){const o=await n.json();airtableState.tables=o.tables||[]}else await fetchTablesDirectly(t)}catch(n){console.warn("Glyph API failed, trying direct Airtable:",n),await fetchTablesDirectly(t)}populateTables(airtableState.tables)});async function fetchTablesDirectly(e){try{const t=await fetch(`https://api.airtable.com/v0/meta/bases/${e}/tables`,{headers:{Authorization:`Bearer ${airtableState.apiKey}`}});if(!t.ok){const o=await t.text();console.error("Failed to fetch tables:",t.status,o),airtableState.tables=[];return}const n=await t.json();airtableState.tables=n.tables||[]}catch(t){console.error("Failed to fetch tables:",t),airtableState.tables=[]}}function populateTables(e){airtableTableSelect.innerHTML='<option value="">Select a table...</option>',e.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,airtableTableSelect.appendChild(n)}),airtableTableSelect.disabled=!1}airtableTableSelect.addEventListener("change",async e=>{const t=e.target.value;if(!t){airtableFieldsContainer.style.display="none",airtableState.selectedTable=null,airtableState.fields=[],updateNextButton();return}airtableState.selectedTable=airtableState.tables.find(n=>n.id===t),document.getElementById("info-table").textContent=airtableState.selectedTable?.name||"-",airtableState.fields=airtableState.selectedTable?.fields||[],displayFields(airtableState.fields),await fetchSampleRecords(),updateNextButton()});function displayFields(e){airtableFieldsList.innerHTML="",e.forEach(t=>{const n=document.createElement("span");n.className="airtable-field-badge",n.innerHTML=`
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
          </svg>
          ${t.name}
        `,airtableFieldsList.appendChild(n)}),airtableFieldsContainer.style.display="flex"}async function fetchSampleRecords(){if(!(!airtableState.selectedBase||!airtableState.selectedTable)){if(airtableState.isDemo&&airtableState.demoRecords){const e=airtableState.selectedTable.id;airtableState.records=airtableState.demoRecords[e]||[];return}try{const e=airtableState.selectedBase.id,t=airtableState.selectedTable.id,n=await fetch(`https://api.airtable.com/v0/${e}/${encodeURIComponent(airtableState.selectedTable.name)}?maxRecords=3`,{headers:{Authorization:`Bearer ${airtableState.apiKey}`}});if(n.ok){const o=await n.json();airtableState.records=o.records||[]}}catch(e){console.warn("Failed to fetch sample records:",e),airtableState.records=[]}}}function prepareDescriptionStep(){const e=document.getElementById("step3-fields-preview");e.innerHTML=airtableState.fields.map(t=>`<div class="airtable-data-row"><span class="airtable-data-label">${t.name}</span><span class="airtable-data-value">${t.type}</span></div>`).join("")}async function generateTemplate(){if(airtableState.description=airtableDescription.value.trim(),!!airtableState.description){setNextButtonLoading(!0),goToStep(4),showPreviewLoading(!0);try{const e=await fetch(`${GLYPH_API}/v1/templates/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({airtable:{apiKey:airtableState.apiKey,baseId:airtableState.selectedBase.id,tableId:airtableState.selectedTable.id,tableName:airtableState.selectedTable.name},description:airtableState.description,style:airtableState.style,fields:airtableState.fields,sampleRecords:airtableState.records})});if(e.ok){const t=await e.json();airtableState.generatedTemplate=t.template,airtableState.generatedHtml=t.html||t.preview,renderAirtablePreview(airtableState.generatedHtml),displayDataPreview()}else generateDemoTemplate()}catch(e){console.warn("Template generation failed, using demo:",e),generateDemoTemplate()}finally{setNextButtonLoading(!1),showPreviewLoading(!1)}}}function generateDemoTemplate(){const e=airtableState.style==="modern"?"#1E3A5F":airtableState.style==="professional"?"#1E40AF":"#6B7280",t=airtableState.style==="modern"?"#64748b":airtableState.style==="professional"?"#475569":"#9CA3AF",n=airtableState.style==="minimal"?"#fafafa":"#f9fafb",o=airtableState.records[0]?.fields||{},i=airtableState.fields.map(d=>d.name).slice(0,5),a=(airtableState.description||"").toLowerCase(),r=airtableState.selectedBase?.name||"Your Company",s=new Date().toLocaleDateString(),l=new Date(Date.now()+30*24*60*60*1e3).toLocaleDateString(),p=detectDocumentType(a);let c;switch(p){case"invoice":c=generateInvoiceTemplate(e,t,n,o,i,r,s,l);break;case"receipt":c=generateReceiptTemplate(e,t,n,o,i,r,s);break;case"packing":c=generatePackingSlipTemplate(e,t,n,o,i,r,s);break;case"report":c=generateReportTemplate(e,t,n,o,i,r,s);break;default:c=generateDataTableTemplate(e,t,n,o,i,r,s)}airtableState.generatedHtml=c,renderAirtablePreview(c),displayDataPreview()}function detectDocumentType(e){return/\b(invoice|invoices|billing|bill)\b/i.test(e)?"invoice":/\b(receipt|receipts|payment\s+confirmation|paid)\b/i.test(e)?"receipt":/\b(packing|shipping|slip|shipment|delivery)\b/i.test(e)?"packing":/\b(report|summary|analysis|overview)\b/i.test(e)?"report":"data"}function findFieldValue(e,t,n){const o=Object.keys(e).map(i=>({orig:i,lower:i.toLowerCase()}));for(const i of t){const a=o.find(r=>r.lower.includes(i.toLowerCase()));if(a&&e[a.orig])return e[a.orig]}return n}function generateInvoiceTemplate(e,t,n,o,i,a,r,s){const l=findFieldValue(o,["name","customer","client","company","contact"],"Customer Name"),p=findFieldValue(o,["email","mail"],"customer@example.com"),c=findFieldValue(o,["address","location","street"],"123 Main Street"),d=findFieldValue(o,["item","product","service","description","title"],"Professional Services"),m=findFieldValue(o,["qty","quantity","units","count"],"1"),f=findFieldValue(o,["rate","price","cost","amount"],"500.00");return`<!DOCTYPE html>
<html>
<head>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; font-size: 12px; color: #1a1a1a; padding: 40px; background: white; }
  .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; }
  .company { font-size: 24px; font-weight: 700; color: ${e}; }
  .company-details { font-size: 11px; color: ${t}; margin-top: 4px; }
  .doc-title { font-size: 32px; font-weight: 700; color: ${e}; text-transform: uppercase; letter-spacing: 0.05em; }
  .invoice-meta { display: flex; gap: 40px; margin-bottom: 32px; }
  .meta-block { }
  .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 4px; }
  .meta-value { font-weight: 600; font-size: 14px; }
  .addresses { display: flex; gap: 60px; margin-bottom: 32px; }
  .address-block { }
  .address-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 8px; font-weight: 600; }
  .address-content { line-height: 1.6; }
  .address-name { font-weight: 600; }
  .line-items { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
  .line-items th { background: ${e}; color: white; padding: 12px 16px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
  .line-items th:last-child, .line-items td:last-child { text-align: right; }
  .line-items th:nth-child(2), .line-items td:nth-child(2),
  .line-items th:nth-child(3), .line-items td:nth-child(3) { text-align: center; }
  .line-items td { padding: 14px 16px; border-bottom: 1px solid #e5e5e5; }
  .totals { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; margin-top: 16px; }
  .total-row { display: flex; gap: 40px; font-size: 13px; }
  .total-label { color: ${t}; min-width: 80px; }
  .total-value { font-weight: 500; min-width: 100px; text-align: right; }
  .total-final { font-size: 16px; font-weight: 700; color: ${e}; padding-top: 8px; border-top: 2px solid ${e}; }
  .footer { margin-top: 48px; padding-top: 16px; border-top: 1px solid #e5e5e5; text-align: center; color: #999; font-size: 10px; }
  .notes { background: ${n}; padding: 16px; border-radius: 8px; margin-top: 32px; }
  .notes-title { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 8px; }
</style>
</head>
<body>
  <div class="header">
    <div>
      <div class="company">${a}</div>
      <div class="company-details">123 Business Ave, Suite 100<br>contact@company.com</div>
    </div>
    <div class="doc-title">Invoice</div>
  </div>

  <div class="invoice-meta">
    <div class="meta-block">
      <div class="meta-label">Invoice #</div>
      <div class="meta-value">INV-001</div>
    </div>
    <div class="meta-block">
      <div class="meta-label">Date</div>
      <div class="meta-value">${r}</div>
    </div>
    <div class="meta-block">
      <div class="meta-label">Due Date</div>
      <div class="meta-value">${s}</div>
    </div>
  </div>

  <div class="addresses">
    <div class="address-block">
      <div class="address-label">Bill To</div>
      <div class="address-content">
        <div class="address-name">${l}</div>
        <div>${c}</div>
        <div>${p}</div>
      </div>
    </div>
  </div>

  <table class="line-items">
    <thead>
      <tr>
        <th>Description</th>
        <th>Qty</th>
        <th>Rate</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>${d}</td>
        <td>${m}</td>
        <td>$${parseFloat(f).toFixed(2)}</td>
        <td>$${(parseFloat(m)*parseFloat(f)||500).toFixed(2)}</td>
      </tr>
      <tr>
        <td>Additional Services</td>
        <td>2</td>
        <td>$250.00</td>
        <td>$500.00</td>
      </tr>
    </tbody>
  </table>

  <div class="totals">
    <div class="total-row">
      <span class="total-label">Subtotal</span>
      <span class="total-value">$${1e3.toFixed(2)}</span>
    </div>
    <div class="total-row">
      <span class="total-label">Tax (10%)</span>
      <span class="total-value">$${100 .toFixed(2)}</span>
    </div>
    <div class="total-row total-final">
      <span class="total-label">Total</span>
      <span class="total-value">$${1100 .toFixed(2)}</span>
    </div>
  </div>

  <div class="notes">
    <div class="notes-title">Payment Terms</div>
    <div>Payment is due within 30 days. Please include invoice number with payment.</div>
  </div>

  <div class="footer">
    Generated with Glyph - AI-Powered PDF Customization
  </div>
</body>
</html>`}function generateReceiptTemplate(e,t,n,o,i,a,r){const s=findFieldValue(o,["name","customer","client","contact"],"Customer Name"),l=findFieldValue(o,["email","mail"],"customer@example.com"),p=findFieldValue(o,["item","product","service","description"],"Product/Service"),c=findFieldValue(o,["payment","method","card"],"Credit Card");return`<!DOCTYPE html>
<html>
<head>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; font-size: 12px; color: #1a1a1a; padding: 40px; background: white; max-width: 400px; margin: 0 auto; }
  .header { text-align: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid ${e}; }
  .company { font-size: 24px; font-weight: 700; color: ${e}; margin-bottom: 4px; }
  .company-details { font-size: 11px; color: ${t}; }
  .doc-title { font-size: 20px; font-weight: 700; color: ${e}; text-transform: uppercase; letter-spacing: 0.1em; margin-top: 16px; }
  .receipt-meta { background: ${n}; padding: 16px; border-radius: 8px; margin-bottom: 24px; }
  .meta-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
  .meta-row:last-child { margin-bottom: 0; }
  .meta-label { color: ${t}; font-size: 11px; }
  .meta-value { font-weight: 600; }
  .items { margin-bottom: 24px; }
  .item-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e5e5; }
  .item-name { font-weight: 500; }
  .item-price { font-weight: 600; }
  .totals { border-top: 2px solid #e5e5e5; padding-top: 16px; }
  .total-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
  .total-final { font-size: 18px; font-weight: 700; color: ${e}; margin-top: 12px; padding-top: 12px; border-top: 2px solid ${e}; }
  .paid-stamp { text-align: center; margin: 24px 0; padding: 12px; border: 3px solid #22c55e; border-radius: 8px; color: #22c55e; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; }
  .footer { margin-top: 32px; text-align: center; color: #999; font-size: 10px; }
  .thank-you { font-size: 14px; color: ${e}; font-weight: 600; margin-bottom: 8px; }
</style>
</head>
<body>
  <div class="header">
    <div class="company">${a}</div>
    <div class="company-details">123 Business Ave | contact@company.com</div>
    <div class="doc-title">Receipt</div>
  </div>

  <div class="receipt-meta">
    <div class="meta-row">
      <span class="meta-label">Receipt #</span>
      <span class="meta-value">RCP-001</span>
    </div>
    <div class="meta-row">
      <span class="meta-label">Date</span>
      <span class="meta-value">${r}</span>
    </div>
    <div class="meta-row">
      <span class="meta-label">Customer</span>
      <span class="meta-value">${s}</span>
    </div>
    <div class="meta-row">
      <span class="meta-label">Payment Method</span>
      <span class="meta-value">${c}</span>
    </div>
  </div>

  <div class="items">
    <div class="item-row">
      <span class="item-name">${p}</span>
      <span class="item-price">$500.00</span>
    </div>
    <div class="item-row">
      <span class="item-name">Service Fee</span>
      <span class="item-price">$50.00</span>
    </div>
  </div>

  <div class="totals">
    <div class="total-row">
      <span>Subtotal</span>
      <span>$550.00</span>
    </div>
    <div class="total-row">
      <span>Tax</span>
      <span>$55.00</span>
    </div>
    <div class="total-row total-final">
      <span>Total Paid</span>
      <span>$605.00</span>
    </div>
  </div>

  <div class="paid-stamp">Paid</div>

  <div class="footer">
    <div class="thank-you">Thank you for your business!</div>
    <div>Generated with Glyph - AI-Powered PDF Customization</div>
  </div>
</body>
</html>`}function generatePackingSlipTemplate(e,t,n,o,i,a,r){const s=findFieldValue(o,["name","customer","client","contact","recipient"],"Recipient Name"),l=findFieldValue(o,["address","location","street","shipping"],"456 Delivery Lane"),p=findFieldValue(o,["city","town"],"Anytown"),c=findFieldValue(o,["item","product","sku","description"],"Product Item"),d=findFieldValue(o,["qty","quantity","units","count"],"2");return`<!DOCTYPE html>
<html>
<head>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; font-size: 12px; color: #1a1a1a; padding: 40px; background: white; }
  .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 3px solid ${e}; }
  .company { font-size: 24px; font-weight: 700; color: ${e}; }
  .doc-title { font-size: 28px; font-weight: 700; color: ${e}; text-transform: uppercase; letter-spacing: 0.05em; }
  .shipping-info { display: flex; gap: 60px; margin-bottom: 32px; }
  .address-block { flex: 1; }
  .address-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 8px; font-weight: 600; padding-bottom: 8px; border-bottom: 1px solid #e5e5e5; }
  .address-content { line-height: 1.8; padding: 12px; background: ${n}; border-radius: 8px; }
  .address-name { font-weight: 700; font-size: 14px; }
  .order-meta { background: ${n}; padding: 16px 24px; border-radius: 8px; margin-bottom: 32px; display: flex; gap: 40px; }
  .meta-block { }
  .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 4px; }
  .meta-value { font-weight: 600; font-size: 14px; }
  .items-table { width: 100%; border-collapse: collapse; }
  .items-table th { background: ${e}; color: white; padding: 12px 16px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
  .items-table th:last-child { text-align: center; width: 100px; }
  .items-table td { padding: 14px 16px; border-bottom: 1px solid #e5e5e5; }
  .items-table td:last-child { text-align: center; font-weight: 600; }
  .item-sku { font-size: 10px; color: ${t}; margin-top: 2px; }
  .checkbox { width: 16px; height: 16px; border: 2px solid ${e}; border-radius: 3px; display: inline-block; margin-right: 8px; vertical-align: middle; }
  .summary { margin-top: 24px; text-align: right; font-size: 14px; }
  .summary-value { font-weight: 700; color: ${e}; }
  .footer { margin-top: 48px; padding-top: 16px; border-top: 1px solid #e5e5e5; text-align: center; color: #999; font-size: 10px; }
  .signature-line { margin-top: 48px; display: flex; gap: 40px; }
  .sig-block { flex: 1; }
  .sig-label { font-size: 10px; text-transform: uppercase; color: ${t}; margin-bottom: 8px; }
  .sig-line { border-bottom: 1px solid #333; height: 40px; }
</style>
</head>
<body>
  <div class="header">
    <div class="company">${a}</div>
    <div class="doc-title">Packing Slip</div>
  </div>

  <div class="order-meta">
    <div class="meta-block">
      <div class="meta-label">Order #</div>
      <div class="meta-value">ORD-12345</div>
    </div>
    <div class="meta-block">
      <div class="meta-label">Ship Date</div>
      <div class="meta-value">${r}</div>
    </div>
    <div class="meta-block">
      <div class="meta-label">Carrier</div>
      <div class="meta-value">Standard Shipping</div>
    </div>
  </div>

  <div class="shipping-info">
    <div class="address-block">
      <div class="address-label">Ship From</div>
      <div class="address-content">
        <div class="address-name">${a}</div>
        <div>123 Warehouse Blvd</div>
        <div>Distribution Center, ST 12345</div>
      </div>
    </div>
    <div class="address-block">
      <div class="address-label">Ship To</div>
      <div class="address-content">
        <div class="address-name">${s}</div>
        <div>${l}</div>
        <div>${p}, ST 67890</div>
      </div>
    </div>
  </div>

  <table class="items-table">
    <thead>
      <tr>
        <th>Item Description</th>
        <th>Qty</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <span class="checkbox"></span>${c}
          <div class="item-sku">SKU: ITEM-001</div>
        </td>
        <td>${d}</td>
      </tr>
      <tr>
        <td>
          <span class="checkbox"></span>Packaging Materials
          <div class="item-sku">SKU: PKG-001</div>
        </td>
        <td>1</td>
      </tr>
    </tbody>
  </table>

  <div class="summary">
    Total Items: <span class="summary-value">${parseInt(d)+1}</span>
  </div>

  <div class="signature-line">
    <div class="sig-block">
      <div class="sig-label">Packed By</div>
      <div class="sig-line"></div>
    </div>
    <div class="sig-block">
      <div class="sig-label">Date</div>
      <div class="sig-line"></div>
    </div>
  </div>

  <div class="footer">
    Generated with Glyph - AI-Powered PDF Customization
  </div>
</body>
</html>`}function generateReportTemplate(e,t,n,o,i,a,r){const s=findFieldValue(o,["title","name","report","subject"],"Data Report");return`<!DOCTYPE html>
<html>
<head>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; font-size: 12px; color: #1a1a1a; padding: 40px; background: white; }
  .header { margin-bottom: 32px; padding-bottom: 20px; border-bottom: 3px solid ${e}; }
  .company { font-size: 14px; color: ${t}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.1em; }
  .doc-title { font-size: 28px; font-weight: 700; color: ${e}; }
  .subtitle { font-size: 14px; color: ${t}; margin-top: 8px; }
  .meta-bar { display: flex; gap: 32px; background: ${n}; padding: 16px 24px; border-radius: 8px; margin-bottom: 32px; }
  .meta-item { }
  .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 4px; }
  .meta-value { font-weight: 600; }
  .section { margin-bottom: 32px; }
  .section-title { font-size: 16px; font-weight: 700; color: ${e}; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid ${e}; }
  .summary-cards { display: flex; gap: 16px; margin-bottom: 32px; }
  .summary-card { flex: 1; background: ${n}; padding: 20px; border-radius: 8px; text-align: center; }
  .card-value { font-size: 28px; font-weight: 700; color: ${e}; }
  .card-label { font-size: 11px; color: ${t}; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 4px; }
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th { background: ${e}; color: white; padding: 12px 16px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
  .data-table td { padding: 12px 16px; border-bottom: 1px solid #e5e5e5; }
  .data-table tr:nth-child(even) { background: ${n}; }
  .footer { margin-top: 48px; padding-top: 16px; border-top: 1px solid #e5e5e5; text-align: center; color: #999; font-size: 10px; }
  .notes { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 16px; margin-top: 24px; }
  .notes-title { font-weight: 600; margin-bottom: 4px; }
</style>
</head>
<body>
  <div class="header">
    <div class="company">${a}</div>
    <div class="doc-title">${s}</div>
    <div class="subtitle">Comprehensive data overview and analysis</div>
  </div>

  <div class="meta-bar">
    <div class="meta-item">
      <div class="meta-label">Report Date</div>
      <div class="meta-value">${r}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Period</div>
      <div class="meta-value">Current Quarter</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Status</div>
      <div class="meta-value">Final</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Summary</div>
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-value">${i.length}</div>
        <div class="card-label">Data Fields</div>
      </div>
      <div class="summary-card">
        <div class="card-value">${Object.keys(o).length}</div>
        <div class="card-label">Values</div>
      </div>
      <div class="summary-card">
        <div class="card-value">100%</div>
        <div class="card-label">Complete</div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Data Overview</div>
    <table class="data-table">
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        ${i.map(l=>`
        <tr>
          <td>${l}</td>
          <td>${o[l]||"{{"+l+"}}"}</td>
        </tr>
        `).join("")}
      </tbody>
    </table>
  </div>

  <div class="notes">
    <div class="notes-title">Note</div>
    <div>This report was automatically generated from your Airtable data. You can customize the layout and add additional sections using Glyph's AI-powered editor.</div>
  </div>

  <div class="footer">
    Generated with Glyph - AI-Powered PDF Customization
  </div>
</body>
</html>`}function generateDataTableTemplate(e,t,n,o,i,a,r){return`<!DOCTYPE html>
<html>
<head>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; font-size: 12px; color: #1a1a1a; padding: 32px; background: white; }
  .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 20px; border-bottom: 3px solid ${e}; margin-bottom: 24px; }
  .company { font-size: 20px; font-weight: 700; color: ${e}; }
  .doc-title { font-size: 28px; font-weight: 700; color: ${e}; text-transform: uppercase; letter-spacing: 0.05em; }
  .meta { display: flex; gap: 40px; background: ${n}; padding: 16px 24px; border-radius: 8px; margin-bottom: 24px; }
  .meta-item { }
  .meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: ${t}; margin-bottom: 4px; }
  .meta-value { font-weight: 600; font-size: 14px; }
  .section { margin-bottom: 24px; }
  .section-title { font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; color: ${e}; margin-bottom: 12px; font-weight: 600; }
  table { width: 100%; border-collapse: collapse; }
  th { background: ${e}; color: white; padding: 12px 16px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
  td { padding: 14px 16px; border-bottom: 1px solid #e5e5e5; }
  .field-name { color: ${t}; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; }
  .field-value { font-weight: 500; margin-top: 4px; }
  .footer { margin-top: 32px; padding-top: 16px; border-top: 1px solid #e5e5e5; text-align: center; color: #999; font-size: 10px; }
</style>
</head>
<body>
  <div class="header">
    <div class="company">${a}</div>
    <div class="doc-title">Document</div>
  </div>

  <div class="meta">
    <div class="meta-item">
      <div class="meta-label">Table</div>
      <div class="meta-value">${airtableState.selectedTable?.name||"Data"}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Generated</div>
      <div class="meta-value">${r}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Style</div>
      <div class="meta-value">${airtableState.style.charAt(0).toUpperCase()+airtableState.style.slice(1)}</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Data Fields</div>
    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        ${i.map(s=>`
        <tr>
          <td><div class="field-name">${s}</div></td>
          <td><div class="field-value">${o[s]||"{{"+s+"}}"}</div></td>
        </tr>
        `).join("")}
      </tbody>
    </table>
  </div>

  <div class="footer">
    Generated with Glyph - AI-Powered PDF Customization
  </div>
</body>
</html>`}function renderAirtablePreview(e){const t=airtablePreviewFrame.contentDocument||airtablePreviewFrame.contentWindow.document;t.open(),t.write(e),t.close()}function displayDataPreview(){const e=document.getElementById("airtable-data-preview"),t=airtableState.records[0]?.fields||{},n=airtableState.fields.slice(0,4).map(o=>o.name);e.innerHTML=n.map(o=>`<div class="airtable-data-row">
          <span class="airtable-data-label">${o}</span>
          <span class="airtable-data-value">${truncateValue(t[o])}</span>
        </div>`).join("")}function truncateValue(e){if(!e)return"-";const t=String(e);return t.length>20?t.substring(0,20)+"...":t}function showPreviewLoading(e){airtablePreviewLoading.classList.toggle("visible",e)}function setNextButtonLoading(e){airtableNextBtn.classList.toggle("loading",e),airtableNextBtn.disabled=e}airtableRefineBtn.addEventListener("click",async()=>{const e=airtableRefineInput.value.trim();if(e){airtableRefineBtn.disabled=!0,airtableRefineBtn.textContent="Refining...",showPreviewLoading(!0);try{const t=await fetch(`${GLYPH_API}/v1/templates/refine`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({template:airtableState.generatedTemplate,html:airtableState.generatedHtml,modification:e,data:airtableState.records[0]?.fields||{}})});if(t.ok){const n=await t.json();airtableState.generatedHtml=n.html||n.preview,renderAirtablePreview(airtableState.generatedHtml)}else simulateRefinement(e)}catch(t){console.warn("Refinement failed, simulating:",t),simulateRefinement(e)}finally{airtableRefineBtn.disabled=!1,airtableRefineBtn.textContent="Refine",showPreviewLoading(!1),airtableRefineInput.value=""}}});function simulateRefinement(e){let t=airtableState.generatedHtml;const n=e.toLowerCase();n.includes("blue")?t=t.replace(/#1E3A5F|#1E40AF|#6B7280/g,"#3B82F6"):n.includes("red")?t=t.replace(/#1E3A5F|#1E40AF|#6B7280/g,"#EF4444"):n.includes("green")?t=t.replace(/#1E3A5F|#1E40AF|#6B7280/g,"#22C55E"):n.includes("purple")?t=t.replace(/#1E3A5F|#1E40AF|#6B7280/g,"#8B5CF6"):n.includes("orange")&&(t=t.replace(/#1E3A5F|#1E40AF|#6B7280/g,"#F97316")),airtableState.generatedHtml=t,renderAirtablePreview(t)}airtableRefineInput.addEventListener("keypress",e=>{e.key==="Enter"&&airtableRefineBtn.click()}),airtableDownloadPdfBtn.addEventListener("click",async()=>{airtableDownloadPdfBtn.classList.add("loading");try{const e=await fetch(`${GLYPH_API}/v1/pdf`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({html:airtableState.generatedHtml})});if(e.ok){const t=await e.blob(),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`${airtableState.selectedTable?.name||"document"}.pdf`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}else alert("PDF generation requires an API key. Sign up at dashboard.glyph.you")}catch(e){console.error("PDF download failed:",e),alert("PDF generation requires an API key. Sign up at dashboard.glyph.you")}finally{airtableDownloadPdfBtn.classList.remove("loading")}}),airtableSaveTemplateBtn.addEventListener("click",()=>{alert("Template saving requires an account. Sign up at dashboard.glyph.you to save and manage your templates.")});const batchViewSelect=document.getElementById("batch-view-select"),batchFilenameInput=document.getElementById("batch-filename"),batchRecordCount=document.getElementById("batch-record-count"),batchGenerateBtn=document.getElementById("batch-generate-btn"),batchBtnText=document.getElementById("batch-btn-text"),batchProgress=document.getElementById("batch-progress"),batchProgressFill=document.getElementById("batch-progress-fill"),batchCompleted=document.getElementById("batch-completed"),batchTotal=document.getElementById("batch-total");let batchJobId=null,batchPollInterval=null;async function loadBatchViews(){if(!(!airtableState.apiKey||!airtableState.selectedBase||!airtableState.selectedTable)){try{const e=new URLSearchParams({apiKey:airtableState.apiKey,baseId:airtableState.selectedBase.id,tableId:airtableState.selectedTable.id}),t=await fetch(`${GLYPH_API}/v1/templates/views?${e}`);if(t.ok){const n=await t.json();batchViewSelect.innerHTML='<option value="">All records</option>',(n.views||[]).forEach(o=>{const i=document.createElement("option");i.value=o.name,i.textContent=o.name,batchViewSelect.appendChild(i)})}}catch(e){console.warn("Failed to load views:",e)}airtableState.selectedTable&&(batchFilenameInput.value=`${airtableState.selectedTable.name.toLowerCase().replace(/\s+/g,"-")}-{{fields.Name}}.pdf`),await updateRecordCount()}}batchViewSelect.addEventListener("change",updateRecordCount);async function updateRecordCount(){if(!airtableState.apiKey||!airtableState.selectedBase||!airtableState.selectedTable){batchRecordCount.textContent="0",batchGenerateBtn.disabled=!0;return}try{const e=new URLSearchParams({apiKey:airtableState.apiKey,baseId:airtableState.selectedBase.id,tableId:airtableState.selectedTable.id});batchViewSelect.value&&e.append("view",batchViewSelect.value);const t=await fetch(`${GLYPH_API}/v1/templates/count?${e}`);if(t.ok){const n=await t.json();batchRecordCount.textContent=n.count||0,batchGenerateBtn.disabled=(n.count||0)===0,batchBtnText.textContent=`Generate All PDFs (${n.count} records)`}}catch(e){console.warn("Failed to get record count:",e),batchRecordCount.textContent="?"}}batchGenerateBtn.addEventListener("click",async()=>{if(!airtableState.generatedHtml||!airtableState.apiKey){alert("Please generate a template first");return}const e=parseInt(batchRecordCount.textContent)||0;if(e===0){alert("No records to generate");return}batchGenerateBtn.disabled=!0,batchGenerateBtn.classList.add("loading"),batchBtnText.textContent="Starting...",batchProgress.style.display="block",batchProgressFill.style.width="0%",batchCompleted.textContent="0",batchTotal.textContent=e;const t={template:airtableState.generatedHtml,airtable:{apiKey:airtableState.apiKey,baseId:airtableState.selectedBase.id,tableId:airtableState.selectedTable.id,view:batchViewSelect.value||void 0,maxRecords:e},output:{filename:batchFilenameInput.value||"document-{{record.id}}.pdf"}};try{if(e<=20){batchBtnText.textContent="Generating...";const n=await fetch(`${GLYPH_API}/v1/templates/batch`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(n.ok){const o=await n.blob();downloadBlob(o,`batch-${Date.now()}.zip`),batchProgressFill.style.width="100%",batchCompleted.textContent=e,batchBtnText.textContent="Download Complete!"}else{const o=await n.json();throw new Error(o.error||"Batch generation failed")}}else{batchBtnText.textContent="Starting batch job...";const n=await fetch(`${GLYPH_API}/v1/templates/batch/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok){const i=await n.json();throw new Error(i.error||"Failed to start batch job")}batchJobId=(await n.json()).jobId,batchBtnText.textContent="Processing...",batchPollInterval=setInterval(pollBatchStatus,2e3)}}catch(n){console.error("Batch generation error:",n),alert(n.message||"Batch generation failed"),resetBatchUI()}});async function pollBatchStatus(){if(batchJobId)try{const e=await fetch(`${GLYPH_API}/v1/templates/batch/${batchJobId}`);if(!e.ok)throw new Error("Failed to get job status");const t=await e.json();if(batchCompleted.textContent=t.completed,batchTotal.textContent=t.total,batchProgressFill.style.width=`${t.progress}%`,batchBtnText.textContent=`Processing... ${t.progress}%`,t.status==="completed"){clearInterval(batchPollInterval),batchBtnText.textContent="Downloading...";const n=await fetch(`${GLYPH_API}/v1/templates/batch/${batchJobId}/download`);if(n.ok){const o=await n.blob();downloadBlob(o,`batch-${batchJobId}.zip`),batchBtnText.textContent="Download Complete!"}setTimeout(resetBatchUI,3e3)}else if(t.status==="failed")throw clearInterval(batchPollInterval),new Error("Batch job failed")}catch(e){console.error("Polling error:",e),clearInterval(batchPollInterval),alert("Batch processing failed"),resetBatchUI()}}function downloadBlob(e,t){const n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}function resetBatchUI(){batchGenerateBtn.disabled=!1,batchGenerateBtn.classList.remove("loading");const e=batchRecordCount.textContent;batchBtnText.textContent=`Generate All PDFs (${e} records)`,batchProgress.style.display="none",batchJobId=null,batchPollInterval&&(clearInterval(batchPollInterval),batchPollInterval=null)}const originalGoToStep=goToStep;goToStep=function(e){originalGoToStep(e),e===4&&loadBatchViews()};let saveTemplateElements=null;function getSaveTemplateElements(){return saveTemplateElements||(saveTemplateElements={btn:document.getElementById("save-template-btn"),modal:document.getElementById("save-template-modal"),form:document.getElementById("save-template-form"),demoNotice:document.getElementById("save-template-demo-notice"),nameInput:document.getElementById("template-name-input"),typeSelect:document.getElementById("template-type-select"),descriptionInput:document.getElementById("template-description-input"),defaultCheckbox:document.getElementById("template-default-checkbox"),errorEl:document.getElementById("save-template-error"),cancelBtn:document.getElementById("save-template-cancel"),confirmBtn:document.getElementById("save-template-confirm")}),saveTemplateElements}function canSaveTemplates(){try{const e=localStorage.getItem("glyph_user_api_key");return e&&e!==DEMO_API_KEY&&e.startsWith("gk_")}catch{return!1}}function getUserApiKey(){try{const e=localStorage.getItem("glyph_user_api_key");if(e&&e.startsWith("gk_"))return e}catch{}return DEMO_API_KEY}function showSaveTemplateButton(){const e=getSaveTemplateElements();e.btn&&e.btn.classList.add("visible")}function hideSaveTemplateButton(){const e=getSaveTemplateElements();e.btn&&e.btn.classList.remove("visible")}function showSaveTemplateModal(){const e=getSaveTemplateElements();if(!e.modal)return;const t=canSaveTemplates();e.form&&(e.form.style.display=t?"flex":"none"),e.demoNotice&&(e.demoNotice.style.display=t?"none":"block"),t&&e.form&&(e.form.reset(),e.errorEl&&(e.errorEl.textContent="",e.errorEl.classList.remove("visible"))),e.modal.classList.add("active"),t&&e.nameInput&&setTimeout(()=>e.nameInput.focus(),100)}function closeSaveTemplateModal(){const e=getSaveTemplateElements();e.modal&&e.modal.classList.remove("active")}function showSaveTemplateError(e){const t=getSaveTemplateElements();t.errorEl&&(t.errorEl.textContent=e,t.errorEl.classList.add("visible"))}function hideSaveTemplateError(){const e=getSaveTemplateElements();e.errorEl&&(e.errorEl.textContent="",e.errorEl.classList.remove("visible"))}function setSaveTemplateLoading(e){const t=getSaveTemplateElements();if(!t.confirmBtn)return;const n=t.confirmBtn.querySelector(".btn-text"),o=t.confirmBtn.querySelector(".btn-spinner");t.confirmBtn.disabled=e,n&&(n.style.display=e?"none":"inline"),o&&(o.style.display=e?"inline-block":"none")}async function handleSaveTemplateSubmit(e){e.preventDefault();const t=getSaveTemplateElements();if(!t.nameInput)return;const n=t.nameInput.value.trim(),o=t.typeSelect?.value||void 0,i=t.descriptionInput?.value.trim()||void 0,a=t.defaultCheckbox?.checked||!1;if(!n){showSaveTemplateError("Please enter a template name."),t.nameInput.focus();return}if(!currentHtml){showSaveTemplateError("No template content to save. Apply some changes first.");return}const r=getUserApiKey();if(r===DEMO_API_KEY){showSaveTemplateError("You need an API key to save templates. Get one from the dashboard.");return}setSaveTemplateLoading(!0),hideSaveTemplateError();try{const s=await fetch(`${API_URL}/v1/templates/saved`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({name:n,type:o||void 0,description:i||void 0,html:currentHtml,isDefault:a})}),l=await s.json();if(!s.ok)throw new Error(l.error||l.message||"Failed to save template");closeSaveTemplateModal(),showToast(`Template saved! ID: ${l.template.id}`,"success",4e3),console.log("[Glyph] Template saved:",{id:l.template.id,name:l.template.name,type:l.template.type,apiUsage:`Use with API: POST /v1/create with templateId: "${l.template.id}"`})}catch(s){console.error("[Glyph] Failed to save template:",s),showSaveTemplateError(s.message||"Failed to save template. Please try again.")}finally{setSaveTemplateLoading(!1)}}function initSaveTemplateFeature(){const e=getSaveTemplateElements();e.btn&&e.btn.addEventListener("click",showSaveTemplateModal),e.cancelBtn&&e.cancelBtn.addEventListener("click",closeSaveTemplateModal),e.form&&e.form.addEventListener("submit",handleSaveTemplateSubmit),e.modal&&e.modal.addEventListener("click",t=>{t.target===e.modal&&closeSaveTemplateModal()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&e.modal?.classList.contains("active")&&closeSaveTemplateModal()}),console.log("[Glyph] Save Template feature initialized")}const originalAddHistoryEntry=addHistoryEntry;addHistoryEntry=function(e,t){originalAddHistoryEntry(e,t),historyEntries.length>0&&showSaveTemplateButton()},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initSaveTemplateFeature):initSaveTemplateFeature(),function(){const e=function(){const t=document.getElementById("mouseGlow");if(!t)return;if(!window.matchMedia("(hover: hover)").matches){t.style.display="none";return}let o=0,i=0,a=0,r=0,s=null,l=!1;function p(u){o=u.clientX,i=u.clientY,t.classList.add("active")}function c(){t.classList.remove("active")}document.addEventListener("mousemove",p),document.addEventListener("mouseleave",c);function d(){l&&(a+=(o-a)*.1,r+=(i-r)*.1,t.style.left=a+"px",t.style.top=r+"px",s=requestAnimationFrame(d))}function m(){l||(l=!0,d())}function f(){l=!1,s&&(cancelAnimationFrame(s),s=null)}document.addEventListener("visibilitychange",()=>{document.hidden?(f(),t.classList.remove("active")):m()}),document.hidden||m()};typeof requestIdleCallback=="function"?requestIdleCallback(e):setTimeout(e,2e3)}(),function(){[{input:"prompt-input",hint:"prompt-input-hint"},{input:"airtable-key",hint:"airtable-key-hint"},{input:"batch-filename",hint:"batch-filename-hint"}].forEach(function(o){var i=document.getElementById(o.input),a=document.getElementById(o.hint);!i||!a||(i.addEventListener("focus",function(){a.classList.add("input-hint--visible")}),i.addEventListener("blur",function(){a.classList.remove("input-hint--visible")}))});var n=[{input:"template-name-input",counter:"template-name-counter"},{input:"template-description-input",counter:"template-description-counter"},{input:"version-name-input",counter:"version-name-counter"}];n.forEach(function(o){var i=document.getElementById(o.input),a=document.getElementById(o.counter);if(!i||!a)return;var r=parseInt(a.getAttribute("data-max"),10)||100;function s(){var l=i.value.length;a.textContent=l+" / "+r,a.classList.remove("char-counter--warning","char-counter--limit"),l>=r?a.classList.add("char-counter--limit"):l>=r*.85&&a.classList.add("char-counter--warning")}i.addEventListener("focus",function(){a.classList.add("char-counter--visible"),s()}),i.addEventListener("blur",function(){a.classList.remove("char-counter--visible")}),i.addEventListener("input",s)}),function(){var i=[],a=6e4,r=10,s=document.getElementById("rate-limit-indicator"),l=document.getElementById("rate-limit-text");if(!s||!l)return;function p(){for(var m=Date.now();i.length>0&&m-i[0]>a;)i.shift()}function c(){p();var m=i.length;if(m===0){s.style.display="none";return}s.style.display="",l.textContent=m+"/"+r+" requests this minute",s.classList.remove("playground__rate-limit--warning","playground__rate-limit--error"),m>=r?(s.classList.add("playground__rate-limit--error"),l.textContent=m+"/"+r+" requests - slow down"):m>=8&&(s.classList.add("playground__rate-limit--warning"),l.textContent=m+"/"+r+" requests - slow down")}function d(){!s||!l||(s.style.display="",s.classList.remove("playground__rate-limit--warning"),s.classList.add("playground__rate-limit--error"),l.innerHTML='Rate limited &mdash; resets shortly. <a href="#pricing" class="playground__rate-limit-link">Get a free API key for more.</a>')}window.__glyphRateLimit={track:function(){i.push(Date.now()),c()},onRateLimited:d,update:c},setInterval(c,1e4)}(),function(){document.addEventListener("keydown",function(i){if((i.ctrlKey||i.metaKey)&&i.key==="s"){var a=document.getElementById("playground");if(!a)return;var r=a.getBoundingClientRect(),s=r.top<window.innerHeight&&r.bottom>0;if(!s)return;i.preventDefault(),i.stopPropagation(),typeof showToast=="function"&&showToast("Generating PDF...","info",3e3);var l=document.getElementById("generate-btn");l&&!l.disabled?l.click():typeof showToast=="function"&&showToast("No document ready to download yet.","warning",3e3)}})}(),function(){function i(){var s=document.querySelector("#preview-container iframe");if(s)try{var l=s.contentDocument||s.contentWindow.document;if(!l)return;var p=l.querySelectorAll("[data-glyph-region]");p.forEach(function(c){var d=c.getAttribute("data-glyph-region");d&&!c.getAttribute("aria-label")&&(c.setAttribute("aria-label","Editable PDF region: "+d),c.setAttribute("role","button"))})}catch{}}var a=new MutationObserver(function(){setTimeout(i,500)}),r=document.getElementById("preview-container");r&&a.observe(r,{childList:!0,subtree:!0}),setTimeout(i,2e3)}()}();
